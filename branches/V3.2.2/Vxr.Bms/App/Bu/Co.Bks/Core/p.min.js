$.widget("custom.vbooking",{options:{cid:0,aid:0,uid:0,un:"",serviceUrl:null,backupBaseUrl:null,baseUrl:null,sTimeZoneOffset:0,cite:"",cice:"",cifne:"",cisne:"",pilne:"",aite:"",aice:"",aisne:"",aifne:"",rights:""},_$container:null,_$toolbar:null,_$tripInfo:null,_$sheet:null,_$notComeSheet:null,_$cancelSheet:null,_numCoach:1,_numRow:7,_numCol:5,_info:null,_data:null,_cTripIndex:0,_cTripId:0,_cFromId:0,_cToId:0,_cDefaultFromId:0,_cDefaultToId:0,_cTripDate:null,_cTripTime:null,_cTripBus:0,_cStageBinary:"",_cStageCode:0,_cMaxStageCode:0,_m:null,_nc:null,_c:null,_cphoneSt:null,_cCodeSt:null,_sOffsetMinute:0,_grid:!0,_rBookingOnPast:!1,_create:function(){FlatObj.W=this;this._initializeFields();this._createContainer();this._createToolBar();this._createSheet()},_initializeFields:function(n){var i;this._data=[];this._info=[];this._m=[];this._nc=[];this._c=[];this._cphoneSt={};this._cCodeSt={};this._cFromId=0;this._cToId=0;var t=new Date,r=t.getTimezoneOffset(),u=vPrsDt(this.options.sTime),f=Math.floor((u-t)/6e4);t.setHours(0);t.setMinutes(0);t.setSeconds(0);n&&n.d&&moment(n.d,"DD.MM.YYYY").isValid()?(i=vPrsDt(n.d),this._cTripDate=i?i:t):this._cTripDate=t;this._sOffsetMinute=parseInt(this.options.sTimeZoneOffset)+r+f;app.sOffsetMinute=this._sOffsetMinute},_createContainer:function(){this._$container=$(".vbooking-container")},_createToolBar:function(){this._$toolbar=$(".vbooking-toolbar")},_createSheet:function(){this._$tripInfo=$("<div />").addClass("vbooking-info col-md-12 col-sm-12 col-xs-12 clearfix").appendTo(this._$container);this._$sheet=$("<div />").addClass("vbooking-sheet col-md-12 col-sm-12 col-xs-12 clearfix").appendTo(this._$container);this._$notComeSheet=$("<div />").addClass("vbooking-ncsheet col-md-12 col-sm-12 col-xs-12 clearfix").appendTo(this._$container);this._$cancelSheet=$("<div />").addClass("vbooking-csheet col-md-12 col-sm-12 col-xs-12 clearfix").appendTo(this._$container)},load:function(n){return this._beginEvent(),this._initializeFields(n),this.reload(n),this._reloadInfo(),{x:this}},startNotification:function(){},reload:function(n){var t=this,i,r,u;$("#FilterForm .btn-filter > button").removeClass("active");i=$("#FilterForm .btn-filter > button.btn-grid");i.length>0&&(i.hasClass("active")||(i.addClass("active"),t._grid=!0));typeof t.options.rid!="undefined"&&(t._cTripId=t.options.rid);t._reloadTrigger();t._reloadData(function(){(t.allowCompEvent||t.allowAgentTripEvent)&&(alert("Không tìm thấy chuyến, vui lòng chọn Company khác"),$("body").trigger("tripNotFound"))});r=function(){FlatObj.LFTime=!1};typeof t._reloadFilter=="function"?(t._reloadFilter(n),t._reloadFrame(),u=function(){t._reloadSheet(r);$('ul.vbooking-list a[data-tab="bks"]').trigger("click");FlatObj.LDefTrip=!1},t._reloadAllowedSeats(u),t._isOrderring=!1):(console.error("BKS load fail. Trying again...."),location.reload())},_reloadFlatObj:function(){var n=this;return(FlatObj.W=this,n._data[n._cTripIndex]||(n._cTripIndex=0),FlatObj.cRoute=n._data[n._cTripIndex],!FlatObj.cRoute)?!1:(FlatObj.cTrip=FlatObj.cRoute.Ts[FlatObj.W._cTripTime][0],FlatObj.SP=n._data[n._cTripIndex].StopPoints,!0)},destroy:function(){this.element.empty();$.Widget.prototype.destroy.call(this)},_reloadTrigger:function(){$("body").trigger("applyBooking",this.options)},_beginEvent:function(){var n=this;$("#agtTrips").find(".jtable").on("mouseenter",function(){});$("body").on("compChanged",function(t,i){n.allowCompEvent&&typeof i!="undefined"&&i!=null&&(FlatObj.LFTime=!0,FlatObj.FTripGetTrip=!1,FlatObj.LDefTrip=!0,n._clearSelectedItem(),vbf("resetSeatStack"))});$("body").on("tripChanged",function(t,i){n.allowAgentTripEvent&&(n._setOption("cid",i.CompId),n._setOption("rid",i.Id),n.reload(),$("body").find("select[name=TripId]").trigger("change"))});vbv("fTripReady",function(t){t.cb!=undefined?n._mapData(t.r,t.cb):n._mapData(t.r);n._data[n._cTripIndex]&&(FlatObj.SP=n._data[n._cTripIndex].StopPoints);FlatObj.cRoute=n._data[n._cTripIndex];FlatObj.FTripGetTrip=!0});vbv("doEmptySheets",function(n){$(n.d.value).empty()});vbv("doHideSheets",function(){$(e.d.value).hide()});vbv("doRenderTripInfo",function(){FlatObj.FTripGetTrip=!1;n._renderTripInfo()});vbv("doShowPopModal",function(t){n._showPopModal(t.d.msg)});vbv("doShowSuccessModal",function(t){n._showSuccessModal(t.d.hdr,t.d.msg)});vbv("reloadSheet",function(t){var i=function(){t.cb&&t.cb.call(this,t)};n._reloadSheet(i)});vbv("storeHistory",function(t){n._storeHistory(t.d.un,t.d.key,t.d.his)});vbv("clearSelectedItem",function(){n._clearSelectedItem()});vbv("doGetCurrentTripInfo",function(){var t=n._getCurrentTripInfo();vbf("CurrentTripInfo",{tripInfo:t})});vbv("doResetAll",function(){n._resetAll()});vbv("doGetTotalSeats",function(){n._getTotalAvaiSeats()});vbv("doGetMultiTotalSeats",function(){n._getMultiTotalAvaiSeats()})},_endEvent:function(){this.allowCompEvent=!0;this.allowAgentTripEvent=!0},_setOption:function(n,t){this.options[n]=t},_submitAction:function(n,t){vRqs(n,t,{async:!1})},_submitAsyncAction:function(n,t){vRqs(n,t)},_reloadInfo:function(){var n=this,t=n._createGetInfoObj(),i=function(n,t,i){n!=1||i<=0};vdc.gCompany(t._c,"#",!1,null,i)},_createGetInfoObj:function(){var t=this,n={};return n._a="fGetCompany",n._c={BaseId:t.options.cid,Type:"($x = 2 OR $x = 3)",IsPrgStatus:1},n._f="Id, Type, Code, Name, AddressInfo, PhoneInfo",n},_reloadData:function(n){var i=this,t;FlatObj.FTripGetTrip||(t=jQuery.Event("fTripGetTrip"),t.in=i._cTripDate,t.reload=!FlatObj.LFTime,typeof n=="function"&&FlatObj.RBePrint&&(t.cb=n),$("body").trigger(t))},_createGetFrameObj:function(){var n=this,i,t;return n._cTripDate.setHours(0),n._cTripDate.setMinutes(0),n._cTripDate.setSeconds(0),i="(type = 1 or (type = 2 and Time is not null and $x = N'"+n._cTripDate.toFormatString("iso")+"')) order by type,DisplayOrder,name asc",t={},t._a="fGetTrip",t._c={CompId:n.options.cid,IsPrgStatus:"$x != 3",Date:i},t._f="Id, Name, Info, SeatTemplateInfo, FareInfo, StatusInfo, BaseId, Type, Time, Alias, TeamInfo, VehicleInfo, FromArea, ToArea, Note, RouteInfo, SeatSummaryInfo, TotalSeats, ClosedStatus, PassengerMoney, ProductMoney, FeeMoney, BranchReceiveProduct, RealDepartureTime, PickedPointsInfo, TransferPointsInfo, NewFare,DisplayOrder, Description, TotalBookedSeats, TotalPaidSeats",t},_parseStopPoints:function(n){var i={idx:{},data:[]},t=0;return $.each(n,function(n,r){if(t==0){t++;return}r=r.split("|");i.idx[r[0]]=t-1;i.data.push({Id:r[0],Type:r[1],Code:r[2],Name:r[3],Address:r[4],Distance:r[5],Hour:parseInt(r[6]),Minute:parseInt(r[7]),Order:typeof r[8]=="undefined"?0:r[8]});t++}),i},_mapData:function(n,t){var i=this,r;i._data=[];i._points=[];r=[];$.each(n,function(n,t){var o=parseInt(t[6]),f=parseInt(t[0]),a,e,c,l,w;if(isNaN(o)||o==0||(f=o),typeof _dict._hasBlockTripByBranch=="undefined"||!_dict._hasBlockTripByBranch||typeof _dict._blockTripByBranch=="undefined"||typeof _dict._blockTripByBranch[app.aid]=="undefined"||_dict._blockTripByBranch[app.aid].indexOf(f)==-1){a=parseInt(t[5]);e=parseInt(t[9]);isNaN(e)&&(e=0);var v=a,y=parseInt(t[7]),u=r.indexOf(f);u==-1&&(u=r.push(f)-1,i._data[u]={Id:f,Name:t[1],FromArea:t[12],ToArea:t[13],StopPoints:t[15]?i._parseStopPoints(t[15].split("~")):i._parseStopPoints([]),FareInfo:t[4],Ts:{},BranchReceiveProduct:t[22],PickedPointsInfo:t[24],TransferPointsInfo:t[25],TripDriver:t[28]});var s=0,h=t[3]?t[3].split("~")[1]:null,p=t[3]?t[3].split("~")[0]:null;typeof h!="undefined"&&h!=null&&(s=parseInt(h.split("|")[2]));c=t[17];l=t[16];1==y?t[2]!=null&&(w=t[2].split("~"),$.each(w,function(n,r){var f=r.split("|")[0];typeof i._data[u].Ts[f]=="undefined"&&(i._data[u].Ts[f]=[]);i._data[u].Ts[f][e]={T:t[3],SeatTemplateId:p,F:t[4],S:v,N:t[14],NS:s,BS:l,TS:c,ClosedStatus:t[18],RealDepartureTime:t[23],TripDriver:t[28]}})):2==y&&t[8]!=null&&t[8]!=""&&(typeof i._data[u].Ts[t[8]]=="undefined"&&(i._data[u].Ts[t[8]]=[]),i._data[u].Ts[t[8]][e]={T:t[3],SeatTemplateId:p,F:vIsEstStr(t[26])?t[26]:t[4],S:v,NS:s,Dr:t[10],V:t[11],N:t[14],BS:l,TS:c,TeamInfo:t[10],TripDetailId:t[0],ClosedStatus:t[18],PassengerMoney:t[19],ProductMoney:t[20],FeeMoney:t[21],RealDepartureTime:t[23],TripDriver:t[28],TotalPaidSeats:t[30],TotalBookedSeats:t[29]})}});vdc.gPhoiTemplates({IsPrgStatus:1,CompId:app.cid},"#",!1,null,function(n,t){i._phoiTemplates={};for(var r=0;r<t.length;r++)t[r][2]!=null&&t[r][2]!=""&&(i._phoiTemplates[t[r][2]]={id:t[r][0],name:t[r][1],seatTemplateId:t[r][2],seatTemplateName:t[r][3],html:t[r][4],numberOfPage:t[r][5],orientation:t[r][6]==0?"portrait":"landscape"})});t!=undefined&&t.call()},_reloadFrame:function(){var n=this;if(n._data[n._cTripIndex])try{n._mapSeatToMatrix(n._data[n._cTripIndex].Ts[n._cTripTime][n._cTripBus].T)}catch(t){console.log("(Error) _reloadFrame: "+t)}},_mapSeatToMatrix:function(n){var t=this,i,f,e,r,o;for(t._m=[],i=n.split("~"),t._numCoach=parseInt(i[1].split("|")[1]),f=2;f<4;f++){var h=i[f].split("|"),c=parseInt(h[1]),l=parseInt(h[2]);t._numRow<c&&(t._numRow=c);t._numCol<l&&(t._numCol=l)}for(e=t._numCoach+1;e<i.length;e++)if(r=i[e].split("|"),o=t._createSeatFromRecord(r),!$.isEmptyObject(o)){var u=parseInt(r[5]),s=parseInt(r[6]),a=parseInt(r[7]);typeof t._m[u-1]=="undefined"&&(t._m[u-1]=[]);typeof t._m[u-1][s-1]=="undefined"&&(t._m[u-1][s-1]=[]);t._m[u-1][s-1][a-1]=o}app.sheetMatrix=t._m},_reloadSheet:function(n){var t=this,u,r,i,f;return(FlatObj.FTripGetTrip=!1,$("button.btn-thong-ke").removeClass("active"),t._$sheet.removeClass("thong-ke-tb"),u=t._reloadFlatObj(),!u)?!1:(r=t._data[t._cTripIndex].Ts[t._cTripTime][0].S,r!=undefined&&r==3?(t._renderCanceledTrip(),t._$cancelSheet.hide()):(t._$cancelSheet.show(),i=t._createGetSeatObj(),f=function(i,r,u){i==1&&(t._clearTicket(),t._clearCancelled(),t._clearNotCome(),t._checkAllowedSeats(),u>0&&t._mapTicketToSeat(r),t._isOrderring?(t._renderPickupTicket(),t._hasMergeTransfer()&&t._reloadMergeTransferTicket(),t._renderTransferTicket()):t._grid?(t._renderSeatTemplate(),t._renderCancelledTicket(),t._renderNotComeTicket()):(t._lrenderSeatTemplate(),t._lrenderCancelledTicket()),typeof n!="undefined"&&typeof n=="function"&&n.call(),oRq.iAc&&t._resetAjaxRequest(),t._renderTripInfo())},$.isEmptyObject(i)?t._reloadFrame():vdc.gTicket(i._c,i._f,!FlatObj.LFTime,null,f)),app.oldData.t=t._cTripId,app.oldData.d=t._cTripDate.toFormatString("dd.mm.yyyy"),app.oldData.h=t._cTripTime.replace(":","."),$.setUrlByData("Quản lý nhà xe",{t:t._cTripId,d:t._cTripDate.toFormatString("dd.mm.yyyy"),h:t._cTripTime.replace(":",".")}),!0)},_getTotalAvaiSeats:function(){var n=this,t={_a:"fGetBTotalSeats",_c:{cId:app.cid,tripId:n._getCTripId(),tripDate:n._getDepartureTime().toFormatString("yyyy-mm-dd hh:mm:ss")},_f:"TotalBookedSeats,TotalExpiredSeats"},i=function(t,i){t==1&&i[0]&&vbf("bUpdateAvaiSeats",{value:n,TotalBookedSeats:i[0][0],TotalExpiredSeats:i[0][1]})};vRqs(t,i)},_getMultiTotalAvaiSeats:function(){var n=this,t={_a:"fGetBMultiTotalSeats",_c:{cId:app.cid,tripId:n._getCTripId(),tripDate:n._getDepartureTime().toFormatString("yyyy-mm-dd")},_f:"Time,TotalBookedSeats,TotalExpiredSeats"},i=function(t,i){t==1&&i&&vbf("bUpdateAvaiSeats",{value:n,ArrayTotalTimes:i})};vRqs(t,i)},_createGetSeatObj:function(){var t=this,i=t._getDepartureTime(),n={};return $.isEmptyObject(i)?($("body").trigger("timeNotFound"),{}):(n._a="fGetTicket",n._c={cId:app.cid,tripId:t._cTripId,tripDate:i.toFormatString("iso")},n._f=_dict._tgF.join(),n)},_clearTicket:function(){var n=this;n._cphoneSt=[];n._cCodeSt=[];$.each(n._m,function(n,t){typeof t!="undefined"&&$.each(t,function(n,t){typeof t!="undefined"&&$.each(t,function(n,t){typeof t!="undefined"&&t!=null&&(t._tickets=[])})})})},_clearCancelled:function(){var n=this;n._c=[];n._$cancelSheet.empty()},_clearNotCome:function(){var n=this;n._nc=[];n._$notComeSheet.empty()},_reloadAllowedSeats:function(n){var t=this,i,r,u;app.onlineCompId!=null&&app.aid!=app.vaid&&(app.onlineCompId.indexOf(parseInt(app.cid))!=-1?(t._allowedSeats=[],t._allAllowedSeats=[],i=t._createAllowedSeatObj(),r=function(i,r,u){if(i!=1){t._allowBookAllSeat=!0;n!=undefined&&n.call();return}u>=1?t._mapDataAllowedSeat(r,n):(n!=undefined&&n.call(),t._allowBookAllSeat=!0)},vdc.gBusTicketStatus(i._c,"#",!FlatObj.LFTime,null,r)):n!=undefined&&n.call(),u=this._createLSeatObj(),vRqs(u,function(n,t){n==1&&(app.vmsLSeats=[],$.each(t,function(n,t){var f=vIsEstStr(t[8])?vGtDtObj(t[8]):null,i=t[9],e=t[11],o=t[12],r="",u;r=vIsEstStr(i)?vPrsTm(i):"";u={Date:f,Time:r,Info:e,TimeLimit:parseInt(t[12])};app.vmsLSeats.push(u)}))}))},_createLSeatObj:function(){var n=this;return{_a:"fGetBus_Tickets_Status_01",_c:{XTypeId:11,XTripId:n._cTripId,XStatus:1,XDate:n._cTripDate.toFormatString("yyyy-mm-dd"),IsPrgStatus:"($x is null or $x != 3)"},_f:"Id,XTypeId,XAgentId,XBranchId,XOperatorId,XCompanyId,XRouteId,XTripId,XDate,XTime,XStatus,Info,TimeLimit"}},_createAllowedSeatObj:function(){var n=this;return{_a:"fGetBus_Tickets_Status",_c:{XTypeId:"($x in (2,5,11))",XTripId:n._cTripId,XStatus:1,XDate:n._cTripDate.toFormatString("yyyy-mm-dd"),IsPrgStatus:"($x is null or $x != 3)"},_f:"Id,XTypeId,XAgentId,XBranchId,XOperatorId,XCompanyId,XRouteId,XTripId,XDate,XTime,XStatus,Info,TimeLimit"}},_mapDataAllowedSeat:function(n,t){var i=this;app.vmsLSeats=[];i._allAllowedSeats=[];$.each(n,function(n,t){var e=vIsEstStr(t[8])?vGtDtObj(t[8]):null,u=t[9],o=t[11],s=t[12],f="",r;f=vIsEstStr(u)?vPrsTm(u):"";r={Date:e,Time:f,Info:o,TimeLimit:parseInt(t[12])};t[1]==11?app.vmsLSeats.push(r):i._allAllowedSeats.push(r)});t!=undefined&&t.call()},_checkAllowedSeats:function(){var n=this,t=!1,i=!1,r,u;if(n._allAllowedSeats!=undefined&&n._allAllowedSeats.length>0?$.each(n._allAllowedSeats,function(r,u){i||($.isEmptyObject(u.Date)?vIsEstStr(u.Time)&&u.Time!=n._cTripTime||(t=n._getAllowedSeats(u)):vGetDateOnly(u.Date)==vDtToStr("dd-mm-yyyy",n._cTripDate)&&(vIsEstStr(u.Time)&&u.Time!=n._cTripTime||(t=n._getAllowedSeats(u),u.Time==n._cTripTime&&(i=!0))))}):(i=!1,app.vmsLSeats!=undefined&&app.vmsLSeats.length>0&&$.each(app.vmsLSeats,function(r,u){i||($.isEmptyObject(u.Date)?vIsEstStr(u.Time)&&u.Time!=n._cTripTime||(t=n._getAllowedSeats(u)):vGetDateOnly(u.Date)==vDtToStr("dd-mm-yyyy",n._cTripDate)&&(vIsEstStr(u.Time)&&u.Time!=n._cTripTime||(t=n._getAllowedSeats(u),u.Time==n._cTripTime&&(i=!0))))})),t){r=new Date;r.addMinutes(app.onlineTimeLimit);u=n._cTripDate;u<r&&(n._allowBookAllSeat=!0,n._allowedSeats=[]);return}n._allowBookAllSeat=!0;n._allowedSeats=[];return},_getAllowedSeats:function(n){var t=this,e=n.Info,u;if(t._allowBookAllSeat=!0,t._allowedSeats=[],vIsEstStr(e)&&e.indexOf("~")>0){var r=e.split("~"),s=parseInt(r[0]),h=parseInt(r[1]);if(s==1&&h<1e3){for(u=2;u<r.length;u++){var f=r[u].split("|"),i=parseInt(f[1]),o=parseInt(f[2]),c=parseInt(f[3]);typeof t._allowedSeats[i]=="undefined"&&(t._allowedSeats[i]=[]);typeof t._allowedSeats[i][o]=="undefined"&&(t._allowedSeats[i][o]=[]);t._allowedSeats[i][o][c]=f[0]}return t._allowBookAllSeat=!1,app.onlineTimeLimit=n.TimeLimit,!0}}return!1},_mapTicketToSeat:function(n){var t=this;$.each(n,function(n,i){var r=t._createTicketFromRecord(i),f,o,s;if(!$.isEmptyObject(r)){var h=i[4].split("|"),u=parseInt(h[1]),e=parseInt(h[2]),c=parseInt(h[3]);isNaN(u)||isNaN(e)||isNaN(c)||typeof t._m[u-1]!="undefined"&&typeof t._m[u-1][e-1]!="undefined"&&typeof t._m[u-1][e-1][c-1]!="undefined"&&(f=t._m[u-1][e-1][c-1],r._isNotCome()?(o=f._clone(),o._tickets=[],o._addTicket(r,t._cStageCode),typeof t._nc[u-1]=="undefined"&&(t._nc[u-1]=[]),t._nc[u-1].push(o)):r._isCancelled()?(r._pcode==null||r._pcode=="")&&(s=f._clone(),s._tickets=[],s._addTicket(r,t._cStageCode),typeof t._c[u-1]=="undefined"&&(t._c[u-1]=[]),t._c[u-1].push(s)):r._isValid()||r._isOpen()||f._isAvailable()&&(f._addTicket(r,t._cStageCode),t._updateCPhoneSt(f,r),t._updateCCodeSt(f,r)))}})},_getCurrentTripInfo:function(){var w,s,h,it,rt,ut,c,ft,l,ht,a,ct,lt;if(FlatObj.cTripInfo!=null)return FlatObj.cTripInfo;var f=this,n={_vehicleNumber:"",_driverName:"",_assistantName:"",_guideName:"",_note:""},t=f._data[f._cTripIndex].Ts[f._cTripTime][f._cTripBus];if(vIsEstStr(t.T)&&(n._vehicleName=vIsEstStr(t.V)&&!vIsEstStr(t.V.split("~")[1].split("|")[3])?t.V.split("~")[1].split("|")[3]:t.T.split("~")[1].split("|")[5]),vIsEstStr(t.V)&&(n._vehicleNumber=t.V.split("~")[1].split("|")[2]),vIsEstStr(t.Dr)){w=t.Dr.split("~");w.shift();var b=[],k=[],d=[];$.each(w,function(n,t){if(typeof t!="undefined"&&t!=null){var i=t.split("|");switch(parseInt(i[0])){case 2:b.push(i[2]);break;case 4:k.push(i[2]);break;case 5:d.push(i[2])}}});n._driverName=b.length>0?b.join(", "):"";n._assistantName=k.length>0?k.join(", "):"";n._guideName=d.length>0?d.join(", "):""}vIsEstStr(t.N)&&(n._note=t.N);var v=0,o=0,nt=0,e=0,u=0,i={},y={},r={},g={};if($.each(f._m,function(n,t){typeof t!="undefined"&&$.each(t,function(n,t){typeof t!="undefined"&&$.each(t,function(n,t){typeof t!="undefined"&&t!=null&&t._isAvailable()&&(t._hasTicket()?$.each(t._tickets,function(n,t){var f,h,c,l,a,s;if(t._isPaid()||t._isPass()){if(f=t._getPaymentInfo(),!$.isEmptyObject(f))switch(f.type){case 1:case 6:typeof f.info!="undefined"&&(h=f.info._code,typeof i[h]=="undefined"&&(i[h]=0,r[h]=0),i[h]++,r[h]+=t._fare,u+=t._fare,e+=t._fare);break;case 2:case 3:case 4:c=f.sname;typeof i[c]=="undefined"&&(i[c]=0,r[c]=0);i[c]++;r[c]+=t._fare;e+=t._fare;u+=t._fare;break;case 5:case 7:l=f.sname;typeof i[l]=="undefined"&&(i[l]=0,r[l]=0);i[l]++;r[l]+=t._fare;e+=t._fare;u+=t._fare;break;case 8:case 9:a=f.sname;typeof i[a]=="undefined"&&(i[a]=0,r[a]=0);i[a]++;r[a]+=0;u+=0;break;case 10:typeof i[f.sname]=="undefined"&&(i[f.sname]=0,r[f.sname]=0);i[f.sname]++;r[f.sname]+=t._fare;u+=t._fare;e+=t._fare}v++}else t._isBooking()&&(s=t._getAgentInfo(),$.isEmptyObject(s)||(typeof y[s._code]=="undefined"&&(y[s._code]=0,g[s._code]=0),y[s._code]++,g[s._code]+=t._fare,u+=t._fare),o++)}):nt++)})})}),n._numPaid=v,n._numBooking=o,n._numAvail=nt,v>0&&(n._numPaidPerType=[],n._totalPaidPerType=[],n._tkNumPaidPerType=[],$.each(i,function(t,i){typeof i!="undefined"&&($.each(r,function(r,u){r==t&&(n._totalPaidPerType.push(t+":&nbsp;"+i+"&nbsp;-&nbsp;"+u.toMn()+" đ"),n._tkNumPaidPerType.push(t+"|"+i+"|"+u))}),n._numPaidPerType.push(t+":&nbsp;"+i))}),n._numPaidPerType="&nbsp;("+n._numPaidPerType.join()+")",n._totalPaidPerType=n._totalPaidPerType.join(", &nbsp;")),o>0&&(n._numBookingPerAgent=[],n._totalBookingPerAgent=[],$.each(y,function(t,i){typeof i!="undefined"&&($.each(g,function(r,u){r==t&&n._totalBookingPerAgent.push(t+":&nbsp;"+i+"&nbsp;-&nbsp;"+u.toMn()+"đ")}),n._numBookingPerAgent.push(t+":&nbsp;"+i))}),n._numBookingPerAgent="&nbsp;("+n._numBookingPerAgent.join()+")",n._totalBookingPerAgent=n._totalBookingPerAgent.join(", ")),n._total=v+o,n._totalPaid=e,n._numBooking=o,n._totalMoney=u!=0?u.toMn()+" đ":"",n._mainFareTienKhach=e,n._anotherFareTienKhach=0,n._nameAnotherFareTienKhach="",n._feeTienKhach=0,n._nameFeeTienKhach="",t.PassengerMoney!=null){var at=t.PassengerMoney.indexOf("~"),tt=t.PassengerMoney.substr(at,t.PassengerMoney.length).split("|"),p=tt[1].split("##");n._nameAnotherFareTienKhach=p[0]!=null?p[0]:"";n._anotherFareTienKhach=p[1]!=null?p[1].toNum():0;s=tt[2].split("##");n._nameFeeTienKhach=s[0]!=null?s[0]:"";n._feeTienKhach=s[1]!=null?s[1].toNum():0}if(n._branchReceiveProduct=[],h=f._data[f._cTripIndex].BranchReceiveProduct,h!=null&&(it=h.indexOf("~"),rt=h.substr(it+1,h.length).split("~"),$.each(rt,function(t,i){var r=i.split("|"),u={_id:r[0],_code:r[2]};n._branchReceiveProduct.push(u)})),n._numPickedProPaid=0,n._moneyPickedProPaid=0,n._numPickedProNotPaid=0,n._moneyPickedProNotPaid=0,n._branchProduct=[],n._totalMoneyBranchNotPaid=0,n._totalMoneyBranchPaid=0,n._totalNumBranchNotPaid=0,n._totalNumBranchPaid=0,n._feeTienHang=0,n._nameFeeTienHang="",t.ProductMoney!=null){ut=t.ProductMoney.indexOf("~");c=t.ProductMoney.substr(ut+1,t.ProductMoney.length).split("~");vIsEstStr(c[0])&&(ft=c[0].split(","),$.each(ft,function(t,i){var e=i.substr(0,i.indexOf(":")),o=i.substr(i.indexOf(":")+1,i.length),f=o.split("##"),r=f[0].split("|"),u=f[1].split("|"),s={_branchCode:e,_numBranchProPaid:r[0].toNum(),_moneyBranchProPaid:r[1].toNum(),_numBranchProNotPaid:u[0].toNum(),_moneyBranchProNotPaid:u[1].toNum()};n._branchProduct.push(s);n._totalMoneyBranchNotPaid+=u[1].toNum();n._totalMoneyBranchPaid+=r[1].toNum();n._totalNumBranchNotPaid+=u[0].toNum();n._totalNumBranchPaid+=r[0].toNum()}));var et=c[1].split("##"),ot=et[0].split("|"),st=et[1].split("|");n._numPickedProPaid=ot[0].toNum();n._moneyPickedProPaid=ot[1].toNum();n._numPickedProNotPaid=st[0].toNum();n._moneyPickedProNotPaid=st[1].toNum();l=c[2].split("##");n._nameFeeTienHang=l[0]!=null?l[0]:"";n._feeTienHang=l[1]!=null?l[1].toNum():0}return n._tollFee=0,n._washFee=0,n._eatFee=0,n._anotherFee=[],t.FeeMoney!=null&&(ht=t.FeeMoney.indexOf("~"),a=t.FeeMoney.substr(ht+1,t.FeeMoney.length).split("~"),n._tollFee=a[0].toNum(),n._washFee=a[1].toNum(),n._eatFee=a[2].toNum(),ct=a[3],lt=ct.split("##"),$.each(lt,function(t,i){var r=i.split("|"),u={_index:r[0],_name:r[1]==null?"":r[1],_money:r[2]==null?0:r[2]};n._anotherFee.push(u)})),n},_resetAjaxRequest:function(){vRqz()},_renderSeatTemplate:function(){var n=this,c=n._data[n._cTripIndex].Ts[n._cTripTime][0].ClosedStatus,l=n._data[n._cTripIndex].Ts[n._cTripTime][0].TripDetailId,o="",i=n._data[n._cTripIndex].Ts[n._cTripTime][0].V,s,u,f,r;typeof i!="undefined"&&i!=null&&(s=i.substr(i.indexOf("~")+1,i.length).split("|"),o=s[2]);n._clearSheet();u=n._data[n._cTripIndex].Ts[n._cTripTime][n._cTripBus].NS;f=null;typeof _dict._specialPos!="undefined"&&typeof _dict._specialPos[u]!="undefined"&&(f=_dict._specialPos[u]);var a=n._transformSeatMatrix(f),h=0,v=n._hasBookingPermission(),t=!0,e;if(app.vmsLSeats.length>0)for(r=0;r<app.vmsLSeats.length;r++)if(app.vmsLSeats[r].Time==n._cTripTime&&app.vmsLSeats[r].Date.toDateString()==n._cTripDate.toDateString()){e=app.vmsLSeats[0].Info;break}$.each(a,function(i,r){if(typeof r!="undefined"){var u=n._createCoach(n._$sheet).addClass(_dict._g[n._numCoach-1]).addClass("Trip-"+n._cTripId);n._numCoach>1&&u.addClass(_dict._chcl[h%2]);$.each(r,function(i,r){typeof r!="undefined"&&$.each(r,function(i,r){var f,a,w,b,p,k,s,y,h;typeof r!="undefined"&&r!=null&&(f=r._getCurrentTicket(),a=0,$.isEmptyObject(f)||(_dict._allowGroupByCode?typeof n._cCodeSt[f._getTicketCode()]!="undefined"&&(a=n._cCodeSt[f._getTicketCode()].length):typeof n._cphoneSt[f._getDefaultPhoneNumber()]!="undefined"&&(a=n._cphoneSt[f._getDefaultPhoneNumber()].length)),w=n._data[n._cTripIndex].StopPoints.data.length,b=n._isStageBooking(),n._allowBookAllSeat?t=!1:(t=typeof n._allowedSeats[r._coach]!="undefined"&&typeof n._allowedSeats[r._coach][r._row]!="undefined"&&typeof n._allowedSeats[r._coach][r._row][r._col]!="undefined"?!1:!0,app.cid!=app.vid&&(t=!t)),p=!1,k=r._label+"|"+r._coach+"|"+r._row+"|"+r._col,e!=undefined&&e.indexOf(k)!=-1&&(p=!0),s=r._renderSeat(a,v,n._cStageCode,w,n._data[n._cTripIndex].StopPoints,b,n._cMaxStageCode,c,"",l,o,t,n._cTripId,n._hasBookingPermissionByUsers(),p),app.fMoving?(y=!1,$.each(app.movingStack,function(n,t){if(!y){var i=t._getCurrentTicket();i._id==f._id&&(y=!0)}}),y&&s.addClass(_dict._slc[0])):n._existingSeatStack(r)&&s.addClass("selected"),r._isAvailable()&&(f._type!=2||f._type==2&&app.rights.indexOf($.rights.bEdtOnlTic.val)>=0)&&n._bindEventOnSeat(s,r),h=n._data[n._cTripIndex].Ts[n._cTripTime][0].SeatTemplateId,_dict._specialNumColBySeatTemplateId!=undefined&&_dict._specialNumColBySeatTemplateId[h]!=undefined?s.addClass(_dict._g[_dict._specialNumColBySeatTemplateId[h]-1]).addClass(_dict._sg[_dict._specialNumColBySeatTemplateId[h]-1]).addClass(_dict._mg[_dict._specialNumColBySeatTemplateId[h]-1]):s.addClass(_dict._g[_dict._tplNumCol-1]).addClass(_dict._sg[_dict._tplNumCol-1]).addClass(_dict._mg[_dict._tplNumCol-1]),u.append(s))})});h++}});n._bindNumStageTicketsTooltips();app.fMoving?n._bindEventMoving():app.hasCopyTicket?vbf("onBindEventCopying"):app.hasBookReturnTicket&&vbf("onBindEventBookReturnTicket",{tId:n._getCTripId()})},_renderTripInfo:function(){var n=this;FlatObj.LFTime&&(FlatObj.FTripGetTrip=!0);n._reloadData();n._$tripInfo.empty();FlatObj.cTripInfo=null;FlatObj.cTripInfo=n._getCurrentTripInfo();var i=FlatObj.cTripInfo,t={trip:i},r=n._data[n._cTripIndex].Ts[n._cTripTime][n._cTripBus].ClosedStatus,u=n._data[n._cTripIndex].Ts[n._cTripTime][n._cTripBus].TripDetailId;if(u)switch(r){case 1:n._hideXuatBenButton();n._$tripInfo.html(vtpl(_dict._tInfoClosedTpl,t));break;case 2:n._hideXuatBenButton();n._$tripInfo.html(vtpl(_dict._tInfoChotPhoiTpl,t));break;default:n._showXuatBenButton();n._$tripInfo.html(vtpl(_dict._tInfoTpl,t))}else n._showXuatBenButton(),n._$tripInfo.html(vtpl(_dict._tInfoTpl,t))},_clearSheet:function(){this._$sheet.empty()},_createNoSeat:function(){return $("<li />").addClass("seat noseat")},_createSeatFromRecord:function(n){var t={};return _dict._ts.indexOf(parseInt(n[2]))!=-1&&(t=new S(parseInt(n[5]),parseInt(n[6]),parseInt(n[7]),parseInt(n[0]),"seat",n[3],parseInt(n[2]))),t},_createTicketFromRecord:function(n){var v=this,y=parseInt(n[8]),p=parseInt(n[22]),i,r,u;if(p==v._cTripBus){var w=parseInt(n[0]),b=vIsEstStr(n[5])?vPrsDt(n[5]):null,k=vPrsDt(n[6]),f=parseInt(n[9]);isNaN(f)&&(f=0);var d=n[10],g=n[11],nt=n[12],e=n[13];null==e&&(e="");var tt=n[14],it=n[15],rt=n[16],ut=vPrsDt(n[17]),ft=vPrsDt(n[18]),et=vPrsDt(n[19]),ot=n[20],o=parseInt(n[21]);isNaN(o)&&(o=0);i=parseInt(n[26]);isNaN(i)&&(i=0);r=parseInt(n[27]);isNaN(r)&&(r=0);u=parseInt(n[29]);isNaN(u)&&(u=0);var st=n[23],ht=n[24],ct=parseInt(n[25]),lt=parseInt(n[1]),at=vPrsDt(n[3]),h=0,c="",l="",t=n[7];t!=null&&(t=t.split("|"),h=parseInt(t[2]),c=t[3],l=t[4]);var vt=n[28],yt=n[29],s=parseInt(n[30]);isNaN(s)&&(s=1);var pt=n[32],wt=n[33],bt=n[34],kt=n[35],dt=n[36],gt=n[37],ni=n[38],ti=n[39],ii=n[40],ri=n[41],ui=n[42],fi=n[43],ei=n[44],oi=n[45],si=n[46],hi=n[47],ci=n[48],a=new T(w,at,h,c,l,y,b,k,f,d,g,nt,e,tt,it,rt,ut,ft,et,ot,o,st,ht,ct,lt,i,r,vt,yt,s,u,pt,wt,bt,kt,dt,gt,ni,ti,ii,ri,ui,fi,ei,oi,si,hi,ci);return a.agentId=n[2],a}return{}},_createCoach:function(n){return $("<ul />").addClass("coach vbooking-coach").appendTo(n)},_notFoundResult:function(){var n=this;$("<div />").addClass(_dict._g[n._numCoach-1]).append($("<div />").addClass("alert alert-danger").html("<strong>Không tìm thấy chuyến.<\/strong>  Vui lòng chọn ngày giờ khác")).appendTo(n._$sheet)},_renderCancelledTicket:function(){var n=this,t,i;n._c.length>0&&(n._$cancelSheet.append($("<h4 />").addClass("sheet-title").html("Vé đã hủy")),t=0,i=n._hasBookingPermission(),$.each(n._c,function(r,u){var e,f;typeof u!="undefined"&&u!=null&&(e=n._createCoach(n._$cancelSheet).addClass(_dict._g[n._numCoach-1]),n._numCoach>1&&e.addClass(_dict._chcl[t%2]),f=_dict._tplNumCol,$.each(u,function(t,r){var u,o;if(typeof r!="undefined"&&r!=null&&(u=r._getCurrentTicket(),u._type!=2&&u._cancelType!=4)){var h=n._data[n._cTripIndex].StopPoints.data.length,c=n._isStageBooking(),l=n._data[n._cTripIndex].Ts[n._cTripTime][n._cTripBus].ClosedStatus,a=n._data[n._cTripIndex].Ts[n._cTripTime][n._cTripBus].RealDepartureTime,s=r._renderSeat(0,i,n._cStageCode,h,n._data[n._cTripIndex].StopPoints,c,n._cMaxStageCode,l,a,null,null,null,null,n._hasBookingPermissionByUsers()).addClass(_dict._g[f-1]).addClass(_dict._sg[f-1]).addClass(_dict._mg[f-1]);app.fMoving&&(o=!1,$.each(app.movingStack,function(n,t){if(!o){var i=t._getCurrentTicket();i._id==u._id&&(o=!0)}}),o&&s.addClass(_dict._slc[0]));n._bindEventOnSeat(s,r);e.append(s)}}),t++)}));(app.hasCopyTicket||app.hasBookReturnTicket)&&($("#bksContent div.vbooking-csheet").find("ul.vbooking-coach li.seat").unbind("click"),$("#bksContent div.vbooking-csheet").find("ul.vbooking-coach li.seat button").prop("disabled",!0))},_renderNotComeTicket:function(){var n=this,t,i;n._nc.length>0&&(n._$notComeSheet.append($("<h4 />").addClass("sheet-title").html("Hành khách không đến")),t=0,i=n._hasBookingPermission(),$.each(n._nc,function(r,u){var e,f;typeof u!="undefined"&&u!=null&&(e=n._createCoach(n._$notComeSheet).addClass(_dict._g[n._numCoach-1]),n._numCoach>1&&e.addClass(_dict._chcl[t%2]),f=_dict._tplNumCol,$.each(u,function(t,r){if(typeof r!="undefined"&&r!=null){var o=n._data[n._cTripIndex].StopPoints.data.length,s=n._isStageBooking(),u=r._renderSeat(0,i,n._cStageCode,o,n._data[n._cTripIndex].StopPoints,s,n._cMaxStageCode).addClass(_dict._g[f-1]).addClass(_dict._sg[f-1]).addClass(_dict._mg[f-1]);n._bindEventOnSeat(u,r);e.append(u)}}),t++)}))},_renderCanceledTrip:function(){var n=this,t;n._$sheet.empty();t="<div class='cancelled-trip'>Không có chuyến xe nào trong ngày đã chọn. Vui lòng chọn ngày khác để đặt vé.<\/div>";n._$sheet.append(t)},_createForm:function(n,t,i){var r=this,c=$("<form />").attr("id",n).attr("role","form"),h,o,a,s,u,v;typeof i!="undefined"&&c.addClass(i);var f=[],y=[],l=0,e=0;for($.each(t,function(n,t){var i=t[0],r=t[1];t[4]=="hidden"?y.push(t):(typeof f[i-1]=="undefined"&&(f[i-1]=[]),typeof f[i-1][r-1]=="undefined"&&(f[i-1][r-1]=[]),f[i-1][r-1].push(t));l<i&&(l=i);e<r&&(e=r)}),$.each(y,function(n,t){if(typeof t!="undefined"){var i=r._createFormInput(t[4],t[5],t[7]).addClass(t[6]);$.isEmptyObject(t[8])||$.each(t[8],function(n,t){i.attr(n,t)});c.append(i)}}),h=r._createFormContainer(),h.append($('<div class="alert alert-danger message-error" role="alert" style="margin:5px 0 0 0;display:none;" />')),h.append($('<div class="row" />').css("margin-top","0").append($('<div class="col-md-12 checkbox-route-point" />'))),o=0;o<l;o++)if(typeof f[o]!="undefined"){for(a=r._createFormRow(),s=0;s<e;s++)u=r._createFormCol(),typeof f[o][s]!="undefined"&&(v=!1,$.each(f[o][s],function(n,t){var i=r._createFormLabel(t[2]),f,c,l,o,a,y,p,w,h;i.length>0&&i.addClass("col-md-4 col-sm-4 col-xs-12 pl0");f=r._createFormInputGroup().addClass("col-md-8 col-sm-8 col-xs-12");switch(t[3]){case"input":c=r._createFormInput(t[4],t[5],t[7],t[8]).addClass(t[6]);l=r._createFormInputAddon(t[10]);switch(t[4]){case"checkbox":case"radio":c.append("&nbsp; "+t[2]);f.addClass("col-md-offset-4 col-sm-offset-4");break;default:u.append(i)}u.append(f.append(c).append(l));break;case"select":o=t[9];t[5]=="PaymentType"&&(o=[],$.each(_dict._pm,function(n,t){if(t[2]==1){var i=t[0],r=t[1][_dict._lang];o.push({Value:i,Text:r})}}));a=r._createFormSelect(t[5],o,t[7],t[4],t[8]).addClass(t[6]);u.append(i).append(f.append(a));break;case"textarea":y=r._createFormTextArea(t[5],t[7],t[8]).addClass(t[6]);u.append(i).append(f.append(y));break;case"p":p=r._createFormText(t[7],t[8]).addClass(t[6]);u.append(p);break;case"button":w=r._createFormButton(t[4],t[8]).addClass(t[6]).append(t[10]).append(t[5]);u.append(w)}typeof t[11]!="undefined"&&t[11].length>0&&(h=t[11][1]-t[11][0],u.addClass(_dict._g[e-h-1]).addClass(_dict._mg[e-h-1]),v=!0,s+=h)}),v||u.addClass(_dict._g[e-1]).addClass(_dict._sg[e-1]).addClass(_dict._mg[e-1])),a.append(u);h.append(a)}return c.append(h)},_createFormContainer:function(){return $("<div />").addClass("container-fluid")},_createFormRow:function(){return $("<div />").addClass("row")},_createFormCol:function(){return $("<div />")},_createFormLabel:function(n){return""!=n?$("<label />").addClass("col-sm-4 control-label").text(n):""},_createFormInputGroup:function(){return $("<div />").addClass("input-group")},_createFormInput:function(n,t,i,r){var u=$();switch(n){case"checkbox":case"radio":u=$("<label />").append($("<input />",{type:n,name:t,value:i}));break;default:u=$("<input />",{type:n,name:t,value:i})}return $.isEmptyObject(u)||typeof r=="undefined"||r==null||$.isEmptyObject(r)||$.each(r,function(n,t){u.attr(n,t)}),u},_createFormInputAddon:function(n){return""!=n?$("<div />").addClass("input-group-addon").append(n):""},_createFormSelect:function(n,t,i,r,u){var f=$("<select />",{name:n});return f.append($("<option />",{value:""}).text(r)),$.each(t,function(n,t){f.append($("<option />",{value:t.Value}).text(t.Text))}),typeof u!="undefined"&&u!=null&&($.isEmptyObject(u)||$.each(u,function(n,t){f.attr(n,t)})),f},_createFormTextArea:function(n,t,i){var r=$("<textarea />",{name:n}).val(t);return typeof i!="undefined"&&i!=null&&($.isEmptyObject(i)||$.each(i,function(n,t){r.attr(n,t)})),r},_createFormButton:function(n,t){var i=$("<button />",{type:n});return typeof t!="undefined"&&t!=null&&($.isEmptyObject(t)||$.each(t,function(n,t){i.attr(n,t)})),i},_createFormText:function(n,t){var i=$("<p />").text(n);return typeof t!="undefined"&&t!=null&&($.isEmptyObject(t)||$.each(t,function(n,t){i.attr(n,t)})),i},_resetForm:function(n){n.find("input[type=hidden]").val("");n.find("input[type=text], textarea, select").val("");n.find("input[type=checkbox]").prop("checked",!1);n.find("input[type=radio]").prop("checked",!1);n.find("div.has-error").removeClass("has-error");n.find("div.search-result").remove()},_convertFormDataToObj:function(n){var r=this,i={},t=null;return(app.hasCopyTicket||app.hasBookReturnTicket)&&(t=$(n).find(":input:disabled").removeAttr("disabled")),$.each($(n).serializeArray(),function(n,t){i[t.name]=t.value}),(app.hasCopyTicket||app.hasBookReturnTicket)&&t&&t.attr("disabled","disabled"),i},_getDepartureTime:function(){var i=this,t=i._cTripDate,n=i._cTripTime.split(":");return isNaN(parseInt(n[0]))||isNaN(parseInt(n[1]))?{}:(t.setHours(parseInt(n[0])),t.setMinutes(parseInt(n[1])),t)},_getCustomer:function(n,t,i){return $.trim("1|1|"+n+"|"+t+"|"+i)},_getPayment:function(n,t,i){return $.trim(n+":"+t+":"+i)},_getHistory:function(n,t){var i=this,r=[i.options.cid,i.options.aid,i.options.uid,i.options.un,(new Date).addMinutes(i._sOffsetMinute).toFormatString("iso"),n];return r.push(JSON.stringify(t)),r.join("##")},_getFareQuickBook:function(n,t){var r=this,u=r._parseFares(),f=n+"|"+t,i=u[f];return typeof i=="undefined"?0:i},_parseFares:function(){var t=this,f="",e="",u=0,i=t._data[t._cTripIndex].Ts[t._cTripTime][t._cTripBus].F,n;if(typeof i!="undefined"&&vIsEstStr(i)&&i.length>1){var r=i.split("~"),s=r.length,o=[];for(n=1;n<s;n++)f=r[n].split("|")[0],e=r[n].split("|")[1],u=parseInt(r[n].split("|")[2]),o[f+"|"+e]=isNaN(u)?0:u;return o}return[]},_getCurrentFare:function(){var n=this,t=0,i=n._data[n._cTripIndex].Ts[n._cTripTime][n._cTripBus].F.split("~");return i.length>0&&(t=parseInt(i[1].split("|")[2]),isNaN(t)&&(t=0)),t},_getBranchInfo:function(n){var t="";return $.each(app.branchInfo,function(i,r){t==""&&n==r[0]&&(t=r.join("|"))}),t==""&&(t=[app.aid,app.aite,app.aice,app.aisne,"",""].join("|")),t},_getAgentInfo:function(){var n=this;return $.trim(n.options.aid+"|"+n.options.aite+"|"+n.options.aice+"|"+n.options.aisne)},_getPickupInfo:function(n,t,i){return typeof n=="undefined"&&(n=""),typeof t=="undefined"&&(t=""),typeof i=="undefined"&&(t=""),$.trim(n+"|"+t+"|"+i)},_createHistoryForm:function(){var n=this;return $("<div />").addClass("container-fluid").append($("<div />").addClass("row history-row").append($("<div />").addClass("col-sm-12").append($("<table />").addClass("table table-striped table-hover table-condensed").append($("<thead>").append($("<tr />").append($("<th />").text("NV")).append($("<th />").text("Tác vụ")).append($("<th />").text("Ngày")).append($("<th />").text("Cập nhật")))).append($("<tbody />"))))).append($("<div />").addClass("row action-row").append($("<div />").addClass("col-md-12 list-btn").append(n._createFormButton("button").addClass("btn btn-default btn-close").text("Đóng"))))},_getTripById:function(n){var i=this,t=null;return $.each(i._data,function(i,r){t==null&&n==r.Id&&(t=r)}),t},_createTable:function(){return $("<table />")},_createTableRow:function(){return $("<tr />")},_createTableCol:function(n){var t=$("<td />");return n>1&&t.attr("colspan",n),t},_createTableHead:function(){return $("<thead />")},_createTableBody:function(){return $("<tbody />")},_createTableHeadCol:function(n){var t=$("<th />");return n>1&&t.attr("colspan",n),t},_transformSeatMatrix:function(n){var i=this,t=[];return i._printStageTickets=[],$.each(i._m,function(r,u){typeof u!="undefined"&&$.each(u,function(u,f){typeof f!="undefined"&&$.each(f,function(f,e){var c,s,h,o;if(typeof e!="undefined"&&e!=null&&_dict._ts.indexOf(e._type)!=-1){if(e._tickets&&e._tickets.length>=1)for(c=e._tickets.length,s=0;s<c;s++)e._tickets[s].seatLabel=e._label,i._printStageTickets.push(e._tickets[s]);h=e._coach+"_"+e._row+"_"+e._col;n!=null&&n.hasOwnProperty(h)?(o=n[h],typeof t[o[0]-1]=="undefined"&&(t[o[0]-1]=[]),typeof t[o[0]-1][o[1]-1]=="undefined"&&(t[o[0]-1][o[1]-1]=[]),t[o[0]-1][o[1]-1][o[2]-1]=e):(typeof t[r]=="undefined"&&(t[r]=[]),typeof t[r][u]=="undefined"&&(t[r][u]=[]),t[r][u][f]=e)}})})}),t},_responsiveDevice:function(){var n=this;n.adjustStyle($(window).width());$(window).resize(function(){n.adjustStyle($(window).width())})},adjustStyle:function(n){n=parseInt(n);n<=480?($(".vbooking-sheet .seat").removeClass("col-xs-6").addClass("col-xs-12"),$(".vbooking-csheet .seat").removeClass("col-xs-6").addClass("col-xs-12")):($(".vbooking-sheet .seat").removeClass("col-xs-12").addClass("col-xs-6"),$(".vbooking-csheet .seat").removeClass("col-xs-12").addClass("col-xs-6"))},_resetAll:function(n){var t=this,i;$._resetCopyInfo();vbf("onUnbindEventCopying");vbf("resetSeatStack");vbf("onResetMovingStack");vbf("onUnbindEventMoving");vbf("onClearSelectedItem");vbf("onCloseUpdateForm");vbf("onCloseCancelForm");vbf("onCloseQBook");vbf("onCloseErrorForm");vbf("onClearSuggestCustomer",{f:$("#UpdateForm")});app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1;t._closeHistoryLog();$._resetBookReturnInfo();vbf("onUnbindEventBookReturnTicket");i=function(){n!=undefined&&n.call()};t._reloadSheet(i)},_bindEventOnSeat:function(n,t){var i=this,r;i._hasBookingPermission()&&(r=t._getCurrentTicket(),!$.isEmptyObject(r)&&r._isCancelled()&&(vev(n,"mouseenter",function(){$(n).attr("data-original-title",r._cancelInfo).attr("data-toggle","tooltip").attr("data-placement","top").tooltip("show")}),vev(n,"mouseleave",function(){$(n).attr("data-original-title","").attr("data-toggle","").attr("data-placement","").tooltip("hide")})),vev(n,"click",function(r){var o,u,f,e;t.disableClickEvent||(r.preventDefault(),r.stopPropagation(),t._isAvailable()&&(t._hasTicket()?app.fMoving||(r.ctrlKey?(i._updateSeatStack(n,t),app.ctrlOn=!0):(o=app.seatStack.indexOf(t),o!=-1?i._removeFromSeatStack(n,t,o):(u=t._getCurrentTicket(),u._type==2?vbf("showErrorForm",{message:_dict._err[8]}):_dict._allowGroupByCode?(e=u._getTicketCode()?u._getTicketCode():"",app.selectedCode!=e&&(vbf("resetSeatStack"),vbf("onClearSelectedItem")),!vIsEstStr(e)||u._isNotCome()||u._isCancelled()?i._updateSeatStack(n,t):i._search(e,!0),app.selectedCode=e):(f=u._getDefaultPhoneNumber?u._getDefaultPhoneNumber():"",app.selectedPhone!=f&&(vbf("resetSeatStack"),vbf("onClearSelectedItem")),!vIsEstStr(f)||u._isNotCome()||u._isCancelled()?i._updateSeatStack(n,t):i._search(f),app.selectedPhone=f)),app.ctrlOn=!1)):app.fMoving&&app.allowMoving&&(vbf("onMovingTicket",{seat:t,tId:i._cTripId,tName:i._data[i._cTripIndex].Name,tDate:i._getDepartureTime(),tBus:i._cTripBus,tStage:i._cStageCode,fromId:vIsEstStr(i._cDefaultFromId)?i._cDefaultFromId:i._cFromId,toId:vIsEstStr(i._cDefaultToId)?i._cDefaultToId:i._cToId,stopPoints:i._data[i._cTripIndex].StopPoints}),app.allowMoving=!1)))}),$.each(n.find("button"),function(r,u){var f=$(u).attr("data-type");switch(f){case"book":vev(u,"click",function(n){n.preventDefault();n.stopPropagation();app.fMoving?vbf("showErrorForm",{message:_dict._err[3]}):(_dict._allowGroupByCode?app.selectedCode!=""&&(vbf("resetSeatStack"),i._clearSelectedItem(),app.selectedCode="",app.ctrlOn=!1):app.selectedPhone!=""&&(vbf("resetSeatStack"),i._clearSelectedItem(),app.selectedPhone="",app.ctrlOn=!1),oRq.cEl=$(this),oRq.cLType=1,oRq.cKey=t._label,oRq.cAType=2,oRq.iAc=!0,i._fakeBookedSeat(this,t),vbf("onBookTicket",{seat:t,tData:{cTripBus:i._cTripBus,cStageCode:i._cStageCode,cTripId:i._cTripId,cFromId:i._cFromId,cToId:i._cToId,cDefaultFromId:i._cDefaultFromId,cDefaultToId:i._cDefaultToId,cTripIndex:i._cTripIndex,data:i._data,cTripTime:i._cTripTime,cTripDate:i._cTripDate}}))});break;case"move":vev(u,"click",function(r){var u,f;app.hasCopyTicket?(r.preventDefault(),r.stopPropagation(),vbf("showErrorForm",{message:_dict._err[5]}),vbf("onClearSelectedItem")):app.hasBookReturnTicket?(r.preventDefault(),r.stopPropagation(),vbf("showErrorForm",{message:_dict._err[6]}),vbf("onClearSelectedItem")):(app.isBooking=!1,app.fMoving?$._isInMovingStack(t)||vbf("showErrorForm",{message:_dict._err[3]}):(r.preventDefault(),r.stopPropagation(),u=t._getCurrentTicket(),_dict._allowGroupByCode?(f=u._code==null?"":u._code,app.selectedCode==f||app.ctrlOn||(vbf("resetSeatStack"),vbf("onClearSelectedItem")),app.selectedCode=f):(app.selectedPhone==u._cphone||app.ctrlOn||(vbf("resetSeatStack"),vbf("onClearSelectedItem")),app.selectedPhone=u._cphone),app.seatStack.indexOf(t)==-1&&i._addToSeatStack(n,t),vbf("onMaskMovingTicket",{tId:i._cTripId,tName:i._data[i._cTripIndex].Name,tDate:i._getDepartureTime()})))});break;case"update":vev(u,"click",function(r){var u,e,f,o,s,h;r.preventDefault();r.stopPropagation();u=t._getCurrentTicket();_dict._allowGroupByCode?(e=u._code==null?"":u._code,app.selectedCode==e||app.ctrlOn||(vbf("resetSeatStack"),vbf("onClearSelectedItem")),app.selectedCode=e):(app.selectedPhone==u._cphone||app.ctrlOn||(vbf("resetSeatStack"),vbf("onClearSelectedItem")),app.selectedPhone=u._cphone);f=app.seatStack;o=[];f.indexOf(t)==-1&&i._addToSeatStack(n,t);$.each(f,function(n,t){var i=t._getCurrentTicket();$.isEmptyObject(i)||o.push(i._id)});s={_a:"fGetInfoTickets",ticketIds:o.join(",")};h=function(u,e){var o,s;u==1&&(o={},$.each(e[0],function(n,t){var r=i._createTicketFromRecord(t);!$.isEmptyObject(r)&&$.isEmptyObject(o[r._id])&&(o[r._id]=r)}),s=!1,$.each(f,function(n,t){var e=$("#bksContent").find('li.seat[data-position="'+t._coach+"_"+t._row+"_"+t._col+'"]'),r=e.find("div.paid, div.booking, div.pass"),u=t._getCurrentTicket(),f;if(u._status==3&&(s=!0),f=o[u._id],!$.isEmptyObject(f)&&(t._tickets=[],t._addTicket(o[u._id],i._cStageCode,u.stageCode),r.length==1))switch(f._status){case 2:r.removeClass();r.addClass("paid");break;case 5:r.removeClass();r.addClass("pass");break;case 1:vIsEstStr(f._code)?(r.removeClass(),r.addClass("fbooking").addClass("booking")):(r.removeClass(),r.addClass("booking"));break;case 3:s=!0}}),app.isBooking=!1,app.seatStack=f,app.fMoving?vbf("showErrorForm",{message:_dict._err[3]}):(r.preventDefault(),r.stopPropagation(),vbf("showUpdateForm",{self:i,obj:n,seat:t,blockEnterEvent:s})))};vRqs(s,h)});break;case"quick-pay":vev(u,"click",function(r){var f,u,e;r.preventDefault();r.stopPropagation();app.fMoving?vbf("showErrorForm",{message:_dict._err[3]}):(f=!1,u=[],app.hasCopyTicket?vbf("showErrorForm",{message:_dict._err[5]}):(app.seatStack.indexOf(t)==-1&&i._addToSeatStack(n,t),app.seatStack.length==0&&i._updateSeatStack(n,t),$.each(app.seatStack,function(n,t){var i=t._getCurrentTicket();$.isEmptyObject(i)||(u.push(i._status),i._fare==0&&(f=!0,vbf("showErrorForm",{message:_dict._err[7]})))}),u=u.getUnique(),e=!1,u.length>1&&(e=!0,vbf("showErrorForm",{message:_dict._err[9]})),f||e||vbf("onQuickPayTicket",{tId:i._cTripId,tName:i._data[i._cTripIndex].Name,tDate:i._getDepartureTime(),tBus:i._cTripBus,sOffsetMinute:i._sOffsetMinute})))});break;case"quick-book":vev(u,"click",function(r){var f,u,e;app.hasCopyTicket?vbf("showErrorForm",{message:_dict._err[5]}):(f=app.seatStack,i._reloadSheet(),app.isBooking=!1,app.seatStack=f,app.fMoving?$._isInMovingStack(t)?(r.preventDefault(),r.stopPropagation(),vbf("resetSeatStack",{},function(){$.each(app.movingStack,function(n,t){app.seatStack.push(t)});vbf("onResetMovingStack")}),vbf("onShowQBook",{tData:{cTripBus:i._cTripBus,cStageCode:i._cStageCode,cTripId:i._cTripId,cFromId:i._cFromId,cToId:i._cToId,cDefaultFromId:i._cDefaultFromId,cDefaultToId:i._cDefaultToId,cTripIndex:i._cTripIndex,data:i._data,cTripTime:i._cTripTime,cTripDate:i._cTripDate}})):vbf("showErrorForm",{message:_dict._err[3]}):(r.preventDefault(),r.stopPropagation(),u=t._getCurrentTicket(),_dict._allowGroupByCode?(e=u._code==null?"":u._code,app.selectedCode==e||app.ctrlOn||(vbf("resetSeatStack"),i._clearSelectedItem())):app.selectedPhone==u._cphone||app.ctrlOn||(vbf("resetSeatStack"),i._clearSelectedItem()),app.seatStack.indexOf(t)==-1&&i._addToSeatStack(n,t),vbf("onShowQBook",{tData:{cTripBus:i._cTripBus,cStageCode:i._cStageCode,cTripId:i._cTripId,cFromId:i._cFromId,cToId:i._cToId,cDefaultFromId:i._cDefaultFromId,cDefaultToId:i._cDefaultToId,cTripIndex:i._cTripIndex,data:i._data,cTripTime:i._cTripTime,cTripDate:i._cTripDate,tInfo:i._getCurrentTripInfo(),cTrip:i._data[i._cTripIndex],tName:i._data[i._cTripIndex].Name,tDate:i._getDepartureTime()}})))})}}))},_bindEventOnSheet:function(){var n=this;$(document).keyup(function(t){t.keyCode==27&&n._resetAll()});$("ul.vbooking-list a").click(function(t){t.preventDefault();$("ul.vbooking-list a").closest("li").removeClass("active");var i=$(this).attr("data-tab");$("ul.vbooking-list").closest("div.danhsach").find("button").html($(this).text()+'&nbsp;<span class="caret"><\/span>');$(this).tab("show");switch(i){case"bks":$("#bksContent").css("display","");$("#report").css("display","none");$("#product-content").css("display","none");break;case"vopen":n._reloadVO();break;case"vvalid":n._reloadVV();break;case"vcancelled":vbf("onShowVC",{td:{_cTripBus:n._cTripBus,_numCoach:n._numCoach}})}});vev("#FilterForm .btn-filter button.btn-ui","click",function(){$("#FilterForm .btn-filter button").removeClass("active");$("button.btn-thong-ke").removeClass("active");$(this).addClass("active");n._grid=$(this).hasClass("btn-grid")?!0:!1;n._isOrderring=!1;n._reloadSheet()})},_bindArrowEventList:function(n){var t,i=n.parent(),r=i.height(),u=i.prop("scrollHeight"),f=1,e=Math.round(u/r)-1;$(window).keydown(function(o){var s,c,h,l;o.which===40?(t?(n.removeClass("selected"),s=t.next(),t=s.length>0?s.addClass("selected"):n.eq(0).addClass("selected")):t=n.eq(0).addClass("selected"),t.position().top<0?(i.animate({scrollTop:0},500),f=1):t.position().top>r&&(c=Math.floor(r*f)-35,i.animate({scrollTop:c},500),f++)):o.which===38&&(t?(n.removeClass("selected"),h=t.prev(),t=h.length>0?h.addClass("selected"):n.last().addClass("selected")):t=n.last().addClass("selected"),t.position().top<=0?(l=Math.floor(u-r*e)+35,i.animate({scrollTop:l},500),e++):t.position().top>r&&(i.animate({scrollTop:u},500),e=Math.round(u/r)-1))})},_updateCPhoneSt:function(n,t){var r=this,i=t._getDefaultPhoneNumber();vIsEstStr(i)&&(typeof r._cphoneSt[i]=="undefined"&&(r._cphoneSt[i]=[]),r._cphoneSt[i].push(n))},_updateCCodeSt:function(n,t){var r=this,i=t._getTicketCode();vIsEstStr(i)&&(typeof r._cCodeSt[i]=="undefined"&&(r._cCodeSt[i]=[]),r._cCodeSt[i].push(n))},_getLimitedDateByUsers:function(){var n=this,t=new Date;return new Date(t.getTime()-_dict._limitedMinuteBeforeRole*6e4).addMinutes(n._sOffsetMinute)},_hasBookingPermissionByUsers:function(){var n=this,t=!0;return n._getDepartureTime().getTime()<n._getLimitedDateByUsers().getTime()&&app.rights.indexOf($.rights.hbookingbyDate.val)!=-1&&(t=!1),t},_getLimitedDate:function(){var n=this,t=new Date;return new Date(t.getTime()-_dict._limitedMinuteBefore*6e4).addMinutes(n._sOffsetMinute)},_hasBookingPermission:function(){var n=this,t=!0;return n._getDepartureTime().getTime()<n._getLimitedDate().getTime()&&app.rights.indexOf($.rights.bBookPastTk.val)==-1&&(t=n._rBookingOnPast),t},_bindEventMoving:function(){var n=this;n._$sheet.find("ul.vbooking-coach li.seat.selected").addClass("dotted-background");n._$sheet.find("ul.vbooking-coach li.seat div.available").unbind().on("mouseenter",function(){$(this).addClass("cursor-moving")})},_unbindEventMoving:function(){var n=this;n._$sheet.find("ul.vbooking-coach li.seat").removeClass("dotted-background");n._$sheet.find("ul.vbooking-coach li.seat div.available").removeClass("cursor-moving");n._$sheet.find("ul.vbooking-coach li.seat div.available").unbind("mouseenter")},_bindEventCopying:function(){var n=this;n._$sheet.find("ul.vbooking-coach li.seat div.available, ul.vbooking-coach li.seat div.booking").not("ul.vbooking-coach li.seat div.fbooking").unbind().on("mouseenter",function(){$(this).addClass("cursor-them-ve")});n._$sheet.find("ul.vbooking-coach li.seat div.paid, ul.vbooking-coach li.seat div.fbooking").closest("li.seat").unbind("click");n._$sheet.find("ul.vbooking-coach li.seat div.paid button, ul.vbooking-coach li.seat div.fbooking button").prop("disabled",!0)},_unbindEventCopying:function(){var n=this;n._$sheet.find("ul.vbooking-coach li.seat div.available, ul.vbooking-coach li.seat div.booking").removeClass("cursor-them-ve");n._$sheet.find("ul.vbooking-coach li.seat div.available, ul.vbooking-coach li.seat div.booking").unbind("mouseenter")},_bindEventBookReturnTicket:function(){var n=this,u=n._getCTripId(),t=n._$filterForm.find("select[name=TripId]"),i=n._$filterForm.find("input[name=DepartureDate]"),r=n._$filterForm.find("select[name=TimeSlot]");n._$sheet.find("ul.vbooking-coach li.seat div.available, ul.vbooking-coach li.seat div.booking").not("ul.vbooking-coach li.seat div.fbooking").unbind().on("mouseenter",function(){$(this).addClass("cursor-khu-hoi")});n._$sheet.find("ul.vbooking-coach li.seat div.paid button, ul.vbooking-coach li.seat div.fbooking button").prop("disabled",!0);u==app.cBookReturnTripId?(n._$sheet.find("ul.vbooking-coach li.seat").unbind("click"),n._$sheet.find("ul.vbooking-coach li.seat button").prop("disabled",!0),i.prop("disabled",!0),n._$filterForm.find(".glyphicon-calendar").parent().unbind("click"),r.prop("disabled",!0),app.hasBookReturnTicket&&(t.hasClass("book-return")||t.addClass("book-return"))):(n._$sheet.find("ul.vbooking-coach li.seat div.paid, ul.vbooking-coach li.seat div.fbooking").closest("li.seat").unbind("click"),n._$sheet.find("ul.vbooking-coach li.seat div.available button").prop("disabled",!1),t.removeClass("book-return"),i.prop("disabled",!1),r.prop("disabled",!1),n._bindEventOnCalendarIcon())},_unbindEventBookReturnTicket:function(){var n=this;n._$sheet.find("ul.vbooking-coach li.seat div.available").removeClass("cursor-khu-hoi");n._$sheet.find("ul.vbooking-coach li.seat div.available").unbind("mouseenter");n._$sheet.find("ul.vbooking-coach li.seat div.available button").prop("disabled",!1)},_showError:function(n){var t=this;t._$emodal.find(".message").html(n);t._showEModal()},backupBKS:function(n){var t=this,i=t._createBackUpBKSObj(),r=function(t,i,r){t!=1||r<=0||(window.location.href=i,n.removeAttr("disabled"))};t._submitAsyncAction(i,r)},_createBackUpBKSObj:function(){var t=this,i=new Date,n={};return n._a="bBackUpCustomerPerTrip",n._c={CompId:t.options.cid,UserId:t.options.uid,FromDate:i.toFormatString("iso")},n},_bindNumStageTicketsTooltips:function(){var n=this;$(".so-chang,.chang-di").unbind().hover(function(){$(this).closest(".seat").find(".chang-di").css("display","block")},function(){$(this).closest(".seat").find(".chang-di").css("display","none")});vev(".stage-ticket-context","click",function(){var t=$(this).attr("data-fromId"),i=$(this).attr("data-toId");n.selectStage(t,i)})},_cancelClosedStatus:function(){var n=this,r=n._data[n._cTripIndex].Ts[n._cTripTime][0].TripDetailId,t={},i;t._a="UpTrip";t._c={Id:r};t._d={ClosedStatus:0};i=function(t){t==1&&(n._data[n._cTripIndex].Ts[n._cTripTime][0].ClosedStatus=0,n._showXuatBenButton(),n._reloadSheet())};vRqs(t,i)},_closedTrip:function(){var n=this,r=n._data[n._cTripIndex].Ts[n._cTripTime][0].TripDetailId,i=n._getCurrentTripInfo(),t,u;if(typeof r=="undefined"){n._showPopModal("Chuyến chưa đặt vé, vui lòng kiểm tra lại.");return}if(typeof _dict._driverInfoRequired!="undefined"&&_dict._driverInfoRequired){if(typeof _dict._fieldDriverInfoRequired!="undefined"&&_dict._fieldDriverInfoRequired.indexOf("VehicleNumber")!=-1&&i._vehicleNumber==""){n._showPopModal("Vui lòng điền thông tin xe trước khi xuất bến.");return}if(typeof _dict._fieldDriverInfoRequired!="undefined"&&_dict._fieldDriverInfoRequired.indexOf("DriverName")!=-1&&i._driverName==""){n._showPopModal("Vui lòng điền thông tin tài trước khi xuất bến.");return}if(typeof _dict._fieldDriverInfoRequired!="undefined"&&_dict._fieldDriverInfoRequired.indexOf("AssistantName")!=-1&&i._assistantName==""){n._showPopModal("Vui lòng điền thông tin phục vụ trước khi xuất bến.");return}}t={};t._a="UpTrip";t._c={Id:r};t._d={ClosedStatus:1};u=function(t){t==1&&(n._data[n._cTripIndex].Ts[n._cTripTime][0].ClosedStatus=1,n._showHuyXuatBenButton(),n._reloadSheet())};n._submitAction(t,u)}});
//# sourceMappingURL=p.min.js.map
