define({start:function(n){var i=this,t;n.m&&$.extend(_dict,_dict,n.m);i._createUpdateDialogDiv();t=$(n._e);vev("body","doShowUpdateForm",function(n){var f;if(n.d)try{i._mapInfo(t);var r=n.d.self,o=n.d.seat,s=r._cTripId,u=r._cTripIndex,p=r._data[u].Name,w=r._getDepartureTime(),e=r._cTripTime,h=r._cTripBus,b=r._cStageCode,l=r._data[u].Ts[e][h].TripDetailId,c=app.seatStack,a=r._data[u].Ts[e][0].ClosedStatus,k=r._data[u].Ts[e][h].F,d=r._data[u].StopPoints,v=r._sOffsetMinute,g=r._cDefaultFromId,nt=r._cDefaultToId,tt=r._data[u],it=r._getLimitedDate(),rt=r._data[u].PickedPointsInfo,ut=r._data[u].TransferPointsInfo,ft=r._getCurrentTripInfo(),et=r._data[u].StopPoints.data,y=!1;n.d.blockEnterEvent!=undefined&&n.d.blockEnterEvent&&(y=!0);f=i._initUpdateFormData(t,o,c,l,v,et,s);f&&(app.fromRouteId=0,app.toRouteId=0,i._resetForm(t),t.find("div.message-error").html(""),t.find("div.message-error").hide(),i._populateFormData(f,t),i._renderSeatNoDiv(f.SeatNo,t),i._createRoutePoints(t,f.RoutePoints,f.FromArea,f.ToArea,g,nt,e,k),i._resetForm(t.find("#ValidForm")),vbf("renderHistoryUpdateForm",{seat:o}),i._disableFormFields(t,o,c,a,s),i._bindEventOnUpdateForm(t,c,s,p,w,h,b,d,v,tt,l,it,a,rt,ut,e,ft,y),t.modal("show"),i._triggerUpdateTab(t),i._triggerUpdateForm(t))}catch(ot){vbf("showErrorForm",{message:ot})}else console.log("Show update form fail 2.....")});vev("body","doCloseUpdateForm",function(){i._closeUpdateDialog(t)})},_createUpdateDialogDiv:function(){var n=this,t,i,r,u;vRqs({_a:"fGetArea",_c:{BaseId:n._createBaseIdQueryCondition(app.cid),Type:"( $x=5 or $x=3 )",IsPrgStatus:1},_f:"Id, Type, Code, Name"},function(t,i,r){if(t==1&&!(r<=0)){n._listArea=[];var u=$('select[name="FromStop"]'),f=$('select[name="ToStop"]');$.each(i,function(t,i){n._listArea.push(i);u.append($("<option />").val(i[0]).append(i[3]));f.append($("<option />").val(i[0]).append(i[3]))});u.trigger("chosen:updated");f.trigger("chosen:updated")}});t=$._createForm(_dict._uForm[0],_dict._uForm[1],_dict._uForm[2]);t.find("div.alert.alert-danger.message-error").after($('<div class="row" />').css("margin-top","0").append($('<div class="col-md-12 checkbox-route-point" />')));t.find(".row").last().addClass("action-row").children().first().addClass("list-btn col-xs-12 col-sm-12");n._$validForm=$._createForm(_dict._vForm[0],_dict._vForm[1],_dict._vForm[2]);n._$validForm.find(".row").last().addClass("action-row").children().first().addClass("list-btn");i=$("<div />").addClass("modal-body").css("padding-top",0).append($("<div />").addClass("container-fluid").append($("<div />").addClass("row").append($("<div />").addClass("col-md-1 col-sm-1 col-xs-1").css("padding-right",0).addClass("responsive-xs-l").append($("<ul />").addClass("list-group").attr("id","seat-no"))).append($("<div />").addClass("col-md-11 col-sm-11 col-xs-11 pl0-xs mt10-xs").addClass("responsive-xs-r").append($("<ul />").addClass("nav nav-tabs").attr("role","tab-list").append($("<li />").addClass("active").append($("<a />").attr("href","#general").attr("role","tab").attr("data-toggle","tab").attr("data-tab","general").text("Thông tin chung"))).append($("<li />").append($("<a />").attr("href","#valid").attr("role","tab").attr("data-toggle","tab").attr("data-tab","valid").text("Vé mở"))).append($("<li />").append($("<a />").attr("href","#history").attr("role","tab").attr("data-toggle","tab").attr("data-tab","history").text("Lịch sử")))).append($("<div />").addClass("tab-content").append($("<div />").addClass("tab-pane fade in active").attr("id","general").append(t)).append($("<div />").addClass("tab-pane fade").attr("id","valid").append(n._$validForm)).append($("<div />").addClass("tab-pane fade").attr("id","history"))))));n._$modal=$("<div />").addClass("modal fade").attr("id","update-popup").attr("role","dialog").attr("aria-hidden","true").append($("<div />").addClass("modal-dialog modal-md").append($("<div />").addClass("modal-content").append($("<div />").addClass("modal-header bg-primary").css("padding-top","10px").css("padding-bottom","10px").append($("<h3 />").addClass("modal-title thin-1").html("Cập nhật thông tin").css("font-size","18px"))).append(i))).appendTo($("body"));r=$('select[name="FromStop"]').chosen({on:!0,width:"100%"});this._initInputForChosenBox(r);u=$('select[name="ToStop"]').chosen({on:!0,width:"100%"});this._initInputForChosenBox(u);vbf("onUpdateFormCreated")},_renderDataForSelectBox:function(n,t){var h=this,i=t._getCurrentTicket(),r=n.find('select[name="FromStop"]'),u=n.find('select[name="ToStop"]');if(i._fromStop!=null&&i._toStop!=null){var f=i._fromStop.split("~"),e=i._toStop.split("~"),o=f[1].split("|")[0],s=e[1].split("|")[0];setTimeout(function(){r.val(o);r.trigger("chosen:updated");u.val(s);u.trigger("chosen:updated")},1)}else setTimeout(function(){r.val("");r.trigger("chosen:updated");u.val("");u.trigger("chosen:updated")},1)},_initInputForChosenBox:function(n){var u=this,t,r,i;t=n.parent().find("div.chosen-container");drop=t.find("div.chosen-drop");r=n.attr("name")=="FromStop"?" đi":" đến";drop.append($("<div />").addClass("chosen-save-button-"+n.attr("name")).attr("style","text-align:center").append($("<button />").attr("type","button").addClass("btn").addClass("btn-success").addClass("hidden2").addClass("save-new-area").addClass("btn-sm").append(" Lưu mới")));i=drop.find("div.chosen-save-button-"+n.attr("name")+" button.save-new-area");i.bind("click",function(){var f=t.find("input").val(),i={};i._a="InsertArea";i._c={};i._d={Type:5,CompId:app.cid,Name:f};vRqs(i,function(t,i,e){if(t==1&&e>=1){var o=$("<option>").val(i[0][0]).text(f);u._listArea.push([i[0][0],5,"",f]);n.find('option[value=""]').remove();n.prepend(o);n.find(o).prop("selected",!0);n.prepend($("<option />").val("").text("Chọn điểm"+r));n.trigger("chosen:updated")}})});t.find("input").keyup(function(f){if(t.find("li.no-results").length>0){if(i.removeClass("hidden2"),f.which==13){var o=t.find("input").val(),e={};e._a="InsertArea";e._c={};e._d={Type:5,CompId:app.cid,Name:o};vRqs(e,function(t,i,f){if(t==1&&f>=1){var e=$("<option>").val(i[0][0]).text(o);u._listArea.push([i[0][0],5,"",o]);n.find('option[value=""]').remove();n.prepend(e);n.find(e).prop("selected",!0);n.prepend($("<option />").val("").text("Chọn điểm"+r));n.trigger("chosen:updated")}})}}else i.addClass("hidden2")})},_createBaseIdQueryCondition:function(){var n="(";return $.each(_dict._fromToBaseId,function(t,i){n=t!=_dict._fromToBaseId.length-1?n+"$x="+i+" or Id="+i+" or ":n+"$x="+i+" or Id="+i}),n=n+")"},_listArea:[],_createGetAreaObj:function(){var n=this},_mapInfo:function(n){var t=this,i=t._createGetInfoObj(),r=function(t,i,r){var f,e,u,o;t!=1||r<=0||(app.branchInfo=i,f=[],e=[],$.each(i,function(n,t){var i={value:t[0],text:$.trim(t[3])};t[1]==2?f.push(i):t[1]==3&&e.push(i)}),f.sort(function(n,t){return n.text.localeCompare(t.text)}),e.sort(function(n,t){return n.text.localeCompare(t.text)}),$.each(f,function(t,i){n.find("select[name=BranchName]").append($("<option />",{value:i.value}).text(i.text))}),u=n.find("select[name=AgentName]"),o=u.find("option:first-child"),u.empty(),u.append(o),$.each(e,function(n,t){u.append($("<option />",{value:t.value}).text(t.text))}),n.find("select[name=AgentName]").chosen({width:"100%",search_contains:!0}))};vdc.gCompany(i._c,"#",!1,null,r)},_createGetInfoObj:function(){var n={};return n._a="fGetCompany",n._c={BaseId:app.cid,Type:"($x = 2 OR $x = 3)",IsPrgStatus:1},n._f="Id, Type, Code, Name, AddressInfo, PhoneInfo",n},_updateTicket:function(n,t,i,r,u,f,e,o,s){var c=this,h=c._createUpdateTicketObj(n,t,i,r,u,e,s),l;h&&(h._d||(h._d=[{}]),l=function(t,i,u,s){var nt,p,w,l,d,g,a,v,tt;if(t!=1){c._closeUpdateDialog(n);return}if(nt=app.seatStack,typeof o!="undefined"&&typeof o=="function"?(app.seatToBeUpdatedReturningInfo=app.seatStack,$.each(app.seatStack,function(n,t){var i=t._getCurrentTicket();i.fromArea=h._d[0].FromArea;i.toArea=h._d[0].ToArea}),o.call(this,h._d[0].Code,h._d[0].FromArea,h._d[0].ToArea)):(p=[],$.each(app.seatStack,function(n,t){p.push(t._label)}),app.dataToBeSavedReturningInfo.code=s,app.seatToBeUpdatedReturningInfo.length>0&&vbf("onUpdateInfoOfReturnTickets"),c._closeUpdateDialog(n),vbf("onStoreHistory",{un:app.un,key:"update",his:{_tid:r,_tname:f,_tdate:e,_s:p}}),vbf("resetSeatStack"),vbf("reloadBookingSheet")),w=!1,l=h._d[0],$.isEmptyObject(l)||l.HasSendSms!="YES"||(w=!0),_dict._autoSendSmsUpdate!=undefined&&_dict._autoSendSmsUpdate&&w){var b=[],k=[],y=0;$.isEmptyObject(l)||(y=l.Status,d=l.CustomerInfo.split("|"),g=d[d.length-1],vIsEstStr(g)&&b.push(g));$.each(nt,function(n,t){k.push(t._label)});a="";v={_tripName:f,_tripDate:e.toFormatString("HH:mm-dd.mm.yyyy"),_nOfSeat:k.length,_seatCodes:k.join(","),_status:y==2||y==5?"Da thanh toan":"Chua thanh toan"};switch(parseInt(y)){case 1:a=vtpl(_dict._smsUpdateTpl,v);break;case 2:a=vtpl(_dict._smsUpdateTpl,v);break;case 3:a=vtpl(_dict._smsCancelTpl,v);break;case 5:a=vtpl(_dict._smsUpdateTpl,v)}b.length>0&&(tt={_a:"sendMobifoneSms",_c:{},_d:{phones:b.join(","),message:a}},vRqs(tt))}},vRqs(h,l))},_createUpdateTicketObj:function(n,t,i,r,u,f,e){var c=this,o=$._convertFormDataToObj(n),b=o.StatusInfo.split(","),k=o.CustomerInfo.split(","),h={},l,a,s;if(h._a="UpdateBookTicket",h._c=[],h._d=[],l=null,vIsEstStr(o.PaymentType)){a="";s="";$.each(_dict._pm,function(n,t){""==a&&t[0]==o.PaymentType&&(a=t[1].vi)});switch(parseInt(o.PaymentType)){case 1:s=typeof _dict._hasSelectBranchPayment!="undefined"&&_dict._hasSelectBranchPayment?$._getBranchInfo(o.BranchName):$._getBranchInfo(app.aid);break;case 2:s=o.ChargeCode;break;case 3:s=o.PayAddress;break;case 4:s=c._getTeamInfo();break;case 5:s=o.TransCode;break;case 6:s=$._getBranchInfo(o.AgentName);break;case 10:s=$._getBranchInfo(o.BranchName)}l=$._getPayment(o.PaymentType,a,s)}var v=null,y=null,d=n.find('select[name="FromStop"]'),g=n.find('select[name="ToStop"]');if(d.length>0&&g.length>0){var p=[1],w=[1],nt=n.find('select[name="FromStop"]').find(":selected").val(),tt=n.find('select[name="ToStop"]').find(":selected").val();$.each(c._listArea,function(n,t){var i,r;nt==t[0]&&(i=[],$.each(t,function(n,t){i.push(t)}),p.push(i.join("|")));tt==t[0]&&(r=[],$.each(t,function(n,t){r.push(t)}),w.push(r.join("|")))});v=p.join("~");y=w.join("~")}return $.each(app.seatStack,function(s,a){var w=a._getCurrentTicket(),et=b[s],ot=k[s],nt=moment(w._dept),st=moment(w._pdate),p,d,ut,ht,g,ft;if(st.add(u,"m"),p={TripAlias:parseInt(i),Status:et,CustomerInfo:ot,FromArea:lt,ToArea:at},vIsEstStr(v)&&v!="1"&&(p.FromStop=v),vIsEstStr(y)&&y!="1"&&(p.ToStop=y),_dict._autoCancelTickets!=undefined&&_dict._autoCancelTickets&&(_dict._bookedTicketStatus!=undefined&&app.status==_dict._bookedTicketStatus&&(d=moment(f),app.seatStack.length<=2?(ut=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+_dict._cancelledTime,nt.isAfter(ut)?d=moment(ut).add(_dict._eslapsedTime[1],"m"):d.add(_dict._eslapsedTime[2],"m")):app.seatStack.length>2&&app.seatStack.length<=5?d.add(_dict._eslapsedTime[3],"m"):app.seatStack.length>5&&app.seatStack.length<=9?d.add(_dict._eslapsedTime[4],"m"):app.seatStack.length>9&&d.add(_dict._eslapsedTime[5],"m")),p.ExpiredTime=d.format("YYYY-MM-DD HH:mm")),nt=nt.format("YYYY-MM-DD HH:mm"),h._c.push({Id:w._id,TripId:r,SeatCode:a._getSeatInfo(),TripDate:nt,Bus:i}),app.dataToBeSavedReturningInfo.code=a._getSeatInfo(),app.dataToBeSavedReturningInfo.date=st.format("YYYY-MM-DD HH:mm"),ht=app.un,vIsEstStr(w._firstUserUpdated)||(p.FirstUserUpdated=ht),w._isBooking()){var tt=0,it=0,ct=n.find('input[name="RoutePoint"][checked="checked"]');app.fromRouteId==0?(tt=ct.first().attr("data-point-id"),app.fromRouteId=tt):tt=app.fromRouteId;g=t.data[t.idx[tt]];app.toRouteId==0?(it=ct.last().attr("data-point-id"),app.toRouteId=it):it=app.toRouteId;var rt=t.data[t.idx[it]],lt="1~"+g.Id+"|"+g.Type+"|"+g.Code+"|"+g.Name,at="1~"+rt.Id+"|"+rt.Type+"|"+rt.Code+"|"+rt.Name;p.FromArea=lt;p.ToArea=at}if(vIsEstStr(w._code)?p.Code=w._code:typeof o.Code!="undefined"&&vIsEstStr(o.Code)&&(p.Code=o.Code),o.PhoneNumbers!=undefined||o.FullName!=undefined){var vt=ot.split("|"),yt=o.PhoneNumbers!=undefined?o.PhoneNumbers.trim():vt[4],pt=o.FullName!=undefined?o.FullName:vt[3];p.CustomerInfo=c._getCustomer(o.CustomerId,pt,yt)}typeof o.Debt!="undefined"&&(p.Debt=et==1?o.Debt.toNum()/app.seatStack.length:0);(typeof o.PickupInfo!="undefined"||typeof o.TransferInfo!="undefined")&&(o.pIndex==""&&(vIsEstStr(o.PickupInfo)||vIsEstStr(o.TransferInfo))&&(o.pIndex=0),p.PickupInfo=c._getPickupInfo(o.PickupInfo,o.TransferInfo,o.pIndex));typeof o.PaymentType!="undefined"&&vIsEstStr(l)&&(w._isBooking()?p.UserCharge=app.un:p.ChargeDate=w._chargeDate,p.PaymentInfo=l);typeof o.Note!="undefined"&&(p.Note=o.Note);typeof o.Fare!="undefined"&&(p.Fare=o.Fare.toNum());typeof o.Surcharge!="undefined"&&(p.Surcharge=o.Surcharge.toNum());typeof o.Deposit!="undefined"&&(p.Deposit=o.Deposit.toNum());typeof o.Discount!="undefined"&&(p.Discount=o.Discount.toNum());typeof o.Serial!="undefined"&&(p.Serial=o.Serial);typeof o.RoundTripCode!="undefined"&&(p.RoundTripCode=o.RoundTripCode);typeof o.SNote!="undefined"&&(p.SNote=o.SNote);typeof o.ResponsibilityUser!="undefined"&&(p.ResponsibilityUser=o.ResponsibilityUser);typeof o.PickOrReturnDate!="undefined"&&(p.PickOrReturnDate=o.PickOrReturnDate);ft=n.find("input[type='checkbox'][name='HasSendSms']");p.HasSendSms=ft.length>0&&ft.is(":checked")?"YES":"NO";e!=null&&e&&(p.IssuedUser=app.un,p.PrintStatus=0,p.NumOfPrint=w._numOfPrint?w._numOfPrint+1:1);h._d.push(p)}),h},_createUnblockObj:function(n,t,i,r){var o=this,f=n.find('input[type="hidden"][name="StatusInfo"]'),e=f.val(),u={};return u._a="UpdateBookTicket",u._c=[],u._d=[],$.each(app.seatStack,function(n,f){var o=f._getCurrentTicket(),c=e[n],h=moment(o._pdate),l=moment(o._dept),s;h.add(r,"m");s={PrintStatus:1};u._c.push({Id:o._id,Status:c,TripId:i,SeatCode:f._getSeatInfo(),PickupDate:h.format("YYYY-MM-DD HH:mm"),Bus:t});app.dataToBeSavedReturningInfo.code=f._getSeatInfo();app.dataToBeSavedReturningInfo.date=h.format("YYYY-MM-DD HH:mm");vIsEstStr(o._code)&&(s.Code=o._code);vIsEstStr(o._pmInfo)&&(s.PaymentInfo=o._pmInfo);u._d.push(s)}),u},_validateUpdateForm:function(n,t){var r=!1,i=n.find("div.message-error"),e=n.find("select[name=PaymentType]"),v=n.find("select[name=AgentName]"),u=n.find("input:text[name=PhoneNumbers]"),h=n.find("textarea[name=Note]"),k=n.find("input[name=PickupInfo]"),d=n.find("input[name=TransferInfo]"),o=n.find("input[name=Fare]"),a=n.find("div.checkbox-route-point"),b=n.find("input[name=ToTalFare]"),f=null,c=n.find('select[name="FromStop"]'),l=n.find('select[name="ToStop"]'),y,s,p,w;if(_dict._reqFieldUpdateForm!=undefined&&$.each(_dict._reqFieldUpdateForm,function(n,t){switch(t){case"PhoneNumbers":if(vIsEstStr(u.val())||vIsEstStr(h.val())||vIsEstStr(e.val()))u.closest("div.col-md-6").removeClass("has-error");else return r=!0,u.closest("div.col-md-6").addClass("has-error"),i.html("Vui lòng nhập số điện thoại !"),i.show(),!1}}),!r){if(_dict._isValidateFromToStop){if(c.length>0)if(vIsEstStr(c.val()))c.closest("div.col-md-6").removeClass("has-error");else return r=!0,c.closest("div.col-md-6").addClass("has-error"),i.html("Vui lòng chọn điểm đi !"),i.show(),!1;if(l.length>0)if(vIsEstStr(l.val()))l.closest("div.col-md-6").removeClass("has-error");else return r=!0,l.closest("div.col-md-6").addClass("has-error"),i.html("Vui lòng chọn điểm đến !"),i.show(),!1}if(vIsEstStr(u.val())&&!r)if(vIsPhone(u.val()))i.html(""),i.hide();else return r=!0,u.closest("div.col-md-6").addClass("has-error"),i.html("Số điện thoại không chính xác, vui lòng kiểm tra lại."),i.show(),!1;else if(vIsEstStr(h.val())&&vIsEstStr(u.val()))if(vIsPhone(u.val()))i.html(""),i.hide();else return r=!0,u.closest("div.col-md-6").addClass("has-error"),i.html("Số điện thoại không chính xác, vui lòng kiểm tra lại."),i.show(),!1;if(vIsEstStr(e.val())&&_dict._validUpdateForm!=undefined&&parseInt(e.val())!=9){if(_dict._validUpdateForm.indexOf(">=")!=-1){if(f=parseInt(_dict._validUpdateForm.substring(_dict._validUpdateForm.indexOf(">=")+1,_dict._validUpdateForm.length)),!parseInt(o.val())>=f)return r=!0,o.closest("div.col-md-6").addClass("has-error"),i.html("Giá vé phải lớn hơn hoặc bằng "+f+"."),i.show(),!1;i.html("");i.hide()}else if(_dict._validUpdateForm.indexOf(">")!=-1){if(f=parseInt(_dict._validUpdateForm.substring(_dict._validUpdateForm.indexOf(">")+1,_dict._validUpdateForm.length)),!parseInt(o.val())>f)return r=!0,o.closest("div.col-md-6").addClass("has-error"),i.html("Giá vé phải lớn hơn "+f+"."),i.show(),!1;if(y=b.val().toNum()/app.seatStack.length,s="",$.each(app.seatStack,function(n,t){var i=t._getCurrentTicket();y<o.val().toNum()&&i._fare==0&&(s+=t._label+", ")}),s!="")return p="Ghế "+s.substring(0,s.length-2)+": Giá vé phải lớn hơn 0.",r=!0,i.html(p),i.show(),!1;i.html("");i.hide()}else if(_dict._validUpdateForm.indexOf("=")!=-1){if(f=parseInt(_dict._validUpdateForm.substring(_dict._validUpdateForm.indexOf("=")+1,_dict._validUpdateForm.length)),!parseInt(o.val())==f)return r=!0,o.closest("div.col-md-6").addClass("has-error"),i.html("Giá vé bằng "+f+"."),i.show(),!1;i.html("");i.hide()}if(parseInt(e.val())==6&&!vIsEstStr(v.val()))return r=!0,v.closest("div.col-md-6").addClass("has-error"),i.html("Vui lòng chọn đại lý thanh toán."),i.show(),!1}if(t!=undefined&&t&&!vIsEstStr(e.val()))return r=!0,e.closest("div.col-md-6").addClass("has-error"),i.html("Vui lòng chọn hình thức thanh toán !"),i.show(),!1;if(e.closest("div.col-md-6").removeClass("has-error"),i.html(""),i.hide(),a.length>0&&a.is(":visible")&&(w=a.find('input[name="RoutePoint"][checked="checked"]'),w.length!=2))return r=!0,i.html("Điểm đi, điểm đến không chính xác. Vui lòng kiểm tra lại."),i.show(),!1;app.hasCopyTicket&&_dict._copyFieldRequired!=undefined&&$.each(_dict._copyFieldRequired,function(n,t){switch(t){case"PhoneNumbers":if(!vIsEstStr(u.val()))return r=!0,u.closest("div.col-md-6").addClass("has-error"),!1;break;case"Note":if(!vIsEstStr(h.val()))return r=!0,h.closest("div.col-md-6").addClass("has-error"),!1}});app.hasBookReturnTicket&&_dict._returnFieldRequired!=undefined&&$.each(_dict._returnFieldRequired,function(n,t){switch(t){case"PhoneNumbers":if(!vIsEstStr(u.val()))return r=!0,u.closest("div.col-md-6").addClass("has-error"),!1}})}return!r},_validateUpdateForm2:function(n){var r=n.find("div.message-error"),s=n.find("select[name=PaymentType]"),a=n.find("select[name=AgentName]"),o=n.find("input:text[name=PhoneNumbers]"),h=n.find("textarea[name=Note]"),v=n.find("input[name=PickupInfo]"),y=n.find("input[name=TransferInfo]"),p=n.find("input[name=Fare]"),c=n.find("div.checkbox-route-point"),i={payment:parseInt(s.val()),agent:a.val(),phone:o.val(),note:h.val(),pickup:v.val(),transfer:y.val(),fare:vToNum(p.val())},e=!1,w=!1,u="",l=function(n){var r=!1,t;try{t=i[n];n.indexOf("[")>=0?isNaN(s.val())||t==9||(t=parseInt(i[n.substring(0,n.indexOf("["))]),n.indexOf("[>=")>=0?r=t>=parseInt(n.substring(n.indexOf("[>=")+3).replace("]","")):n.indexOf("[<=")>=0?r=t<=parseInt(n.substring(n.indexOf("[<=")+3).replace("]","")):n.indexOf("[=")>=0?r=t==parseInt(n.substring(n.indexOf("[=")+2).replace("]","")):n.indexOf("[>")>=0?r=t>parseInt(n.substring(n.indexOf("[>")+2).replace("]","")):n.indexOf("[<")>=0&&(r=t<parseInt(n.substring(n.indexOf("[<")+2).replace("]","")))):r=vIsEstStr(t)}catch(u){}return r},k=function(){var f,s,t,o,n,h,r;if(_dict._updateFormValidatingConditions!="undefined")for(f=0;f<_dict._updateFormValidatingConditions.length;f++)for(s=_dict._updateFormValidatingConditions[f].split("&"),t=!0,o=0;o<s.length;o++){if(n=s[o],n=="phone"?t=t&&vIsPhone(i.phone):n.indexOf("!")==0?(h=n.replace("!","").split("->"),t=l(h[0])?t&&l(h[1]):t&&!0):t=t&&l(n),t||u!=""||(u=n,n.indexOf("!")>=0?(r=n.split("->"),u=r[1].indexOf("[")>0?r[1].substring(0,r[1].indexOf("[")):r[1]):n.indexOf("[")>=0&&(u=n.substring(0,n.indexOf("[")))),vIsEstStr(i.phone)&&!vIsPhone(i.phone)){e=!1;break}if(e=e||t,e)return!0}return!1},t,f,b;if(w=k(),w)r.html(""),r.hide();else{switch(u){case"payment":t=s;break;case"agent":t=a;break;case"phone":t=o;break;case"note":t=h;break;case"pickup":t=v;break;case"transfer":t=y;break;case"fare":t=p}_dict._updateFormValidatingErrorMessages!=null&&_dict._updateFormValidatingErrorMessages[u]!=null?r.html(_dict._updateFormValidatingErrorMessages[u]):r.html(_dict._updateFormValidatingErrorMessage);r.show();t!=null&&(t.closest("div.col-md-6").addClass("has-error"),t.focus())}return f=!1,c.length>0&&c.is(":visible")&&(b=c.find('input[name="RoutePoint"][checked="checked"]'),b.length!=2&&(f=!0,r.html("Điểm đi, điểm đến không chính xác. Vui lòng kiểm tra lại."),r.show())),app.hasCopyTicket&&_dict._copyFieldRequired!=undefined&&$.each(_dict._copyFieldRequired,function(n,t){switch(t){case"PhoneNumbers":if(!vIsEstStr(i.phone)){f=!0;o.closest("div.col-md-6").addClass("has-error");break}case"Note":if(!vIsEstStr(i.note)){f=!0;h.closest("div.col-md-6").addClass("has-error");break}}}),app.hasBookReturnTicket&&_dict._returnFieldRequired!=undefined&&$.each(_dict._returnFieldRequired,function(n,t){switch(t){case"PhoneNumbers":if(!vIsEstStr(i.phone)){f=!0;o.closest("div.col-md-6").addClass("has-error");break}}}),e&&!f},_bindEventOnUpdateForm:function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b){var k=this;n.find("input[name=TransferInfo]").not(":disabled").blur(function(){n.find("div.search-result.search-location").remove()});n.find("input[name=TransferInfo]").not(":disabled").keyup(function(t){if(t.keyCode==13||t.keyCode==9){var i=n.find("div.search-result tr.location-selected");i.length>0&&(n.find("input[name=TransferInfo]").val(i.attr("data-name")),n.find("input[name=pIndex]").val(i.attr("data-order")));n.find("div.search-result").remove()}else t.keyCode==40||t.keyCode==38?vbf("onNavigateSuggestTransfer",{keyCode:t.keyCode}):vbf("onGetSuggestTransfer",{f:n,ltp:y,tTime:p,key:this.value})});n.find("input[name=PickupInfo]").not(":disabled").blur(function(){n.find("div.search-result.search-location").remove()});n.find("input[name=PickupInfo]").not(":disabled").keyup(function(t){if(t.keyCode==13||t.keyCode==9){var i=n.find("div.search-result tr.location-selected");i.length>0&&(n.find("input[name=PickupInfo]").val(i.attr("data-name")),n.find("input[name=pIndex]").val(i.attr("data-order")));$("div.search-result").remove()}else t.keyCode==40||t.keyCode==38?vbf("onNavigateSuggestPickup",{keyCode:t.keyCode}):vbf("onGetSuggestPickup",{f:n,lpp:v,tTime:p,key:this.value})});n.find("input[name=PhoneNumbers]").not(":disabled").unbind("keyup").keyup(function(t){if(t.keyCode==13){t.preventDefault();t.stopPropagation();var u=n.find("div.upform-search-result-phone ul.search-items li.selected"),f=u.attr("cid"),e=u.attr("cphone"),o=u.attr("cname");f&&n.find("input[name=CustomerId]").val(u.attr("cid"));e&&n.find("input:text[name=PhoneNumbers]").val(u.attr("cphone"));o&&n.find("input[name=FullName]").val(u.attr("cname"));_dict._hasBTWarning&&f&&vbf("doGetWarningCustomer",{f:n,cName:u.attr("cname"),cPhone:u.attr("cphone"),cId:u.attr("cid"),lmDate:l,tId:i,tName:r});vbf("onClearSuggestCustomer",{f:n});return}vIsNumKey(t)?this.value.length>=6&&this.value.length<=11?(t.preventDefault(),t.stopPropagation(),vbf("onGetSuggestCustomer",{f:n,key:this.value,lmDate:l,tId:i,tName:r})):(t.preventDefault(),t.stopPropagation(),vbf("onClearSuggestCustomer",{f:n})):_dict._arrows.indexOf(t.keyCode)==-1?(t.preventDefault(),t.stopPropagation(),vbf("onClearSuggestCustomer",{f:n})):t.keyCode==27&&(t.preventDefault(),t.stopPropagation(),vbf("onClearSuggestCustomer",{f:n}))});n.find("input[name=PhoneNumbers]").not(":disabled").bind("paste",function(t){this.value=t.originalEvent.clipboardData.getData("Text");isNaN(this.value)||this.value.length!=10&&this.value.length!=11?(t.preventDefault(),t.stopPropagation(),vbf("onClearSuggestCustomer",{f:n})):(t.preventDefault(),t.stopPropagation(),vbf("onGetSuggestCustomer",{f:n,key:this.value,lmDate:l,tId:i,tName:r}));n.find("input[name=PhoneNumbers]").not(":disabled").blur()});n.find("input[type=text]").not("[readonly]").unbind("keypress",function(t){var e=n.find("div.upform-search-result-phone"),h=n.find("div.search-result.search-location");if(e.length==0&&h.length==0&&t.keyCode==13&&!b){if(t.preventDefault(),t.stopPropagation(),$(this).prop("name")=="Fare")return;if(!k._validateUpdateForm(n))return;if(a!=null&&a==1)return;k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u);$._resetBookReturnInfo()}}).on("focus",function(){});n.find("input[name=Code]").parent().find(".input-group-addon").attr("title","Copy to clipboard").clipboard({path:"Base/jquery-clipboard-1.3.2/jquery.clipboard.swf",copy:function(){return console.log("Copy code to clipboard"),n.find("input[name=Code]").val()}});n.find("select[name=PaymentType]").unbind("change").on("change",function(){var i=$(this).closest(".row"),t;i.find(".mpayment").parent().hide();i.find(".mpayment").parent().prev().hide();this.value&&(t=i.find(".mpayment[data-type="+this.value+"]"),this.value==1||this.value==4?typeof _dict._hasSelectBranchPayment!="undefined"&&_dict._hasSelectBranchPayment&&t.length>0&&(t.parent().show(),t.parent().prev().show()):t.length>0&&(t.parent().show(),t.parent().prev().show(),this.value==6&&(t.parent().find("a.chosen-single").css("border-color","#aaa"),n.find("select[name=PaymentType]").attr("disabled")||t.parent().find("select[name=AgentName]").children().each(function(n){n==0?$(this).attr("selected",!0):$(this).attr("selected",!1)}),t.parent().find("select[name=AgentName]").trigger("chosen:updated"))))});n.find("input[name=Fare]").not(["readonly"]).unbind("change").on("change",function(){var r=parseInt(n.find("input[name=NumSeat]").val()),u=0,f=0,e=0,t,i,o;n.find("input[name=Deposit]").length>0&&(u=n.find("input[name=Deposit]").val().toNum());n.find("input[name=Discount]").length>0&&(f=n.find("input[name=Discount]").val().toNum());n.find("input[name=Surcharge]").length>0&&(e=n.find("input[name=Surcharge]").val().toNum());t=$(this).val().toNum();t<1e4&&(t=t*1e3);i=(t+e-f)*r;$(this).val(t.toMn());o=i-u*r;n.find("input[name=Debt]").val(o.toMn());n.find("input[name=ToTalFare]").val(i.toMn())}).focus(function(){$(this).select()}).mouseup(function(n){n.preventDefault()});n.find("input[name=Deposit]").not(["readonly"]).unbind("change").on("change",function(){var t=$(this).val().toNum(),i,u,f,r,e;t<1e4&&(t=t*1e3);$(this).val(t.toMn());i=0;u=0;n.find("input[name=Discount]").length>0&&(i=n.find("input[name=Discount]").val().toNum());n.find("input[name=Surcharge]").length>0&&(i=n.find("input[name=Surcharge]").val().toNum());f=n.find("input[name=Fare]").val().toNum();r=parseInt(n.find("input[name=NumSeat]").val());n.find("input[name=Debt]").length>0&&(e=r*(f+u-i)-r*t,n.find("input[name=Debt]").val(e.toMn()))}).focus(function(){$(this).select()}).mouseup(function(n){n.preventDefault()});n.find("input[name=Surcharge]").not(["readonly"]).unbind("change").on("change",function(){var t=$(this).val().toNum(),i,e;t<1e4&&(t=t*1e3);$(this).val(t.toMn());var r=parseInt(n.find("input[name=NumSeat]").val()),o=n.find("input[name=Fare]").val().toNum(),u=0,f=0;n.find("input[name=Discount]").length>0&&(u=n.find("input[name=Discount]").val().toNum());n.find("input[name=Deposit]").length>0&&(f=n.find("input[name=Deposit]").val().toNum());i=(o+t-u)*r;n.find("input[name=Debt]").length>0&&(e=i-f*r,n.find("input[name=Debt]").val(e.toMn()));n.find("input[name=ToTalFare]").val(i.toMn())}).focus(function(){$(this).select()}).mouseup(function(n){n.preventDefault()});n.find("input[name=Discount]").not(["readonly"]).unbind("change").on("change",function(){var t=$(this).val().toNum(),i,e;t<1e4&&(t=t*1e3);$(this).val(t.toMn());var r=parseInt(n.find("input[name=NumSeat]").val()),o=n.find("input[name=Fare]").val().toNum(),u=0,f=0;n.find("input[name=Surcharge]").length>0&&(u=n.find("input[name=Surcharge]").val().toNum());n.find("input[name=Deposit]").length>0&&(f=n.find("input[name=Deposit]").val().toNum());i=(o+u-t)*r;n.find("input[name=Debt]").length>0&&(e=i-f*r,n.find("input[name=Debt]").val(e.toMn()));n.find("input[name=ToTalFare]").val(i.toMn())}).focus(function(){$(this).select()}).mouseup(function(n){n.preventDefault()});n.find("input").not("[name=PhoneNumbers]").each(function(t,i){$(i).focus(function(t){t.preventDefault();t.stopPropagation();vbf("onClearSuggestCustomer",{f:n})})});n.unbind("shown.bs.modal").on("shown.bs.modal",function(){try{vIsEstStr(_dict._focusUpdateForm)?n.find("input[name="+_dict._focusUpdateForm+"]").focus():n.find("input[name=PhoneNumbers]").focus()}catch(e){n.find("input[name=PhoneNumbers]").focus()}vbf("onClearSuggestCustomer",{f:n})});n.find("button").each(function(l,a){if($(a).hasClass("btn-cancel"))$(a).unbind().on("click",function(o){var s,h,c;o.preventDefault();s=[];h=!0;$.each(t,function(n,t){var i=t._getCurrentTicket();i._status!=1&&(h=!1);s.push(i._fare)});c=0;$.each(s,function(n,t){c+=t});k._closeUpdateDialog(n);vbf("doShowCancelForm",{totalFare:c,allIsBooking:h,st:t,tId:i,tName:r,tDate:u,tBus:f,sc:e});app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1});else if($(a).hasClass("btn-update"))$(a).unbind().on("click",function(t){t.preventDefault();var e=k._createGetSeatStatusObj(n),h=function(t,e){var h,a,v;if(typeof e[0][2]!="undefined")if(e[0][2]==3)k._closeUpdateDialog(n),vbf("showErrorForm",{message:_dict._err[7]}),vbf("reloadBookingSheet"),vbf("onClearSelectedItem");else{if(!k._validateUpdateForm(n))return;var y=n.find("input[name=CreatedUser]").val(),c=y.split(","),l=c[0];for(h=0;h<c.length;h++)c[h]!=app.un&&(l=c[h]);l!=app.un?(a=n.find("input:hidden[name=PhoneNumbers]").val(),v=n.find("input:text[name=PhoneNumbers]").val(),a!=v?(k._closeUpdateDialog(n),k._createUpdateConflictDialogDiv(n,l,o,f,i,s,r,u)):(k._transformUpdateFormValue(n),k._updateTicket(n,o,f,i,s,r,u),app.selectedPhone="",app.selectedCode="",app.ctrlOn=!1,$._resetCopyInfo(),$._resetBookReturnInfo())):(k._transformUpdateFormValue(n),k._updateTicket(n,o,f,i,s,r,u),app.selectedPhone="",app.selectedCode="",app.ctrlOn=!1,$._resetCopyInfo(),$._resetBookReturnInfo())}else k._transformUpdateFormValue(n),k._updateTicket(n,o,f,i,s,r,u),app.selectedPhone="",app.selectedCode="",app.ctrlOn=!1,$._resetCopyInfo(),$._resetBookReturnInfo()};$.isEmptyObject(e)?alert("Dữ liệu không chính xác, vui lòng nhấn phím F5. Xin cảm ơn !"):vRqs(e,h)});else if($(a).hasClass("btn-close"))$(a).unbind().on("click",function(t){t.preventDefault();vbf("onClearSelectedItem");vbf("resetSeatStack");app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1;k._closeUpdateDialog(n)});else if($(a).hasClass("btn-eprint"))$(a).unbind().on("click",function(t){t.preventDefault();vbf("onPrintETicket",{tId:i,tName:r,tDate:u,cTrip:h,tInfo:w});vbf("onClearSelectedItem");vbf("resetSeatStack");k._closeUpdateDialog(n);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1});else if($(a).hasClass("btn-eprint-save"))$(a).unbind().on("click",function(t){var v,y,p,b;t.preventDefault();var e=[],c=[],l=n.find('select[name="PaymentType"]').val(),d=$(a).attr("state");switch(d){case"avai":if(v=function(){var t=function(){vbf("onPrintETicket",{tId:i,tName:r,tDate:u,cTrip:h,tInfo:w});vbf("onClearSelectedItem");vbf("resetSeatStack");k._closeUpdateDialog(n)};vbf("reloadBookingSheet",{},t)},!k._validateUpdateForm(n,!0))return;if($.each(app.seatStack,function(n,t){var i=t._getCurrentTicket();e.push(i._status);c.push(i._printStatus)}),e=e.getUnique(),c=c.getUnique(),c.length>1){n.find("div.message-error").html("Đã có ghế xuất vé rồi, vui lòng kiểm tra lại !");n.find("div.message-error").show();return}if(e.length>1){n.find("div.message-error").html("Đã có ghế thanh toán rồi, vui lòng kiểm tra lại !");n.find("div.message-error").show();return}if(!vIsEstStr(l)){n.find("div.message-error").html("Vui lòng chọn hình thức thanh toán.");n.find("div.message-error").show();return}k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u,v,!0);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1;break;case"block":n.find("div.message-error").html("Đã xuất vé rồi, vui lòng kiểm tra lại !");n.find("div.message-error").show();break;case"unblock":y=k._createUnblockObj(n,f,i,s);p=function(t){if(t==1){var i=n.find("button.btn-eprint-save");i.prop("disabled",!1);i.attr("state","avai");i.text("In vé")}};vRqs(y,p);break;default:if(b=function(){var t=function(){vbf("onPrintETicket",{tId:i,tName:r,tDate:u,cTrip:h,tInfo:w});vbf("onClearSelectedItem");vbf("resetSeatStack");k._closeUpdateDialog(n)};vbf("reloadBookingSheet",{},t)},!k._validateUpdateForm(n,!0))return;if($.each(app.seatStack,function(n,t){var i=t._getCurrentTicket();e.push(i._status);c.push(i._printStatus)}),e=e.getUnique(),c=c.getUnique(),c.length>1){n.find("div.message-error").html("Đã có ghế xuất vé rồi, vui lòng kiểm tra lại !");n.find("div.message-error").show();return}if(e.length>1){n.find("div.message-error").html("Đã có ghế thanh toán rồi, vui lòng kiểm tra lại !");n.find("div.message-error").show();return}if(!vIsEstStr(l)){n.find("div.message-error").html("Vui lòng chọn hình thức thanh toán.");n.find("div.message-error").show();return}k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u,b,!0);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1}});else if($(a).hasClass("btn-add-more-ticket"))$(a).unbind().on("click",function(t){t.preventDefault();app.hasCopyTicket=!0;var e=function(t,r,u){var f=function(){vbf("onBookMoreTicket",{f:n,oldCode:t,fromArea:r,toArea:u,tdid:c,tId:i})};vbf("reloadBookingSheet",{},f)};if(!k._validateUpdateForm(n)){app.hasCopyTicket&&($._resetCopyInfo(),vbf("onUnbindEventCopying"));return}k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u,e);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1});else if($(a).hasClass("btn-return"))$(a).unbind().on("click",function(t){t.preventDefault();app.hasBookReturnTicket=!0;var e=function(){var t=function(){vbf("onBookReturnTicket",{f:n,tId:i})};vbf("reloadBookingSheet",{},t)};if(!k._validateUpdateForm(n)){app.hasBookReturnTicket&&($._resetBookReturnInfo(),vbf("onUnbindEventBookReturnTicket"));return}k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u,e);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1;$("html, body").animate({scrollTop:parseInt($("body").offset().top)},500)})});n.find('textarea[name="Note"]').unbind().on("keypress",function(t){if(t.keyCode==13&&!b){if(t.preventDefault(),t.stopPropagation(),!k._validateUpdateForm(n))return;if(a!=null&&a==1)return;k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u)}});$(document).unbind("keypress").on("keypress",function(t){var r=!0,f=$("#update-popup #UpdateForm").find("ul.search-items,div.search-result"),u,i;f.length>0&&(r=!1);t.keyCode==13&&r&&(u=$("#update-popup"),i=n.find("button.btn-update"),u.hasClass("in")&&i.is(":visible")&&i.trigger("click"))})},_populateFormData:function(n,t){$.each(n,function(n,i){var r=$(t).find('[name="'+n+'"]'),u=r.attr("type");switch(u){case"checkbox":r.prop("checked",i);break;case"radio":r.filter('[value="'+i+'"]').prop("checked",i);break;case"label":r.text(i);break;default:r.val(i)}n=="AgentName"&&r.length>0&&setTimeout(function(){r.val(i);r.trigger("chosen:updated")},500)})},_createGetSeatStatusObj:function(n){var t=null,i={};return t=n.find("input[name=IdInfo]").val().split(","),t.length>0&&t[0]!=null&&t[0]!=""&&(i._a="fGetTicket",i._c={Id:t[0]},i._f="Id, TripId, Status, IsPrgHistoryInfo, Code"),i},_initUpdateFormData:function(n,t,i,r,u,f,e){var h=app.copyInfo,o=t._getCurrentTicket(),v,ut,s,c,y,p,l;if($.isEmptyObject(o))return!1;var w=o.fromArea,b=o.toArea,ft=o._fromStop,et=o._toStop,d=0;vIsEstStr(h.CurrentTripId)&&(d=h.CurrentTripId);app.hasCopyTicket&&(d==e?(vIsEstStr(h.FromArea)&&(w=h.FromArea),vIsEstStr(h.ToArea)&&(b=h.ToArea)):(h.FromArea=w,h.ToArea=b));this._renderDataForSelectBox(n,t);var g=[],k=[],nt=[],tt=[],it=0,rt=[],a=0;if($.each(i,function(n,t){var i=t._getCurrentTicket();app.hasCopyTicket&&h.Fare!=undefined&&(i._fare=h.Fare.toNum());(a==0||a>i._fare&&i._fare>0)&&(a=i._fare);g.push(i._id);k.push(t._label);nt.push(i._getCustomerInfo());tt.push(i._status);rt.push(i._suser);it+=i._fare+i._surCharge-i._discount;i._status!=1&&(i._debt=0)}),v=new Date(o._pdate.getTime()),v.addMinutes(u),ut=f,s={IdInfo:g.join(),PickupDate:v.toFormatString("dd-mm-yyyy"),PickupTime:v.toFormatString("hh:mm"),SeatNo:k,Code:o._code,Fare:a.toMn(),Surcharge:o._surCharge.toMn(),Deposit:o._deposit.toMn(),Discount:o._discount.toMn(),Debt:(o._debt*app.seatStack.length).toMn(),CustomerId:o._cid,CustomerInfo:nt.join(),PhoneNumbers:o._cphone,FullName:o._cname,CreatedUser:rt,Note:o._note,StatusInfo:tt.join(),Serial:o._seri,Notcome:o._status==4?!0:!1,KeepOnTime:o._status==8?!0:!1,NumSeat:k.length,ToTalFare:it.toMn(),RoutePoints:ut,NumClick:0,FromArea:w,ToArea:b,SNote:o._sNote,ResponsibilityUser:o._responUser,PickOrReturnDate:o._porDate,FromStop:ft,ToStop:et,IssuedUser:o._issuedUser,PrintStatus:o._printStatus},vIsEstStr($.trim(o._pmInfo))){c=o._getPaymentInfo();s.PaymentType=c.type;switch(c.type){case 1:s.BranchName=c.info._id;break;case 2:s.ChargeCode=$.map(c.info,function(n){return n}).join("|");break;case 3:s.PayAddress=c.info._addr;break;case 4:s.DriverName=c.info._dname;break;case 5:s.TransCode=c.info._tcode;break;case 6:s.AgentName=c.info._id}}if(vIsEstStr(s.BranchName)||(y=[],n.find("select[name=BranchName] > option").each(function(){y.push($(this).val())}),y.length>0&&y.indexOf(app.aid)!=-1&&(s.BranchName=app.aid)),vIsEstStr(s.AgentName)||(p=[],n.find("select[name=AgentName] > option").each(function(){p.push($(this).val())}),p.length>0&&p.indexOf(app.aid)!=-1&&(s.AgentName=app.aid)),typeof s.ChargeCode=="undefined"&&(s.ChargeCode=_dict._pm[1][4]),vIsEstStr(o._pInfo)&&(l=o._getPickupInfo(),!$.isEmptyObject(l))){switch(l.type){case"P":s.PickupInfo=l.text;break;case"T":s.TransferInfo=l.text}s.pIndex=null;typeof l.pIndex!="undefined"&&(s.pIndex=l.pIndex)}return app.hasCopyTicket&&typeof _dict._copyField!="undefined"&&$.each(_dict._copyField,function(n,t){if(t!="Code")s[t]=h[t];else{var i=h.TripDetailId?h.TripDetailId:0;i==r&&(s[t]=h[t])}}),app.hasBookReturnTicket&&typeof _dict._returnField!="undefined"&&$.each(_dict._returnField,function(n,t){s[t]=h[t]}),_dict._autoSendSmsUpdate!=undefined&&_dict._autoSendSmsUpdate&&(s.HasSendSms=!0),s},_renderSeatNoDiv:function(n,t){var i=t.find("ul#seat-no").empty();$.each(n,function(n,t){i.append($("<li />").addClass("list-group-item").addClass(_dict._vc[Math.floor(Math.random()*_dict._vc.length)]).text(t))})},_normalFormFields:function(n){n.find("input:disabled").prop("disabled",!1);n.find("select:disabled").prop("disabled",!1);n.find("textarea:disabled").prop("disabled",!1);n.find('input[name="RoutePoint"]').prop("disabled",!1);n.find("ul[role=tab-list] li").removeClass("hidden").removeClass("active");n.find("button").removeClass("hidden");n.find("div.message-error").html("");n.find("div.message-error").hide()},_disableFormFields:function(n,t,i,r,u){var d=this,s,l,k,o;d._normalFormFields(n);s=["input","select","textarea"];i.length>1&&($.each(_dict._frule[0],function(n,t){var i=$("#"+t[0]);$.each(t[1],function(n,t){for(var r=$(),u=0;r.length==0&&u<s.length;)r=i.find(s[u]+"[name="+t+"]"),u++;r.length>0&&r.prop("disabled",!0)})}),$.each(_dict._trule[0],function(t,i){n.find("a[data-tab="+i+"]").closest("li").addClass("hidden")}));var a=[],v=[],y=[],f={_customer:[],_pickUp:[],_note:[],_fare:[],_surCharge:[],_deposit:[],_discount:[],_paymentInfo:[],_cNames:[],_cPhones:[]},p=[],w=[],b=[],h=[],c=[],e=!1;$.each(i,function(n,t){var i=t._getCurrentTicket(),r,u;$.each(_dict._frule[1],function(n,t){i._status==t[0]&&app.rights.indexOf($.rights.bEdtInfPaidTk.val)==-1&&a.push(t[1])});$.each(_dict._trule[1],function(n,t){i._status==t[0]&&v.push(t[1])});$.each(_dict._brule[1],function(n,t){i._status==t[0]&&y.push(t[1])});f._customer.push(i._getCustomerInfo());f._cNames.push(i._cname);f._cPhones.push(i._cphone);r=i._getPickupInfo();u="";$.isEmptyObject(r)||(u=r.text);f._pickUp.push(u);f._note.push(i._note);f._fare.push(i._fare);f._surCharge.push(i._surCharge);f._deposit.push(i._deposit);f._discount.push(i._discount);f._paymentInfo.push(i._pmInfo);p.push(i.fromArea);w.push(i.toArea);b.push(i._status);c.push(i._printStatus)});p=p.getUnique();w=w.getUnique();(p.length>1||w.length>1)&&h.push("RoutePoint");b=b.getUnique();b.length>1&&h.push("RoutePoint");h=h.getUnique();$.each(h,function(t,i){switch(i){case"RoutePoint":n.find('input[name="RoutePoint"]').prop("disabled",!0);e=!0}});a=a.getUnique();v=v.getUnique();y=y.getUnique();$.each(a,function(n,t){$.each(t,function(n,t){var i=$("#"+t[0]);$.each(t[1],function(n,t){for(var r=$(),u=0;r.length==0&&u<s.length;)r=i.find(s[u]+"[name="+t+"]"),u++;r.length>0&&r.prop("disabled",!0)})})});$.each(v,function(t,i){$.each(i,function(t,i){n.find("a[data-tab="+i+"]").closest("li").addClass("hidden")})});$.each(y,function(n,t){$.each(t,function(n,t){var i=$("#"+t[0]);$.each(t[1],function(n,t){t=="btn-cancel"?app.rights.indexOf($.rights.cReDeFo.val)==-1&&i.find("button."+t).addClass("hidden"):i.find("button."+t).addClass("hidden")})})});l=t._tickets[t._currentTicketIndex]._status;r==1&&(l==2||l==5||l==3)&&typeof _dict._closedTripConf!="undefined"&&_dict._closedTripConf.UpdateForm.length>0&&app.rights.indexOf($.rights.bEnBtnAtDpt.val)==-1&&$.each(_dict._closedTripConf.UpdateForm,function(t,i){n.find("button."+i).addClass("hidden")});l!=1&&n.find('input[name="RoutePoint"]').prop("disabled",!0);f._customer=f._customer.getUnique();f._pickUp=f._pickUp.getUnique();f._note=f._note.getUnique();f._fare=f._fare.getUnique();f._surCharge=f._surCharge.getUnique();f._deposit=f._deposit.getUnique();f._discount=f._discount.getUnique();f._paymentInfo=f._paymentInfo.getUnique();f._cNames=f._cNames.getUnique();f._cPhones=f._cPhones.getUnique();f._cNames.length>1&&(n.find("input[name=FullName]").prop("disabled",!0),e=!0);f._cPhones.length>1&&(n.find("input:text[name=PhoneNumbers]").prop("disabled",!0),e=!0);f._pickUp.length>1&&(n.find("input[name=PickupInfo]").prop("disabled",!0),n.find("input[name=TransferInfo]").prop("disabled",!0),n.find("input[name=pIndex]").prop("disabled",!0),e=!0);f._note.length>1&&(n.find("textarea[name=Note]").prop("disabled",!0),e=!0);f._fare.length>1&&(n.find("input[name=Fare]").prop("disabled",!0),e=!0);f._surCharge.length>1&&(n.find("input[name=Surcharge]").prop("disabled",!0),e=!0);f._deposit.length>1&&(n.find("input[name=Deposit]").prop("disabled",!0),e=!0);f._discount.length>1&&(n.find("input[name=Discount]").prop("disabled",!0),e=!0);f._paymentInfo.length>1&&(n.find("select[name=PaymentType]").prop("disabled",!0),n.find("input[name=BranchName]").prop("disabled",!0),n.find("select[name=BranchName]").prop("disabled",!0),n.find("input[name=ChargeCode]").prop("disabled",!0),n.find("input[name=PayAddress]").prop("disabled",!0),n.find("input[name=DriverName]").prop("disabled",!0),n.find("input[name=TransCode]").prop("disabled",!0),n.find("input[name=AgentName]").prop("disabled",!0),e=!0);typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&(k=n.find('div.checkbox-route-point input[name="RoutePoint"]').first(),app.rights.indexOf($.rights.bUBFrtStg.val)==-1&&(k.is(":disabled")||k.attr("disabled",!0)));_dict._printETicketOnlyOne!=undefined&&_dict._printETicketOnlyOne&&(o=n.find("button.btn-eprint-save"),o.length>0&&(c=c.getUnique(),c.length>1||c[0]==0?app.rights.indexOf($.rights.bUnPr.val)!=-1?(o.prop("disabled",!1),o.attr("state","unblock"),o.text("Mở in vé")):(o.prop("disabled",!0),o.attr("state","block"),o.text("Đã xuất vé")):(o.prop("disabled",!1),o.attr("state","avai"),o.text("In vé"))));(app.hasCopyTicket||app.hasBookReturnTicket||e)&&(n.find("button.btn-add-more-ticket").addClass("hidden"),n.find("button.btn-return").addClass("hidden"));d._checkRightOnUpdateForm(u)?n.find("button.btn-cancel").show():n.find("button.btn-cancel").hide()},_triggerUpdateTab:function(n){n.find("ul[role=tab-list] li").not(".hidden").first().find("a").trigger("click")},_triggerUpdateForm:function(n){n.find("select[name=PaymentType]").trigger("change")},_createRoutePoints:function(n,t,i,r,u,f,e,o){var b=this,c=n.find("div.checkbox-route-point"),l,a,y,p,v;c.empty();l=0;a=0;u!=0&&(l=u);f!=0&&(a=f);vIsEstStr(i)&&(y=i.indexOf("~"),l=i.substr(y+1,i.length).split("|")[0]);vIsEstStr(r)&&(p=r.indexOf("~"),a=r.substr(p+1,r.length).split("|")[0]);var w=e,s=parseInt(w.split(":")[0]),h=parseInt(w.split(":")[1]);$.each(t,function(n,i){var r="",o="",u,f;s+=parseInt(i.Hour);h+=parseInt(i.Minute);h>=60&&(h=h%60,s+=1);s>24?s=s%24:s==24&&(s=0,r="00");s<10?r="0"+s:s>=10&&(r=s);o=h<10?"0"+h:h;u="";u=n==0?e:r+":"+o;f=$('<label class="checkbox-inline" />').append($('<input type="checkbox" name="RoutePoint" data-point-id="'+i.Id+'"/>')).append($("<b />").html(i.Code)).append($('<mark class="text-primary"/>').html(u));t.length==2&&f.addClass("hidden");c.append(f)});l==0&&a==0?(v=c.find('input[name="RoutePoint"]'),v.first().attr("checked",!0),v.last().attr("checked",!0)):(c.find('input[name="RoutePoint"][data-point-id="'+l+'"]').attr("checked",!0),c.find('input[name="RoutePoint"][data-point-id="'+a+'"]').attr("checked",!0));b._bindEventRoutePoints(n,o)},_bindEventRoutePoints:function(n,t){var i=this;n.find('input[name="RoutePoint"]').unbind().on("click",function(){var f=0,e=0,u=0,o=0,s=n.find('input[name="NumSeat"]').val(),h=n.find('input[name="NumClick"]').val(),r;$(this).is(":checked")?(r=n.find('input[name="RoutePoint"][checked="checked"]'),r.length>=2?h!=0?(n.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),$(this).attr("checked",!0),typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint?(r=n.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),r.length==1&&(f=n.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),e=r.attr("data-point-id"),u=i._getFareQuickBook(f,e,t)),o=s*u,n.find('input[name="Fare"]').val(u.toMn()),n.find('input[name="ToTalFare"]').val(o.toMn())):(n.find('input[name="Fare"]').val(0),n.find('input[name="ToTalFare"]').val(0))):(r=n.find('input[name="RoutePoint"][checked="checked"]'),r.last().removeAttr("checked"),$(this).attr("checked",!0),r=n.find('input[name="RoutePoint"][checked="checked"]'),r.length==2&&(f=r.first().attr("data-point-id"),e=r.last().attr("data-point-id"),u=i._getFareQuickBook(f,e,t)),o=s*u,n.find('input[name="Fare"]').val(u.toMn()),n.find('input[name="ToTalFare"]').val(o.toMn()),n.find('input[name="NumClick"]').val(1)):r.length<=1&&(typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&app.rights.indexOf($.rights.bUBFrtStg.val)==-1?(n.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),$(this).attr("checked",!0),r=n.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),r.length==1&&(f=n.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),e=r.attr("data-point-id"),u=i._getFareQuickBook(f,e,t)),o=s*u,n.find('input[name="Fare"]').val(u.toMn()),n.find('input[name="ToTalFare"]').val(o.toMn())):($(this).attr("checked",!0),r=n.find('input[name="RoutePoint"][checked="checked"]'),r.length==2&&(f=r.first().attr("data-point-id"),e=r.last().attr("data-point-id"),u=i._getFareQuickBook(f,e,t)),o=s*u,n.find('input[name="Fare"]').val(u.toMn()),n.find('input[name="ToTalFare"]').val(o.toMn())))):($(this).removeAttr("checked"),n.find('input[name="Fare"]').val(0),n.find('input[name="ToTalFare"]').val(0),n.find('input[name="NumClick"]').val(1))})},_closeUpdateDialog:function(n){n&&(vbf("onClearWarningCustomer",{f:n}),n.modal("hide"));$("body").find(".updateConflict-popup").remove();$("body").find(".modal-backdrop.fade.in").remove()},_createUpdateConflictDialogDiv:function(n,t,i,r,u,f,e,o){var s=this,h;$("body").find("#updateConflict-popup").remove();h=$("<div />").addClass("modal-body").append($("<form />").attr("id","UpdateConflictForm").append($("<table />").addClass("table no-border mb0 table-modal table-condensed").append($("<tr />").append($('<td style="border:0;" />').addClass("col-md-6").append($("<div />").addClass("form-group").attr("area-hidden","true").append($("<p />").html("Ghế đã được đặt bởi <strong style='color:red'>"+t+"<\/strong>. Đặt chồng vé ?"))))).append($("<tr />").append($("<td />").addClass("col-md-12 list-btn").attr("colspan",3).append($("<button />",{type:"button"}).addClass("btn btn-danger").text("Đồng ý").css("float","left").click(function(){s._closeUpdateConflictDialog();s._transformUpdateFormValue(n);s._updateTicket(n,i,r,u,f,e,o);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1;$._resetCopyInfo();$._resetBookReturnInfo()})).append($("<button />",{type:"button"}).addClass("btn btn-default").text("Không").css("float","left").click(function(){s._closeUpdateConflictDialog()}))))));s._$updateConflictModal=$("<div />").addClass("modal fade updateConflict-popup").attr("role","dialog").attr("aria-hidden","true").append($("<div />").addClass("modal-dialog modal-md").append($("<div />").addClass("modal-content").append($("<div />").addClass("modal-header").css("background-color","#c9302c").addClass("bg-primary").append($("<h2 />").addClass("modal-title thin-1").html("Cảnh báo"))).append(h))).appendTo($("body"));s._$updateConflictModal.modal("show")},_closeUpdateConflictDialog:function(){this._$updateConflictModal.modal("hide")},_resetForm:function(n){n.find("input[type=hidden]").val("");n.find("input[type=text], textarea, select").val("");n.find("input[type=checkbox]").prop("checked",!1);n.find("input[type=radio]").prop("checked",!1);n.find("div.has-error").removeClass("has-error");n.find("div.search-result").remove()},_getPickupInfo:function(n,t,i){return typeof n=="undefined"&&(n=""),typeof t=="undefined"&&(t=""),typeof i=="undefined"&&(t=""),$.trim(n+"|"+t+"|"+i)},_getCustomer:function(n,t,i){return $.trim("1|1|"+n+"|"+t+"|"+i)},_getTeamInfo:function(){var n=FlatObj.cTrip.TeamInfo,t="|",i;return n&&(i=n.split("~"),$.each(i,function(n,i){if(n>=1){var r=i.split("|");r[0]==2&&(t=r[2]+"|"+r[3])}})),t},_getFareQuickBook:function(n,t,i){var u=this,f=u._parseFares(i),e=n+"|"+t,r=f[e];return typeof r=="undefined"?0:r},_parseFares:function(n){var u="",f="",r=0,t;if(n!=undefined&&vIsEstStr(n)&&n.length>1){var i=n.split("~"),o=i.length,e=[];for(t=1;t<o;t++)u=i[t].split("|")[0],f=i[t].split("|")[1],r=parseInt(i[t].split("|")[2]),e[u+"|"+f]=isNaN(r)?0:r;return e}return[]},_transformUpdateFormValue:function(n){var t=this,i=n.find("select[name=PaymentType]").not(":disabled").val(),r=n.find("input[name=Notcome]").not(":disabled").prop("checked"),u=n.find("input[name=KeepOnTime]").not(":disabled").prop("checked");if(r)t._changeFormToNotComeStatus(n);else if(u)t._changeFormToKeepOnTimeStatus(n);else if(typeof i!="undefined")if(i=parseInt(i),isNaN(i))t._changeFormToBookingStatus(n);else switch(i){case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 10:t._changeFormToPaidStatus(n);break;case 9:t._changeFormToPassStatus(n)}},_changeFormToPaidStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(2);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToNotComeStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(4);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToPassStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(5);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToKeepOnTimeStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(8);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToBookingStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(1);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToOpenStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(7);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToValidStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(6);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToCancelledStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(3);n.find("input[name=StatusInfo]").val(t.join())},_checkRightOnUpdateForm:function(n){var r,i,t;if(app.rights.indexOf("~3|2|")==-1)return!0;for(r=app.rights.indexOf("~3|2|0")>=0?!1:!0,i=app.rights.split("~"),t=0;t<i.length;t++)if(i[t].indexOf("3|2|")>=0&&n==i[t].split("|")[2])return!r;return r}});$(document).ready(function(){$._convertFormDataToObj=function(n){var t={},i=!1,r;return(app.hasCopyTicket||app.hasBookReturnTicket)&&(i=!0),r=n.find("#UpdateForm input,textarea,select"),$.each(r,function(n,r){(!$(r).is(":disabled")||i)&&(t[r.name]=r.value)}),t};$._bindEventOnCalendarIcon=function(){$("#FilterForm").find(".glyphicon-calendar").parent().on("click",function(){$(this).prev().datepicker("show")})};$._getBranchInfo=function(n){var t="";return $.each(app.branchInfo,function(i,r){t==""&&n==r[0]&&(t=r.join("|"))}),t==""&&(t=[app.aid,app.aite,app.aice,app.aisne,"",""].join("|")),t};$._getPayment=function(n,t,i){return $.trim(n+":"+t+":"+i)}});
//# sourceMappingURL=p.min.js.map
