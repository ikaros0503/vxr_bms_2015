define({pager:null,tickets:[],filter:"",statusArr:{"1":"Mới","2":"Đã xác nhận","3":"Đang giao","4":"Đã giao","5":"Đã hủy"},sourceArr:{"1":"Website","2":"CallCenterVXR","3":"CallCenter"},fieldsToGet:["Code","Type","Status","TripDate","SeatCode","IssueDate","PickupDate","CustomerInfo","Fare","Note","PickupInfo","PaymentInfo","CreatedUser","UserCharge","FromArea","ToArea","CanceledDate","CompName","CanceledUser","IsConfirmed","IsPrgCreatedDate","CancelType","TripName","ChargeDate","Id","BookingCode","TransactionStatus","Source","AddressInfo","FromAddress"],smsTemplate:"Kinh gui QK {customerName}. Ma Ve: {code}. Ghe: {seat}. Xe {compName}. Noi di: {fromAddress}. T/g: {tripTime} {tripDate}. Tran Trong. VeXeRe. Hotline: 19006484",start:function(n){$("#bksContent").hide();$("#report").hide();$("#product-content").hide();$("#bTickets").hide();$("#cod").show();$("div.footer").hide();$("#cod").html($("#codTemplate").html());console.log("COD is running now");console.log(n.data);this.init()},test:function(){vRqs({_a:"sendEmailToCustomer",email:"thichdesign@gmail.com",code:"GHAGDK",tripDateTime:"11:15 28/05/2015",compName:"Tiến Oanh",tripName:"Sài Gòn - Kon Tum",fromArea:"Bến xe miền Đông",toArea:"Bến xe Buôn Ma Thuột",tripDate:"28/05/2015",tripTime:"11:15",seat:"A1, B2",fare:"100000",money:"200000",customerName:"Tuan Huynh",customerPhone:"01228101037",date:moment(new Date).format("DD-MM-YYYY"),template:"EmailTemplate.html"},function(n,t,i){console.log(n,t,i)})},init:function(){var n=this,t;$("body").append($("#dlgChangeCodStatusTemplate").html());$("#dlgChangeCodStatusTemplate").html("");$("#cod select[name=district]").html("");vRqs({_a:"fGetArea",_c:{BaseId:29,Type:5},_f:"Id, Name, URLId"},function(n,t){if(n==1&&t.length>0){$("#cod select[name=district]").append('<option value="-1">Quận<\/option>');for(var i=0;i<t.length;i++)$("#cod select[name=district]").append('<option value="'+t[i][2]+'">'+t[i][1]+"<\/option>")}});t=function(){$("#cod button.refresh").unbind().on("click",function(){n.loadTickets()});$(".btnChangeCodStatus").unbind().on("click",function(){setVisibleToElement($(".dlgChangeCodStatus div.alert"),0);var t=parseInt($(this).attr("data-index")),i=parseInt($(this).attr("data-statusId"));n.tickets[t].bookingCode!=null&&n.tickets[t].bookingCode!=""&&vRqs({_a:"InsertPaymentTransaction",_c:{BookingCode:n.tickets[t].bookingCode},_d:{Actor:app.un,TransactionStatus:i,Type:1,BookingCode:n.tickets[t].bookingCode,Note:$("#txtCodStatusNote").val()}},function(r){setVisibleToElement($(".dlgChangeCodStatus div.alert"),r!=1);r==1&&($(".dlgChangeCodStatus").modal("hide"),i==4&&(vRqs({_a:"sendSms",phone:n.tickets[t].customerPhone,content:vtpl(n.smsTemplate,n.tickets[t])},function(n,t,i){console.log(n,t,i)}),vRqs({_a:"sendEmailToCustomer",email:n.tickets[t].customerMail,code:n.tickets[t].code,tripDateTime:n.tickets[t].tripDate+" "+n.tickets[t].tripTime,compName:n.tickets[t].compName,tripName:n.tickets[t].tripName,fromArea:n.tickets[t].fromArea,toArea:n.tickets[t].toArea,tripDate:n.tickets[t].tripDate,tripTime:n.tickets[t].tripTime,seat:n.tickets[t].seat,fare:n.tickets[t].fareFormatted,money:n.tickets[t].moneyFormatted,customerName:n.tickets[t].customerName,customerPhone:n.tickets[t].customerPhone,date:moment(new Date).format("DD-MM-YYYY"),template:"EmailTemplate.html"},function(n,t,i){console.log(n,t,i)})),n.loadTickets())})});$("#cod input[name=tripDate]").datepicker({dateFormat:"dd-mm-yy"});$("#cod input[name=fromDate]").datepicker({dateFormat:"dd-mm"});$("#cod input[name=toDate]").datepicker({dateFormat:"dd-mm"});$("#cod input[name=fromDate]").datepicker("setDate",new Date);$("#cod input[name=toDate]").datepicker("setDate",new Date);$("#cod input").on("change",function(){n.updateFilter().loadTickets()});$("#cod select").on("change",function(){n.updateFilter().loadTickets()});$("#cod .mnuCodSource li a").unbind().on("click",function(){$(this).hasClass("selected")||($("#cod .mnuCodSource li a").removeClass("selected"),$(this).addClass("selected"),$("#mnuCodSource span.content").text($(this).text()=="Tất cả"?"Nguồn":$(this).text()),n.updateFilter().loadTickets())});$("#cod .mnuCodStatus li a").unbind().on("click",function(){$(this).hasClass("selected")||($("#cod .mnuCodStatus li a").removeClass("selected"),$(this).addClass("selected"),$("#mnuCodStatus span.content").text($(this).text()=="Tất cả"?"Trạng thái":$(this).text()),n.updateFilter().loadTickets())})};$.getScript("App/Core/UI/pager.js",function(){n.pager=new Pager(1,10,"#cod div.page",5,function(){n.renderTickets()});n.pager.render();n.updateFilter().loadTickets()});t()},updateFilter:function(){var n=this,t;return n.filter="",t={fromDate:formatDatepicker($("#cod input[name=fromDate]"),"YYYY-MM-DD 00:00:00"),toDate:formatDatepicker($("#cod input[name=toDate]"),"YYYY-MM-DD 23:59:59"),tripDateStart:formatDatepicker($("#cod input[name=tripDate]"),"YYYY-MM-DD 00:00:00"),tripDateEnd:formatDatepicker($("#cod input[name=tripDate]"),"YYYY-MM-DD 23:59:59"),bookingCode:$("#cod input[name=code]").val(),comp:replaceUnicodeCharacter($("#cod input[name=comp]").val()),customer:replaceUnicodeCharacter($("#cod input[name=customer]").val()),user:$("#cod input[name=account]").val(),statusId:$("#cod #mnuCodStatus").attr("data-status"),sourceId:$("#cod .mnuCodSource li a.selected").attr("data-source"),districtId:$("#cod select[name=district]").val()},n.filter+=t.tripDateStart!=""?" and TripDate>='{tripDateStart}' and TripDate<='{tripDateEnd}' ":"",n.filter+=t.fromDate!=""?" and CreatedTime>='{fromDate}' ":"",n.filter+=t.toDate!=""?" and CreatedTime<='{toDate}' ":"",n.filter+=t.bookingCode!=""?" and BookingCode like N'%{bookingCode}%' ":"",n.filter+=t.comp!=""?" and ([dbo].ConvertToUnsignWithBlank(CompName) like N'%{comp}%' or SeatCode like N'%{comp}%')":"",n.filter+=t.customer!=""?" and [dbo].ConvertToUnsignWithBlank(CustomerInfo) like N'%{customer}%'":"",n.filter+=t.user!=""?" and [dbo].ConvertToUnsignWithBlank(CreatedUser) like N'%{user}%'":"",n.filter+=" and PaymentMethod=1 ",n.filter+=t.statusId!="-1"?" and TransactionStatus={statusId}":"",n.filter+=t.sourceId!="-1"?" and Source={sourceId}":"",n.filter+=t.districtId!=null&&parseInt(t.districtId)>0?" and DistrictId={districtId}":"",n.filter=vtpl(n.filter,t),n},loadTickets:function(){var n=this,t=function(t,i){var u=function(n){return n!=null&&n!=""?"":"display:none;"},r={};if(t==null)return r;r.index=i;r.totalSeats=1;r.code=t[0];r.compName=t[17];r.tripName=t[22];r.createdUser=t[12];r.compName=t[17];r.fare=t[8];r.statusId=t[26];r.bookingCode=t[25];var f=parseDateFromTString(t[3]),e=parseDateFromTString(t[20]),o=parseDateFromTString(t[32]);return r.tripDate=moment(f).format("YYYY-MM-DD"),r.createdDate=moment(e).format("YYYY-MM-DD"),r.updatedDate=moment(o).format("YYYY-MM-DD"),r.tripTime=moment(f).format("hh:mm"),r.createdTime=moment(e).format("hh:mm"),r.updatedTime=moment(o).format("hh:mm"),r.fromArea=getSubItem(t[14],"|",3),r.toArea=getSubItem(t[15],"|",3),r.seat=getSubItem(t[4],"|",0),r.customerName=getSubItem(t[7],"|",3),r.customerPhone=getSubItem(t[7],"|",4),r.customerMail=getSubItem(t[7],"|",6),r.note=getSubItem(t[28],"|",5),r.address=getSubItem(t[28],"|",0).replace("%7C","|"),r.district=getSubItem(t[28],"|",2),r.city=getSubItem(t[28],"|",1),r.addressStr=r.address+", "+r.district+", "+r.city,r.seats=[r.seat],r.fares=[r.fare],r.money=r.fare,r.moneyFormatted=vToMn(r.money),r.fareFormatted=vToMn(r.fare),r.customerName=r.customerName==""?"Khách hàng":r.customerName,r.status1Class=r.statusId==1?"selected":"",r.status2Class=r.statusId==2?"selected":"",r.status3Class=r.statusId==3?"selected":"",r.status4Class=r.statusId==4?"selected":"",r.status5Class=r.statusId==5?"selected":"",r.addressStr=r.address+", "+r.district+", "+r.city,r.codHistory="",r.fromAddress=t[29],r.source=n.sourceArr[t[27]],r.status=n.statusArr[t[26]],r.status2Display=r.statusId==1?"":"hide",r.status3Display=r.statusId==2?"":"hide",r.status4Display=r.statusId==3?"":"hide",r.status5Display=r.statusId==1||r.statusId==3?"":"hide",r.customerPhoneDisplay=u(r.customerPhone),r.noteDisplay=u(r.note),r.updatedTime=r.createdTime,r.updatedDate=r.createdDate,r.updatedUser=r.createdUser,r.historyStr="",r.history=[],r},i=function(n){var r=[],t,u,i;if(n!=null&&n.length>1){for(t=n[0],u=0,i=1;i<n.length;i++)n[i].bookingCode==t.bookingCode?(t.seats.push(n[i].seat),t.seat+=", "+n[i].seat,t.fares.push(n[i].fare),t.money+=n[i].fare,t.moneyFormatted=vToMn(t.money),t.fareFormatted=vToMn(t.fare),t.totalSeats++):(t.index=u++,r.push(t),t=n[i]);t.index=u++;r.push(t)}else return n;return r};n.setStatus("loading");n.tickets=[];vRqs({_a:"fGetCodTicket",_c:{Status:"$x=1 "+n.filter+" order by Id desc"},_f:n.fieldsToGet.join()},function(r,u){if(r==1){for(var f=0;f<u.length;f++)n.tickets.push(t(u[f],f));n.tickets=i(n.tickets);n.pager.updateInfo(n.tickets.length,1).render()}n.setStatus(r!=1?"error":n.tickets.length>0?"loaded":"noTicket")})},setStatus:function(n){return setVisibleToElement($("#cod div.page"),n=="loaded"),setVisibleToElement($("#cod div.loading"),n=="loading"),setVisibleToElement($("#cod div.info"),n=="noTicket"||n=="error"),setVisibleToElement($("#cod table.data tbody"),n=="loaded"),$("#cod div.info p.message").text(n=="noTicket"?"Không có vé nào hết ^^":"Đã có lỗi xảy ra, vui lòng tải lại trang."),this},renderTickets:function(){var n=this,u=function(){$("#cod .mnuCodStatusRow li a").on("click",function(){if(!$(this).hasClass("selected")){var t=parseInt($(this).attr("data-index")),i=$(this).attr("data-status");$(".dlgChangeCodStatus div.alert").hide();$("#txtCodStatusNote").val("");$(".btnChangeCodStatus").attr("data-index",t).attr("data-statusId",i);$(".dlgChangeCodStatus span.from").text(n.statusArr[n.tickets[t].statusId]);$(".dlgChangeCodStatus span.to").text(n.statusArr[i]);$(".dlgChangeCodStatus").modal()}});$("#cod .btn-update-status").on("click",function(){var t=parseInt($(this).attr("data-index")),i=$(this).attr("data-status");$(".dlgChangeCodStatus div.alert").hide();$("#txtCodStatusNote").val("");$(".btnChangeCodStatus").attr("data-index",t).attr("data-statusId",i);$(".dlgChangeCodStatus span.from").text(n.statusArr[n.tickets[t].statusId]);$(".dlgChangeCodStatus span.to").text(n.statusArr[i]);$(".dlgChangeCodStatus").modal()});var t=function(t,i,r){var u=$("#hiddenRowCod"+t);u.is(":hidden")?(u.show("slow"),setAnimation($(r),"rotateShow","0.5s"),n.tickets[t].history.length==0&&vRqs({_a:"fGetPaymentTransaction",_c:{BookingCode:i},_f:"Actor, CreatedTime, Type, BookingCode, TransactionStatus, Note"},function(i,r){var u,f;if(i==1){for(u=0;u<r.length;u++)f={statusId:r[u][4],status:n.statusArr[r[u][4]],date:moment(parseDateFromTString(r[u][1])).format("YYYY-MM-DD"),time:moment(parseDateFromTString(r[u][1])).format("hh:mm"),user:r[u][0],note:r[u][5]},n.tickets[t].history.push(f),n.tickets[t].historyStr+=vtpl($("#codHistoryItemTemplate").html(),f);$("#cod ul.history"+t).html(n.tickets[t].historyStr)}})):(u.hide("slow"),setAnimation($(r),"rotateHide","0.5s"))};$("#cod a.showMore").on("click",function(){var n=$(this).attr("data-index"),i=$(this).attr("data-bookingCode");t(n,i,this)});$("#cod td.detail-info").on("click",function(){var n=$(this).attr("data-index"),i=$(this).attr("data-bookingCode");t(n,i)})},i,r,t;for($("#cod table.data tbody").html(""),i=(n.pager.currentPage-1)*n.pager.itemsPerPage,r=Math.min(n.pager.currentPage*n.pager.itemsPerPage,n.pager.totalRecords)-1,t=i;t<=r;t++)$("#cod table.data tbody").append(vtpl($("#codRowTemplate").html(),n.tickets[t]));return u(),n}});
//# sourceMappingURL=p.min.js.map
