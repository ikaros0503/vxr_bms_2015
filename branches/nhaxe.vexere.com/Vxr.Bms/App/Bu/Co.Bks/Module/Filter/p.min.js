(function(n){var t={_create:n.custom.vbooking.prototype._create};n.extend(!0,n.custom.vbooking.prototype,{options:{},_$filterForm:null,_$BSfilterForm:null,_$voFilterForm:null,_$vvFilterForm:null,_$vcFilterForm:null,_$searchTicketFilter:null,_searchResult:[],_totalSearchResult:0,_$filterSearchResult:null,_hasSearchPhone:!1,_create:function(){var i,r,u;if(t._create.apply(this,arguments),this.options.serviceUrl){this._createFilterForm();this._createBSFilterForm();this._createVOFilterForm();this._createVVFilterForm();this._createVCFilterForm();this._createXuatBenButton();i=n.vPrpRgts(n("ul.vbooking-list"));n.vApplyRights(app.rights,i);r=n.vPrpRgts(n("div.vbooking-toolbar.filter"));n.vApplyRights(app.rights,r);u=this;n("body").on("updateFilters",function(n,t){u.updateFilters(t)})}},updateFilters:function(t){var i=this,u,r;console.log(t);i._cTripTime=t.tripTime;n("body").trigger("tripChangedWithoutReload",{CompId:t.compId,TripId:t.tripId,TripTime:t.tripTime});n("#FilterForm select[name=TripId]").val(t.tripId);u=t.tripDate.split("-")[2]+"-"+t.tripDate.split("-")[1]+"-"+t.tripDate.split("-")[0];n("#FilterForm input[name=DepartureDate]").datepicker("setDate",new Date(u));n("#FilterForm select[name=TimeSlot]").val(t.tripTime);i._changeCTripId(n("#FilterForm select[name=TripId]").val());i._changeCTripIndex(n("#FilterForm select[name=TripId]").prop("selectedIndex"));i._changeCFromId(0);i._changeCToId(0);i._reloadStopPoints();i._cTripTime=n("#FilterForm select[name=TimeSlot]").val();i._changeCTripTime(n("#FilterForm select[name=TimeSlot]").val());i._changeCTripDate(n("#FilterForm input[name=DepartureDate]").datepicker("getDate"));i._reloadTimeSlot();i._reloadTimeFromAndTo();i._reloadFrame();i._reloadSheet();i._generateStageCode();i._changeCMaxStageCode(i._cStageCode);i._reloadAllowedSeats();i._reloadSheet();i._fMoving||(i._resetSeatStack(),i._clearSelectedItem());_dict._availableSeatOn&&i._reloadAvailableSeat();typeof _dict._hasDefaultStagePerTrip!="undefined"&&_dict._hasDefaultStagePerTrip&&(typeof _dict._defaultStagePerTrip[n("#FilterForm select[name=TripId]").val()]!="undefined"?(r=_dict._defaultStagePerTrip[n("#FilterForm select[name=TripId]").val()].split(","),i._cDefaultFromId=parseInt(r[0]),i._cDefaultToId=parseInt(r[1])):(i._cDefaultFromId=i._cFromId,i._cDefaultToId=i._cToId))},_initEvent:function(){var t=this;if(!t.eventInited){t.eventInited=!0;n("body").on("compChanged",function(){});n("body").on("tripChanged",function(){alert(4444)})}},_createFilterForm:function(){var t=this;t._$filterForm=n("#FilterForm");t._bindEventOnFilterForm()},_createBSFilterForm:function(){var t=this;t._$BSfilterForm=n("#BSFilterForm");t._bindEventOnBSFilterForm()},_createVOFilterForm:function(){var t=this;t._$voFilterForm=n("#VOFilterForm");t._bindEventOnVOFilterForm()},_createVVFilterForm:function(){var t=this;t._$vvFilterForm=n("#VVFilterForm");t._bindEventOnVVFilterForm()},_createVCFilterForm:function(){var t=this;t._$vcFilterForm=n("#VCFilterForm");t._bindEventOnVCFilterForm()},_changeCTripId:function(n){this._cTripId=parseInt(n)},_getCTripId:function(){return this._cTripId},_changeCTripIndex:function(n){this._cTripIndex=parseInt(n)},_getCTripIndex:function(){return this._cTripIndex},_changeCFromId:function(n){this._cFromId=parseInt(n)},_changeCToId:function(n){this._cToId=parseInt(n)},_changeCStageCode:function(n){this._cStageCode=n},_changeCMaxStageCode:function(n){this._cMaxStageCode=n},_changeCTripDate:function(t){this._cTripDate=t;n("body").trigger("changeCTripDate",t)},_changeCTripTime:function(t){this._cTripTime=t;n("body").trigger("changeCTripTime",t)},_changeCTripBus:function(n){this._cTripBus=parseInt(n)},_reloadFilter:function(){var t=this,i,r,u;t._hasBookReturnTicket||FlatObj.LDefTrip&&vIsEstStr(app.rights)&&(i=app.rights.match(/\~3\|1\|\d+/g),i!=null?(r=parseInt(i[i.length-1].substring(i[i.length-1].lastIndexOf("|")+1)),isNaN(r)||(t._cTripId=r)):t._cTripId=0,app.rights.indexOf(n.rights.bBookPastTk.val)>=0&&(t._rBookingOnPast=!0));t._reloadTrip();t._reloadStopPoints();typeof _dict._hasDefaultStagePerTrip!="undefined"&&_dict._hasDefaultStagePerTrip&&(typeof _dict._defaultStagePerTrip[t._cTripId]!="undefined"?(u=_dict._defaultStagePerTrip[t._cTripId].split(","),t._cDefaultFromId=parseInt(u[0]),t._cDefaultToId=parseInt(u[1])):(t._cDefaultFromId=t._cFromId,t._cDefaultToId=t._cToId));t._generateStageCode();t._changeCMaxStageCode(t._cStageCode);t._cTripTime=null;t._reloadTimeSlot();t._reloadTimeFromAndTo();_dict._availableSeatOn&&t._reloadAvailableSeat();t._reloadVOTrip();t._reloadVVTrip();t._reloadVCTrip()},_reloadTrip:function(){var t=this,i=t._$filterForm.find("select[name=TripId]").empty(),r=!1;n.each(t._data,function(n,i){t._cTripId==i.Id&&(r=!0)});n.each(t._data,function(u,f){if(typeof _dict._hasBlockTripByBranch=="undefined"||!_dict._hasBlockTripByBranch||typeof _dict._blockTripByBranch=="undefined"||typeof _dict._blockTripByBranch[app.aid]=="undefined"||_dict._blockTripByBranch[app.aid].indexOf(f.Id)==-1){var e=n("<option />",{text:f.Name,value:f.Id});r&&t._cTripId>0?f.Id==t._cTripId&&(e.attr("selected",!0),t._changeCTripIndex(u)):u==0&&(e.attr("selected",!0),t._changeCTripIndex(u),t._changeCTripId(f.Id));i.append(e)}});i.find("option:selected").length<=0&&(i.find("option").first().attr("selected",!0),t._changeCTripTime(i.val()),t._changeCTripIndex(0));t._$filterForm.find('input[name="DepartureDate"]').val(t._cTripDate.toFormatString("DD dd-mm-yyyy"))},_getStopPoints:function(){var n=this;return n._data[n._cTripIndex].StopPoints},_reloadStopPoints:function(){var t=this,s=t._$filterForm.find("select[name=FromPoint]").empty(),h=t._$filterForm.find("select[name=ToPoint]").empty(),o,u,r;if(app.oRights.StageEnable&&n("#StageModule").removeClass("hidden"),t._data[t._cTripIndex]){var i=t._data[t._cTripIndex].StopPoints,f=0,e=i.data.length-1;t._cFromId==0&&i.data[0]!=null&&(t._cFromId=parseInt(i.data[0].Id));t._cToId==0?i.data[e]!=null&&(t._cToId=parseInt(i.data[e].Id)):t._cFromId==t._cToId&&(o=i.idx[t._cFromId],t._cToId=parseInt(i.data[o+1].Id));u=i.idx[t._cFromId];r=i.idx[t._cToId];r<=u&&(r=u+1,t._cToId=i.data[r].Id);app.oRights.StageEnable&&n.each(i.data,function(i,e){var o,c;f<r&&(o=n("<option />",{text:"_",value:e.Id}),e.Id==t._cFromId&&o.attr("selected",!0),s.append(o));f>u&&(c=n("<option />",{text:"_",value:e.Id}),e.Id==t._cToId&&c.attr("selected",!0),h.append(c));f++})}},_reloadTimeFromAndTo:function(){var t=this,h=t._$filterForm.find("select[name=FromPoint]"),c=t._$filterForm.find("select[name=ToPoint]");if(app.oRights.StageEnable&&n("#StageModule").removeClass("hidden"),t._data[t._cTripIndex]){var u=t._data[t._cTripIndex].StopPoints,f=0,l=u.data.length-1,e=u.idx[t._cFromId],o=u.idx[t._cToId];o<=e&&(o=e+1,t._cToId=u.data[o].Id);var s=t._$filterForm.find("select[name=TimeSlot] option:selected").val().split(":"),r=parseInt(s[0]),i=parseInt(s[1]);n.each(u.data,function(n,t){var u,o;r+=t.Hour;i+=t.Minute;i>=60&&(i-=60,r+=1);r=r%24;f<l&&(u=h.find('option[value="'+t.Id+'"]'),u.html(t.Code+" - "+t.Name+" - "+r+":"+(i<10?"0":"")+i));f>e&&(o=c.find('option[value="'+t.Id+'"]'),o.html(t.Code+" - "+t.Name+" - "+r+":"+(i<10?"0":"")+i));f++})}},_reloadTimeSlot:function(){var t=this,s=t._$filterForm.find("select[name=TimeSlot]").empty(),c=new Date,u,e,i,r,l,o,h;if(c.setSeconds(0),u=new Date(t._cTripDate.getTime()),u.setSeconds(0),e={},t._data[t._cTripIndex])for(i=Object.keys(t._data[t._cTripIndex].Ts),l=i.length,i.sort(),r=0;r<l;r++)if(app.rights.indexOf(n.rights.bUBlockBks.val)==-1)if(typeof _dict._hasBlockBKSByTime!="undefined"&&_dict._hasBlockBKSByTime&&typeof _dict._dayBlockBKS!="undefined"&&typeof _dict._hourBlockBKS!="undefined"&&typeof _dict._minuteBlockBKS!="undefined"){var v=_dict._dayBlockBKS,y=_dict._hourBlockBKS,p=_dict._minuteBlockBKS,f=new Date;if(f.setDate(f.getDate()-v),f.setHours(f.getHours()-y),f.setMinutes(f.getMinutes()-p),i[r]!=null){var a=i[r].split(":"),w=parseInt(a[0]),b=parseInt(a[1]);u.setHours(w);u.setMinutes(b);f<=u&&(e[i[r]]=t._data[t._cTripIndex].Ts[i[r]])}}else e[i[r]]=t._data[t._cTripIndex].Ts[i[r]];else e[i[r]]=t._data[t._cTripIndex].Ts[i[r]];o=!1;n.each(e,function(i,r){var e,f,h;r[0].S!=3&&(e=i,r[0].S==2&&(e+=" - Tăng cường"),f=n("<option />",{text:e,value:i}),o||(h=i.split(":"),u.setHours(parseInt(h[0])),u.setMinutes(parseInt(h[1])),t._cTripTime!=null?i==t._cTripTime&&(f.attr("selected",!0),o=!0):u>c&&(f.attr("selected",!0),o=!0)),s.append(f))});o||(h=s.find("option:first-child"),h.attr("selected",!0),t._changeCTripTime(h.val()));s.val()!=t._cTripTime&&t._changeCTripTime(s.val())},_reloadBus:function(){var t=this,i=t._$filterForm.find("select[name=Bus]").empty(),r=0;n.each(t._data[t._cTripIndex].Ts[t._cTripTime],function(u,f){if(typeof f!="undefined"&&f!=null&&f.S!=3){var e=n("<option />",{text:"Bus "+u,value:u});t._cTripBus!=null?u==t._cTripBus&&e.attr("selected",!0):r==0&&(e.attr("selected",!0),t._changeCTripBus(u));i.append(e);r++}});i.val()!=t._cTripBus&&t._changeCTripBus(i.val())},_search:function(t,i){var r=this,u;r._clearSelectedItem();r._resetSeatStack();vIsEstStr(t)&&(u="",typeof i!="undefined"&&i?(u=n.trim(t).toUpperCase(),typeof r._cCodeSt[u]!="undefined"&&r._cCodeSt[u].length>0&&(n.each(r._cCodeSt[u],function(t,i){if(!i.disableClickEvent){var u=r._$sheet.find('.seat[data-position="'+i._coach+"_"+i._row+"_"+i._col+'"]');r._grid||(u=r._$sheet.find('.lseat[data-position="'+i._coach+"_"+i._row+"_"+i._col+'"]'));r._updateSeatStack(u,i);!FlatObj.HScrolled&&FlatObj.STBPhone&&(n("html, body").animate({scrollTop:u.offset().top},500),FlatObj.STBPhone=!1,FlatObj.HScrolled=!0)}}),r._selectedCode=u)):(u=n.trim(t).toLowerCase(),typeof r._cphoneSt[u]!="undefined"&&r._cphoneSt[u].length>0&&(n.each(r._cphoneSt[u],function(t,i){if(!i.disableClickEvent){var u=r._$sheet.find('.seat[data-position="'+i._coach+"_"+i._row+"_"+i._col+'"]');r._grid||(u=r._$sheet.find('.lseat[data-position="'+i._coach+"_"+i._row+"_"+i._col+'"]'));r._updateSeatStack(u,i);!FlatObj.HScrolled&&FlatObj.STBPhone&&(n("html, body").animate({scrollTop:u.offset().top},500),FlatObj.STBPhone=!1,FlatObj.HScrolled=!0)}}),r._selectedPhone=u)))},_searchCancelled:function(t,i){var r=this,u,f;r._clearSelectedItem();r._resetSeatStack();u="";f=!1;vIsEstStr(t)&&(typeof i!="undefined"&&i?(u=n.trim(t).toUpperCase(),f=!1,n.each(r._c,function(t,i){typeof i!="undefined"&&i!=null&&n.each(i,function(t,i){var o,s,e;typeof i!="undefined"&&i!=null&&(o=i._getCurrentTicket(),n.isEmptyObject(o)||(s=o._getTicketCode(),s==u&&(e=r._$cancelSheet.find('.seat[data-position="'+i._coach+"_"+i._row+"_"+i._col+'"]'),r._grid||(e=r._$cancelSheet.find('.lseat[data-position="'+i._coach+"_"+i._row+"_"+i._col+'"]')),r._updateSeatStack(e,i),!FlatObj.HScrolled&&FlatObj.STBPhone&&(n("html, body").animate({scrollTop:e.offset().top},500),FlatObj.HScrolled=!0,FlatObj.STBPhone=!1),f=!0)))})}),f&&(r._selectedCode=u)):(u=n.trim(t).toLowerCase(),f=!1,n.each(r._c,function(t,i){typeof i!="undefined"&&i!=null&&n.each(i,function(t,i){var o,s,e;typeof i!="undefined"&&i!=null&&(o=i._getCurrentTicket(),n.isEmptyObject(o)||(s=o._getDefaultPhoneNumber(),s==u&&(e=r._$cancelSheet.find('.seat[data-position="'+i._coach+"_"+i._row+"_"+i._col+'"]'),r._grid||(e=r._$cancelSheet.find('.lseat[data-position="'+i._coach+"_"+i._row+"_"+i._col+'"]')),r._updateSeatStack(e,i),!FlatObj.HScrolled&&FlatObj.STBPhone&&(n("html, body").animate({scrollTop:e.offset().top},500),FlatObj.STBPhone=!1,FlatObj.HScrolled=!0),f=!0)))})}),f&&(r._selectedPhone=u)))},_reloadVOTrip:function(){var t=this,i=t._$voFilterForm.find("select[name=TripId]").empty();n.each(t._data,function(r,u){r==0?(i.append(n("<option />",{text:u.Name,value:u.Id}).attr("selected",!0)),t._changeCVOTripId(u.Id)):i.append(n("<option />",{text:u.Name,value:u.Id}))})},_reloadVVTrip:function(){var t=this,i=t._$vvFilterForm.find("select[name=TripId]").empty();n.each(t._data,function(r,u){r==0?(i.append(n("<option />",{text:u.Name,value:u.Id}).attr("selected",!0)),t._changeCVVTripId(u.Id)):i.append(n("<option />",{text:u.Name,value:u.Id}))})},_reloadVCTrip:function(){var t=this,i=t._$vcFilterForm.find("select[name=TripId]").empty();n.each(t._data,function(r,u){r==0?(i.append(n("<option />",{text:u.Name,value:u.Id}).attr("selected",!0)),t._changeCVCTripId(u.Id)):i.append(n("<option />",{text:u.Name,value:u.Id}))})},_changeCVOTripId:function(n){this._cVOTripId=parseInt(n)},_changeCVVTripId:function(n){this._cVVTripId=parseInt(n)},_changeCVCTripId:function(n){this._cVCTripId=parseInt(n)},_isStageBooking:function(){var n=this;return n._cStageCode<n._cMaxStageCode},reloadAll:function(){var n=this;n._reloadFrame();n._generateStageCode();n._reloadSheet();n._reloadStopPoints();n._reloadTimeFromAndTo();n._fMoving||(n._resetSeatStack(),n._clearSelectedItem())},selectStage:function(n,t){var i=this,r=i._$filterForm;i._changeCFromId(n);i._changeCToId(t);r.find("select[name=FromPoint]").val(n);r.find("select[name=ToPoint]").val(t);i.reloadAll()},_bindEventOnBSFilterForm:function(){var i=this,r=new Date,t=i._$BSfilterForm;t.find("#calendar_drown").datepicker({dateFormat:"dd-mm-yy",defaultDate:r,onSelect:function(n){t.find("button").html(n)}}).hide();t.find("button").on("click",function(){n("#calendar_drown").hide()})},_bindEventOnFilterForm:function(){var t=this,r=new Date,i=t._$filterForm;i.find("input.datepicker").not("[readonly]").datepicker({dateFormat:"DD dd-mm-yy",defaultDate:r,beforeShowDay:function(t){if(app.rights.indexOf(n.rights.bUBlockBks.val)==-1&&typeof _dict._hasBlockBKSByTime!="undefined"&&_dict._hasBlockBKSByTime&&typeof _dict._dayBlockBKS!="undefined"&&typeof _dict._hourBlockBKS!="undefined"){var r=!0,u="available",i=new Date,e=i.getHours(),f=_dict._dayBlockBKS,o=_dict._hourBlockBKS;return e-o<0&&(f+=1),i.setDate(i.getDate()-f),i.setHours(0),i.setMinutes(0),i.setSeconds(0),i.setMilliseconds(0),t<i&&(r=!1,u="unavailable"),[r,u]}return[!0,"available"]}}).val(r.toFormatString("DD dd-mm-yyyy"));t._bindEventOnCalendarIcon();i.find("button").each(function(i,r){if(n(r).hasClass("btn-print"))n(r).unbind().on("click",function(i){i.preventDefault();n("body").trigger("fPrintExcuse",t)});else if(n(r).hasClass("btn-refresh"))n(r).unbind().on("click",function(i){i.preventDefault();oRq.cEl=n(this);oRq.cLType=1;oRq.cKey="refresh";oRq.cAType=2;oRq.iAc=!0;n("button.btn-thong-ke").removeClass("active");n(this).find("i").addClass("glyphicon-refresh-animate");_dict._availableSeatOn&&t._reloadAvailableSeat();t._resetSeatStack();t._clearSelectedItem();t._reloadSheet();n(this).find("i").removeClass("glyphicon-refresh-animate")});else if(n(r).hasClass("btn-pickup"))n(r).unbind().on("click",function(i){i.preventDefault();t._isOrderring=!0;t._reloadSheet();n(".select-layout > button").removeClass("active");n("button.btn-thong-ke").removeClass("active")});else if(n(r).hasClass("btn-backup"))n(r).unbind().on("click",function(i){i.preventDefault();n("button.btn-thong-ke").removeClass("active");t.backupBKS(n(r));n(r).attr("disabled","disabled")});else if(n(r).hasClass("btn-xuat-ben"))n(r).unbind().on("click",function(i){i.preventDefault();n("#FilterForm .btn-refresh").trigger("click");n("button.btn-thong-ke").removeClass("active");t._createXuatBenDialogDiv()});else if(n(r).hasClass("btn-thong-ke"))n(r).unbind().on("click",function(i){n(this).hasClass("active")||(i.preventDefault(),n(this).addClass("active"),n(".select-layout > button").removeClass("active"),t._thongKeTheoChuyen())})});i.find("select[name=TripId]").on("change",function(){var i=this.value,r;n("tr.jtable-data-row").removeClass("jtable-row-selected");n("tr.jtable-data-row[data-record-key="+i+"]").addClass("jtable-row-selected");t._changeCTripId(this.value);t._changeCTripIndex(this.selectedIndex);t._changeCFromId(0);t._changeCToId(0);t._reloadStopPoints();t._reloadTimeSlot();t._reloadTimeFromAndTo();t._reloadFrame();t._generateStageCode();t._changeCMaxStageCode(t._cStageCode);t._reloadAllowedSeats();t._reloadSheet();t._fMoving||(t._resetSeatStack(),t._clearSelectedItem());_dict._availableSeatOn&&t._reloadAvailableSeat();typeof _dict._hasDefaultStagePerTrip!="undefined"&&_dict._hasDefaultStagePerTrip&&(typeof _dict._defaultStagePerTrip[i]!="undefined"?(r=_dict._defaultStagePerTrip[i].split(","),t._cDefaultFromId=parseInt(r[0]),t._cDefaultToId=parseInt(r[1])):(t._cDefaultFromId=t._cFromId,t._cDefaultToId=t._cToId))});i.find("select[name=FromPoint]").on("change",function(){t._changeCFromId(this.value);t.reloadAll()});i.find("select[name=ToPoint]").on("change",function(){t._changeCToId(this.value);t.reloadAll()});i.find("input[name=DepartureDate]").on("change",function(){FlatObj.FTripGetTrip=!1;var n=this.value.split(" ");t._changeCTripDate(vPrsDt(n[n.length-1]));t._hasSearchPhone||(t._cTripTime=null,t._cTripBus=0);t.reload();t._fMoving||(t._resetSeatStack(),t._clearSelectedItem())});i.find("a[name=PreDate]").on("click",function(){var t=n("#FilterForm input[name=DepartureDate]").datepicker("getDate");t.setDate(t.getDate()-1);n("#FilterForm input[name=DepartureDate]").datepicker("setDate",new Date(t));n("#FilterForm input[name=DepartureDate]").trigger("change")});i.find("a[name=NexDate]").on("click",function(){var t=n("#FilterForm input[name=DepartureDate]").datepicker("getDate");t.setDate(t.getDate()+1);n("#FilterForm input[name=DepartureDate]").datepicker("setDate",new Date(t));n("#FilterForm input[name=DepartureDate]").trigger("change")});i.find("select[name=TimeSlot]").on("change",function(){t._changeCTripTime(this.value);t._reloadFrame();t._reloadSheet();t._fMoving||(t._resetSeatStack(),t._clearSelectedItem());t._reloadTimeSlot();t._reloadTimeFromAndTo();_dict._availableSeatOn&&t._reloadAvailableSeat()});i.find("select[name=Bus]").on("change",function(){t._changeCTripBus(this.value);t._reloadFrame();t._reloadSheet();t._fMoving||(t._resetSeatStack(),t._clearSelectedItem())});t._$searchTicketFilter=n("input[name=Keyword]");t._$searchTicketFilter.focus(function(){t._fMoving||(t._clearSelectedItem(),t._resetSeatStack())}).keyup(function(n){this.value.length==6?(n.preventDefault(),n.stopPropagation(),t._searchTicket(this.value,!0)):vIsNumKey(n)?this.value.length==3||this.value.length>=6?(n.preventDefault(),n.stopPropagation(),t._searchTicket(this.value)):(n.preventDefault(),n.stopPropagation(),t._clearSearchResult()):_dict._arrows.indexOf(n.keyCode)==-1&&(n.preventDefault(),n.stopPropagation(),t._clearSearchResult())});t._$searchTicketFilter.bind("paste",function(n){this.value=n.originalEvent.clipboardData.getData("Text");this.value.length==6||this.value.length==10||this.value.length==11?(n.preventDefault(),n.stopPropagation(),this.value.length==6?t._searchTicket(this.value,!0):isNaN(this.value)||t._searchTicket(this.value)):(n.preventDefault(),n.stopPropagation(),t._clearSearchResult());t._$searchTicketFilter.blur()})},_bindEventOnCalendarIcon:function(){var t=this,i=t._$filterForm;i.find(".glyphicon-calendar").parent().on("click",function(){n(this).prev().datepicker("show")})},_bindEventOnVOFilterForm:function(){var n=this,t=n._$voFilterForm;t.find("select[name=TripId]").on("change",function(){n._changeCVOTripId(this.value);n._reloadVO()})},_bindEventOnVVFilterForm:function(){var n=this,t=n._$vvFilterForm;t.find("select[name=TripId]").on("change",function(){n._changeCVVTripId(this.value);n._reloadVV()})},_bindEventOnVCFilterForm:function(){var n=this,t=n._$vcFilterForm;t.find("select[name=TripId]").on("change",function(){n._changeCVCTripId(this.value);n._reloadVC()})},_searchTicket:function(t,i){var r=this,o,s,h,e;if(app.module.toLowerCase()=="bks")o=r._createSearchTicketObj(t,i),s=function(n,t,u,f){n==1&&(r._clearSearchResult(),u>0&&r._mapSearchResult(t,f),r._renderSearchResult(i),r._bindEventOnSearchResult(),FlatObj.HScrolled=!1,FlatObj.STBPhone=!0)},r._submitAction(o,s);else{var u={},f=[],c=r._crProOrderObj(t),l=function(i,e,o){o>0&&n.each(e,function(n,i){var u=r._convertDbIntoSearchPhone(i,t);f.push(u)});u.listResult=f;u.totalItems=f.length};r._submitAction(c,l);h=n.getHtml("search-phone",u);r._clearSearchResult();r._$searchTicketFilter.parent().append(h);e=r._$searchTicketFilter.parent().find("li");e.on("click",function(t){t.preventDefault();t.stopPropagation();var i=n(this).attr("data-proid"),u=n(this).attr("data-tripid"),f=n(this).attr("data-triptime"),e=n(this).attr("data-tripdate"),o=n(this).attr("data-typeofview");n("#product-content").product("load",{proId:i,pIndex:1,pSize:10,tId:u,tTime:f,tDate:e,tOView:o});r._clearSearchResult();r._$searchTicketFilter.val("")}).hover(function(){e.removeClass("selected");n(this).addClass("selected")})}},_crProOrderObj:function(n){var t={};return t._a="fGetProductOrder",t._c={PickupInfo:"($x like N'%"+n+"%' or DropOffInfo like N'%"+n+"%') order by IsPrgCreatedDate desc"},t._f="Id,TripTime,TripDate,PickupInfo,DropOffInfo,Fare,Status,TripId,AgentInfo,ReceivedAgentInfo",t},_convertDbIntoSearchPhone:function(n,t){var i={},u=n[3].split("|"),r,f,e;i.senderName=u[3].length>10?vGln(u[3]):u[3];i.senderPhone=u[4];i.keySender=u[4].indexOf(t)==0?"vred":"";r=n[4].split("|");i.receiverName=r[3].length>10?vGln(r[3]):r[3];i.receiverPhone=r[4];i.keyReceiver=r[4].indexOf(t)==0?"vred":"";f=n[8].split("|");i.fromName=f[2];e=n[9].split("|");i.toName=e[2];i.fare=vToMn(n[5]);i.proId=n[0];i.tripId=n[7];i.tripTime=n[1];i.tripDate=vPrsDt(n[2]).toFormatString("dd-mm-yyyy");vIsEstStr(i.tripTime)&&vIsEstStr(i.tripDate)&&(i.tripDepartureDate="/ "+i.tripTime+" ngày "+i.tripDate);switch(parseInt(n[6])){case 1:i.status="Chưa nhận";i.typeOfView="kho-hang-di";break;case 2:i.status="Chưa nhận";i.typeOfView="kho-hang-di";break;case 3:i.status="Chưa nhận";i.typeOfView="xem-chuyen";break;case 4:i.status="Đã nhận";i.typeOfView="xem-chuyen";break;case 5:i.status="Chưa nhận";i.typeOfView="xem-chuyen";break;case 6:i.status="Đã nhận";i.typeOfView="xem-chuyen";break;case 7:i.status="Chưa giao";i.typeOfView="kho-hang-ve";break;case 8:i.status="Chưa giao";i.typeOfView="kho-hang-ve";break;case 9:i.status="Đã giao";i.typeOfView="kho-hang-ve";break;default:i.status="";i.typeOfView=""}return i},_createSearchTicketObj:function(t,i){var e=this,c=n("input[name=type_filterdate]").val(),h=e._getLimitedDate(),l=e._$BSfilterForm,r={},u,f,s;if(typeof i!="undefined"&&i)r._a="fGetCustomerTripTicket",r._c={Code:n.trim(t).toUpperCase()},r._f="Id, TripId, AgentId, SeatCode, PickupDate, CustomerInfo, Status, Fare, Note, PickupInfo, Code, TripDate, CustomerNote";else{r._a="fGetCustomerTripDetail";u="($x like N'%"+t+"%')";switch(t.length){case 3:u="($x like N'%"+t+"')";break;case 4:case 5:u="($x like N'%"+t+"%')";break;case 6:u="($x like N'"+t+"%')"}f="$x >= '"+h.toFormatString("iso")+"'";switch(parseInt(c)){case 1:f="$x >= '"+h.toFormatString("iso")+"'";break;case 2:f="$x is not null";break;case 3:var a=l.find("button").html(),v=new Date(vPrsDt(a).getTime()),o=new Date;o.setDate(v.getDate()-1);s=new Date;s.setDate(o.getDate()+2);f="$x > '"+o.toFormatString("iso")+"' and $x < '"+s.toFormatString("iso")+"'"}r._c=[{CompId:parseInt(e.options.cid),Phone:u,IsPrgStatus:"$x != 3"},{CustomerTripIdTripDate:f}];r._f="Id, Name, Note, Phone, BookingTicket, TotalBooking, PaidTicket, TotalPaid, CancelTicket, TotalCancel, NotComeTicket, TotalNotCome, PassTicket, TotalPass, KeepOnTimeTicket, TotalKeepOnTime, CustomerTripIdTripId, CustomerTripIdTripDate, CustomerTripIdBookingTicket, CustomerTripIdTotalBooking, CustomerTripIdListSeatBooking, CustomerTripIdPaidTicket, CustomerTripIdTotalPaid, CustomerTripIdListSeatPaid, CustomerTripIdCancelTicket, CustomerTripIdTotalCancel, CustomerTripIdListSeatCancel, CustomerTripIdNotComeTicket, CustomerTripIdTotalNotCome, CustomerTripIdListSeatNotCome, CustomerTripIdPassTicket, CustomerTripIdTotalPass, CustomerTripIdListSeatPass, CustomerTripIdKeepOnTimeTicket, CustomerTripIdTotalKeepOnTime, CustomerTripIdListSeatKeepOnTime, CustomerTripIdTripName, CustomerTripIdNote, CustomerTripIdPickupInfo"}return r},_clearSearchResult:function(){var n=this;n._searchResult=[];n._totalSearchResult=0;n._$searchTicketFilter.parent().find("div.search-result").remove();n._hasSearchPhone=!1},_mapSearchResult:function(n,t){var i=this;i._searchResult=n;i._totalSearchResult=t},_renderSearchResult:function(t){var u=this,e,s=0,p,r;if(u._totalSearchResult>0)if(e=n("<ul />").addClass("search-items"),typeof t!="undefined"&&t){var c=[],h=[],w="",b="",f="",o=null,g="",l="",nt=[],tt=0,k="",it=null,rt=0,i={},d="",a="",v="",y={};n.each(u._searchResult,function(n,t){var e,s,p,ut,ot,st;if(typeof t!="undefined"&&t!=null){var ft=[],et="",r="";vIsEstStr(t[5])&&(e=t[5].split("|"),vIsEstStr(e[3])&&c.indexOf(e[3])<0&&c.push(e[3]),vIsEstStr(e[4])&&h.indexOf(e[4])<0&&h.push(e[4]));b=t[10];w=t[12];f=t[9];rt+=parseInt(t[7]);vIsEstStr(f)?(s=f.split("|"),f=s[0]?"&nbsp/Đón:&nbsp"+s[0]:s[1]?"&nbsp/T.C:&nbsp"+s[1]:""):f="";it=t[2];o=parseInt(t[1]);g=vPrsDt(t[4]);p=t[3].split("|");nt.push(p[0]);tt++;ut=parseInt(t[6]);k=_dict._stn[ut].vi;ut==3&&(et="isCancelled");y.hasOwnProperty(o)?l=y[o]:(ot=function(n,t,i){n!=1||i<=0||(y[o]=t[0][0],l=t[0][0])},st={_a:"fGetTrip",_c:{Id:o},_f:"Name"},u._submitAction(st,ot));v=vPrsDt(t[11]).toFormatString("hh:mm");a=vPrsDt(t[11]).toFormatString("dd-mm-yyyy");d=v+" "+a;r=d+" "+ut;ft.push(p[0]);typeof i[r]!="undefined"?(i[r][3].push(p[0]),i[r][4]+=parseInt(t[7])):(i[r]={},i[r][0]=b,i[r][1]=c,i[r][2]=h,i[r][3]=ft,i[r][4]=parseInt(t[7]),i[r][5]=l,i[r][6]=a,i[r][7]=v,i[r][8]=k,i[r][9]=f,i[r][10]=w,i[r][11]=o,i[r][12]=et)}});for(p in i)i.hasOwnProperty(p)&&(r=i[p],e.append(n('<li style="overflow: hidden;  white-space: nowrap;" />').attr("tid",r[11]).attr("type",r[12]).attr("tdate",r[6]).attr("ttime",r[7]).attr("code",r[0]).html("Mã vé:&nbsp<span class='vred'>"+r[0]+"<\/span> - "+r[1].join(",")+'<span style="color: gray;font-size: smaller;font-weight: lighter;">&nbsp;'+(r[10]==null?"":"("+r[10]+")")+"&nbsp;<\/span>(<span class='vred'>"+r[2].join(" ,")+"<\/span>) / <span class='vred'>"+r[3].length+"<\/span> vé "+r[3].join(",")+" / <span class='vred'>"+r[4].toMn(0,",",".")+"₫<\/span> / "+r[5]+" /  ngày <span class='vred'>"+r[6]+"<\/span> lúc <span class='vred'>"+r[7]+"<\/span> / "+r[8]+r[9]+'<button class="customer-profile customer-profile-item btn btn-sm btn-primary" title="Chỉnh sửa thông tin khách hàng" style="position: absolute;right: 20px;margin:2px;" data-phone="'+h+'"><i class="glyphicon glyphicon-edit"><\/i> Edit<\/button>')),s++)}else n.each(u._searchResult,function(t,i){var h;if(typeof i!="undefined"&&i!=null){var c=i[1],u=i[3],o=i[37],f=i[38];vIsEstStr(f)?(h=f.split("|"),f=h[0]?"&nbsp/Đón:&nbsp"+h[0]:h[1]?"&nbsp/T.C:&nbsp"+h[1]:""):f="";o=vIsEstStr(o)?"&nbsp;/&nbsp;"+o:"";var l=parseInt(i[4]+i[6]+i[12]+i[14]),a=parseInt(i[8]+i[10]),nt=parseInt(i[5]+i[7]+i[13]+i[15]),v=parseInt(i[16]),r=vPrsDt(i[17]),y=i[36],p=parseInt(i[18]+i[21]+i[30]+i[33]),b=parseInt(i[19]+i[22]+i[31]+i[34]),k=[i[20],i[23],i[32],i[35]],w=parseInt(i[24]+i[27]),d=parseInt(i[25]+i[28]),g=[i[26],i[29]];p>0&&(e.append(n('<li style="overflow: hidden;  white-space: nowrap;" />').attr("tid",v).attr("tdate",r.toFormatString("dd-mm-yyyy")).attr("ttime",r.toFormatString("hh:mm")).attr("phone",u).html(c+" <span class='vred'>("+u+')<\/span><span style="color: gray;font-size: smaller;font-weight: lighter;">&nbsp;'+(i[2]==null?"":"("+i[2]+")")+"&nbsp;<\/span>- Đặt:&nbsp;<span class='vred'>"+l+"<\/span> - Hủy:&nbsp;<span class='vred'>"+a+"<\/span> / Đã đặt - <span class='vred'>"+p+"<\/span> vé "+k.filter(function(n){return n!==null}).join(", ")+" / <span class='vred'>"+b.toMn()+"₫<\/span> / "+y+" / ngày <span class='vred'>"+r.toFormatString("dd-mm-yyyy")+"<\/span> lúc <span class='vred'>"+r.toFormatString("hh:mm")+"<\/span> "+f+o+'<button class="customer-profile customer-profile-item btn btn-sm btn-primary" title="Chỉnh sửa thông tin khách hàng" data-phone="'+u+'"><i class="glyphicon glyphicon-edit"><\/i> Edit<\/button>')),s++);w>0&&(e.append(n('<li style="overflow: hidden;  white-space: nowrap;" />').attr("tid",v).attr("type","isCancelled").attr("tdate",r.toFormatString("dd-mm-yyyy")).attr("ttime",r.toFormatString("hh:mm")).attr("phone",u).html(c+" <span class='vred'>("+u+')<\/span><span style="color: gray;font-size: smaller;font-weight: lighter;">&nbsp;'+(i[2]==null?"":"("+i[2]+")")+"&nbsp;<\/span>- Đặt:&nbsp;<span class='vred'>"+l+"<\/span> - Hủy:&nbsp;<span class='vred'>"+a+"<\/span> / Đã hủy - <span class='vred'>"+w+"<\/span> vé "+g.filter(function(n){return n!==null}).join(", ")+" / <span class='vred'>"+d.toMn()+"₫<\/span> / "+y+" / ngày <span class='vred'>"+r.toFormatString("dd-mm-yyyy")+"<\/span> lúc <span class='vred'>"+r.toFormatString("hh:mm")+"<\/span> "+f+o+'<button class="customer-profile customer-profile-item btn btn-sm btn-primary" title="Chỉnh sửa thông tin khách hàng" data-phone="'+u+'"><i class="glyphicon glyphicon-edit"><\/i> Edit<\/button>')),s++)}});else e=n("<div />").html('<p class="not-found">Không tìm thấy số điện thoại hoặc mã vé<\/p>');u._$filterSearchResult=n("<div />").addClass("dropdown-menu search-result").append(n("<div />").addClass("search-title").append("Kết quả tìm kiếm").append(n("<span />").append("X").on("click",function(){u._clearSearchResult();u._$searchTicketFilter.val("")}))).append(e).append(n("<div />").addClass("search-summary").append("Tổng số ("+s+" phần tử)"));u._$searchTicketFilter.parent().append(u._$filterSearchResult);n(".customer-profile-item").unbind().click(function(t){t.stopPropagation();t.preventDefault();app.cusphone=n(this).attr("data-phone");n("#showCustomerProfile").trigger("click")})},_bindEventOnSearchResult:function(){var t=this,i;t._totalSearchResult>0&&(i=t._$filterSearchResult.find("li"),i.on("click",function(i){var r,s,f,e,o;i.preventDefault();i.stopPropagation();r=parseInt(n(this).attr("tid"));s=t._cTripId;r!=s&&(t._changeCTripId(r),t._$filterForm.find("select[name=TripId]").val(r),n.each(t._$filterForm.find("select[name=TripId] option"),function(i,u){n(u).attr("value")==r&&t._changeCTripIndex(i)}));f=n(this).attr("tdate");t._changeCTripDate(vPrsDt(f));t._$filterForm.find("input[name=DepartureDate]").val(vPrsDt(f).toFormatString("DD dd-mm-yyyy"));e=n(this).attr("ttime");t._changeCTripTime(e);t._$filterForm.find("select[name=TimeSlot]").val(e);n("a[data-tab=bks]","ul.vbooking-list").trigger("click");t._hasSearchPhone=!0;t._changeCFromId(0);t._changeCToId(0);t._reloadStopPoints();t._reloadTimeSlot();t._reloadTimeFromAndTo();_dict._availableSeatOn&&t._reloadAvailableSeat();t._reloadFrame();t._generateStageCode();t._changeCMaxStageCode(t._cStageCode);var h=n(this).attr("phone"),u=n(this).attr("code"),c=n(this).attr("type"),l=function(){t._$searchTicketFilter.val("").blur();c=="isCancelled"?typeof u=="undefined"?t._searchCancelled(h,!1):t._searchCancelled(u,!0):typeof u=="undefined"?t._search(h,!1):t._search(u,!0);t._clearSearchResult()};t._reloadSheet(l);t._reloadAllowedSeats();t._reloadData();typeof _dict._hasDefaultStagePerTrip!="undefined"&&_dict._hasDefaultStagePerTrip&&(typeof _dict._defaultStagePerTrip[r]!="undefined"?(o=_dict._defaultStagePerTrip[r].split(","),t._cDefaultFromId=parseInt(o[0]),t._cDefaultToId=parseInt(o[1])):(t._cDefaultFromId=t._cFromId,t._cDefaultToId=t._cToId));t._reloadVOTrip();t._reloadVVTrip();t._reloadVCTrip()}).hover(function(){i.removeClass("selected");n(this).addClass("selected")}),t._bindArrowEventList(i))},_reloadTripStatistic:function(){var n=this,t=n._createGetTripStatisticObj(),i=function(n){n!=1};n._submitAction(t,i)},_createGetTripStatisticObj:function(){var t=this,n={};return n._a="sGetTripInfo",n._c={TripId:parseInt(t._cTripId),TripDate:"convert(nvarchar(10), $x, 105) = '"+t._cTripDate.toFormatString("dd-mm-yyyy")+"'"},n._f="*",n},_generateStageCode:function(){var n=this;n._data[n._cTripIndex]&&n._generateStageCodeByAreaId(n._data[n._cTripIndex].StopPoints,n._cFromId,n._cToId)},_generateStageCodeByAreaId:function(n,t,i){var r=this,u=Object.keys(n.idx),f=u.length-1,e=n.idx[t.toString()],o=n.idx[i.toString()];r._cStageBinary=r._generateStageCodeByAreaIndex(f,e,o);r._cStageBinary==""&&(r._cStageBinary="1");r._cStageCode=parseInt(r._cStageBinary,2)},_generateStageCodeByAreaIndex:function(n,t,i){var u="",f,r;for(t>i&&(f=t,t=i,i=f),t++,r=1;r<=n;r++)u+=r>=t&&r<=i?"1":"0";return u},_reloadAvailableSeat:function(){var n=this,t=n._createGetTripTotalSeatInfoObj(),i=function(t,i){t==1&&n._mapAvailableSeat(i)};n._submitAsyncAction(t,i)},_createGetTripTotalSeatInfoObj:function(){var t=this,n={};return n._a="sGetTripTotalSeatInfo",n._c={TripId:parseInt(t._cTripId),TripDate:"convert(nvarchar(10), $x, 105) = '"+t._cTripDate.toFormatString("dd-mm-yyyy")+"'"},n._f="*",n},_mapAvailableSeat:function(t){var i=this,r=i._$filterForm.find("select[name=TimeSlot] option");n.each(r,function(r,u){var e=0,o,f;n.each(t,function(n,t){u.value==t[2]&&(e=t[3])});typeof i._data[i._cTripIndex].Ts[u.value]!="undefined"&&(o=i._data[i._cTripIndex].Ts[u.value][0].NS-e,f=u.value,i._data[i._cTripIndex].Ts[u.value][0].S==2&&(f+=" - Tăng cường"),n(u).text(f+" / Ghế trống "+o))})}})})(jQuery);$(document).mouseup(function(n){var t=$("div.search-result");t.is(n.target)||t.has(n.target).length!==0||(t.hide(),$("#inputSuccess2").val(""))});$("div.input-group-btn ul.dropdown-menu li a").click(function(n){var t=$(this).parent().parent().parent(),r=t.find("button"),i=$(this).attr("data-value");return $("input[name=type_filterdate]").val(i),i=="3"?$("#calendar_drown").show():(r.html($(this).text()+' <span class="caret"><\/span>'),t.removeClass("open")),n.preventDefault(),!1});
//# sourceMappingURL=p.min.js.map
