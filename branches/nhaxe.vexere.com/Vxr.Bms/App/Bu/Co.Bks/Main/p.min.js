define({_reloadBks:function(){$("#report").hide();$("#product-content").hide();$("#bksContent").show();$("#bTickets").hide();$("#roleConfig").hide();FlatObj.LFTime=!0;FlatObj.FTripGetTrip=!1;FlatObj.LDefTrip=!0;$("#bksContent").vbooking(window.app);$("#bksContent").vbooking("load");$("#bksContent").vbooking("startNotification")},start:function(n){var t=this;t._reloadBks(n);$(document).keypress(function(n){if(n.keyCode==13&&!$("#update-popup input").is(":focus")){var t=$("#update-popup");t.hasClass("in")&&$("#update-popup .btn-update").trigger("click")}})}}),function(n){var t={_create:n.custom.vbooking.prototype._create};n.extend(!0,n.custom.vbooking.prototype,{options:{},_seatStack:null,_selectedPhone:null,_selectedCode:"",_ctrlOn:!1,_fMoving:!1,_movingStack:null,_cMovingSeat:null,_cMovingTrip:null,_$updateForm:null,_$validForm:null,_$historyForm:null,_hasCopyTicket:!1,_hasBookReturnTicket:!1,_cBookReturnTripId:null,_copyInfo:{},_seatToBeUpdatedReturningInfo:[],_dataToBeSavedReturningInfo:{date:"",code:""},_$modal:null,_$cmodal:null,_$emodal:null,_$popModal:null,_$xuatbenModal:null,_$chotphoiModal:null,_suggestCustomer:[],_totalSuggestCustomer:0,_isBooking:!1,_$xuatbenButton:null,_$connection:null,_isFirstTime:!0,_allowBookAllSeat:!0,_allowedSeats:[],_create:function(){(t._create.apply(this,arguments),this.options.serviceUrl)&&(this._initializeBookingFields(),this._createUpdateDialogDiv(),this._createCancelDialogDiv(),this._createErrorDialogDiv(),this._createQuickBookDiv(),this._bindEventOnSheet())},_createQuickBookDiv:function(){var i=this,t=n('<div class="panel panel-primary" />').append(n('<div class="panel-heading" />').append(n('<h3 class="panel-title" />').html("Đặt vé nhanh"))).append(n('<div class="panel-body" style="padding:15px !important;" />').append(n('<div class="alert alert-danger warning-message" role="alert" style="margin-bottom:10px;" />').css("display","none")).append(n('<input type="hidden" name="StatusInfo" value="2" />')).append(n('<input type="hidden" name="NumClick" value="0" />')).append(n('<ul id="seat-no" class="list-group" />')).append(n('<div class="clearfix" />')).append(n('<div class="row mt10" />').append(n('<div class="col-md-12" />').append(n('<label class="col-md-6 pl0" name="RouteName" type="label" />')).append(n('<label class="col-md-6" name="DepartureDate" type="label" />'))).append(n('<div class="col-md-12 mt10 checkbox-route-point" />')).append(n('<div class="col-md-6 mt10" />').append(n('<label class="control-label col-md-4 pl0" />').css("margin-top","8px").html("Giá vé")).append(n('<div class="input-group" />').append(n('<input type="text" name="Fare" class="form-control vblue fw700" value="" />')).append(n('<div class="input-group-addon" />').html("đ")))).append(n('<div class="col-md-6 mt10" />').append(n('<label class="control-label col-md-4 pl0" />').css("margin-top","8px").html("Tổng tiền")).append(n('<div class="input-group" />').append(n('<input type="text" name="TotalFare" class="form-control vblue fw700" disabled="disabled" value="" />')).append(n('<div class="input-group-addon" />').html("đ")))).append(n('<div class="clearfix" />')).append(n('<div class="col-md-6 mt10" />').append(n('<label class="control-label col-md-4 pl0" />').css("margin-top","8px").html("Thanh toán")).append(n('<div class="input-group col-md-8" />').append(n('<select class="form-control" name="PaymentType" />')))).append(n('<div class="col-md-6 mt10" />').append(n('<label class="control-label col-md-4 pl0" />').css("margin-top","8px").html("Ghi chú")).append(n('<div class="input-group col-md-8" />').append(n('<input type="text" class="form-control" name="Note" value="" />')))).append(n('<div class="col-md-12 mt10" />').append(n('<button class="btn btn-default close-qBook" type="button" />').html("Đóng")))));typeof _dict._qBookFormButton!="undefined"&&n.each(_dict._qBookFormButton,function(i,r){var u=n('<button type="button" />').css("margin-right","5px").addClass(r[1]).html(r[0]);t.find("button.close-qBook").parent().prepend(u)});i._$quickBookModal=n("<div />").addClass("modal fade pop-payment vbooking-container").attr("id","quick-book-popup").attr("role","dialog").attr("aria-hidden","true").append(n("<div />").addClass("modal-dialog modal-md").append(n("<div />").addClass("modal-content").append(t))).appendTo(n("body"))},_createXuatBenButton:function(){return this._$xuatbenButton=this._$filterForm.find("button.btn-xuat-ben")},_initializeBookingFields:function(){this._seatStack=[];this._movingStack=[];this._selectedPhone="";this._selectedCode=""},_createUpdateDialogDiv:function(){var t=this,i;t._$updateForm=t._createForm(_dict._uForm[0],_dict._uForm[1],_dict._uForm[2]);t._$updateForm.find(".row").last().addClass("action-row").children().first().addClass("list-btn col-xs-12 col-sm-12");t._$validForm=t._createForm(_dict._vForm[0],_dict._vForm[1],_dict._vForm[2]);t._$validForm.find(".row").last().addClass("action-row").children().first().addClass("list-btn");t._$historyForm=t._createHistoryForm();i=n("<div />").addClass("modal-body").css("padding-top",0).append(n("<div />").addClass("container-fluid").append(n("<div />").addClass("row").append(n("<div />").addClass("col-md-1 col-sm-1 col-xs-1").css("padding-right",0).addClass("responsive-xs-l").append(n("<ul />").addClass("list-group").attr("id","seat-no"))).append(n("<div />").addClass("col-md-11 col-sm-11 col-xs-11 pl0-xs mt10-xs").addClass("responsive-xs-r").append(n("<ul />").addClass("nav nav-tabs").attr("role","tab-list").append(n("<li />").addClass("active").append(n("<a />").attr("href","#general").attr("role","tab").attr("data-toggle","tab").attr("data-tab","general").text("Thông tin chung"))).append(n("<li />").append(n("<a />").attr("href","#valid").attr("role","tab").attr("data-toggle","tab").attr("data-tab","valid").text("Vé mở"))).append(n("<li />").append(n("<a />").attr("href","#history").attr("role","tab").attr("data-toggle","tab").attr("data-tab","history").text("Lịch sử")))).append(n("<div />").addClass("tab-content").append(n("<div />").addClass("tab-pane fade in active").attr("id","general").append(t._$updateForm)).append(n("<div />").addClass("tab-pane fade").attr("id","valid").append(t._$validForm)).append(n("<div />").addClass("tab-pane fade").attr("id","history").append(t._$historyForm))))));t._$modal=n("<div />").addClass("modal fade").attr("id","update-popup").attr("role","dialog").attr("aria-hidden","true").append(n("<div />").addClass("modal-dialog modal-md").append(n("<div />").addClass("modal-content").append(n("<div />").addClass("modal-header  bg-primary").css("padding-top","10px").css("padding-bottom","10px").append(n("<h3 />").addClass("modal-title thin-1").html("Cập nhật thông tin").css("font-size","18px"))).append(i))).appendTo(n("body"));t._bindEventOnUpdateForm();t._bindEventOnValidForm();t._bindEventOnHistoryForm()},_createUpdateConflictDialogDiv:function(t){var i=this,r;n("body").find("#updateConflict-popup").remove();r=n("<div />").addClass("modal-body").append(n("<form />").attr("id","UpdateConflictForm").append(n("<table />").addClass("table no-border mb0 table-modal table-condensed").append(n("<tr />").append(n('<td style="border:0;" />').addClass("col-md-6").append(n("<div />").addClass("form-group").attr("area-hidden","true").append(n("<p />").html("Ghế đã được đặt bởi <strong style='color:red'>"+t+"<\/strong>. Đặt chồng vé ?"))))).append(n("<tr />").append(n("<td />").addClass("col-md-12 list-btn").attr("colspan",3).append(n("<button />",{type:"button"}).addClass("btn btn-danger").text("Đồng ý").css("float","left").click(function(){i._closeUpdateConflictDialog();i._transformUpdateFormValue();i._updateTicket();i._selectedPhone="";i._selectedCode="";i._ctrlOn=!1;i._resetCopyInfo();i._resetBookReturnInfo()})).append(n("<button />",{type:"button"}).addClass("btn btn-default").text("Không").css("float","left").click(function(){i._closeUpdateConflictDialog()}))))));i._$updateConflictModal=n("<div />").addClass("modal fade updateConflict-popup").attr("role","dialog").attr("aria-hidden","true").append(n("<div />").addClass("modal-dialog modal-md").append(n("<div />").addClass("modal-content").append(n("<div />").addClass("modal-header").css("background-color","#c9302c").addClass("bg-primary").append(n("<h2 />").addClass("modal-title thin-1").html("Cảnh báo"))).append(r))).appendTo(n("body"));i._$updateConflictModal.modal("show")},_createCancelDialogDiv:function(){var t=this,i,r,u;t._$cmodal=null;i=0;r=0;typeof _dict._cancelFeePercentDefault!="undefined"&&(i=_dict._cancelFeePercentDefault);typeof _dict._cancelFeeMoneyDefault!="undefined"&&(r=_dict._cancelFeeMoneyDefault.toMn());u=n("<div />").addClass("modal-body").css("padding-top","10px").append(n("<form />").attr("id","CancelForm").append(n("<table />").addClass("table no-border mb0 table-modal table-condensed").append(n("<tr />").append(n('<td style="border:0;" />').addClass("col-md-6").append(n('<input type="hidden" name="TicketFares" value="" />')).append(n('<lable class="control-label col-md-2 pr0 pl0 lblFeePercentRadio" style="margin: 5px 0 0 0 !important;"/>').html("Phí hủy vé : ")).append(n("<div />").addClass("input-group col-md-10 divFeePercentRadio").css("margin-top","-2px").append(n('<div class="input-group-addon pl0 " />').css("border","0").css("background-color","transparent").append(n('<input type="radio" name="FeePercentRadio" checked="checked"/>').css("margin-top","3px"))).append(n('<input type="text" class="form-control input-sm" name="CancelFeePercentInput" value="'+i+'" style="border-bottom-left-radius: 3px;border-top-left-radius: 3px;" />')).append(n('<span style="border-bottom-right-radius: 3px;border-top-right-radius: 3px;"/>').addClass("input-group-addon").html("%")).append(n('<div class="input-group-addon pl0" />').css("border","0").css("background-color","transparent").append(n('<input type="radio" name="FeeMoneyRadio" />').css("margin","3px 0 0 25px"))).append(n('<input type="text" class="form-control input-sm" name="CancelFeeMoneyInput" value="'+r+'" style="border-bottom-left-radius: 3px;border-top-left-radius: 3px;" />')).append(n("<span />").addClass("input-group-addon").html("đ"))).append(n('<div style="margin-top:10px;margin-bottom:10px;"/>').addClass("form-group col-md-12 pl0 pr0").append(n('<lable class="control-label col-md-2 pr0 pl0" style="margin: 5px 0 0 0 !important;"/>').html("Lý do hủy vé: ")).append(n('<div class="col-md-10 pl0 pr0" />').append(n('<select class="form-control input-sm cor-black" name="CancelReason"/>').append(n('<option value=""> - - - - - Chọn lý do hủy vé - - - - - <\/option>')).append(n('<option value="1">Nhà xe hủy<\/option>')).append(n('<option value="2">Khách hàng hủy<\/option>')).append(n('<option value="3">Đại lý hủy<\/option>')).append(n('<option value="0">Khác<\/option>'))).change(function(n){n.stopPropagation();n.preventDefault();var i=t._$cmodal.find('select[name="CancelReason"]').val();i!=""&&t._$cmodal.find("div.warning-mess").html("").hide()}))).append(n("<div />").addClass("form-group col-md-12 pl0 pr0").css("margin-bottom","10px").append(n('<lable class="control-label col-md-2 pr0 pl0" />').html("Ghi chú: ")).append(n('<div class="col-md-10 pl0 pr0" />').append(n('<textarea class="col-md-12 form-control input-sm" name="NoteCancel" />')))).append(n('<div style="margin:10px 0;"/>').addClass("form-group").append(n("<p />").html("Bạn có chắc muốn hủy vé đã chọn ?"))))).append(n("<tr />").append(n("<td />").addClass("col-md-12 list-btn").attr("colspan",3).append(n("<button />",{type:"button"}).addClass("btn btn-danger").text("Hủy vé").css("float","left").click(function(){var i=0,r=0,f=!1,e=!1,o,s,u,h;if(t._$cmodal.find('input[name="FeePercentRadio"]').is(":checked")){if(i=t._$cmodal.find('input[name="CancelFeePercentInput"]').val(),isNaN(i)){t._$cmodal.find("div.warning-mess").html("Phí hủy vé không chính xác, vui lòng kiểm tra lại.").show();return}if(i>100){t._$cmodal.find("div.warning-mess").html("Phí hủy vé không được lớn hơn 100%, vui lòng kiểm tra lại.").show();return}f=!0}if(t._$cmodal.find('input[name="FeeMoneyRadio"]').is(":checked")){if(r=t._$cmodal.find('input[name="CancelFeeMoneyInput"]').val().replace(/\./g,""),isNaN(r)){t._$cmodal.find("div.warning-mess").html("Phí hủy vé không chính xác, vui lòng kiểm tra lại.").show();return}if(o=t._$cmodal.find('input[name="TicketFares"]').val(),s=[],n.each(o.split(","),function(n,t){parseInt(r)>parseInt(t)&&s.push(t)}),s.length>0){t._$cmodal.find("div.warning-mess").html("Phí hủy vé không được lớn hơn tổng giá vé: "+o+" đ.").show();return}e=!0}u=t._$cmodal.find('select[name="CancelReason"]').val();h=t._$cmodal.find('textarea[name="NoteCancel"]').val();typeof _dict._cancelReasonRequired!="undefined"&&_dict._cancelReasonRequired?u!=""?(t._cancelTicket(f,i,e,r,u,h),t._resetCancelForm()):t._$cmodal.find("div.warning-mess").html("Vui lòng chọn lý do hủy vé.").show():(t._cancelTicket(f,i,e,r,u,h),t._resetCancelForm())})).append(n("<button />",{type:"button"}).addClass("btn btn-default").text("Đóng").css("float","left").click(function(){t._clearSelectedItem();t._resetSeatStack();t._closeCancelDialog();t._resetCancelForm()}))))));t._$cmodal=n("<div />").addClass("modal fade").attr("id","cancel-popup").attr("role","dialog").attr("aria-hidden","true").append(n("<div />").addClass("modal-dialog modal-md").append(n("<div />").addClass("modal-content").append(n("<div />").addClass("modal-header bg-primary").append(n("<h3 />").addClass("modal-title thin-1").html("Xác nhận"))).append(n('<div class="warning-mess alert alert-danger" role="alert" style="display:none;"/>').css("margin","10px 10px 0 10px")).append(u))).appendTo(n("body"));t._bindEventOnCancelForm()},_createXuatBenDialogDiv:function(){var t=this,i=n("<div />").addClass("modal-body").append(n("<form />").attr("id","XuatBenForm").append(n("<table />").addClass("table no-border mb0 table-modal table-condensed").append(n("<tr />").append(n('<td style="border:0;" />').addClass("col-md-6").append(n("<div />").addClass("form-group").append(n("<p />").html("Khi bấm nút Xuất Bến, phơi sẽ được chốt và tất cả vé đã thanh toán sẽ không còn thay đổi được nữa. Đồng ý ?"))))).append(n("<tr />").append(n("<td />").addClass("col-md-12 list-btn").attr("colspan",3).append(n("<button />",{type:"button"}).addClass("btn btn-danger").text("Đồng ý").css("float","left").click(function(){t._closedTrip();t._closeXuatBenDialog()})).append(n("<button />",{type:"button"}).addClass("btn btn-default").text("Không").css("float","left").click(function(){t._closeXuatBenDialog()}))))));t._$xuatbenModal=n("<div />").addClass("modal fade").attr("id","xuatben-popup").attr("role","dialog").attr("aria-hidden","true").append(n("<div />").addClass("modal-dialog modal-md").append(n("<div />").addClass("modal-content").append(n("<div />").addClass("modal-header bg-primary").append(n("<h3 />").addClass("modal-title thin-1").html("Xác nhận"))).append(i))).appendTo(n("body"));t._$xuatbenModal.modal("show")},_createChotPhoiDialogDiv:function(){var t=this,i=n("<div />").addClass("modal-body").append(n("<form />").attr("id","ChotPhoiPopup").append(n("<table />").addClass("table no-border mb0 table-modal table-condensed").append(n("<tr />").append(n('<td style="border:0;" />').addClass("col-md-6").append(n("<div />").addClass("form-group").append(n("<p />").html("Khi bấm nút Chốt phơi, phơi được chốt sẽ không còn thay đổi thông tin được nữa. Đồng ý ?"))))).append(n("<tr />").append(n("<td />").addClass("col-md-12 list-btn").attr("colspan",3).append(n("<button />",{type:"button"}).addClass("btn btn-danger").text("Đồng ý").css("float","left").click(function(){t._chotPhoi();t._closeChotPhoiDialog()})).append(n("<button />",{type:"button"}).addClass("btn btn-default").text("Không").css("float","left").click(function(){t._closeChotPhoiDialog()}))))));t._$chotphoiModal=n("<div />").addClass("modal fade").attr("id","chotphoi-popup").attr("role","dialog").attr("aria-hidden","true").append(n("<div />").addClass("modal-dialog modal-md").append(n("<div />").addClass("modal-content").append(n("<div />").addClass("modal-header bg-primary").append(n("<h3 />").addClass("modal-title thin-1").html("Xác nhận"))).append(i))).appendTo(n("body"));t._$chotphoiModal.modal("show")},_hideXuatBenButton:function(){this._$xuatbenButton.removeClass("hidden");this._$xuatbenButton.addClass("hidden")},_showXuatBenButton:function(){this._$xuatbenButton.removeClass("hidden")},_createErrorDialogDiv:function(){var t=this,i=n('<div style="padding-top:0;" />').addClass("modal-body").append(n("<table />").addClass("table no-border mb0 table-modal table-condensed").append(n('<tr class="col-md-12 pl0 pr0"/>').append(n('<td style="border-top:0;" class="col-md-1" />').append(n('<img src="Content/images/warning-popup-icon.png" width="80px" />'))).append(n('<td  style="border-top:0;vertical-align:middle;" class="col-md-11" />').append(n('<h4 style="line-height:22px;"/>').addClass("message")))).append(n("<tr />").append(n('<td style="padding-top:10px;" />').addClass("col-md-12").append(n("<button />",{type:"button"}).addClass("btn btn-danger").text("Đồng ý").click(function(){t._closeErrorDialog()})))));t._$emodal=n("<div />").addClass("modal fade").attr("id","error-popup").attr("role","dialog").attr("aria-hidden","true").append(n("<div />").addClass("modal-dialog modal-md").append(n("<div />").addClass("modal-content").append(n("<div />").addClass("modal-header bg-primary").css("background-color","#d9534f").append(n("<h3 />").addClass("modal-title thin-1").html("Cảnh báo"))).append(i))).appendTo(n("body"))},_showModal:function(){this._$modal.modal("show")},_showCModal:function(){this._$cmodal.modal("show")},_showEModal:function(){this._$emodal.modal("show")},_closeUpdateDialog:function(){this._clearCustomerWarning();this._$modal.modal("hide");n("body").find(".updateConflict-popup").remove();n("body").find(".modal-backdrop.fade.in").remove()},_closeErrorDialog:function(){this._$emodal.modal("hide")},_closeCancelDialog:function(){this._$cmodal.modal("hide");this._resetCancelForm()},_closePopupModal:function(){this._$popModal.modal("hide")},_showPopModal:function(t){var i=this,r=n("<div />").addClass("modal-body").css("padding-top",0).append(n("<table />").addClass("table no-border mb0 table-modal table-condensed").append(n('<tr class="col-md-12 pl0 pr0"/>').append(n('<td style="border-top:0;" class="col-md-1" />').append(n('<img src="Content/images/warning-popup-icon.png" width="80px" />'))).append(n('<td  style="border-top:0;vertical-align:middle;" class="col-md-11" />').append(n('<h4 style="line-height:22px;"/>').addClass("message").html(t)))).append(n("<tr />").append(n("<td />").addClass("col-md-12 list-btn").attr("colspan",3).append(n("<button />",{type:"button"}).addClass("btn btn-default").text("Đóng").css("float","left").click(function(){i._closePopupModal()})))));i._$popModal=n("<div />").addClass("modal fade").attr("id","message-popup").attr("role","dialog").attr("aria-hidden","true").append(n("<div />").addClass("modal-dialog modal-md").append(n("<div />").addClass("modal-content").append(n("<div />").addClass("modal-header bg-primary").css("background-color","#d9534f").append(n("<h3 />").addClass("modal-title thin-1").html("Thông báo"))).append(r))).appendTo(this.element);i._$popModal.modal("show")},_closeXuatBenDialog:function(){this._$xuatbenModal.modal("hide")},_closeUpdateConflictDialog:function(){this._$updateConflictModal.modal("hide")},_closeChotPhoiDialog:function(){this._$chotphoiModal.modal("hide")},_getCurrentBKSHash:function(){var n=this,t=n._getDepartureTime();return n._cTripId+t.getTime()+n._cTripBus},_updateSeatStack:function(n,t){var i=this,r=i._seatStack.indexOf(t);r!=-1?i._removeFromSeatStack(n,t,r):i._addToSeatStack(n,t)},_addToSeatStack:function(t,i){var r=this;r._seatStack.indexOf(i)==-1&&(r._seatStack.push(i),n(t).addClass(_dict._slc[0]))},_removeFromSeatStack:function(t,i,r){var u=this;u._seatStack.splice(r,1);n(t).removeClass(_dict._slc[0])},_resetSeatStack:function(){var n=this;n._seatStack=[]},_resetMovingStack:function(){this._movingStack=[];this._fMoving=!1;this._toggleFilterWhenMoving()},_clearSelectedItem:function(){var n=this;n._grid?(n._$sheet.find(".seat").removeClass(_dict._slc[0]),n._$notComeSheet.find(".seat").removeClass(_dict._slc[0]),n._$cancelSheet.find(".seat").removeClass(_dict._slc[0])):(n._$sheet.find(".lseat").removeClass(_dict._slc[0]),n._$notComeSheet.find(".lseat").removeClass(_dict._slc[0]),n._$cancelSheet.find(".lseat").removeClass(_dict._slc[0]))},_maskSelectedSeat:function(t){n(t).find("table").toggleClass(_dict._slc[0])},_existingSeatStack:function(t){var r=this,i=-1,u=t._getCurrentTicket();return n.each(r._seatStack,function(n,r){if(-1==i){var f=r._getCurrentTicket();r._coach==t._coach&&r._row==t._row&&r._col==t._col&&f._id==u._id&&(i=n)}}),!(-1==i)},_bookSeat:function(t,i){var r=this,u,f;try{u=r._createBookTicketObj(i);f=function(t,u,f){if(oRq.cAType=1,t!=1||f<=0){r._showError(_dict._err[4]);r._reloadSheet();return}n.each(r._seatStack,function(n,t){var i=t._getCurrentTicket();i._status!=1&&r._resetSeatStack()});r._existingSeatStack(i)||r._seatStack.push(i);r._reloadSheet();r._storeHistory(r.options.un,"book",{_tid:r._cTripId,_tname:r._data[r._cTripIndex].Name,_tdate:r._getDepartureTime(),_s:[i._label]})};oRq.cEl.length>0&&vRqu(u,f)}catch(e){r._showError(e)}},_fakeBookedSeat:function(t,i){var e=this,f={_coach:i._coach,_row:i._row,_col:i._col,_class:"booking",_label:i._label,_suser:"B:&nbsp;"+app.un,_pmInfo:" - "+app.aice,_half:[_dict._g[_dict._tplNumCol-1],_dict._sg[_dict._tplNumCol-1],_dict._mg[_dict._tplNumCol-1]].join(" "),buttons:'<button type="button" class="btn btn-sm bg-none circle active" data-type="update">U<\/button><button type="button" class="btn btn-sm bg-none circle active" data-type="move">M<\/button>'},s,h,r,c;try{var u=vGetArr({Id:e._cTripId},!1,e._data),l=u[0].FromArea.split("~")[1].split("|"),o=u[0].ToArea.split("~")[1].split("|");f._stageName=o[2];s=u[0].FareInfo.substring(u[0].FareInfo.indexOf("~")+1);n.each(s.split("~"),function(n,t){t.indexOf(l[0]+"|"+o[0])>=0&&(f._fare=vToMn(t.split("|")[2])+"đ")});h={seat:f};r=n(vtpl(_dict._sTpl,h));r.find(".pick").css("background","none");r.addClass("selected");c=r.attr("data-position");n(".vbooking-sheet").find("button").unbind();n(".vbooking-sheet").find(".seat[data-position="+c+"]").addClass("paid",100,"easeInOutQuint",function(){n(this).replaceWith(r)})}catch(a){console.log(a)}},_createBookTicketObj:function(n){var t=this,o=t._getDepartureTime(),s=0,e={},i,r,u,h,f,c;return e._a="BookTicket",e._c=[{TripId:t._cTripId,SeatCode:n._getSeatInfo(),PickupDate:o.toFormatString("iso"),Bus:t._cTripBus,StageCode:t._cStageCode}],i=0,r=0,app.oRights.StageEnable?(i=typeof t._cFromId!="undefined"&&t._cFromId>0?t._cFromId:t._cDefaultFromId,r=typeof t._cToId!="undefined"&&t._cToId>0?t._cToId:t._cDefaultToId):(i=typeof t._cDefaultFromId!="undefined"&&t._cDefaultFromId>0?t._cDefaultFromId:t._cFromId,r=typeof t._cDefaultToId!="undefined"&&t._cDefaultToId>0?t._cDefaultToId:t._cToId),u=t._data[t._cTripIndex].StopPoints.data[t._data[t._cTripIndex].StopPoints.idx[i]],typeof u!="undefined"&&(h="1~"+u.Id+"|"+u.Type+"|"+u.Code+"|"+u.Name),f=t._data[t._cTripIndex].StopPoints.data[t._data[t._cTripIndex].StopPoints.idx[r]],typeof f!="undefined"&&(c="1~"+f.Id+"|"+f.Type+"|"+f.Code+"|"+f.Name),s=typeof _dict._hasMultiFare=="undefined"||_dict._hasMultiFare?t._getCurrentFareById(i,r):t._getCurrentFare(),e._d=[{CompId:t.options.cid,TripId:t._cTripId,AgentId:parseInt(t.options.aid),AgentInfo:t._getAgentInfo(),TripDate:o.toFormatString("iso"),SeatCode:n._getSeatInfo(),IssueDate:(new Date).addMinutes(t._sOffsetMinute).toFormatString("iso"),PickupDate:o.toFormatString("iso"),TripAlias:parseInt(t._cTripBus),Status:1,Fare:s,CreatedUser:t.options.un,StageCode:t._cStageCode,SeatType:n._getSeatType(),FromArea:h,ToArea:c,FromId:i,ToId:r,Type:app.aid==135?3:1}],e},_renderSeatNoQuickBookDiv:function(t){var i=this,r=i._$quickBookModal.find("ul#seat-no").empty();n.each(t,function(t,i){r.append(n("<li />").addClass("list-group-item").addClass(_dict._vc[Math.floor(Math.random()*_dict._vc.length)]).text(i))})},_showQuickBookForm:function(){var n=this,t=n._initQuickBookFormData();n._renderSeatNoQuickBookDiv(t.SeatNo);n._renderRoutePoints(t.RoutePoints,t.FromPoint,t.ToPoint);n._renderPaymentQuickBook();n._populateFormData(t,n._$quickBookModal);n._blockFormField();n._bindEventOnQuickBookForm();n._showQuickBookModal()},_blockFormField:function(){var t=this,s;t._$quickBookModal.find('input[name="Note"]').prop("disabled",!1);t._$quickBookModal.find('select[name="PaymentType"]').prop("disabled",!1);t._$quickBookModal.find('input[name="Fare"]').prop("disabled",!1);t._$quickBookModal.find('input[name="RoutePoint"]').prop("disabled",!1);var r=[],u=[],f=[],e=[],o=[],i=[];n.each(t._seatStack,function(n,t){var i=t._getCurrentTicket();r.push(i._note);u.push(i._status);f.push(i._fare);e.push(i.fromArea);o.push(i.toArea)});r=r.getUnique();r.length>1&&i.push("Note");u=u.getUnique();u.length>1&&(i.push("RoutePoint"),i.push("PaymentType"));f=f.getUnique();f.length>1&&i.push("Fare");e=e.getUnique();o=o.getUnique();(e.length>1||o.length>1)&&i.push("RoutePoint");i=i.getUnique();n.each(i,function(n,i){switch(i){case"Note":t._$quickBookModal.find('input[name="Note"]').prop("disabled",!0);break;case"Fare":t._$quickBookModal.find('input[name="Fare"]').prop("disabled",!0);break;case"RoutePoint":t._$quickBookModal.find('div.checkbox-route-point input[name="RoutePoint"]').prop("disabled",!0);break;case"PaymentType":t._$quickBookModal.find('select[name="PaymentType"]').prop("disabled",!0)}});typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&(s=t._$quickBookModal.find('div.checkbox-route-point input[name="RoutePoint"]').first(),app.rights.indexOf(n.rights.bUBFrtStg.val)==-1&&(s.is(":disabled")||s.attr("disabled",!0)))},_renderRoutePoints:function(t,i,r){var u=this,o,s;u._$quickBookModal.find("div.checkbox-route-point").empty();var h=u._cTripTime,f=parseInt(h.split(":")[0]),e=parseInt(h.split(":")[1]);n.each(t,function(i,r){var o="",c="",s,h;f+=parseInt(r.Hour);e+=parseInt(r.Minute);e>=60&&(e=e%60,f+=1);f>24?f=f%24:f==24&&(f=0,o="00");f<10?o="0"+f:f>=10&&(o=f);c=e<10?"0"+e:e;s="";s=i==0?u._cTripTime:o+":"+c;h=n('<label class="checkbox-inline" />').append(n('<input type="checkbox" name="RoutePoint" data-point-id="'+r.Id+'"/>')).append(n("<b />").html(r.Code)).append(n('<mark class="text-primary"/>').html(s));t.length==2&&h.addClass("hidden");u._$quickBookModal.find("div.checkbox-route-point").append(h)});o=0;s=0;u._cDefaultFromId!=0&&(o=u._cDefaultFromId);u._cDefaultToId!=0&&(s=u._cDefaultToId);n.isEmptyObject(i)||(o=i.Id);n.isEmptyObject(r)||(s=r.Id);o==0&&s==0?(u._$quickBookModal.find('div.checkbox-route-point input[name="RoutePoint"]').first().attr("checked",!0),u._$quickBookModal.find('div.checkbox-route-point input[name="RoutePoint"]').last().attr("checked",!0)):(u._$quickBookModal.find('div.checkbox-route-point input[name="RoutePoint"][data-point-id="'+o+'"]').attr("checked",!0),u._$quickBookModal.find('div.checkbox-route-point input[name="RoutePoint"][data-point-id="'+s+'"]').attr("checked",!0))},_initQuickBookFormData:function(){var t=this,h=[],c=0,p=t._data[t._cTripIndex].StopPoints.data,u={},f={},l=0,e=[],a="",i=[],r=[],v,o,y,s;return n.each(t._seatStack,function(n,t){var u=t._getCurrentTicket();e.push(u._note);i.push(u.fromArea);r.push(u.toArea);h.push(t._label);l=u._fare;c+=u._fare}),e=e.getUnique(),e.length==1&&(a=e[0]),i=i.getUnique(),i.length==1&&(v=i[0].indexOf("~"),o=i[0].substr(v+1,i[0].length).split("|"),u.Id=o[0],u.Type=o[1],u.Code=o[2],u.Name=o[3]),r=r.getUnique(),r.length==1&&(y=r[0].indexOf("~"),s=r[0].substr(y+1,r[0].length).split("|"),f.Id=s[0],f.Type=s[1],f.Code=s[2],f.Name=s[3]),{SeatNo:h,Fare:l.toMn(),TotalFare:c.toMn(),DepartureDate:"Ngày khởi hành: "+t._cTripDate.toFormatString("dd/mm/yyyy")+" - "+t._cTripTime,RouteName:"Tuyến: "+t._data[t._cTripIndex].Name,RoutePoints:p,Note:a,FromPoint:u,ToPoint:f}},_showQuickBookModal:function(){this._resetQuickBookModal();this._$quickBookModal.modal("show")},_resetQuickBookModal:function(){var n=this;n._$quickBookModal.find('input[name="StatusInfo"]').val(2);n._$quickBookModal.find('input[name="NumClick"]').val(0);n._$quickBookModal.find('input[name="Fare"][disabled="disabled"]').prop("disabled",!1);n._$quickBookModal.find('input[name="Note"][disabled="disabled"]').prop("disabled",!1);n._$quickBookModal.find('select[name="PaymentType"][disabled="disabled"]').prop("disabled",!1);n._$quickBookModal.find("div.warning-message").html("");n._$quickBookModal.find("div.warning-message").hide()},_bindEventOnQuickBookForm:function(){var t=this;t._$quickBookModal.find("button.close-qBook").unbind().on("click",function(n){n.preventDefault();n.stopPropagation();t._closeQuickBookForm()});t._$quickBookModal.find('input[name="RoutePoint"]').unbind().on("click",function(){var u=0,f=0,r=0,e=0,o=t._$quickBookModal.find('input[name="NumClick"]').val(),i;n(this).is(":checked")?(i=t._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]'),i.length>=2?o!=0?(t._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),n(this).attr("checked",!0),typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint?(i=t._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),i.length==1&&(u=t._$quickBookModal.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),f=i.attr("data-point-id"),r=t._getFareQuickBook(u,f)),e=t._seatStack.length*r,t._$quickBookModal.find('input[name="Fare"]').val(r.toMn()),t._$quickBookModal.find('input[name="TotalFare"]').val(e.toMn())):(t._$quickBookModal.find('input[name="Fare"]').val(0),t._$quickBookModal.find('input[name="TotalFare"]').val(0))):(i=t._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]'),i.last().removeAttr("checked"),n(this).attr("checked",!0),i=t._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]'),i.length==2&&(u=i.first().attr("data-point-id"),f=i.last().attr("data-point-id"),r=t._getFareQuickBook(u,f)),e=t._seatStack.length*r,t._$quickBookModal.find('input[name="Fare"]').val(r.toMn()),t._$quickBookModal.find('input[name="TotalFare"]').val(e.toMn()),t._$quickBookModal.find('input[name="NumClick"]').val(1)):i.length<=1&&(typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&app.rights.indexOf(n.rights.bUBFrtStg.val)==-1?(t._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),n(this).attr("checked",!0),i=t._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),i.length==1&&(u=t._$quickBookModal.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),f=i.attr("data-point-id"),r=t._getFareQuickBook(u,f)),e=t._seatStack.length*r,t._$quickBookModal.find('input[name="Fare"]').val(r.toMn()),t._$quickBookModal.find('input[name="TotalFare"]').val(e.toMn())):(n(this).attr("checked",!0),i=t._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]'),i.length==2&&(u=i.first().attr("data-point-id"),f=i.last().attr("data-point-id"),r=t._getFareQuickBook(u,f)),e=t._seatStack.length*r,t._$quickBookModal.find('input[name="Fare"]').val(r.toMn()),t._$quickBookModal.find('input[name="TotalFare"]').val(e.toMn())))):(n(this).removeAttr("checked"),t._$quickBookModal.find('input[name="Fare"]').val(0),t._$quickBookModal.find('input[name="TotalFare"]').val(0),t._$quickBookModal.find('input[name="NumClick"]').val(1))});t._$quickBookModal.find('select[name="PaymentType"]').unbind().on("change",function(){n(this).val()==9?t._$quickBookModal.find('input[name="StatusInfo"]').val(5):t._$quickBookModal.find('input[name="StatusInfo"]').val(2)});t._$quickBookModal.find('input[name="Fare"]').unbind().on("change",function(){var u=t._seatStack.length,i=n(this).val().toNum(),r;i<1e4&&(i=i*1e3);r=u*i;n(this).val(i.toMn());t._$quickBookModal.find('input[name="TotalFare"]').val(r.toMn())}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$quickBookModal.find("button.cancel-qBook").unbind().on("click",function(){t._closeQuickBookForm();t._showCancelForm()});t._$quickBookModal.find("button.pay-qBook").unbind().on("click",function(){t._validateQuickBookForm()||t._payQBook()});t._$quickBookModal.find("button.print-qBook").unbind().on("click",function(){var n=function(){var n=function(){t._printETicket();t._closeQuickBookForm();t._resetSeatStack();t._clearSelectedItem()};t._reloadSheet(n)};t._validateQuickBookForm()||t._payQBook(n)})},_validateQuickBookForm:function(){var t=this,i=!1,f=t._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]'),r,u;return f.length!=2&&(i=!0,t._$quickBookModal.find("div.warning-message").html("Điểm đi, điểm đến không chính xác, vui lòng kiểm tra lại."),t._$quickBookModal.find("div.warning-message").show()),r=t._$quickBookModal.find('input[name="Fare"]').val().toNum(),u=t._$quickBookModal.find('select[name="PaymentType"]').val(),u!=9&&r==0&&(i=!0,t._$quickBookModal.find("div.warning-message").html("Giá vé không chính xác, vui lòng kiểm tra lại."),t._$quickBookModal.find("div.warning-message").show()),n.each(t._seatStack,function(n,r){var u=r._getCurrentTicket();u._status!=1&&(i=!0,t._$quickBookModal.find("div.warning-message").html("Đã có ghế thanh toán rồi, vui lòng kiểm tra lại."),t._$quickBookModal.find("div.warning-message").show())}),i},_closeQuickBookForm:function(){var n=this;n._$quickBookModal.modal("hide");n._resetQuickBookModal()},_renderPaymentQuickBook:function(){var t=this;t._$quickBookModal.find('select[name="PaymentType"]').empty();n.each(_dict._qBookPayment,function(i,r){var u=null;r[2]!=0&&(u=n('<option value="'+r[0]+'" />').html(r[1].vi),t._$quickBookModal.find('select[name="PaymentType"]').append(u))})},_payQBook:function(t){var i=this,r=i._createPayQBookObj(),u;!1!=r&&(u=function(u){if(u==1)if(typeof t!="undefined"&&typeof t=="function")n.each(i._seatStack,function(n,t){var i=t._getCurrentTicket();i.fromArea=r._d[0].FromArea;i.toArea=r._d[0].ToArea}),t.call();else{var f=[];n.each(i._seatStack,function(n,t){f.push(t._label)});i._storeHistory(i.options.un,"update",{_tid:i._cTripId,_tname:i._data[i._cTripIndex].Name,_tdate:i._getDepartureTime(),_s:f});i._resetSeatStack();i._reloadSheet();i._closeQuickBookForm()}},i._submitAsyncAction(r,u))},_getDataQuickBookForm:function(){var n=this,t={},s=n._$quickBookModal.find('input[name="RoutePoint"][checked="checked"]'),f=s.first(),h,i,u,c,r,e,o;return f.length>0&&!f.is(":disabled")&&(h=f.attr("data-point-id"),i=n._data[n._cTripIndex].StopPoints.data[n._data[n._cTripIndex].StopPoints.idx[h]],t.FromArea="1~"+i.Id+"|"+i.Type+"|"+i.Code+"|"+i.Name),u=s.last(),u.length>0&&!u.is(":disabled")&&(c=u.attr("data-point-id"),r=n._data[n._cTripIndex].StopPoints.data[n._data[n._cTripIndex].StopPoints.idx[c]],t.ToArea="1~"+r.Id+"|"+r.Type+"|"+r.Code+"|"+r.Name),e=n._$quickBookModal.find('input[name="Fare"]'),e.is(":disabled")||(t.Fare=e.val()),t.PaymentType=n._$quickBookModal.find('select[name="PaymentType"]').val(),t.StatusInfo=n._$quickBookModal.find('input[name="StatusInfo"]').val(),o=n._$quickBookModal.find('input[name="Note"]').not(":disabled"),o.length>0&&(t.Note=o.val()),t},_createPayQBookObj:function(){var i=this,t=i._getDataQuickBookForm(),u={},f,e,r;if(u._a="UpdateBookTicket",u._c=[],u._d=[],f="",vIsEstStr(t.PaymentType)){e="";n.each(_dict._qBookPayment,function(n,i){""==e&&i[0]==t.PaymentType&&(e=i[1].vi)});r="";switch(parseInt(t.PaymentType)){case 1:r=i._getBranchInfo(app.aid);break;case 2:r=t.ChargeCode;break;case 3:r=t.PayAddress;break;case 4:r=i._getTeamInfo();break;case 5:r=t.TransCode;break;case 6:r=i._getBranchInfo(t.AgentName);break;case 10:r=i._getBranchInfo(t.BranchName)}f=i._getPayment(t.PaymentType,e,r)}return n.each(i._seatStack,function(n,r){var o=r._getCurrentTicket(),h=new Date(o._pdate.getTime()),e,s;h.addMinutes(i._sOffsetMinute);u._c.push({Id:o._id,TripId:i._cTripId,SeatCode:r._getSeatInfo(),PickupDate:h.toFormatString("iso"),Bus:i._cTripBus});e={TripAlias:parseInt(i._cTripBus),Status:t.StatusInfo,FromArea:t.FromArea,ToArea:t.ToArea};s=o._code;vIsEstStr(s)&&(e.Code=s);typeof t.Fare!="undefined"&&(e.Fare=t.Fare.toNum());typeof t.Note!="undefined"&&(e.Note=t.Note);typeof t.PaymentType!="undefined"&&(e.PaymentInfo=f,o._isBooking()&&vIsEstStr(f)&&(e.UserCharge=i.options.un));u._d.push(e)}),u},_replaceUnicodeCharacter:function(n){return n.toLowerCase().replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a").replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e").replace(/ì|í|ị|ỉ|ĩ/g,"i").replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o").replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u").replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y").replace(/đ/g,"d").replace(/^\-+|\-+$/g,"")},_bindEventsOnSearchResult:function(){var t=this;n("div.search-result tr").mousedown(function(){n("input:text[name=TransferInfo]").is(":focus")?n("input:text[name=TransferInfo]").val(n(this).attr("data-name")):n("input:text[name=PickupInfo]").is(":focus")&&n("input:text[name=PickupInfo]").val(n(this).attr("data-name"));t._$updateForm.find("div.search-result").remove()});n("div.search-result tr").hover(function(){n("div.search-result").find("tr").removeClass("selected");n(this).addClass("selected")},function(){n(this).removeClass("selected")})},_renderResultList:function(t){var o=this,s=n("<table />").addClass("search-items"),r,f,e,i,u;if(t!=null&&t.length>0)for(r=0;r<t.length;r++)typeof t[r]!="undefined"&&t[r]!=null&&(f=t[r],f._trIndex=r,e=String(o._cTripTime),String(o._cTripTime).indexOf(":")>=0&&(i=parseInt(e.split(":")[1])+parseInt(f.pLoc._time),u=parseInt(e.split(":")[0]),i>=60&&(u+=(i-i%60)/60,i=i%60),u=u>=24?u-24:u,f.pLoc._time=u+":"+(i>9?i.toString():"0"+i)),s.append(vtpl(_dict._locationItemTpl,f)));return s},navigateThroughSearchResult:function(t,i){var u=n("div.search-result tr"),r=n("div.search-result tr.selected"),f=i=="transfer"?n("input[name=TransferInfo]"):n("input[name=PickupInfo]");if(t==13||t==9){if(r=n("div.search-result tr.selected"),n("div.search-result").length!=0&&r!=null)return f.val(r.attr("data-name")),n("div.search-result").remove(),t==9&&f.focus(),!0}else r!=null&&r.length>0&&(r.removeClass("selected"),r=t==40?r.next():r.prev());return r.length==0&&(r=t==40?u.eq(0):u.last()),r.addClass("selected"),!1},suggestLocations:function(t,i,r){var o=i=="transfer"?t._data[t._cTripIndex].TransferPointsInfo.split("~"):t._data[t._cTripIndex].PickedPointsInfo.split("~"),c=[],s,u,h,e,b;if(o!=null&&o.length>1)for(s=1;s<o.length;s++)u=o[s].split("|"),c.push({pLoc:{_index:u[0],_name:u[1],_time:u[2],_order:u[3],_address:u[4],_nearby:u[5],_locationId:u[6]}});var l=Array(),a=Array(),v=Array(),y=Array();if(r.length>=1)for(h=0;h<c.length;h++){var f=c[h],p=this._replaceUnicodeCharacter(r),w=this._replaceUnicodeCharacter(f.pLoc._name);f.pLoc._name.toLowerCase().indexOf(r.toLowerCase())==0?a.push(f):f.pLoc._name.toLowerCase().indexOf(r.toLowerCase())>0?l.push(f):w.indexOf(p)==0?y.push(f):w.indexOf(p)>0&&v.push(f)}t._$updateForm.find("div.search-result").remove();e=a.concat(l.concat(y.concat(v)));b=i=="transfer"?t._$updateForm.find("input[name=TransferInfo]"):t._$updateForm.find("input[name=PickupInfo]");e!=null&&e.length>0&&(b.parent().append(n(_dict._locationHeaderTpl).append(n('<div class="scrollable" />').append(n("<table />").addClass("search-items")).append(t._renderResultList(e,i))).append(vtpl(_dict._locationFooterTpl,{locCount:e.length}))),t._bindEventsOnSearchResult())},updateInfoOfReturnTickets:function(){var n=this,i,r,t;if(n._seatToBeUpdatedReturningInfo.length>0&&n._seatToBeUpdatedReturningInfo[0]._tickets.length>0){for(i=[],r=[],t=0;t<n._seatToBeUpdatedReturningInfo.length;t++)i.push({Id:n._seatToBeUpdatedReturningInfo[t]._tickets[0]._id,Code:n._seatToBeUpdatedReturningInfo[t]._tickets[0]._code,Bus:0}),r.push({ReturnCode:n._dataToBeSavedReturningInfo.code,ReturnDate:n._dataToBeSavedReturningInfo.date});vRqs({_a:"UpdateBookTicket",_c:i,_d:r},function(){})}n._seatToBeUpdatedReturningInfo=[]},_bindEventOnUpdateForm:function(){var t=this,i=t._$updateForm;i.find("input[name=PickupInfo]").not(":disabled").blur(function(){t._$updateForm.find("div.search-result").remove()});i.find("input[name=TransferInfo]").not(":disabled").blur(function(){t._$updateForm.find("div.search-result").remove()});i.find("input[name=PickupInfo]").not(":disabled").keydown(function(n){(n.keyCode==13||n.keyCode==9)&&t.navigateThroughSearchResult(n.keyCode,"pickup")&&n.preventDefault()});i.find("input[name=TransferInfo]").not(":disabled").keydown(function(n){(n.keyCode==13||n.keyCode==9)&&t.navigateThroughSearchResult(n.keyCode,"transfer")&&n.preventDefault()});i.find("input[name=TransferInfo]").not(":disabled").keyup(function(n){n.keyCode!=13&&n.keyCode!=9&&(n.keyCode==40||n.keyCode==38?t.navigateThroughSearchResult(n.keyCode,"transfer-location"):t.suggestLocations(t,"transfer",this.value))});i.find("input[name=PickupInfo]").not(":disabled").keyup(function(n){n.keyCode!=13&&n.keyCode!=9&&(n.keyCode==40||n.keyCode==38?t.navigateThroughSearchResult(n.keyCode,"pickup-location"):t.suggestLocations(t,"pickup",this.value))});i.find("input[name=PhoneNumbers]").not(":disabled").keyup(function(n){if(n.keyCode==13){n.preventDefault();n.stopPropagation();var r=i.find("div.upform-search-result-phone ul.search-items li.selected");i.find("input[name=CustomerId]").val(r.attr("cid"));i.find("input:text[name=PhoneNumbers]").val(r.attr("cphone"));i.find("input[name=FullName]").val(r.attr("cname"));_dict._hasBTWarning&&t._getCustomerWarning(r.attr("cname"),r.attr("cphone"),r.attr("cid"));t._clearSuggestCustomer();app.preventUpdate=!1}else vIsNumKey(n)?this.value.length>=6?(n.preventDefault(),n.stopPropagation(),t._getSuggestCustomer(this.value)):(n.preventDefault(),n.stopPropagation(),t._clearSuggestCustomer()):_dict._arrows.indexOf(n.keyCode)==-1?(n.preventDefault(),n.stopPropagation(),t._clearSuggestCustomer()):n.keyCode==27&&(n.preventDefault(),n.stopPropagation(),t._clearSuggestCustomer())});i.find("input[name=PhoneNumbers]").not(":disabled").bind("paste",function(n){this.value=n.originalEvent.clipboardData.getData("Text");isNaN(this.value)||this.value.length!=10&&this.value.length!=11?(n.preventDefault(),n.stopPropagation(),t._clearSuggestCustomer()):(n.preventDefault(),n.stopPropagation(),t._getSuggestCustomer(this.value));i.find("input[name=PhoneNumbers]").not(":disabled").blur()});i.find("input[type=text]").not("[readonly]").on("keypress",function(i){if(i.keyCode==13&&!app.preventUpdate){if(i.preventDefault(),i.stopPropagation(),n(this).prop("name")=="Fare")return;if(!t._validateUpdateForm())return;var r=t._data[t._cTripIndex].Ts[t._cTripTime][0].ClosedStatus;if(r!=null&&r==1)return;t._transformUpdateFormValue();t._updateTicket()}});i.find("input[name=Code]").parent().find(".input-group-addon").attr("title","Copy to clipboard").clipboard({path:"Base/jquery-clipboard-1.3.2/jquery.clipboard.swf",copy:function(){return console.log("Copy code to clipboard"),i.find("input[name=Code]").val()}});i.find("select[name=PaymentType]").on("change",function(){var r=n(this).closest(".row"),i;r.find(".mpayment").parent().hide();r.find(".mpayment").parent().prev().hide();this.value&&(i=r.find(".mpayment[data-type="+this.value+"]"),this.value==1||this.value==4?typeof _dict._hasSelectBranchPayment!="undefined"&&_dict._hasSelectBranchPayment&&i.length>0&&(i.parent().show(),i.parent().prev().show()):i.length>0&&(i.parent().show(),i.parent().prev().show(),this.value==6&&(i.parent().find("a.chosen-single").css("border-color","#aaa"),t._$updateForm.find("select[name=PaymentType]").attr("disabled")||i.parent().find("select[name=AgentName]").children().each(function(t){t==0?n(this).attr("selected",!0):n(this).attr("selected",!1)}),i.parent().find("select[name=AgentName]").trigger("chosen:updated"))))});i.find("button").each(function(i,r){if(n(r).hasClass("btn-cancel"))n(r).on("click",function(i){var r,u,f;i.preventDefault();r=[];u=!0;n.each(t._seatStack,function(n,t){var i=t._getCurrentTicket();i._status!=1&&(u=!1);r.push(i._fare)});f=0;n.each(r,function(n,t){f+=t});t._closeUpdateDialog();t._showCancelForm(f,u);t._selectedPhone="";t._selectedCode="";t._ctrlOn=!1});else if(n(r).hasClass("btn-update"))n(r).on("click",function(i){i.preventDefault();var r=t._createGetSeatStatusObj(),u=function(n,i){var r,e,o;if(typeof i[0][2]!="undefined")if(i[0][2]==3)t._closeUpdateDialog(),t._showError(_dict._err[7]),t._reloadSheet(),t._clearSelectedItem();else{if(!t._validateUpdateForm())return;var s=t._$updateForm.find("input[name=CreatedUser]").val(),u=s.split(","),f=u[0];for(r=0;r<u.length;r++)u[r]!=app.un&&(f=u[r]);f!=app.un?(e=t._$updateForm.find("input:hidden[name=PhoneNumbers]").val(),o=t._$updateForm.find("input:text[name=PhoneNumbers]").val(),e!=o?(t._closeUpdateDialog(),t._createUpdateConflictDialogDiv(f)):(t._transformUpdateFormValue(),t._updateTicket(),t._selectedPhone="",t._selectedCode="",t._ctrlOn=!1,t._resetCopyInfo(),t._resetBookReturnInfo())):(t._transformUpdateFormValue(),t._updateTicket(),t._selectedPhone="",t._selectedCode="",t._ctrlOn=!1,t._resetCopyInfo(),t._resetBookReturnInfo())}else t._transformUpdateFormValue(),t._updateTicket(),t._selectedPhone="",t._selectedCode="",t._ctrlOn=!1,t._resetCopyInfo(),t._resetBookReturnInfo()};n.isEmptyObject(r)?console.log("_checkSeatCancled: load error"):t._submitAction(r,u)});else if(n(r).hasClass("btn-close"))n(r).on("click",function(n){n.preventDefault();t._clearSelectedItem();t._resetSeatStack();t._selectedPhone="";t._selectedCode="";t._ctrlOn=!1;t._closeUpdateDialog()});else if(n(r).hasClass("btn-eprint"))n(r).on("click",function(n){n.preventDefault();t._printETicket();t._resetAll()});else if(n(r).hasClass("btn-eprint-save"))n(r).on("click",function(i){var u,r,f;if(i.preventDefault(),u=function(){var n=function(){t._printETicket();t._resetAll()};t._reloadSheet(n)},t._validateUpdateForm()){if(r=[],n.each(t._seatStack,function(n,t){var i=t._getCurrentTicket();r.push(i._status)}),r=r.getUnique(),r.length>1){t._$updateForm.find("div.message-error").html("Đã có ghế thanh toán rồi, vui lòng kiểm tra lại.");t._$updateForm.find("div.message-error").show();return}if(f=t._$updateForm.find('select[name="PaymentType"]').val(),!vIsEstStr(f)){t._$updateForm.find("div.message-error").html("Vui lòng chọn hình thức thanh toán.");t._$updateForm.find("div.message-error").show();return}t._transformUpdateFormValue();t._updateTicket(u);t._selectedPhone="";t._selectedCode="";t._ctrlOn=!1}});else if(n(r).hasClass("btn-add-more-ticket"))n(r).on("click",function(n){n.preventDefault();var i=function(n,i,r){var u=function(){var u=t._data[t._cTripIndex].Ts[t._cTripTime][t._cTripBus].TripDetailId;t._hasCopyTicket=!0;t._getCopyInfo(n,i,r,u)};t._reloadSheet(u)};t._validateUpdateForm()&&(t._transformUpdateFormValue(),t._updateTicket(i),t._selectedPhone="",t._selectedCode="",t._ctrlOn=!1)});else if(n(r).hasClass("btn-return"))n(r).on("click",function(i){i.preventDefault();var r=function(){var n=function(){t._hasBookReturnTicket=!0;t._getReturnInfo()};t._reloadSheet(n)};t._validateUpdateForm()&&(t._transformUpdateFormValue(),t._updateTicket(r),t._selectedPhone="",t._selectedCode="",t._ctrlOn=!1,n("html, body").animate({scrollTop:parseInt(n("body").offset().top)},500))})});i.find("input[name=Fare]").not(["readonly"]).on("change",function(){var u=parseInt(i.find("input[name=NumSeat]").val()),f=0,e=0,o=0,t,r,s;i.find("input[name=Deposit]").length>0&&(f=i.find("input[name=Deposit]").val().toNum());i.find("input[name=Discount]").length>0&&(e=i.find("input[name=Discount]").val().toNum());i.find("input[name=Surcharge]").length>0&&(o=i.find("input[name=Surcharge]").val().toNum());t=n(this).val().toNum();t<1e4&&(t=t*1e3);r=(t+o-e)*u;n(this).val(t.toMn());s=r-f*u;i.find("input[name=Debt]").val(s.toMn());i.find("input[name=ToTalFare]").val(r.toMn())}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});i.find("input[name=Deposit]").not(["readonly"]).on("change",function(){var t=n(this).val().toNum(),r,f,e,u,o;t<1e4&&(t=t*1e3);n(this).val(t.toMn());r=0;f=0;i.find("input[name=Discount]").length>0&&(r=i.find("input[name=Discount]").val().toNum());i.find("input[name=Surcharge]").length>0&&(r=i.find("input[name=Surcharge]").val().toNum());e=i.find("input[name=Fare]").val().toNum();u=parseInt(i.find("input[name=NumSeat]").val());i.find("input[name=Debt]").length>0&&(o=u*(e+f-r)-u*t,i.find("input[name=Debt]").val(o.toMn()))}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});i.find("input[name=Surcharge]").not(["readonly"]).on("change",function(){var t=n(this).val().toNum(),r,o;t<1e4&&(t=t*1e3);n(this).val(t.toMn());var u=parseInt(i.find("input[name=NumSeat]").val()),s=i.find("input[name=Fare]").val().toNum(),f=0,e=0;i.find("input[name=Discount]").length>0&&(f=i.find("input[name=Discount]").val().toNum());i.find("input[name=Deposit]").length>0&&(e=i.find("input[name=Deposit]").val().toNum());r=(s+t-f)*u;i.find("input[name=Debt]").length>0&&(o=r-e*u,i.find("input[name=Debt]").val(o.toMn()));i.find("input[name=ToTalFare]").val(r.toMn())}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});i.find("input[name=Discount]").not(["readonly"]).on("change",function(){var t=n(this).val().toNum(),r,o;t<1e4&&(t=t*1e3);n(this).val(t.toMn());var u=parseInt(i.find("input[name=NumSeat]").val()),s=i.find("input[name=Fare]").val().toNum(),f=0,e=0;i.find("input[name=Surcharge]").length>0&&(f=i.find("input[name=Surcharge]").val().toNum());i.find("input[name=Deposit]").length>0&&(e=i.find("input[name=Deposit]").val().toNum());r=(s+f-t)*u;i.find("input[name=Debt]").length>0&&(o=r-e*u,i.find("input[name=Debt]").val(o.toMn()));i.find("input[name=ToTalFare]").val(r.toMn())}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});i.find("input").not("[name=PhoneNumbers]").each(function(i,r){n(r).focus(function(n){n.preventDefault();n.stopPropagation();t._clearSuggestCustomer()})});t._$modal.on("shown.bs.modal",function(){i.find("input[name=PhoneNumbers]").focus()})},_generateCode:function(){return Math.floor(Math.random()*1e5)},_getSuggestCustomer:function(t){var i=this,r,u,f;app.preventUpdate=!0;r=n("<ul />").addClass("search-items");r.append(n("<li>Đang tìm kiếm khách hàng, vui lòng đợi trong giây lát.........<\/li>"));i._$updateForm.find("input:text[name=PhoneNumbers]").parent().append(n("<div />").addClass("dropdown-menu upform-search-result-phone").append(n("<div />").addClass("search-title").append("Kết quả tìm kiếm")).append(r).append(n("<div />").addClass("search-summary").append('Tổng số <span class="vblack"><b>0<\/b><\/span> kết quả')));u=i._createSuggestCustomerObj(t);f=function(n,t,r,u){n==1&&(i._clearSuggestCustomer(),r>0&&i._mapSuggestCustomer(t,u),i._renderSuggestCustomer(),i._bindEventOnSuggestCustomer())};i._submitAsyncAction(u,f)},_createSuggestCustomerObj:function(n){var r=this,t={},i;t._a="fGetCustomer1";i="($x like N'%"+n+"%') ORDER BY Phone ASC";switch(n.length){case 6:i="($x like N'"+n+"%') ORDER BY Phone ASC"}return t._c={CompId:parseInt(r.options.cid),Phone:i},t._f="Id, Name, Note, Phone, BookingTicket, PaidTicket, CancelTicket",t},_clearSuggestCustomer:function(){var n=this;n._suggestCustomer=[];n._totalSuggestCustomer=0;n._$updateForm.find("div.upform-search-result-phone").remove()},_mapSuggestCustomer:function(n,t){var i=this;i._suggestCustomer=n;i._totalSuggestCustomer=t},_renderSuggestCustomer:function(){var t=this,i=n("<ul />").addClass("search-items");t._totalSuggestCustomer>0?(n.each(t._suggestCustomer,function(t,r){var u;if(typeof r[0]!="undefined"&&r[0]!=null){var e=parseInt(r[4]),o=parseInt(r[5]),s=parseInt(r[6]),f=r[2];f=vIsEstStr(f)?"&nbsp;-&nbsp;"+f:"";u=r[1];u=vIsEstStr(u)?u+"&nbsp;-&nbsp;":"";i.append(n("<li />").attr("cid",r[0]).attr("cphone",r[3]).attr("cname",r[1]).html("<p>"+u+"<span class='vred'><b>"+r[3]+"<\/b><\/span>"+f+"<\/p><p>Đang đặt <span class='vred'><b>"+e+"<\/b><\/span> ghế / Số lần đi <span class='vred'><b>"+o+"<\/b><\/span> / Số lần hủy <span class='vred'><b>"+s+"<\/b><\/span><\/p>"))}}),t._$updateForm.find("input:text[name=PhoneNumbers]").parent().append(n("<div />").addClass("dropdown-menu upform-search-result-phone").append(n("<div />").addClass("search-title").append("Kết quả tìm kiếm")).append(i).append(n("<div />").addClass("search-summary").append('Tổng số <span class="vblack"><b>'+t._totalSuggestCustomer+"<\/b><\/span> kết quả"))),t._$updateForm.find("div.upform-search-result-phone ul.search-items li:first-child").addClass("selected")):(i.append(n("<li>Không tìm thấy kết quả phù hợp.........<\/li>")),t._$updateForm.find("input:text[name=PhoneNumbers]").parent().append(n("<div />").addClass("dropdown-menu upform-search-result-phone").append(n("<div />").addClass("search-title").append("Kết quả tìm kiếm")).append(i).append(n("<div />").addClass("search-summary").append('Tổng số <span class="vblack"><b>0<\/b><\/span> kết quả'))))},_bindEventOnSuggestCustomer:function(){var t=this,i;t._totalSuggestCustomer>0&&(i=t._$updateForm.find("div.upform-search-result-phone li"),i.on("click",function(i){i.preventDefault();i.stopPropagation();t._$updateForm.find("input[name=CustomerId]").val(n(this).attr("cid"));t._$updateForm.find("input:text[name=PhoneNumbers]").val(n(this).attr("cphone"));t._$updateForm.find("input[name=FullName]").val(n(this).attr("cname"));t._clearSuggestCustomer();_dict._hasBTWarning&&t._getCustomerWarning(n(this).attr("cname"),n(this).attr("cphone"),n(this).attr("cid"))}).hover(function(){i.removeClass("selected");n(this).addClass("selected")}),t._bindArrowEventList(i))},_getCustomerWarning:function(n,t,i){var r=this,u=r._createCustomerWarningObj(i),f=function(i,u,f){i==1&&(r._clearCustomerWarning(),f>0&&r._renderCustomerWarning(n,t,u))};r._submitAsyncAction(u,f)},_createCustomerWarningObj:function(n){var i=this,r=i._getLimitedDate(),t={};return t._a="fGetTicket",t._c={TripId:i._cTripId,CustomerId:n,TripDate:"($x >= '"+r.toFormatString("iso")+"')",Status:"(($x) IN("+_dict._tksUpSearch.join()+")) ORDER BY TripDate ASC"},t._f="TripDate, SeatCode, Fare, Status",t},_clearCustomerWarning:function(){var n=this;n._$updateForm.find(".customer-w").remove()},_renderCustomerWarning:function(t,i,r){var f=this,e=n("<ul />"),u=[],o=[];n.each(r,function(n,t){var r=vPrsDt(t[0]),e=t[1].split("|")[0],s=parseInt(t[2]),h=parseInt(t[3]),i=o.indexOf(r.toFormatString("iso"));i==-1&&(i=o.push(r.toFormatString("iso"))-1);typeof u[i]=="undefined"&&(u[i]={_b:{_numS:0,_sCodes:[],_total:0,_tname:f._data[f._cTripIndex].Name,_date:r},_c:{_numS:0,_sCodes:[],_total:0,_tname:f._data[f._cTripIndex].Name,_date:r},_p:{_numS:0,_sCodes:[],_total:0,_tname:f._data[f._cTripIndex].Name,_date:r}});switch(h){case 1:u[i]._b._numS++;u[i]._b._sCodes.push(e);u[i]._b._total+=s;break;case 2:u[i]._p._numS++;u[i]._p._sCodes.push(e);u[i]._p._total+=s;break;case 5:case 8:case 3:case 4:u[i]._c._numS++;u[i]._c._sCodes.push(e);u[i]._c._total+=s}});n.each(u,function(n,t){var i,r,u;typeof t!="undefined"&&t!=null&&(t._b._numS>0&&(i={t:{_sText:"Đang đặt",_numS:t._b._numS,_sCodes:t._b._sCodes.join(", "),_total:t._b._total.toMn()+"₫",_tname:t._b._tname,_date:t._b._date.toFormatString("dd-mm-yyyy"),_time:t._b._date.toFormatString("hh:mm")}},e.append(vtpl(_dict._btwarningTpl,i))),t._c._numS>0&&(r={t:{_sText:"Hủy",_numS:t._c._numS,_sCodes:t._c._sCodes.join(", "),_total:t._c._total.toMn()+"₫",_tname:t._c._tname,_date:t._c._date.toFormatString("dd-mm-yyyy"),_time:t._c._date.toFormatString("hh:mm")}},e.append(vtpl(_dict._btwarningTpl,r))),t._p._numS>0&&(u={t:{_sText:"Đã thanh toán",_numS:t._p._numS,_sCodes:t._p._sCodes.join(", "),_total:t._p._total.toMn()+"₫",_tname:t._p._tname,_date:t._p._date.toFormatString("dd-mm-yyyy"),_time:t._p._date.toFormatString("hh:mm")}},e.append(vtpl(_dict._btwarningTpl,u))))});e.find("li").length>0&&f._$updateForm.prepend(n(vtpl(_dict._wTpl,{m:{_cname:t,_cphone:i,_content:n("<div />").append(e).html()}})).addClass("customer-w"))},_transformUpdateFormValue:function(){var n=this,i=n._$updateForm,t=i.find("select[name=PaymentType]").not(":disabled").val(),r=i.find("input[name=Notcome]").not(":disabled").prop("checked"),u=i.find("input[name=KeepOnTime]").not(":disabled").prop("checked");if(r)n._changeFormToNotComeStatus();else if(u)n._changeFormToKeepOnTimeStatus();else if(typeof t!="undefined")if(t=parseInt(t),isNaN(t))n._changeFormToBookingStatus();else switch(t){case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 10:n._changeFormToPaidStatus();break;case 9:n._changeFormToPassStatus()}},_changeFormToPaidStatus:function(){for(var n=this,t=[],i=0;i<n._seatStack.length;i++)t.push(2);n._$updateForm.find("input[name=StatusInfo]").val(t.join())},_changeFormToNotComeStatus:function(){for(var n=this,t=[],i=0;i<n._seatStack.length;i++)t.push(4);n._$updateForm.find("input[name=StatusInfo]").val(t.join())},_changeFormToPassStatus:function(){for(var n=this,t=[],i=0;i<n._seatStack.length;i++)t.push(5);n._$updateForm.find("input[name=StatusInfo]").val(t.join())},_changeFormToKeepOnTimeStatus:function(){for(var n=this,t=[],i=0;i<n._seatStack.length;i++)t.push(8);n._$updateForm.find("input[name=StatusInfo]").val(t.join())},_changeFormToBookingStatus:function(){for(var n=this,t=[],i=0;i<n._seatStack.length;i++)t.push(1);n._$updateForm.find("input[name=StatusInfo]").val(t.join())},_changeFormToOpenStatus:function(){for(var n=this,t=[],i=0;i<n._seatStack.length;i++)t.push(7);n._$updateForm.find("input[name=StatusInfo]").val(t.join())},_changeFormToValidStatus:function(){for(var n=this,t=[],i=0;i<n._seatStack.length;i++)t.push(6);n._$updateForm.find("input[name=StatusInfo]").val(t.join())},_changeFormToCancelledStatus:function(){for(var n=this,t=[],i=0;i<n._seatStack.length;i++)t.push(3);n._$updateForm.find("input[name=StatusInfo]").val(t.join())},_checkRightOnUpdateForm:function(){var i,t,n;if(app.rights.indexOf("~3|2|")==-1)return!0;for(i=app.rights.indexOf("~3|2|0")>=0?!1:!0,t=app.rights.split("~"),n=0;n<t.length;n++)if(t[n].indexOf("3|2|")>=0&&this._cTripId==t[n].split("|")[2])return!i;return i},_showUpdateForm:function(n,t){var i=this,r;try{r=i._initUpdateFormData(t);!1!=r&&(i._resetForm(i._$updateForm),i._$updateForm.find("div.message-error").html(""),i._$updateForm.find("div.message-error").hide(),i._populateFormData(r,i._$updateForm),i._renderSeatNoDiv(r.SeatNo),i._createRoutePoints(r.RoutePoints,r.FromArea,r.ToArea),i._resetForm(i._$validForm),i._renderHistoryTab(t),i._disableFormFields(t),i._showModal(),i._triggerUpdateTab(),i._triggerUpdateForm())}catch(u){i._showError(u)}},_initUpdateFormData:function(t){var i=this,r=t._getCurrentTicket(),g=i._data[i._cTripIndex].Ts[i._cTripTime][i._cTripBus].TripDetailId,s,d,u,f,h,c,e;if(n.isEmptyObject(r))return!1;var o=0,a=r.fromArea,v=r.toArea;vIsEstStr(i._copyInfo.FromArea)&&(a=i._copyInfo.FromArea);vIsEstStr(i._copyInfo.ToArea)&&(v=i._copyInfo.ToArea);var y=[],l=[],p=[],w=[],b=0,k=[];if(n.each(i._seatStack,function(n,t){var i=t._getCurrentTicket();(o==0||o>i._fare&&i._fare>0)&&(o=i._fare);y.push(i._id);l.push(t._label);p.push(i._getCustomerInfo());w.push(i._status);k.push(i._suser);b+=o+i._surCharge-i._discount;i._status!=1&&(i._debt=0)}),s=new Date(r._pdate.getTime()),s.addMinutes(i._sOffsetMinute),d=i._data[i._cTripIndex].StopPoints.data,u={IdInfo:y.join(),PickupDate:s.toFormatString("dd-mm-yyyy"),PickupTime:s.toFormatString("hh:mm"),SeatNo:l,Code:r._code,Fare:o.toMn(),Surcharge:r._surCharge.toMn(),Deposit:r._deposit.toMn(),Discount:r._discount.toMn(),Debt:(r._debt*i._seatStack.length).toMn(),CustomerId:r._cid,CustomerInfo:p.join(),PhoneNumbers:r._cphone,FullName:r._cname,CreatedUser:k,Note:r._note,StatusInfo:w.join(),Serial:r._seri,Notcome:r._status==4?!0:!1,KeepOnTime:r._status==8?!0:!1,NumSeat:l.length,ToTalFare:b.toMn(),RoutePoints:d,NumClick:0,FromArea:a,ToArea:v,SNote:r._sNote,ResponsibilityUser:r._responUser,PickOrReturnDate:r._porDate},vIsEstStr(r._pmInfo)){f=r._getPaymentInfo();u.PaymentType=f.type;switch(f.type){case 1:u.BranchName=f.info._id;break;case 2:u.ChargeCode=n.map(f.info,function(n){return n}).join("|");break;case 3:u.PayAddress=f.info._addr;break;case 4:u.DriverName=f.info._dname;break;case 5:u.TransCode=f.info._tcode;break;case 6:u.AgentName=f.info._id}}if(vIsEstStr(u.BranchName)||(h=[],i._$updateForm.find("select[name=BranchName] > option").each(function(){h.push(n(this).val())}),h.length>0&&h.indexOf(i.options.aid)!=-1&&(u.BranchName=i.options.aid)),vIsEstStr(u.AgentName)||(c=[],i._$updateForm.find("select[name=AgentName] > option").each(function(){c.push(n(this).val())}),c.length>0&&c.indexOf(i.options.aid)!=-1&&(u.AgentName=i.options.aid)),typeof u.ChargeCode=="undefined"&&(u.ChargeCode=_dict._pm[1][4]),vIsEstStr(r._pInfo)&&(e=r._getPickupInfo(),!n.isEmptyObject(e))){switch(e.type){case"P":u.PickupInfo=e.text;break;case"T":u.TransferInfo=e.text}u.pIndex=null;typeof e.pIndex!="undefined"&&(u.pIndex=e.pIndex)}return i._hasCopyTicket&&typeof _dict._copyField!="undefined"&&n.each(_dict._copyField,function(n,t){if(t!="Code")u[t]=i._copyInfo[t];else{var r=i._copyInfo.TripDetailId?i._copyInfo.TripDetailId:0;r==g&&(u[t]=i._copyInfo[t])}}),i._hasBookReturnTicket&&typeof _dict._returnField!="undefined"&&n.each(_dict._returnField,function(n,t){u[t]=i._copyInfo[t]}),u},_populateFormData:function(t,i){n.each(t,function(t,r){var u=n(i).find('[name="'+t+'"]'),f=u.attr("type");switch(f){case"checkbox":u.prop("checked",r);break;case"radio":u.filter('[value="'+r+'"]').prop("checked",r);break;case"label":u.text(r);break;default:u.val(r)}})},_renderSeatNoDiv:function(t){var i=this,r=i._$modal.find("ul#seat-no").empty();n.each(t,function(t,i){r.append(n("<li />").addClass("list-group-item").addClass(_dict._vc[Math.floor(Math.random()*_dict._vc.length)]).text(i))})},_createRoutePoints:function(t,i,r){var u=this,o,s,h,c;u._$updateForm.find("div.checkbox-route-point").empty();o=0;s=0;u._cDefaultFromId!=0&&(o=u._cDefaultFromId);u._cDefaultToId!=0&&(s=u._cDefaultToId);vIsEstStr(i)&&(h=i.indexOf("~"),o=i.substr(h+1,i.length).split("|")[0]);vIsEstStr(r)&&(c=i.indexOf("~"),s=r.substr(c+1,r.length).split("|")[0]);var l=u._cTripTime,f=parseInt(l.split(":")[0]),e=parseInt(l.split(":")[1]);n.each(t,function(i,r){var o="",c="",s,h;f+=parseInt(r.Hour);e+=parseInt(r.Minute);e>=60&&(e=e%60,f+=1);f>24?f=f%24:f==24&&(f=0,o="00");f<10?o="0"+f:f>=10&&(o=f);c=e<10?"0"+e:e;s="";s=i==0?u._cTripTime:o+":"+c;h=n('<label class="checkbox-inline" />').append(n('<input type="checkbox" name="RoutePoint" data-point-id="'+r.Id+'"/>')).append(n("<b />").html(r.Code)).append(n('<mark class="text-primary"/>').html(s));t.length==2&&h.addClass("hidden");u._$updateForm.find("div.checkbox-route-point").append(h)});o==0&&s==0?(u._$updateForm.find('div.checkbox-route-point input[name="RoutePoint"]').first().attr("checked",!0),u._$updateForm.find('div.checkbox-route-point input[name="RoutePoint"]').last().attr("checked",!0)):(u._$updateForm.find('div.checkbox-route-point input[name="RoutePoint"][data-point-id="'+o+'"]').attr("checked",!0),u._$updateForm.find('div.checkbox-route-point input[name="RoutePoint"][data-point-id="'+s+'"]').attr("checked",!0));u._bindEventRoutePoints()},_bindEventRoutePoints:function(){var i=this,t=i._$updateForm;t.find('input[name="RoutePoint"]').unbind().on("click",function(){var f=0,e=0,u=0,o=0,s=t.find('input[name="NumSeat"]').val(),h=t.find('input[name="NumClick"]').val(),r;n(this).is(":checked")?(r=t.find('input[name="RoutePoint"][checked="checked"]'),r.length>=2?h!=0?(t.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),n(this).attr("checked",!0),typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint?(r=t.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),r.length==1&&(f=t.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),e=r.attr("data-point-id"),u=i._getFareQuickBook(f,e)),o=s*u,t.find('input[name="Fare"]').val(u.toMn()),t.find('input[name="ToTalFare"]').val(o.toMn())):(t.find('input[name="Fare"]').val(0),t.find('input[name="ToTalFare"]').val(0))):(r=t.find('input[name="RoutePoint"][checked="checked"]'),r.last().removeAttr("checked"),n(this).attr("checked",!0),r=t.find('input[name="RoutePoint"][checked="checked"]'),r.length==2&&(f=r.first().attr("data-point-id"),e=r.last().attr("data-point-id"),u=i._getFareQuickBook(f,e)),o=s*u,t.find('input[name="Fare"]').val(u.toMn()),t.find('input[name="ToTalFare"]').val(o.toMn()),t.find('input[name="NumClick"]').val(1)):r.length<=1&&(typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&app.rights.indexOf(n.rights.bUBFrtStg.val)==-1?(t.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),n(this).attr("checked",!0),r=t.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),r.length==1&&(f=t.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),e=r.attr("data-point-id"),u=i._getFareQuickBook(f,e)),o=s*u,t.find('input[name="Fare"]').val(u.toMn()),t.find('input[name="ToTalFare"]').val(o.toMn())):(n(this).attr("checked",!0),r=t.find('input[name="RoutePoint"][checked="checked"]'),r.length==2&&(f=r.first().attr("data-point-id"),e=r.last().attr("data-point-id"),u=i._getFareQuickBook(f,e)),o=s*u,t.find('input[name="Fare"]').val(u.toMn()),t.find('input[name="ToTalFare"]').val(o.toMn())))):(n(this).removeAttr("checked"),t.find('input[name="Fare"]').val(0),t.find('input[name="ToTalFare"]').val(0),t.find('input[name="NumClick"]').val(1))})},_triggerUpdateTab:function(){this._$modal.find("ul[role=tab-list] li").not(".hidden").first().find("a").trigger("click")},_triggerUpdateForm:function(){this._$updateForm.find("select[name=PaymentType]").trigger("change")},_renderHistoryTab:function(t){var o=this,f=t._getCurrentTicket(),s=o._$historyForm.find("tbody").empty(),i,r,e,u;if(typeof f._hInfo!="undefined"&&f._hInfo!=null&&(i=f._parseHistoryInfo(),i!=null))for(r=0;r<i.length;r++)if(typeof i[r]!="undefined"){for(e=o._createTableRow(),u=0;u<i[r].length;u++)e.append(n("<td />").html(i[r][u]));s.append(e)}},_normalFormFields:function(){var n=this;n._$updateForm.find("input:disabled").prop("disabled",!1);n._$updateForm.find("select:disabled").prop("disabled",!1);n._$updateForm.find("textarea:disabled").prop("disabled",!1);n._$updateForm.find('input[name="RoutePoint"]').prop("disabled",!1);n._$validForm.find("input:disabled").prop("disabled",!1);n._$validForm.find("select:disabled").prop("disabled",!1);n._$modal.find("ul[role=tab-list] li").removeClass("hidden").removeClass("active");n._$modal.find("button").removeClass("hidden")},_disableFormFields:function(t){var i=this,u,y,e,v;i._normalFormFields();u=["input","select","textarea"];i._seatStack.length>1&&(n.each(_dict._frule[0],function(t,i){var r=n("#"+i[0]);n.each(i[1],function(t,i){for(var f=n(),e=0;f.length==0&&e<u.length;)f=r.find(u[e]+"[name="+i+"]"),e++;f.length>0&&f.prop("disabled",!0)})}),n.each(_dict._trule[0],function(n,t){i._$modal.find("a[data-tab="+t+"]").closest("li").addClass("hidden")}));var o=[],s=[],h=[],r={_customer:[],_pickUp:[],_note:[],_fare:[],_surCharge:[],_deposit:[],_discount:[],_paymentInfo:[]},c=[],l=[],a=[],f=[];n.each(i._seatStack,function(t,i){var u=i._getCurrentTicket(),f,e;n.each(_dict._frule[1],function(t,i){u._status==i[0]&&app.rights.indexOf(n.rights.bEdtInfPaidTk.val)==-1&&o.push(i[1])});n.each(_dict._trule[1],function(n,t){u._status==t[0]&&s.push(t[1])});n.each(_dict._brule[1],function(n,t){u._status==t[0]&&h.push(t[1])});r._customer.push(u._getCustomerInfo());f=u._getPickupInfo();e="";n.isEmptyObject(f)||(e=f.text);r._pickUp.push(e);r._note.push(u._note);r._fare.push(u._fare);r._surCharge.push(u._surCharge);r._deposit.push(u._deposit);r._discount.push(u._discount);r._paymentInfo.push(u._pmInfo);c.push(u.fromArea);l.push(u.toArea);a.push(u._status)});c=c.getUnique();l=l.getUnique();(c.length>1||l.length>1)&&f.push("RoutePoint");a=a.getUnique();a.length>1&&f.push("RoutePoint");f=f.getUnique();n.each(f,function(n,t){switch(t){case"RoutePoint":i._$updateForm.find('input[name="RoutePoint"]').prop("disabled",!0)}});o=o.getUnique();s=s.getUnique();h=h.getUnique();n.each(o,function(t,i){n.each(i,function(t,i){var r=n("#"+i[0]);n.each(i[1],function(t,i){for(var f=n(),e=0;f.length==0&&e<u.length;)f=r.find(u[e]+"[name="+i+"]"),e++;f.length>0&&f.prop("disabled",!0)})})});n.each(s,function(t,r){n.each(r,function(n,t){i._$modal.find("a[data-tab="+t+"]").closest("li").addClass("hidden")})});n.each(h,function(t,i){n.each(i,function(t,i){var r=n("#"+i[0]);n.each(i[1],function(n,t){r.find("button."+t).addClass("hidden")})})});y=i._data[i._cTripIndex].Ts[i._cTripTime][0].ClosedStatus;e=t._tickets[t._currentTicketIndex]._status;y==1&&(e==2||e==5||e==3)&&typeof _dict._closedTripConf!="undefined"&&_dict._closedTripConf.UpdateForm.length>0&&app.rights.indexOf(n.rights.bEnBtnAtDpt.val)==-1&&n.each(_dict._closedTripConf.UpdateForm,function(n,t){i._$modal.find("button."+t).addClass("hidden")});e!=1&&i._$updateForm.find('input[name="RoutePoint"]').prop("disabled",!0);i._hasCopyTicket&&(i._$modal.find("button.btn-add-more-ticket").addClass("hidden"),i._$modal.find("button.btn-return").addClass("hidden"));i._hasBookReturnTicket&&(i._$modal.find("button.btn-add-more-ticket").addClass("hidden"),i._$modal.find("button.btn-return").addClass("hidden"));r._customer=r._customer.getUnique();r._pickUp=r._pickUp.getUnique();r._note=r._note.getUnique();r._fare=r._fare.getUnique();r._surCharge=r._surCharge.getUnique();r._deposit=r._deposit.getUnique();r._discount=r._discount.getUnique();r._paymentInfo=r._paymentInfo.getUnique();r._customer.length>1&&(i._$updateForm.find("input:text[name=PhoneNumbers]").prop("disabled",!0),i._$updateForm.find("input[name=FullName]").prop("disabled",!0));r._pickUp.length>1&&(i._$updateForm.find("input[name=PickupInfo]").prop("disabled",!0),i._$updateForm.find("input[name=TransferInfo]").prop("disabled",!0),i._$updateForm.find("input[name=pIndex]").prop("disabled",!0));r._note.length>1&&i._$updateForm.find("textarea[name=Note]").prop("disabled",!0);r._fare.length>1&&i._$updateForm.find("input[name=Fare]").prop("disabled",!0);r._surCharge.length>1&&i._$updateForm.find("input[name=Surcharge]").prop("disabled",!0);r._deposit.length>1&&i._$updateForm.find("input[name=Deposit]").prop("disabled",!0);r._discount.length>1&&i._$updateForm.find("input[name=Discount]").prop("disabled",!0);r._paymentInfo.length>1&&(i._$updateForm.find("select[name=PaymentType]").prop("disabled",!0),i._$updateForm.find("input[name=BranchName]").prop("disabled",!0),i._$updateForm.find("select[name=BranchName]").prop("disabled",!0),i._$updateForm.find("input[name=ChargeCode]").prop("disabled",!0),i._$updateForm.find("input[name=PayAddress]").prop("disabled",!0),i._$updateForm.find("input[name=DriverName]").prop("disabled",!0),i._$updateForm.find("input[name=TransCode]").prop("disabled",!0),i._$updateForm.find("input[name=AgentName]").prop("disabled",!0));typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&(v=i._$updateForm.find('div.checkbox-route-point input[name="RoutePoint"]').first(),app.rights.indexOf(n.rights.bUBFrtStg.val)==-1&&(v.is(":disabled")||v.attr("disabled",!0)));i._checkRightOnUpdateForm()?i._$updateForm.find("button.btn-cancel").show():i._$updateForm.find("button.btn-cancel").hide()},_validateUpdateForm:function(){var t=this,o={payment:t._$updateForm.find("select[name=PaymentType]").val(),agent:t._$updateForm.find("select[name=AgentName]").val(),phone:t._$updateForm.find("input:text[name=PhoneNumbers]").val(),note:t._$updateForm.find("textarea[name=Note]").val(),pickup:t._$updateForm.find("input[name=PickupInfo]").val(),transfer:t._$updateForm.find("input[name=TransferInfo]").val(),fare:vToNum(t._$updateForm.find("input[name=Fare]").val())},f=!1,s="",h,l,i,c,n,e,r,u;if(_dict._updateFormValidatingConditions!="undefined")for(h=0;h<_dict._updateFormValidatingConditions.length;h++){for(l=_dict._updateFormValidatingConditions[h].split("&"),i=!0,c=0;c<l.length;c++){if(n=l[c],n=="phone")i=i&&vIsPhone(o.phone);else if(n.indexOf("fare")>=0)if(e=o[n.substring(0,n.indexOf("["))],e<0){f=!1;break}else r=0,n.indexOf("[>=")>=0?(r=parseInt(n.substring(n.indexOf("[>=")+3).replace("]","")),i=i&&e>=r):n.indexOf("[<=")>=0?(r=parseInt(n.substring(n.indexOf("[<=")+3).replace("]","")),i=i&&e<=r):n.indexOf("[=")>=0?(r=parseInt(n.substring(n.indexOf("[=")+2).replace("]","")),i=i&&e==r):n.indexOf("[>")>=0?(r=parseInt(n.substring(n.indexOf("[>")+2).replace("]","")),i=i&&e>r):n.indexOf("[<")>=0&&(r=parseInt(n.substring(n.indexOf("[<")+2).replace("]","")),i=i&&e<r);else i=n.indexOf("[")>=0?i&&o[n.substring(0,n.indexOf("["))]==n.substring(n.indexOf("[")+1).replace("]",""):i&&vIsEstStr(o[n]);i||s!=""||(s=n);n.indexOf("[")>=0&&(s=n.substring(0,n.indexOf("[")))}if(vIsEstStr(o.phone)&&!vIsPhone(o.phone)){f=!1;break}if(f=f||i,f)break}if(f)t._$updateForm.find("div.message-error").html(""),t._$updateForm.find("div.message-error").hide();else{switch(s){case"payment":u=t._$updateForm.find("select[name=PaymentType]");break;case"agent":u=t._$updateForm.find("select[name=AgentName]");break;case"phone":u=t._$updateForm.find("input:text[name=PhoneNumbers]");break;case"note":u=t._$updateForm.find("textarea[name=Note]");break;case"pickup":u=t._$updateForm.find("input[name=PickupInfo]");break;case"transfer":u=t._$updateForm.find("input[name=TransferInfo]");break;case"fare":u=t._$updateForm.find("input[name=Fare]")}t._$updateForm.find("div.message-error").html(_dict._updateFormValidatingErrorMessage);t._$updateForm.find("div.message-error").show();u!=null&&u.focus();u.closest("div.col-md-6").addClass("has-error")}return f},_updateTicket:function(t){var i=this,r=i._createUpdateTicketObj(),u;!1!=r&&(u=function(u,f,e,o){if(u!=1){i._closeUpdateDialog();return}if(typeof t!="undefined"&&typeof t=="function")i._seatToBeUpdatedReturningInfo=i._seatStack,n.each(i._seatStack,function(n,t){var i=t._getCurrentTicket();i.fromArea=r._d[0].FromArea;i.toArea=r._d[0].ToArea}),t.call(this,o,r._d[0].FromArea,r._d[0].ToArea);else{var s=[];n.each(i._seatStack,function(n,t){s.push(t._label)});i._dataToBeSavedReturningInfo.code=o;i._seatToBeUpdatedReturningInfo.length>0&&i.updateInfoOfReturnTickets();i._closeUpdateDialog();i._storeHistory(i.options.un,"update",{_tid:i._cTripId,_tname:i._data[i._cTripIndex].Name,_tdate:i._getDepartureTime(),_s:s});i._resetSeatStack();i._reloadSheet()}},i._submitAsyncAction(r,u))},_createGetSeatStatusObj:function(){var t=this,n={};return n._a="fGetTicket",n._c={Id:t._$updateForm.find("input[name=IdInfo]").val().split(",")[0]},n._f="Id, TripId, Status, IsPrgHistoryInfo, Code",n},_getTeamInfo:function(){var t=FlatObj.cTrip.TeamInfo,i="|",r;return t&&(r=t.split("~"),n.each(r,function(n,t){if(n>=1){var r=t.split("|");r[0]==2&&(i=r[2]+"|"+r[3])}})),i},_createUpdateTicketObj:function(){var i=this,t=i._convertFormDataToObj(i._$updateForm),o=t.StatusInfo.split(","),s=t.CustomerInfo.split(","),u={},f,e,r;if(u._a="UpdateBookTicket",u._c=[],u._d=[],f="",vIsEstStr(t.PaymentType)){e="";n.each(_dict._pm,function(n,i){""==e&&i[0]==t.PaymentType&&(e=i[1].vi)});r="";switch(parseInt(t.PaymentType)){case 1:r=typeof _dict._hasSelectBranchPayment!="undefined"&&_dict._hasSelectBranchPayment?i._getBranchInfo(t.BranchName):i._getBranchInfo(app.aid);break;case 2:r=t.ChargeCode;break;case 3:r=t.PayAddress;break;case 4:r=i._getTeamInfo();break;case 5:r=t.TransCode;break;case 6:r=i._getBranchInfo(t.AgentName);break;case 10:r=i._getBranchInfo(t.BranchName)}f=i._getPayment(t.PaymentType,e,r)}return n.each(i._seatStack,function(n,r){var h=r._getCurrentTicket(),v=o[n],b=s[n],a=new Date(h._pdate.getTime()),e;if(a.addMinutes(i._sOffsetMinute),u._c.push({Id:h._id,TripId:i._cTripId,SeatCode:r._getSeatInfo(),PickupDate:a.toFormatString("iso"),Bus:i._cTripBus}),i._dataToBeSavedReturningInfo.code=r._getSeatInfo(),i._dataToBeSavedReturningInfo.date=a.toFormatString("iso"),e={TripAlias:parseInt(i._cTripBus),Status:v,CustomerInfo:b,FromArea:p,ToArea:w},h._isBooking()){var y=i._$updateForm.find('input[name="RoutePoint"][checked="checked"]'),k=y.first().attr("data-point-id"),c=i._data[i._cTripIndex].StopPoints.data[i._data[i._cTripIndex].StopPoints.idx[k]],d=y.last().attr("data-point-id"),l=i._data[i._cTripIndex].StopPoints.data[i._data[i._cTripIndex].StopPoints.idx[d]],p="1~"+c.Id+"|"+c.Type+"|"+c.Code+"|"+c.Name,w="1~"+l.Id+"|"+l.Type+"|"+l.Code+"|"+l.Name;e.FromArea=p;e.ToArea=w}vIsEstStr(h._code)?e.Code=h._code:typeof t.Code!="undefined"&&vIsEstStr(t.Code)&&(e.Code=t.Code);typeof t.PhoneNumbers!="undefined"&&typeof t.FullName!="undefined"&&(e.CustomerInfo=i._getCustomer(t.CustomerId,t.FullName,t.PhoneNumbers));typeof t.Fare!="undefined"&&(e.Fare=t.Fare.toNum());typeof t.Surcharge!="undefined"&&(e.Surcharge=t.Surcharge.toNum());typeof t.Deposit!="undefined"&&(e.Deposit=t.Deposit.toNum());typeof t.Discount!="undefined"&&(e.Discount=t.Discount.toNum());typeof t.Debt!="undefined"&&(e.Debt=v==1?t.Debt.toNum()/i._seatStack.length:0);typeof t.Note!="undefined"&&(e.Note=t.Note);(typeof t.PickupInfo!="undefined"||typeof t.TransferInfo!="undefined")&&(e.PickupInfo=i._getPickupInfo(t.PickupInfo,t.TransferInfo,t.pIndex));typeof t.Serial!="undefined"&&(e.Serial=t.Serial);typeof t.PaymentType!="undefined"&&h._isBooking()&&vIsEstStr(f)&&(e.PaymentInfo=f,e.UserCharge=i.options.un);typeof t.RoundTripCode!="undefined"&&(e.RoundTripCode=t.RoundTripCode);typeof t.SNote!="undefined"&&(e.SNote=t.SNote);typeof t.ResponsibilityUser!="undefined"&&(e.ResponsibilityUser=t.ResponsibilityUser);typeof t.PickOrReturnDate!="undefined"&&(e.PickOrReturnDate=t.PickOrReturnDate);u._d.push(e)}),u},_quickPay:function(){var t=this,i=t._createObjQuickPay(),r;!1!=i&&(r=function(i){if(i==1){var r=[];n.each(t._seatStack,function(n,t){r.push(t._label)});t._storeHistory(t.options.un,"update",{_tid:t._cTripId,_tname:t._data[t._cTripIndex].Name,_tdate:t._getDepartureTime(),_s:r});t._resetSeatStack();t._reloadSheet()}},t._submitAsyncAction(i,r))},_createObjQuickPay:function(){var t=this,r={},i,u,f,e;if(r._a="UpdateBookTicket",r._c=[],r._d=[],i={},i.PaymentType=1,u="",vIsEstStr(i.PaymentType)){f="";n.each(_dict._pm,function(n,t){""==f&&t[0]==i.PaymentType&&(f=t[1].vi)});e="";switch(parseInt(i.PaymentType)){case 1:e=t._getBranchInfo(app.aid)}u=t._getPayment(i.PaymentType,f,e)}return n.each(t._seatStack,function(n,f){var o=f._getCurrentTicket(),s=new Date(o._pdate.getTime()),e;s.addMinutes(t._sOffsetMinute);r._c.push({Id:o._id,TripId:t._cTripId,SeatCode:f._getSeatInfo(),PickupDate:s.toFormatString("iso"),Bus:t._cTripBus});e={TripAlias:parseInt(t._cTripBus),Status:2};typeof i.PaymentType!="undefined"&&(e.PaymentInfo=u,o._isBooking()&&vIsEstStr(u)&&(e.UserCharge=t.options.un));r._d.push(e)}),r},_thongKeTheoChuyen:function(){var i=this,g=n.trim(i._cTripDate.toFormatString("dd-mm-yyyy")),nt=n.trim(i._cTripTime),tt=n.trim(i._data[i._cTripIndex].Name),r,d;i._clearSheet();i._$cancelSheet.hide();i._$tripInfo.append('<h4 style="font-size: 24px;text-align: center;">Thống kê theo chuyến '+tt+" ngày "+g+" lúc "+nt+"<\/h4>");var t=i._getCurrentTripInfo(),o=t._anotherFareTienKhach,it=t._nameAnotherFareTienKhach,rt=t._mainFareTienKhach,s=t._feeTienKhach,ut=t._nameFeeTienKhach,ft=o+rt-s,et=t._totalNumBranchNotPaid+t._numPickedProNotPaid,ot=t._totalNumBranchPaid+t._numPickedProPaid,y=t._totalMoneyBranchNotPaid+t._moneyPickedProNotPaid,p=t._totalMoneyBranchPaid+t._moneyPickedProPaid,h=t._totalMoneyBranchNotPaid+t._totalMoneyBranchPaid+t._moneyPickedProNotPaid+t._moneyPickedProPaid,w=t._feeTienHang,st=t._nameFeeTienHang,c=h-w,b=t._anotherFee,u=[],l=[],a=0;b.length>0?n.each(b,function(n,t){u.length==0?u.push(t):l.push(t);a+=t._money.toNum()}):u.push({_index:0,_name:"",_money:""});var v=t._tollFee+t._washFee+t._eatFee+a,ht=ft+c-v,ct=n('<div class="col-md-6 col-sm-12 col-xs-12 pl0"/>').append("<h4>TIỀN KHÁCH<\/h4>").append(_dict._tienKhachTitle),lt=n('<div class="col-md-6 col-sm-12 col-xs-12 pr0 pl0"/>').append("<h4>TIỀN HÀNG<\/h4>").append(_dict._tienHangTitle),at=n('<div class="col-md-12 col-sm-12 col-xs-12 clearfix pl0 pr0 thong-ke-tb" />').append("<h4>CHI PHÍ<\/h4>").append('<table class="table table-bordered list-ticket thong-ke chi-phi"><tbody><tr><td style="width:22%;height:30px;"><div class="form-group col-md-12" style="margin:0;padding:0;"><label class="col-md-4 col-sm-4 control-label pl0 pr0" style="line-height:30px;" for="inputEmail3">Cầu đường:<\/label><div class="col-md-8 col-sm-7 pl0 pr0 input-group"><input name="TollFee" placeholder="" class="form-control input-sm" value="'+t._tollFee.toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/div><\/td><td style="width:22%;"><div class="form-group col-md-12" style="margin:0;padding:0;"><label class="col-md-4 col-sm-4 control-label pr0" style="line-height:30px;" for="inputEmail3">Rửa xe:<\/label><div class="col-md-8 col-sm-7 pl0 pr0 input-group"><input name="WashFee" placeholder="" class="form-control input-sm" value="'+t._washFee.toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/div><\/td><td colspan="2"><div class="form-group"><label class="col-sm-5 control-label" style="line-height:30px;" for="inputEmail3">Chi phí khác: <span name="TotalAnotherFee" data-total-another-fee="0">'+a.toMn()+' đ<\/span><\/label><\/div><\/td><\/tr><tr><td style="width:22%;"><div class="form-group col-md-12" style="margin:0;padding:0;"><label class="col-md-4 col-sm-4 control-label pl0 pr0" style="line-height:30px;" for="inputEmail3">Tiền ăn:<\/label><div class="col-md-8 col-sm-7 pl0 pr0 input-group"><input name="EatFee" placeholder="" class="form-control input-sm" value="'+t._eatFee.toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/div><\/td><td><\/td><td class="another-fee"><div class="form-group col-md-6 pl0"><label class="col-sm-5 control-label pr0" style="line-height:30px;" for="inputEmail3">Tên chi phí:<\/label><div class="col-sm-7 pl0 pr0"><input name="NameAnotherFee" placeholder="" class="form-control input-sm" value="'+u[0]._name+'"><\/div><\/div><div class="form-group col-md-5"><label class="col-sm-5 control-label pr0" style="line-height:30px;" for="inputEmail3">Số tiền:<\/label><div class="col-sm-7 pl0 pr0 input-group"><input name="MoneyAnotherFee" placeholder="" class="form-control input-sm" value="'+u[0]._money.toNum().toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/div><div class="col-md-1 pr0 pl0"><button name="AddMoreFee" type="button" class="btn btn-sm btn-default"><i class="glyphicon glyphicon-plus"><\/i><\/button><\/div><\/td><\/tr><tr><td colspan="4"><h4>TỔNG CHÍ PHÍ: <span name="TotalFee" data-total-fee="'+v+'">'+v.toMn()+' đ<\/span><\/h4><\/td><\/tr><tr><td colspan="4"><h3>TỔNG CỘNG: <span name="TotalTotal">'+ht.toMn()+' đ<\/span><\/h3><button type="button" class="btn btn-md btn-success tk-save-trip"><i class="glyphicon glyphicon-save"><\/i>&nbsp;LƯU<\/button>&nbsp;<button type="button" class="btn btn-md btn-primary btn-chot-phoi">CHỐT PHƠI<\/button><\/td><\/tr><\/tbody><\/table>');i._$sheet.addClass("thong-ke-tb").append(ct).append(lt).append(at);var k=0,f=0,e=i._$sheet.find("table.tien-khach tbody");typeof t._tkNumPaidPerType!="undefined"&&n.each(t._tkNumPaidPerType,function(t,i){var r=i.split("|"),u="",o,s;u=r[0]=="TX"?"Tài xế thu":r[0]=="VXR"?"VeXeRe":r[0];o={_branchCode:u,_numTic:r[1]+" vé",_totalFare:parseInt(r[2]).toMn()+" đ"};s=n(vtpl(_dict._tienKhachInput,o));e.append(s);k+=parseInt(r[1]);f+=parseInt(r[2])});e.append("<tr><td><h4>Tổng cộng<\/h4><\/td><td><h4>"+k+' vé<\/h4><\/td><td name="TotalFareTicket" data-fare="'+f+'"><h4>'+f.toMn()+" đ<\/h4><\/td><\/tr>");e.append('<tr><td style="line-height:30px;">Doanh thu khác <\/td><td><input type="text" name="NameAnotherFareTienKhach" placeholder="Tên doanh thu" class="form-control input-bd0 input-sm" value="'+it+'"/><\/td><td class="col-md-4"><div class="input-group"><input type="text" placeholder="Tổng tiền doanh thu khác" class="form-control input-bd0 input-sm" name="AnotherFareTienKhach" value="'+o.toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/td><\/tr>');e.append('<tr><td style="line-height:30px;">Chi phí văn phòng <\/td><td><input type="text" name="NameFeeTienKhach" placeholder="Tên chi phí" class="form-control input-bd0 input-sm" value="'+ut+'"/><\/td><td class="col-md-4"><div class="input-group"><input type="text" placeholder="Chi phí văn phòng" class="form-control input-bd0 input-sm" name="FeeTienKhach" value="'+s.toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/td><\/tr>');e.append('<tr><td colspan="2"><h4><b>Tổng<\/b><\/h4><\/td><td><h4 class="totalTienKhach" data-total-tien-khach="'+(f+o-s)+'" style="font-weight:bold;"><b>'+(f+o-s).toMn()+" đ<\/b><\/h4><\/td><\/tr>");r=i._$sheet.find("table.tien-hang tbody");typeof t._branchProduct!="undefined"&&t._branchProduct.length>0?n.each(t._branchProduct,function(t,i){var u={_branchCode:i._branchCode,_numBranchProPaid:i._numBranchProPaid,_moneyBranchProPaid:i._moneyBranchProPaid.toMn(),_numBranchProNotPaid:i._numBranchProNotPaid,_moneyBranchProNotPaid:i._moneyBranchProNotPaid.toMn(),_totalMoneyBranchFormat:(i._moneyBranchProPaid+i._moneyBranchProNotPaid).toMn()},f=n(vtpl(_dict._tienHangInput,u));r.append(f)}):typeof t._branchReceiveProduct!="undefined"&&n.each(t._branchReceiveProduct,function(t,i){var u={_branchCode:i._code,_numBranchProPaid:0,_moneyBranchProPaid:0,_numBranchProNotPaid:0,_moneyBranchProNotPaid:0,_totalMoneyBranchFormat:0},f=n(vtpl(_dict._tienHangInput,u));r.append(f)});r.append('<tr><td style="line-height:30px;">Dọc đường<\/td><td><div class="input-group col-md-12"><input name="PickedPaid" type="text" placeholder="Đã TT" class="form-control input-bd0 input-sm" value="'+t._moneyPickedProPaid.toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/td><td style="width:60px;"><input name="NumPickedPaid" type="text" placeholder="SL" class="form-control input-bd0 input-sm" value="'+t._numPickedProPaid+'"><\/td><td><div class="input-group col-md-12"><input name="PickedNotPaid" type="text" placeholder="Chưa TT" class="form-control input-bd0 input-sm" value="'+t._moneyPickedProNotPaid.toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/td><td style="width:60px;"><input name="NumPickedNotPaid" type="text" placeholder="SL" class="form-control input-bd0 input-sm" value="'+t._numPickedProNotPaid+'"><\/td><td name="TotalFarePicked" style="line-height:30px;">'+(t._moneyPickedProNotPaid+t._moneyPickedProPaid).toMn()+" đ<\/td><\/tr>");r.append('<tr><td><h4>Tổng cộng<\/h4><\/td><td><h4 data-total-paid="'+p+'" class="totalPaid">'+p.toMn()+' đ<\/h4><\/td><td><h4 class="totalCountPaid">'+ot+'<\/h4><\/td><td><h4 data-total-not-paid="'+y+'" class="totalNotPaid">'+y.toMn()+' đ<\/h4><\/td><td><h4 class="totalCountNotPaid">'+et+'<\/h4><\/td><td><h4 class="totalTienHangNotFee" data-total-tien-hang-not-fee="'+h+'">'+h.toMn()+" đ<\/h4><\/td><\/tr>");r.append('<tr><td style="line-height:30px;">Chi phí hàng<\/td><td colspan="4"><input name="NameFeeTienHang" type="text" class="form-control input-bd0 input-sm" placeholder="Tên chi phí" value="'+st+'"/><\/td><td><div class="input-group"><input name="FeeTienHang" type="text" class="form-control input-bd0 input-sm" value="'+w.toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/td><\/tr>');r.append('<tr><td colspan="5" style="line-height:30px;"><h4 style="font-weight:bold;">Tổng<\/h4><\/td><td><h4 style="font-weight:bold;" class="totalTienHang" data-total-tien-hang="'+c+'">'+c.toMn()+" đ<\/h4><\/td><\/tr>");l.length>0&&n.each(l,function(n,t){i._$sheet.find("td.another-fee").append('<div class="form-group col-md-6 pl0 mt10"><label class="col-sm-5 control-label pr0" style="line-height:30px;" for="inputEmail3">Tên chi phí:<\/label><div class="col-sm-7 pl0 pr0"><input name="NameAnotherFee" placeholder="" class="form-control input-sm" value="'+t._name+'"><\/div><\/div><div class="form-group col-md-5 mt10"><label class="col-sm-5 control-label pr0" style="line-height:30px;" for="inputEmail3">Số tiền:<\/label><div class="col-sm-7 pl0 pr0 input-group"><input name="MoneyAnotherFee" placeholder="" class="form-control input-sm" value="'+t._money.toNum().toMn()+'"><div class="input-group-addon">đ<\/div><\/div><\/div><div class="col-md-1 pr0 pl0 mt10"><button name="RemoveMoreFee" type="button" class="btn btn-sm btn-default"><i class="glyphicon glyphicon-remove"><\/i><\/button><\/div>')});d=i._data[i._cTripIndex].Ts[i._cTripTime][0].ClosedStatus;d==2&&app.rights.indexOf("5|10095|1")==-1&&(i._$sheet.find("input,button").prop("disabled","disabled"),i._$sheet.find("button.tk-save-trip,button.btn-chot-phoi").addClass("hidden"));i._bindEventTKTienKhach();i._bindEventTKTienHang();i._bindEventTKChiPhi()},_bindEventTKTienKhach:function(){var t=this,r=t._$sheet.find('td[name="TotalFareTicket"]').attr("data-fare").toNum(),u=0,i=0;t._$sheet.find('input[name="AnotherFareTienKhach"]').on("change",function(){var e=t._$sheet.find('input[name="FeeTienKhach"]').val().replace(/\./g,"").toNum(),f=n(this).val().replace(/\./g,"").toNum(),o,s;f<1e4&&(f=f*1e3);o=t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang").toNum();s=t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee").toNum();f>0?(n(this).val(f.toMn()),i=f+r-e):(n(this).val(0),i=r-e);u=i+o-s;t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach",i);t._$sheet.find("h4.totalTienKhach").text(i.toMn()+" đ");t._$sheet.find('span[name="TotalTotal"]').text(u.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="FeeTienKhach"]').on("change",function(){var f=n(this).val().replace(/\./g,"").toNum(),e=t._$sheet.find('input[name="AnotherFareTienKhach"]').val().replace(/\./g,"").toNum(),o,s;f<1e4&&(f=f*1e3);i=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum();o=t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang").toNum();s=t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee").toNum();f>0?(n(this).val(f.toMn()),i=r+e-f):(n(this).val(0),i=r+e);u=i+o-s;t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach",i);t._$sheet.find("h4.totalTienKhach").text(i.toMn()+" đ");t._$sheet.find('span[name="TotalTotal"]').text(u.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()})},_bindEventTKTienHang:function(){var t=this,h=0,c=0,a=0,f=0,e=0,v=0,o=0,s=0,u=0,r=0,i=0,l=0;t._$sheet.find('input[name="BranchNotPaid"]').on("change",function(){var v=n(this),y=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum(),p=t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee").toNum(),f;h=n(this).val().replace(/\./g,"").toNum();c=v.closest("tr").find('input[name="BranchPaid"]').val().replace(/\./g,"").toNum();e=t._$sheet.find('input[name="PickedNotPaid"]').val().replace(/\./g,"").toNum();s=t._$sheet.find("h4.totalPaid").attr("data-total-paid").toNum();u=t._$sheet.find('input[name="FeeTienHang"]').val().replace(/\./g,"").toNum();h<1e4&&(h=h*1e3);h>0?(n(this).val(h.toMn()),a=h+c):(n(this).val(0),a=c);f=0;n.each(t._$sheet.find('input[name="BranchNotPaid"]'),function(t,i){var r=n(i).val().replace(/\./g,"").toNum();f+=r});o=f+e;r=o+s;i=r-u;l=y+i-p;v.closest("tr").find('td[name="TotalFareBranch"]').text(a.toMn()+" đ");t._$sheet.find("h4.totalNotPaid").text(o.toMn()+" đ");t._$sheet.find("h4.totalNotPaid").attr("data-total-not-paid",o);t._$sheet.find("h4.totalTienHangNotFee").text(r.toMn()+" đ");t._$sheet.find("h4.totalTienHangNotFee").attr("data-total-tien-hang-not-fee",r);t._$sheet.find("h4.totalTienHang").text(i.toMn()+" đ");t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang",i);t._$sheet.find('span[name="TotalTotal"]').text(l.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="BranchPaid"]').on("change",function(){var v=n(this),y=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum(),p=t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee").toNum(),e;c=n(this).val().replace(/\./g,"").toNum();h=v.closest("tr").find('input[name="BranchNotPaid"]').val().replace(/\./g,"").toNum();f=t._$sheet.find('input[name="PickedPaid"]').val().replace(/\./g,"").toNum();o=t._$sheet.find("h4.totalNotPaid").attr("data-total-not-paid").toNum();u=t._$sheet.find('input[name="FeeTienHang"]').val().replace(/\./g,"").toNum();c<1e4&&(c=c*1e3);c>0?(n(this).val(c.toMn()),a=h+c):(n(this).val(0),a=h);e=0;n.each(t._$sheet.find('input[name="BranchPaid"]'),function(t,i){var r=n(i).val().replace(/\./g,"").toNum();e+=r});s=e+f;r=o+s;i=r-u;l=y+i-p;v.closest("tr").find('td[name="TotalFareBranch"]').text(a.toMn()+" đ");t._$sheet.find("h4.totalPaid").text(s.toMn()+" đ");t._$sheet.find("h4.totalPaid").attr("data-total-paid",s);t._$sheet.find("h4.totalTienHangNotFee").text(r.toMn()+" đ");t._$sheet.find("h4.totalTienHangNotFee").attr("data-total-tien-hang-not-fee",r);t._$sheet.find("h4.totalTienHang").text(i.toMn()+" đ");t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang",i);t._$sheet.find('span[name="TotalTotal"]').text(l.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="PickedPaid"]').on("change",function(){var c=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum(),a=t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee").toNum(),h;f=n(this).val().replace(/\./g,"").toNum();e=t._$sheet.find('input[name="PickedNotPaid"]').val().replace(/\./g,"").toNum();o=t._$sheet.find("h4.totalNotPaid").attr("data-total-not-paid").toNum();u=t._$sheet.find('input[name="FeeTienHang"]').val().replace(/\./g,"").toNum();f<1e4&&(f=f*1e3);f>0?(n(this).val(f.toMn()),v=e+f):(n(this).val(0),v=e);h=0;n.each(t._$sheet.find('input[name="BranchPaid"]'),function(t,i){var r=n(i).val().replace(/\./g,"").toNum();h+=r});s=f+h;r=o+s;i=r-u;l=c+i-a;t._$sheet.find('td[name="TotalFarePicked"]').text(v.toMn()+" đ");t._$sheet.find("h4.totalPaid").text(s.toMn()+" đ");t._$sheet.find("h4.totalPaid").attr("data-total-paid",s);t._$sheet.find("h4.totalTienHangNotFee").text(r.toMn()+" đ");t._$sheet.find("h4.totalTienHangNotFee").attr("data-total-tien-hang-not-fee",r);t._$sheet.find("h4.totalTienHang").text(i.toMn()+" đ");t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang",i);t._$sheet.find('span[name="TotalTotal"]').text(l.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="PickedNotPaid"]').on("change",function(){var c=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum(),a=t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee").toNum(),h;e=n(this).val().replace(/\./g,"").toNum();f=t._$sheet.find('input[name="PickedPaid"]').val().replace(/\./g,"").toNum();s=t._$sheet.find("h4.totalPaid").attr("data-total-paid").toNum();u=t._$sheet.find('input[name="FeeTienHang"]').val().replace(/\./g,"").toNum();e<1e4&&(e=e*1e3);e>0?(n(this).val(e.toMn()),v=e+f):(n(this).val(0),v=f);h=0;n.each(t._$sheet.find('input[name="BranchNotPaid"]'),function(t,i){var r=n(i).val().replace(/\./g,"").toNum();h+=r});o=e+h;r=o+s;i=r-u;l=c+i-a;t._$sheet.find('td[name="TotalFarePicked"]').text(v.toMn()+" đ");t._$sheet.find("h4.totalNotPaid").attr("data-total-not-paid",o);t._$sheet.find("h4.totalNotPaid").text(o.toMn()+" đ");t._$sheet.find("h4.totalTienHangNotFee").text(r.toMn()+" đ");t._$sheet.find("h4.totalTienHangNotFee").attr("data-total-tien-hang-not-fee",r);t._$sheet.find("h4.totalTienHang").text(i.toMn()+" đ");t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang",i);t._$sheet.find('span[name="TotalTotal"]').text(l.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="NumBranchNotPaid"]').on("change",function(){var i=0,r;n.each(t._$sheet.find('input[name="NumBranchNotPaid"]'),function(t,r){var u=n(r).val().toNum();i+=u});r=t._$sheet.find('input[name="NumPickedNotPaid"]').val().toNum();t._$sheet.find("h4.totalCountNotPaid").text(i+r)}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="NumPickedNotPaid"]').on("change",function(){var i=0,r;n.each(t._$sheet.find('input[name="NumBranchNotPaid"]'),function(t,r){var u=n(r).val().toNum();i+=u});r=n(this).val().toNum();t._$sheet.find("h4.totalCountNotPaid").text(i+r)}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="NumBranchPaid"]').on("change",function(){var i=0,r;n.each(t._$sheet.find('input[name="NumBranchPaid"]'),function(t,r){var u=n(r).val().toNum();i+=u});r=t._$sheet.find('input[name="NumPickedPaid"]').val().toNum();t._$sheet.find("h4.totalCountPaid").text(i+r)}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="NumPickedPaid"]').on("change",function(){var i=0,r;n.each(t._$sheet.find('input[name="NumBranchPaid"]'),function(t,r){var u=n(r).val().toNum();i+=u});r=n(this).val().toNum();t._$sheet.find("h4.totalCountPaid").text(i+r)}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="FeeTienHang"]').on("change",function(){var f=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum(),e=t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee").toNum();r=t._$sheet.find("h4.totalTienHangNotFee").attr("data-total-tien-hang-not-fee").toNum();u=n(this).val().replace(/\./g,"").toNum();u<1e4&&(u=u*1e3);u>0?(n(this).val(u.toMn()),i=r-u):(n(this).val(0),i=r);l=f+i-e;t._$sheet.find("h4.totalTienHang").text(i.toMn()+" đ");t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang",i);t._$sheet.find('span[name="TotalTotal"]').text(l.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()})},_bindEventTKChiPhi:function(){var t=this,r=0,u=0,f=0,i=0,e=0,o=0,s=0,h=0;t._$sheet.find('input[name="TollFee"]').on("change",function(){r=n(this).val().replace(/\./g,"").toNum();r<1e4&&(r=r*1e3);u=t._$sheet.find('input[name="WashFee"]').val().replace(/\./g,"").toNum();f=t._$sheet.find('input[name="EatFee"]').val().replace(/\./g,"").toNum();e=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum();o=t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang").toNum();s=t._$sheet.find('span[name="TotalAnotherFee"]').attr("data-total-another-fee").toNum();r>0?n(this).val(r.toMn()):n(this).val("");i=r+u+f+s;h=e+o-i;t._$sheet.find('span[name="TotalFee"]').text(i.toMn()+" đ");t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee",i);t._$sheet.find('span[name="TotalTotal"]').text(h.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="WashFee"]').on("change",function(){u=n(this).val().replace(/\./g,"").toNum();u<1e4&&(u=u*1e3);r=t._$sheet.find('input[name="TollFee"]').val().replace(/\./g,"").toNum();f=t._$sheet.find('input[name="EatFee"]').val().replace(/\./g,"").toNum();e=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum();o=t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang").toNum();s=t._$sheet.find('span[name="TotalAnotherFee"]').attr("data-total-another-fee").toNum();u>0?n(this).val(u.toMn()):n(this).val("");i=r+u+f+s;h=e+o-i;t._$sheet.find('span[name="TotalFee"]').text(i.toMn()+" đ");t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee",i);t._$sheet.find('span[name="TotalTotal"]').text(h.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('input[name="EatFee"]').on("change",function(){f=n(this).val().replace(/\./g,"").toNum();f<1e4&&(f=f*1e3);r=t._$sheet.find('input[name="TollFee"]').val().replace(/\./g,"").toNum();u=t._$sheet.find('input[name="WashFee"]').val().replace(/\./g,"").toNum();e=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum();o=t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang").toNum();s=t._$sheet.find('span[name="TotalAnotherFee"]').attr("data-total-another-fee").toNum();f>0?n(this).val(f.toMn()):n(this).val("");i=r+u+f+s;h=e+o-i;t._$sheet.find('span[name="TotalFee"]').text(i.toMn()+" đ");t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee",i);t._$sheet.find('span[name="TotalTotal"]').text(h.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('button[name="AddMoreFee"]').on("click",function(i){i.preventDefault();i.stopPropagation();var r=!0;n.each(t._$sheet.find('input[name="NameAnotherFee"]'),function(t,i){n(i).val()==""?(r=!1,n(i).closest("div").addClass("has-error")):n(i).closest("div").removeClass("has-error")});n.each(t._$sheet.find('input[name="MoneyAnotherFee"]'),function(t,i){n(i).val().replace(/\./g,"").toNum()==0?(r=!1,n(i).closest("div").addClass("has-error")):n(i).closest("div").removeClass("has-error")});r&&(n(this).closest("td.another-fee").append('<div class="form-group col-md-6 pl0 mt10"><label class="col-sm-5 control-label pr0" style="line-height:30px;" for="inputEmail3">Tên chi phí:<\/label><div class="col-sm-7 pl0 pr0"><input name="NameAnotherFee" placeholder="" class="form-control input-sm"><\/div><\/div><div class="form-group col-md-5 mt10"><label class="col-sm-5 control-label pr0" style="line-height:30px;" for="inputEmail3">Số tiền:<\/label><div class="col-sm-7 pl0 pr0 input-group"><input name="MoneyAnotherFee" placeholder="" class="form-control input-sm" value="0"><div class="input-group-addon">đ<\/div><\/div><\/div><div class="col-md-1 pr0 pl0 mt10"><button name="RemoveMoreFee" type="button" class="btn btn-sm btn-default"><i class="glyphicon glyphicon-remove"><\/i><\/button><\/div>'),t._bindEventAnotherFee())});t._$sheet.find("button.tk-save-trip").on("click",function(n){n.preventDefault();n.stopPropagation();t._tkSaveTrip()});t._$sheet.find("button.btn-chot-phoi").on("click",function(n){var i,r,u;if(n.preventDefault(),n.stopPropagation(),i=t._data[t._cTripIndex].Ts[t._cTripTime][0].ClosedStatus,r=t._getCurrentTripInfo(),i!=1){t._showPopModal("Xe chưa xuất bến, không thể chốt phơi. Vui lòng kiểm tra lại.");return}if(r._numBooking>0){t._showPopModal("Còn vé đặt chỗ, vui lòng chuyển thanh toán hoặc hủy rồi thực hiện chốt phơi lại.");return}if(u=t._data[t._cTripIndex].Ts[t._cTripTime][0].TripDetailId,typeof u=="undefined"){t._showPopModal("Chuyến này chưa được đặt vé. Vui lòng kiểm tra lại.");return}t._createChotPhoiDialogDiv()});t._bindEventAnotherFee()},_bindEventAnotherFee:function(){var t=this;t._$sheet.find('input[name="MoneyAnotherFee"]').on("change",function(i){var u,f,e;i.preventDefault();i.stopPropagation();var o=t._$sheet.find('input[name="TollFee"]').val().replace(/\./g,"").toNum(),s=t._$sheet.find('input[name="WashFee"]').val().replace(/\./g,"").toNum(),h=t._$sheet.find('input[name="EatFee"]').val().replace(/\./g,"").toNum(),c=t._$sheet.find("h4.totalTienKhach").attr("data-total-tien-khach").toNum(),l=t._$sheet.find("h4.totalTienHang").attr("data-total-tien-hang").toNum(),r=n(this).val().replace(/\./g,"").toNum();r<1e4&&(r=r*1e3);r>0?n(this).val(r.toMn()):n(this).val("");u=0;n.each(t._$sheet.find('input[name="MoneyAnotherFee"]'),function(t,i){var r=n(i).val().replace(/\./g,"").toNum();u+=r});f=o+s+h+u;e=l+c-f;t._$sheet.find('span[name="TotalAnotherFee"]').text(u.toMn()+" đ");t._$sheet.find('span[name="TotalAnotherFee"]').attr("data-total-another-fee",u);t._$sheet.find('span[name="TotalFee"]').text(f.toMn()+" đ");t._$sheet.find('span[name="TotalFee"]').attr("data-total-fee",f);t._$sheet.find('span[name="TotalTotal"]').text(e.toMn()+" đ")}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$sheet.find('button[name="RemoveMoreFee"]').on("click",function(){var t=n(this).closest("div"),i=t.prev(),r=i.prev();t.remove();i.remove();r.remove()})},_tkSaveTrip:function(){var t=this,y=t._data[t._cTripIndex].Ts[t._cTripTime][0].TripDetailId,p=t._getCurrentTripInfo(),i={},o={_a:"UpTrip",_c:{Id:y}},w=p._mainFareTienKhach,s=t._$sheet.find('input[name="AnotherFareTienKhach"]').val().replace(/\./g,"").toNum(),r=t._$sheet.find('input[name="NameAnotherFareTienKhach"]').val(),h=t._$sheet.find('input[name="FeeTienKhach"]').val().replace(/\./g,"").toNum(),u=t._$sheet.find('input[name="NameFeeTienKhach"]').val(),e,v;if(s>0){if(r==""){t._showPopModal("Vui lòng nhập tên doanh thu khác.");return}}else if(r!=""){t._showPopModal("Doanh thu "+r+" phải lớn hơn 0.");return}if(h>0){if(u==""){t._showPopModal("Vui lòng nhập tên chi phí văn phòng.");return}}else if(u!=""){t._showPopModal("Chi phí "+u+" phải lớn hơn 0.");return}i.PassengerMoney="1~"+w+"|"+r+"##"+s+"|"+u+"##"+h;e=[];n.each(t._$sheet.find("table.thong-ke.tien-hang tbody tr.branch-pro"),function(t,i){var r=n(i),u=r.find('td[name="BranchCode"]').attr("data-branch-code"),f=r.find('input[name="BranchNotPaid"]').val().replace(/\./g,"").toNum(),o=r.find('input[name="NumBranchNotPaid"]').val(),s=r.find('input[name="BranchPaid"]').val().replace(/\./g,"").toNum(),h=r.find('input[name="NumBranchPaid"]').val();e.push(u+":"+h+"|"+s+"##"+o+"|"+f)});var b=t._$sheet.find('input[name="PickedNotPaid"]').val().replace(/\./g,"").toNum(),k=t._$sheet.find('input[name="NumPickedNotPaid"]').val(),d=t._$sheet.find('input[name="PickedPaid"]').val().replace(/\./g,"").toNum(),g=t._$sheet.find('input[name="NumPickedPaid"]').val(),c=t._$sheet.find('input[name="FeeTienHang"]').val().replace(/\./g,"").toNum(),f=t._$sheet.find('input[name="NameFeeTienHang"]').val();if(c>0){if(f==""){t._showPopModal("Vui lòng nhập tên chi phí hàng hóa.");return}}else if(f!=""){t._showPopModal("Chi phí "+f+" phải lớn hơn 0.");return}i.ProductMoney="1~"+e.join(",")+"~"+g+"|"+d+"##"+k+"|"+b+"~"+f+"##"+c;var nt=t._$sheet.find('input[name="TollFee"]').val().replace(/\./g,"").toNum(),tt=t._$sheet.find('input[name="WashFee"]').val().replace(/\./g,"").toNum(),it=t._$sheet.find('input[name="EatFee"]').val().replace(/\./g,"").toNum(),l=[],a=1;n.each(t._$sheet.find('input[name="NameAnotherFee"]'),function(t,i){var r=n(i),u=a,f=r.val(),e=r.closest("div.form-group").next("div").find('input[name="MoneyAnotherFee"]').val().replace(/\./g,"").toNum();l.push(u+"|"+f+"|"+e);a++});i.FeeMoney="1~"+nt+"~"+tt+"~"+it+"~"+l.join("##");o._d=i;v=function(n){n==1&&t._showPopModal("Lưu thành công.")};t._submitAction(o,v)},_chotPhoi:function(){var t=this,u=t._data[t._cTripIndex].Ts[t._cTripTime][0].TripDetailId,h=t._getCurrentTripInfo(),i={},f={_a:"UpTrip",_c:{Id:u}},c=h._mainFareTienKhach,l=t._$sheet.find('input[name="AnotherFareTienKhach"]').val().replace(/\./g,"").toNum(),a=t._$sheet.find('input[name="FeeTienKhach"]').val().replace(/\./g,"").toNum(),r,s;i.PassengerMoney="1~"+c+"|"+l+"|"+a;r=[];n.each(t._$sheet.find("table.thong-ke.tien-hang tbody tr.branch-pro"),function(t,i){var u=n(i),f=u.find('td[name="BranchCode"]').attr("data-branch-code"),e=u.find('input[name="BranchNotPaid"]').val().replace(/\./g,"").toNum(),o=u.find('input[name="NumBranchNotPaid"]').val(),s=u.find('input[name="BranchPaid"]').val().replace(/\./g,"").toNum(),h=u.find('input[name="NumBranchPaid"]').val();r.push(f+":"+h+"|"+s+"##"+o+"|"+e)});var v=t._$sheet.find('input[name="PickedNotPaid"]').val().replace(/\./g,"").toNum(),y=t._$sheet.find('input[name="NumPickedNotPaid"]').val(),p=t._$sheet.find('input[name="PickedPaid"]').val().replace(/\./g,"").toNum(),w=t._$sheet.find('input[name="NumPickedPaid"]').val(),b=t._$sheet.find('input[name="FeeTienHang"]').val().replace(/\./g,"").toNum();i.ProductMoney="1~"+r.join(",")+"~"+w+"|"+p+"##"+y+"|"+v+"~"+b;var k=t._$sheet.find('input[name="TollFee"]').val().replace(/\./g,"").toNum(),d=t._$sheet.find('input[name="WashFee"]').val().replace(/\./g,"").toNum(),g=t._$sheet.find('input[name="EatFee"]').val().replace(/\./g,"").toNum(),e=[],o=1;n.each(t._$sheet.find('input[name="NameAnotherFee"]'),function(t,i){var r=n(i),u=o,f=r.val(),s=r.closest("div.form-group").next("div").find('input[name="MoneyAnotherFee"]').val().replace(/\./g,"").toNum();e.push(u+"|"+f+"|"+s);o++});i.FeeMoney="1~"+k+"~"+d+"~"+g+"~"+e.join("##");f._d=i;s=function(i){if(i==1){var r={_a:"UpTrip",_c:{Id:u},_d:{ClosedStatus:2}},f=function(i){if(i==1){t._renderTripInfo();var r=n.trim(t._cTripDate.toFormatString("dd-mm-yyyy")),u=n.trim(t._cTripTime),f=n.trim(t._data[t._cTripIndex].Name);t._$tripInfo.append('<h4 style="font-size: 24px;text-align: center;">Thống kê theo chuyến '+f+" ngày "+r+" lúc "+u+"<\/h4>");app.rights.indexOf(n.rights.bEdtAtCphoi.val)==-1&&(t._$sheet.find("input,button").prop("disabled","disabled"),t._$sheet.find("button.tk-save-trip,button.btn-chot-phoi").addClass("hidden"))}};t._submitAction(r,f)}};t._submitAction(f,s)},_getCopyInfo:function(t,i,r,u){var f=this,e;if(f._copyInfo={},e=f._convertFormDataToObj(f._$updateForm),typeof _dict._copyField!="undefined"&&n.each(_dict._copyField,function(n,t){f._copyInfo[t]=e[t]!=null?e[t]:""}),f._copyInfo.Code=t,f._copyInfo.FromArea=i,f._copyInfo.ToArea=r,f._copyInfo.TripDetailId=u,!f._validateThemVe()){f._resetCopyInfo();f._unbindEventCopying();return}f._resetSeatStack();f._clearSelectedItem();f._closeUpdateDialog();f._toggleFilterWhenCopyTicket();f._bindEventCopying()},_validateThemVe:function(){var r=this,i=!1,t=null,u=null,f=r._$updateForm.find("input[name=PaymentType]");return typeof _dict._copyFieldRequired!="undefined"&&n.each(_dict._copyFieldRequired,function(n,i){switch(i){case"Note":u=r._$updateForm.find("textarea[name=Note]");break;case"PhoneNumbers":t=r._$updateForm.find("input:text[name=PhoneNumbers]")}}),(f.val()==""||typeof f.val()=="undefined")&&(t!=null&&vIsEstStr(t.val())?t.val().isMulPhone()?t.closest("div.col-md-6").removeClass("has-error"):(t.closest("div.col-md-6").addClass("has-error"),i=!0):u==null?(t.closest("div.col-md-6").addClass("has-error"),i=!0):vIsEstStr(u.val())||(t.closest("div.col-md-6").addClass("has-error"),i=!0)),!i},_resetCopyInfo:function(){var n=this;n._copyInfo={};n._hasCopyTicket=!1;n._toggleFilterWhenCopyTicket()},_toggleFilterWhenCopyTicket:function(){var n=this,t=n._$filterForm.find("select[name=TripId]");n._hasCopyTicket?t.prop("disabled",!0):t.prop("disabled",!1)},_getReturnInfo:function(){var t=this,r,i;if(t._copyInfo={},r=t._getCTripId(),t._cBookReturnTripId=r,i=t._convertFormDataToObj(t._$updateForm),typeof _dict._returnField!="undefined"&&n.each(_dict._returnField,function(n,r){t._copyInfo[r]=i[r]!=null?i[r]:""}),!t._validateBookReturn()){t._resetBookReturnInfo();t._unbindEventBookReturnTicket();return}t._resetSeatStack();t._clearSelectedItem();t._closeUpdateDialog();t._toggleFilterWhenBookReturn();t._bindEventBookReturnTicket()},_validateBookReturn:function(){var r=this,i=!1,t=null;return typeof _dict._returnFieldRequired!="undefined"&&n.each(_dict._returnFieldRequired,function(n,i){switch(i){case"PhoneNumbers":t=r._$updateForm.find("input:text[name=PhoneNumbers]")}}),t!=null&&(t.val()==""?(t.closest("div.col-md-6").addClass("has-error"),i=!0):t.closest("div.col-md-6").removeClass("has-error")),!i},_resetBookReturnInfo:function(){var n=this;n._copyInfo={};n._hasBookReturnTicket=!1;n._cBookReturnTripId=null;n._toggleFilterWhenBookReturn()},_toggleFilterWhenBookReturn:function(){var n=this,t=n._$filterForm.find("select[name=TripId]"),i=n._$filterForm.find("input[name=DepartureDate]"),r=n._$filterForm.find("select[name=TimeSlot]");n._hasBookReturnTicket?(t.addClass("book-return"),i.prop("disabled",!0),n._$filterForm.find(".glyphicon-calendar").parent().unbind("click"),r.prop("disabled",!0)):(t.removeClass("book-return"),i.prop("disabled",!1),r.prop("disabled",!1),n._bindEventOnCalendarIcon())},_showCancelForm:function(n,t){var i=this;typeof t!="undefined"&&t?(i._$cmodal.find(".divFeePercentRadio").children().prop("disabled",!0),i._$cmodal.find(".divFeePercentRadio div").children().prop("disabled",!0)):(i._$cmodal.find(".divFeePercentRadio").children().prop("disabled",!1),i._$cmodal.find(".divFeePercentRadio div").children().prop("disabled",!1));i._$cmodal.find('input[name="TicketFares"]').val(n);i._showCModal()},_resetCancelForm:function(){var n=this,t=0,i=0;typeof _dict._cancelFeePercentDefault!="undefined"&&(t=_dict._cancelFeePercentDefault);typeof _dict._cancelFeeMoneyDefault!="undefined"&&(i=_dict._cancelFeeMoneyDefault.toMn());n._$cmodal.find('input[name="FeePercentRadio"]').prop("checked",!0).button("refresh");n._$cmodal.find('input[name="CancelFeePercentInput"]').val(t);n._$cmodal.find('input[name="CancelFeePercentInput"]').removeClass("cmodal-error-input");n._$cmodal.find('input[name="CancelFeePercentInput"]').next().removeClass("cmodal-error-addon");n._$cmodal.find('input[name="FeeMoneyRadio"]').prop("checked",!1).button("refresh");n._$cmodal.find('input[name="CancelFeeMoneyInput"]').val(i);n._$cmodal.find('input[name="CancelFeeMoneyInput"]').removeClass("cmodal-error-input");n._$cmodal.find('input[name="CancelFeeMoneyInput"]').next().removeClass("cmodal-error-addon");n._$cmodal.find('select[name="CancelReason"]').val("");n._$cmodal.find('textarea[name="NoteCancel"]').val("");n._$cmodal.find("div.warning-mess").html("").hide()},_cancelTicket:function(t,i,r,u,f,e){var o=this,s=o._createCancelTicketObj(t,i,r,u,f,e),h=function(t){if(t==1){var i=[];n.each(o._seatStack,function(n,t){i.push(t._label)});o._storeHistory(o.options.un,"cancel",{_tid:o._cTripId,_tname:o._data[o._cTripIndex].Name,_tdate:o._getDepartureTime(),_s:i});o._resetSeatStack();o._reloadSheet();o._closeCancelDialog()}};o._submitAction(s,h)},_createCancelTicketObj:function(t,i,r,u,f,e){var o=this,s={},h;return s._a="UpdateBookTicket",s._c=[],s._d=[],h=o._seatStack.length,n.each(o._seatStack,function(n,c){var l=c._getCurrentTicket(),a=0,v;t&&(a=l._fare*i/100);r&&(a=Math.floor(u/h));s._c.push({Id:l._id,TripId:o._cTripId,SeatCode:c._getSeatInfo(),PickupDate:l._pdate.toFormatString("iso"),Bus:o._cTripBus,StageCode:o._cStageCode?o._cStageCode:1});v={TripAlias:parseInt(o._cTripBus),Status:3,CancelFee:a,CancelType:f,CancelInfo:e,CanceledUser:app.un,CanceledAgentId:app.aid};s._d.push(v)}),s},_bindEventOnCancelForm:function(){var t=this,i=0,r=0;typeof _dict._cancelFeePercentDefault!="undefined"&&(i=_dict._cancelFeePercentDefault);typeof _dict._cancelFeeMoneyDefault!="undefined"&&(r=_dict._cancelFeeMoneyDefault.toMn());t._$cmodal.find('input[name="FeePercentRadio"]').unbind().on("change",function(i){i.preventDefault();i.stopPropagation();t._$cmodal.find("div.warning-mess").html("").hide();n(this).prop("checked",!0).button("refresh");t._$cmodal.find('input[name="FeeMoneyRadio"]').prop("checked",!1);t._$cmodal.find('input[name="CancelFeeMoneyInput"]').val(r);t._$cmodal.find('input[name="CancelFeeMoneyInput"]').removeClass("cmodal-error-input");t._$cmodal.find('input[name="CancelFeeMoneyInput"]').next().removeClass("cmodal-error-addon")});t._$cmodal.find('input[name="FeeMoneyRadio"]').unbind().on("change",function(r){r.preventDefault();r.stopPropagation();t._$cmodal.find("div.warning-mess").html("").hide();n(this).prop("checked",!0).button("refresh");t._$cmodal.find('input[name="FeePercentRadio"]').prop("checked",!1);t._$cmodal.find('input[name="CancelFeePercentInput"]').val(i);t._$cmodal.find('input[name="CancelFeePercentInput"]').removeClass("cmodal-error-input");t._$cmodal.find('input[name="CancelFeePercentInput"]').next().removeClass("cmodal-error-addon")});t._$cmodal.find('input[name="CancelFeePercentInput"]').unbind().on("change",function(i){i.preventDefault();i.stopPropagation();var r=n(this).val();isNaN(r)?(t._$cmodal.find("div.warning-mess").html("Phí hủy vé không chính xác, vui lòng kiểm tra lại.").show(),n(this).addClass("cmodal-error-input"),n(this).next().addClass("cmodal-error-addon")):(t._$cmodal.find("div.warning-mess").html("").hide(),n(this).removeClass("cmodal-error-input"),n(this).next().removeClass("cmodal-error-addon"))}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$cmodal.find('input[name="CancelFeeMoneyInput"]').unbind().on("change",function(i){i.preventDefault();i.stopPropagation();var r=n(this).val();isNaN(r)?(t._$cmodal.find("div.warning-mess").html("Phí hủy vé không chính xác, vui lòng kiểm tra lại.").show(),n(this).addClass("cmodal-error-input"),n(this).next().addClass("cmodal-error-addon")):(t._$cmodal.find("div.warning-mess").html("").hide(),n(this).removeClass("cmodal-error-input"),n(this).next().removeClass("cmodal-error-addon"),r<1e4&&(r=r*1e3),n(this).val(r.toMn()))}).focus(function(){n(this).select()}).mouseup(function(n){n.preventDefault()});t._$cmodal.find('[name="CancelFeeMoneyInput"]').on("focus",function(){n(this).select();t._$cmodal.find('input[name="FeeMoneyRadio"]').prop("checked",!0);t._$cmodal.find('input[name="FeePercentRadio"]').prop("checked",!1)});t._$cmodal.find('[name="CancelFeePercentInput"]').on("focus",function(){n(this).select();t._$cmodal.find('input[name="FeeMoneyRadio"]').prop("checked",!1);t._$cmodal.find('input[name="FeePercentRadio"]').prop("checked",!0)})},_bindEventOnValidForm:function(){var i=this,t=i._$validForm;t.find("input.datepicker").not("[readonly]").datepicker({dateFormat:"dd-mm-yy"});t.find("i.glyphicon-calendar").parent().on("click",function(){n(this).prev().datepicker("show")});t.find("button").each(function(t,r){if(n(r).hasClass("btn-confirm"))n(r).on("click",function(n){n.preventDefault();i._validTicket()});else if(n(r).hasClass("btn-close"))n(r).on("click",function(n){n.preventDefault();i._clearSelectedItem();i._resetSeatStack();i._closeUpdateDialog()})});t.find("input[name=CancelFee]").not(["readonly"]).on("keyup",function(){var u=parseInt(t.closest("div.modal-body").find("input[name=NumSeat]").val()),i=n(this).val().replace(/\./g,""),r;i=parseInt(i)?parseInt(i):0;r=i*u;n(this).val(i.toMn());t.find("input[name=ToTalCancelFee]").val(r.toMn())})},_validTicket:function(){var n=this,t=n._createValidTicketObj(),i=function(t){t==1&&(n._resetSeatStack(),n._reloadSheet(),n._closeUpdateDialog())};n._submitAction(t,i)},_createValidTicketObj:function(){var i=this,t=i._convertFormDataToObj(i._$validForm),u=0,r;return typeof t.PassCode!="undefined"&&t.PassCode!=null&&t.PassCode!=""&&(u=i._getTicketIdFromPassCode(t.PassCode)),r={},r._a="UpdateBookTicket",r._c=[],r._d=[],n.each(i._seatStack,function(n,f){var o=f._getCurrentTicket(),s,h,e;u!=0?(r._c.push({Id:o._id,TripId:i._cTripId,SeatCode:f._getSeatInfo(),PickupDate:o._pdate.toFormatString("iso"),Bus:i._cTripBus}),r._c.push({Id:u,TripId:i._cTripId,SeatCode:f._getSeatInfo(),PickupDate:o._pdate.toFormatString("iso"),Bus:i._cTripBus}),s={TripAlias:parseInt(i._cTripBus),Status:3,PassCode:t.PassCode},h={TripId:i._cTripId,SeatCode:f._getSeatInfo(),TripDate:i._getDepartureTime().toFormatString("iso"),PickupDate:o._pdate.toFormatString("iso"),TripAlias:parseInt(i._cTripBus),Status:2},r._d.push(s),r._d.push(h)):(r._c.push({Id:o._id,TripId:i._cTripId,SeatCode:f._getSeatInfo(),PickupDate:o._pdate.toFormatString("iso"),Bus:i._cTripBus}),e={},t.Status==7?(e.Status=7,e.TripDate=null):t.Status==6?(e.Status=6,t.FromValid!=null&&t.FromValid!=""&&(e.FromValid=vPrsDt(t.FromValid)),t.ToValid!=null&&t.ToValid!=""&&(e.ToValid=vPrsDt(t.ToValid))):t.Status==3&&(e.TripAlias=parseInt(i._cTripBus),e.Status=t.Status,e.CancelFee=parseInt(t.CancelFee),isNaN(e.CancelFee)&&(e.CancelFee=0)),r._d.push(e))}),r},_getTicketIdFromPassCode:function(n){return parseInt(n)},_maskMoveTicket:function(){var t=this;t._movingStack=[];t._fMoving=!0;n.each(t._seatStack,function(n,i){var u=i._clone(),r=u._getCurrentTicket();r._isNotCome()?r._status=2:r._isCancelled()&&(r._status=1,r._pmInfo=null);t._movingStack.push(u)});t._cMovingTrip={_tid:t._cTripId,_tname:t._data[t._cTripIndex].Name,_tdate:t._getDepartureTime()};t._resetSeatStack();t._toggleFilterWhenMoving();t._bindEventMoving()},_moveTicket:function(n,t){var i=this,r,u;if(i._movingStack.length<=0)return i._fMoving=!1,i._cMovingSeat=null,i._cMovingTrip=null,i._unbindEventMoving(),!1;r=i._createMovedTicketObj(t);u=function(n){if(n==1){var r={_ftid:i._cMovingTrip._tid,_ftname:i._cMovingTrip._tname,_ftdate:i._cMovingTrip._tdate,_fs:[i._cMovingSeat._label],_ttid:i._cTripId,_ttname:i._data[i._cTripIndex].Name,_ttdate:i._getDepartureTime(),_ts:[t._label]};i._storeHistory(i.options.un,"move",r);i._movingStack.length<=0&&(i._fMoving=!1,i._movingStack=[],i._cMovingSeat=null,i._cMovingTrip=null,i._unbindEventMoving(),i._toggleFilterWhenMoving());i._reloadSheet()}};i._submitAction(r,u)},_createMovedTicketObj:function(n){var t=this,u=t._movingStack.shift(),o;t._cMovingSeat=u;var i=u._getCurrentTicket(),f=t._getDepartureTime(),e=f,s=f,r={};return r._a="UpdateBookTicket",r._c=[],r._d=[],r._c.push({Id:i._id,TripId:t._cTripId,SeatCode:n._getSeatInfo(),PickupDate:e.toFormatString("iso"),Bus:t._cTripBus}),o={SeatCode:n._getSeatInfo(),TripDate:s.toFormatString("iso"),PickupDate:e.toFormatString("iso"),TripAlias:t._cTripBus,Status:parseInt(i._status),PaymentInfo:i._pmInfo,SeatType:n._getSeatType(),Code:i._code,LastMovedDate:i._dept.toFormatString("iso"),ChargeDate:i._chargeDate},r._d.push(o),r},_isInMovingStack:function(t){var r=this,i=!1;return n.each(r._movingStack,function(n,r){if(i==!1){var u=r._getCurrentTicket(),f=t._getCurrentTicket();(r._coach=t._coach&&r._row==t._row&&r._col==t._col&&u._id==f._id)&&(i=!0)}}),i},_toggleFilterWhenMoving:function(){var n=this,t=n._$filterForm.find("select[name=TripId]");n._fMoving||n._hasCopyTicket?t.prop("disabled",!0):t.prop("disabled",!1)},_bindEventOnHistoryForm:function(){var t=this,i=t._$historyForm;i.find("button").each(function(i,r){if(n(r).hasClass("btn-close"))n(r).on("click",function(n){n.preventDefault();t._clearSelectedItem();t._resetSeatStack();t._closeUpdateDialog()})})},_startNotification:function(){var t=this;t._$connection=n.connection.notificationHub;typeof t._$connection!="undefined"&&(t._$connection.client.sendNotification=function(n,i,r){t._createWarningDialog(n,i,r)});n.connection.hub.start()},_sendNotification:function(){},_startConnection:function(){n.connection.hub.start()},_isConnected:function(){},_createWarningDialog:function(t,i,r){var o=this,f="",e,u;vIsEstStr(r)&&(f="Mọi chi tiết vui lòng liên hệ: <b>"+r+"<\/b>");e=n("<div />").addClass("modal-body").append(n("<form />").append(n("<table />").addClass("table no-border mb0 table-modal table-condensed").append(n("<tr />").append(n('<td style="border:0;" />').addClass("col-md-6").append(n("<div />").addClass("form-group").attr("area-hidden","true").append(n("<h3 />").html(i)).append(n("<br />")).append(n("<h4 />").html(f))))).append(n("<tr />").append(n("<td />").addClass("col-md-12 list-btn").attr("colspan",3).append(n("<button />",{type:"button"}).addClass("btn btn-danger").text("Đồng ý").css("float","left").click(function(){n("body").find(".warning-popup").modal("hide")}))))));u=n("<div />").addClass("modal fade warning-popup").attr("role","dialog").attr("aria-hidden","true").append(n("<div />").addClass("modal-dialog modal-md").append(n("<div />").addClass("modal-content").append(n("<div />").addClass("modal-header").css("background-color","#c9302c").addClass("bg-danger").append(n("<h2 />").addClass("modal-title thin-1").css("color","white").html(t))).append(e)));u.appendTo(n("body"));u.modal("show")},_parseNotification:function(){}})}(jQuery);
//# sourceMappingURL=p.min.js.map
