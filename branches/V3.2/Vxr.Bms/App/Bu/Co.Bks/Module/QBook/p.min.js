define({start:function(){try{var n=this;n._createQuickBookDiv();vbv("doShowQBook",function(t){n._showQBook(t.d.tData)});vbv("doCloseQBook",function(){n._closeQuickBookForm()})}catch(t){console.error(t)}},_showQBook:function(n){var t=this,i=t._initQuickBookFormData(n);t._renderSeatNoQuickBookDiv(i.SeatNo);t._renderRoutePoints(n,i.RoutePoints,i.FromPoint,i.ToPoint);t._renderPaymentQuickBook();t._populateFormData(i,t._$qBkMd);t._blockFormField();t._bindEventOnQuickBookForm(n);t._showQuickBookModal()},_showQuickBookModal:function(){this._resetQuickBookModal();this._$qBkMd.modal("show")},_bindEventOnQuickBookForm:function(n){var t=this;t._$qBkMd.find("button.close-qBook").unbind().on("click",function(n){n.preventDefault();n.stopPropagation();t._closeQuickBookForm();vbf("resetSeatStack");vbf("onClearSelectedItem")});t._$qBkMd.find('input[name="RoutePoint"]').unbind().on("click",function(){var u=0,f=0,r=0,e=0,o=t._$qBkMd.find('input[name="NumClick"]').val(),i;$(this).is(":checked")?(i=t._$qBkMd.find('input[name="RoutePoint"][checked="checked"]'),i.length>=2?o!=0?(t._$qBkMd.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),$(this).attr("checked",!0),typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint?(i=t._$qBkMd.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),i.length==1&&(u=t._$qBkMd.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),f=i.attr("data-point-id"),r=t._getFareQuickBook(u,f)),e=app.seatStack.length*r,t._$qBkMd.find('input[name="Fare"]').val(r.toMn()),t._$qBkMd.find('input[name="TotalFare"]').val(e.toMn())):(t._$qBkMd.find('input[name="Fare"]').val(0),t._$qBkMd.find('input[name="TotalFare"]').val(0))):(i=t._$qBkMd.find('input[name="RoutePoint"][checked="checked"]'),i.last().removeAttr("checked"),$(this).attr("checked",!0),i=t._$qBkMd.find('input[name="RoutePoint"][checked="checked"]'),i.length==2&&(u=i.first().attr("data-point-id"),f=i.last().attr("data-point-id"),r=t._getFareQBook(n,u,f)),e=app.seatStack.length*r,t._$qBkMd.find('input[name="Fare"]').val(r.toMn()),t._$qBkMd.find('input[name="TotalFare"]').val(e.toMn()),t._$qBkMd.find('input[name="NumClick"]').val(1)):i.length<=1&&(typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&app.rights.indexOf($.rights.bUBFrtStg.val)==-1?(t._$qBkMd.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),$(this).attr("checked",!0),i=t._$qBkMd.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),i.length==1&&(u=t._$qBkMd.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),f=i.attr("data-point-id"),r=t._getFareQuickBook(u,f)),e=app.seatStack.length*r,t._$qBkMd.find('input[name="Fare"]').val(r.toMn()),t._$qBkMd.find('input[name="TotalFare"]').val(e.toMn())):($(this).attr("checked",!0),i=t._$qBkMd.find('input[name="RoutePoint"][checked="checked"]'),i.length==2&&(u=i.first().attr("data-point-id"),f=i.last().attr("data-point-id"),r=t._getFareQBook(n,u,f)),e=app.seatStack.length*r,t._$qBkMd.find('input[name="Fare"]').val(r.toMn()),t._$qBkMd.find('input[name="TotalFare"]').val(e.toMn())))):($(this).removeAttr("checked"),t._$qBkMd.find('input[name="Fare"]').val(0),t._$qBkMd.find('input[name="TotalFare"]').val(0),t._$qBkMd.find('input[name="NumClick"]').val(1))});t._$qBkMd.find('select[name="PaymentType"]').unbind().on("change",function(){$(this).val()==9?t._$qBkMd.find('input[name="StatusInfo"]').val(5):t._$qBkMd.find('input[name="StatusInfo"]').val(2)});t._$qBkMd.find('input[name="Fare"]').unbind().on("change",function(){var r=app.seatStack.length,n=$(this).val().toNum(),i;n<1e4&&(n=n*1e3);i=r*n;$(this).val(n.toMn());t._$qBkMd.find('input[name="TotalFare"]').val(i.toMn())}).focus(function(){$(this).select()}).mouseup(function(n){n.preventDefault()});t._$qBkMd.find("button.pay-qBook").unbind().on("click",function(){t._validateQuickBookForm()||t._payQBook(n)});t._$qBkMd.find("button.print-qBook").unbind().on("click",function(){var i=function(){var i=function(){vbf("onPrintETicket",{tId:n.cTripId,tName:n.tName,tDate:n.tDate,cTrip:n.cTrip,tInfo:n.tInfo});t._closeQuickBookForm();vbf("onClearSelectedItem")};vbf("reloadBookingSheet",{},i)};t._validateQuickBookForm()||t._payQBook(n,i)})},_payQBook:function(n,t){var r=this,i=r._createPayQBookObj(n),u;!1!=i&&(u=function(u){if(u==1)if(typeof t!="undefined"&&typeof t=="function")$.each(app.seatStack,function(n,t){var r=t._getCurrentTicket();r.fromArea=i._d[0].FromArea;r.toArea=i._d[0].ToArea}),t.call();else{var f=[];$.each(app.seatStack,function(n,t){f.push(t._label)});vbf("onStoreHistory",{un:app.un,key:"update",his:{_tid:n.cTripId,_tname:n.data[n.cTripIndex].Name,_tdate:r._getDptTime(),_s:f}});app.seatStack=[];vbf("reloadBookingSheet",{});r._closeQuickBookForm()}},vRqs(i,u))},_getDptTime:function(){var t=app.cDate,n=app.cTime.split(":");return isNaN(parseInt(n[0]))||isNaN(parseInt(n[1]))?{}:(t.setHours(parseInt(n[0])),t.setMinutes(parseInt(n[1])),t)},_createPayQBookObj:function(n){var u=this,t=u._getDataQuickBookForm(n),r={},f,e,i;if(r._a="UpdateBookTicket",r._c=[],r._d=[],f="",vIsEstStr(t.PaymentType)){e="";$.each(_dict._qBookPayment,function(n,i){""==e&&i[0]==t.PaymentType&&(e=i[1].vi)});i="";switch(parseInt(t.PaymentType)){case 1:i=u._getBrIf(app.aid);break;case 2:i=t.ChargeCode;break;case 3:i=t.PayAddress;break;case 4:i=u._gtTmIf();break;case 5:i=t.TransCode;break;case 6:i=u._getBrIf(t.AgentName);break;case 10:i=u._getBrIf(t.BranchName)}f=$.trim(t.PaymentType+":"+e+":"+i)}return $.each(app.seatStack,function(i,u){var o=u._getCurrentTicket(),h=new Date(o._pdate.getTime()),c=moment(o._dept).format("YYYY-MM-DD HH:mm"),e,s;h.addMinutes(app.sOffsetMinute);r._c.push({Id:o._id,TripId:n.cTripId,SeatCode:u._getSeatInfo(),PickupDate:h.toFormatString("iso"),Bus:n.cTripBus});e={TripAlias:parseInt(n.cTripBus),Status:t.StatusInfo,FromArea:t.FromArea,ToArea:t.ToArea};s=o._code;vIsEstStr(s)&&(e.Code=s);typeof t.Fare!="undefined"&&(e.Fare=t.Fare.toNum());typeof t.Note!="undefined"&&(e.Note=t.Note);typeof t.PaymentType!="undefined"&&(e.PaymentInfo=f,o._isBooking()&&vIsEstStr(f)&&(e.UserCharge=app.un));r._d.push(e)}),r},_gtTmIf:function(){var n=FlatObj.cTrip.TeamInfo,t="|",i;return n&&(i=n.split("~"),$.each(i,function(n,i){if(n>=1){var r=i.split("|");r[0]==2&&(t=r[2]+"|"+r[3])}})),t},_getBrIf:function(n){var t="";return $.each(app.branchInfo,function(i,r){t==""&&n==r[0]&&(t=r.join("|"))}),t==""&&(t=[app.aid,app.aite,app.aice,app.aisne,"",""].join("|")),t},_getDataQuickBookForm:function(n){var i=this,t={},h=i._$qBkMd.find('input[name="RoutePoint"][checked="checked"]'),e=h.first(),c,r,f,l,u,o,s;return e.length>0&&!e.is(":disabled")&&(c=e.attr("data-point-id"),r=n.data[n.cTripIndex].StopPoints.data[n.data[n.cTripIndex].StopPoints.idx[c]],t.FromArea="1~"+r.Id+"|"+r.Type+"|"+r.Code+"|"+r.Name),f=h.last(),f.length>0&&!f.is(":disabled")&&(l=f.attr("data-point-id"),u=n.data[n.cTripIndex].StopPoints.data[n.data[n.cTripIndex].StopPoints.idx[l]],t.ToArea="1~"+u.Id+"|"+u.Type+"|"+u.Code+"|"+u.Name),o=i._$qBkMd.find('input[name="Fare"]'),o.is(":disabled")||(t.Fare=o.val()),t.PaymentType=i._$qBkMd.find('select[name="PaymentType"]').val(),t.StatusInfo=i._$qBkMd.find('input[name="StatusInfo"]').val(),s=i._$qBkMd.find('input[name="Note"]').not(":disabled"),s.length>0&&(t.Note=s.val()),t},_validateQuickBookForm:function(){var n=this,t=!1,u=n._$qBkMd.find('input[name="RoutePoint"][checked="checked"]'),i,r;return u.length!=2&&(t=!0,n._$qBkMd.find("div.warning-message").html("Điểm đi, điểm đến không chính xác, vui lòng kiểm tra lại."),n._$qBkMd.find("div.warning-message").show()),i=n._$qBkMd.find('input[name="Fare"]').val().toNum(),r=n._$qBkMd.find('select[name="PaymentType"]').val(),r!=9&&i==0&&(t=!0,n._$qBkMd.find("div.warning-message").html("Giá vé không chính xác, vui lòng kiểm tra lại."),n._$qBkMd.find("div.warning-message").show()),$.each(app.seatStack,function(i,r){var u=r._getCurrentTicket();u._status!=1&&(t=!0,n._$qBkMd.find("div.warning-message").html("Đã có ghế thanh toán rồi, vui lòng kiểm tra lại."),n._$qBkMd.find("div.warning-message").show())}),t},_getFareQBook:function(n,t,i){var u=this,f=u._prsFr(n),e=t+"|"+i,r=f[e];return typeof r=="undefined"?0:r},_prsFr:function(n){var f="",e="",u=0,i=n.data[n.cTripIndex].Ts[n.cTripTime][n.cTripBus].F,t;if(typeof i!="undefined"&&vIsEstStr(i)&&i.length>1){var r=i.split("~"),s=r.length,o=[];for(t=1;t<s;t++)f=r[t].split("|")[0],e=r[t].split("|")[1],u=parseInt(r[t].split("|")[2]),o[f+"|"+e]=isNaN(u)?0:u;return o}return[]},_closeQuickBookForm:function(){var n=this;n._$qBkMd.modal("hide");n._resetQuickBookModal()},_resetQuickBookModal:function(){var n=this;n._$qBkMd.find('input[name="StatusInfo"]').val(2);n._$qBkMd.find('input[name="NumClick"]').val(0);n._$qBkMd.find('input[name="Fare"][disabled="disabled"]').prop("disabled",!1);n._$qBkMd.find('input[name="Note"][disabled="disabled"]').prop("disabled",!1);n._$qBkMd.find('select[name="PaymentType"][disabled="disabled"]').prop("disabled",!1);n._$qBkMd.find("div.warning-message").html("");n._$qBkMd.find("div.warning-message").hide()},_blockFormField:function(){var n=this,o;n._$qBkMd.find('input[name="Note"]').prop("disabled",!1);n._$qBkMd.find('select[name="PaymentType"]').prop("disabled",!1);n._$qBkMd.find('input[name="Fare"]').prop("disabled",!1);n._$qBkMd.find('input[name="RoutePoint"]').prop("disabled",!1);var i=[],r=[],u=[],f=[],e=[],t=[];$.each(app.seatStack,function(n,t){var o=t._getCurrentTicket();i.push(o._note);r.push(o._status);u.push(o._fare);f.push(o.fromArea);e.push(o.toArea)});i=i.getUnique();i.length>1&&t.push("Note");r=r.getUnique();r.length>1&&(t.push("RoutePoint"),t.push("PaymentType"));u=u.getUnique();u.length>1&&t.push("Fare");f=f.getUnique();e=e.getUnique();(f.length>1||e.length>1)&&t.push("RoutePoint");t=t.getUnique();$.each(t,function(t,i){switch(i){case"Note":n._$qBkMd.find('input[name="Note"]').prop("disabled",!0);break;case"Fare":n._$qBkMd.find('input[name="Fare"]').prop("disabled",!0);break;case"RoutePoint":n._$qBkMd.find('div.checkbox-route-point input[name="RoutePoint"]').prop("disabled",!0);break;case"PaymentType":n._$qBkMd.find('select[name="PaymentType"]').prop("disabled",!0)}});typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&(o=n._$qBkMd.find('div.checkbox-route-point input[name="RoutePoint"]').first(),app.rights.indexOf($.rights.bUBFrtStg.val)==-1&&(o.is(":disabled")||o.attr("disabled",!0)))},_populateFormData:function(n,t){$.each(n,function(n,i){var r=$(t).find('[name="'+n+'"]'),u=r.attr("type");switch(u){case"checkbox":r.prop("checked",i);break;case"radio":r.filter('[value="'+i+'"]').prop("checked",i);break;case"label":r.text(i);break;default:r.val(i)}})},_renderPaymentQuickBook:function(){var n=this;n._$qBkMd.find('select[name="PaymentType"]').empty();$.each(_dict._qBookPayment,function(t,i){var r=null;i[2]!=0&&(r=$('<option value="'+i[0]+'" />').html(i[1].vi),n._$qBkMd.find('select[name="PaymentType"]').append(r))})},_renderRoutePoints:function(n,t,i,r){var f=this,o,s;f._$qBkMd.find("div.checkbox-route-point").empty();var h=n.cTripTime,u=parseInt(h.split(":")[0]),e=parseInt(h.split(":")[1]);$.each(t,function(n,i){var r="",h="",o,s;u+=parseInt(i.Hour);e+=parseInt(i.Minute);e>=60&&(e=e%60,u+=1);u>24?u=u%24:u==24&&(u=0,r="00");u<10?r="0"+u:u>=10&&(r=u);h=e<10?"0"+e:e;o="";o=n==0?f._cTripTime:r+":"+h;s=$('<label class="checkbox-inline" />').append($('<input type="checkbox" name="RoutePoint" data-point-id="'+i.Id+'"/>')).append($("<b />").html(i.Code)).append($('<mark class="text-primary"/>').html(o));t.length==2&&s.addClass("hidden");f._$qBkMd.find("div.checkbox-route-point").append(s)});o=0;s=0;n.cDefaultFromId!=0&&(o=n.cDefaultFromId);n.cDefaultToId!=0&&(s=n.cDefaultToId);$.isEmptyObject(i)||(o=i.Id);$.isEmptyObject(r)||(s=r.Id);o==0&&s==0?(f._$qBkMd.find('div.checkbox-route-point input[name="RoutePoint"]').first().attr("checked",!0),f._$qBkMd.find('div.checkbox-route-point input[name="RoutePoint"]').last().attr("checked",!0)):(f._$qBkMd.find('div.checkbox-route-point input[name="RoutePoint"][data-point-id="'+o+'"]').attr("checked",!0),f._$qBkMd.find('div.checkbox-route-point input[name="RoutePoint"][data-point-id="'+s+'"]').attr("checked",!0))},_renderSeatNoQuickBookDiv:function(n){var t=this,i=t._$qBkMd.find("ul#seat-no").empty();$.each(n,function(n,t){i.append($("<li />").addClass("list-group-item").addClass(_dict._vc[Math.floor(Math.random()*_dict._vc.length)]).text(t))})},_initQuickBookFormData:function(n){var p=this,s=[],h=0,y=n.data[n.cTripIndex].StopPoints.data,r={},u={},c=0,f=[],l="",t=[],i=[],a,e,v,o;return $.each(app.seatStack,function(n,r){var u=r._getCurrentTicket();f.push(u._note);t.push(u.fromArea);i.push(u.toArea);s.push(r._label);c=u._fare;h+=u._fare}),f=f.getUnique(),f.length==1&&(l=f[0]),t=t.getUnique(),t.length==1&&(a=t[0].indexOf("~"),e=t[0].substr(a+1,t[0].length).split("|"),r.Id=e[0],r.Type=e[1],r.Code=e[2],r.Name=e[3]),i=i.getUnique(),i.length==1&&(v=i[0].indexOf("~"),o=i[0].substr(v+1,i[0].length).split("|"),u.Id=o[0],u.Type=o[1],u.Code=o[2],u.Name=o[3]),{SeatNo:s,Fare:c.toMn(),TotalFare:h.toMn(),DepartureDate:"Ngày khởi hành: "+n.cTripDate.toFormatString("dd/mm/yyyy")+" - "+n.cTripTime,RouteName:"Tuyến: "+n.data[n.cTripIndex].Name,RoutePoints:y,Note:l,FromPoint:r,ToPoint:u}},_createQuickBookDiv:function(){var t=this,n=$('<div class="panel-primary" />').append($('<div class="panel-heading" />').append($('<h3 class="panel-title" />').html("Đặt vé nhanh"))).append($('<div class="panel-body" style="padding:15px !important;" />').append($('<div class="alert alert-danger warning-message" role="alert" style="margin-bottom:10px;" />').css("display","none")).append($('<input type="hidden" name="StatusInfo" value="2" />')).append($('<input type="hidden" name="NumClick" value="0" />')).append($('<ul id="seat-no" class="list-group" />')).append($('<div class="clearfix" />')).append($('<div class="row mt10" />').append($('<div class="col-md-12" />').append($('<label class="col-md-6 pl0" name="RouteName" type="label" />')).append($('<label class="col-md-6" name="DepartureDate" type="label" />'))).append($('<div class="col-md-12 mt10 checkbox-route-point" />')).append($('<div class="col-md-6 mt10" />').append($('<label class="control-label col-md-4 pl0" />').css("margin-top","8px").html("Giá vé")).append($('<div class="input-group" />').append($('<input type="text" name="Fare" class="form-control vblue fw700" value="" />')).append($('<div class="input-group-addon" />').html("đ")))).append($('<div class="col-md-6 mt10" />').append($('<label class="control-label col-md-4 pl0" />').css("margin-top","8px").html("Tổng tiền")).append($('<div class="input-group" />').append($('<input type="text" name="TotalFare" class="form-control vblue fw700" disabled="disabled" value="" />')).append($('<div class="input-group-addon" />').html("đ")))).append($('<div class="clearfix" />')).append($('<div class="col-md-6 mt10" />').append($('<label class="control-label col-md-4 pl0" />').css("margin-top","8px").html("Thanh toán")).append($('<div class="input-group col-md-8" />').append($('<select class="form-control" name="PaymentType" />')))).append($('<div class="col-md-6 mt10" />').append($('<label class="control-label col-md-4 pl0" />').css("margin-top","8px").html("Ghi chú")).append($('<div class="input-group col-md-8" />').append($('<input type="text" class="form-control" name="Note" value="" />')))).append($('<div class="col-md-12 mt10" />').append($('<button class="btn btn-default close-qBook" type="button" />').html("Đóng")))));typeof _dict._qBookFormButton!="undefined"&&$.each(_dict._qBookFormButton,function(t,i){var r=$('<button type="button" />').css("margin-right","5px").addClass(i[1]).html(i[0]);n.find("button.close-qBook").parent().prepend(r)});t._$qBkMd=$("<div />").addClass("modal fade pop-payment").attr("id","quick-book-popup").attr("role","dialog").attr("aria-hidden","true").append($("<div />").addClass("modal-dialog modal-md").append($("<div />").addClass("modal-content").append(n))).appendTo($("body"))}});
//# sourceMappingURL=p.min.js.map
