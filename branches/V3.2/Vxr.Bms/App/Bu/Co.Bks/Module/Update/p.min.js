define({start:function(n){var i=this,t;n.m&&$.extend(_dict,_dict,n.m);i._createUpdateDialogDiv();t=$(n._e);vev("body","doShowUpdateForm",function(n){var f;if(n.d)try{i._mapInfo(t);var r=n.d.self,o=n.d.seat,s=r._cTripId,u=r._cTripIndex,p=r._data[u].Name,w=r._getDepartureTime(),e=r._cTripTime,h=r._cTripBus,b=r._cStageCode,l=r._data[u].Ts[e][h].TripDetailId,c=app.seatStack,a=r._data[u].Ts[e][0].ClosedStatus,k=r._data[u].Ts[e][h].F,d=r._data[u].StopPoints,v=r._sOffsetMinute,g=r._cDefaultFromId,nt=r._cDefaultToId,tt=r._data[u],it=r._getLimitedDate(),rt=r._data[u].PickedPointsInfo,ut=r._data[u].TransferPointsInfo,ft=r._getCurrentTripInfo(),et=r._data[u].StopPoints.data,y=!1;n.d.blockEnterEvent!=undefined&&n.d.blockEnterEvent&&(y=!0);f=i._initUpdateFormData(t,o,c,l,v,et,s);f&&(app.fromRouteId=0,app.toRouteId=0,i._resetForm(t),t.find("div.message-error").html(""),t.find("div.message-error").hide(),i._populateFormData(f,t),i._renderSeatNoDiv(f.SeatNo,t),i._createRoutePoints(t,f.RoutePoints,f.FromArea,f.ToArea,g,nt,e,k),i._resetForm(t.find("#ValidForm")),vbf("renderHistoryUpdateForm",{seat:o}),i._disableFormFields(t,o,c,a,s),i._bindEventOnUpdateForm(t,c,s,p,w,h,b,d,v,tt,l,it,a,rt,ut,e,ft,y),t.modal("show"),i._triggerUpdateTab(t),i._triggerUpdateForm(t))}catch(ot){vbf("showErrorForm",{message:ot})}else console.log("Show update form fail 2.....")});vev("body","doCloseUpdateForm",function(){i._closeUpdateDialog(t)})},_createUpdateDialogDiv:function(){var n=this,t=$._createForm(_dict._uForm[0],_dict._uForm[1],_dict._uForm[2]),i;t.find("div.alert.alert-danger.message-error").after($('<div class="row" />').css("margin-top","0").append($('<div class="col-md-12 checkbox-route-point" />')));t.find(".row").last().addClass("action-row").children().first().addClass("list-btn col-xs-12 col-sm-12");n._$validForm=$._createForm(_dict._vForm[0],_dict._vForm[1],_dict._vForm[2]);n._$validForm.find(".row").last().addClass("action-row").children().first().addClass("list-btn");i=$("<div />").addClass("modal-body").css("padding-top",0).append($("<div />").addClass("container-fluid").append($("<div />").addClass("row").append($("<div />").addClass("col-md-1 col-sm-1 col-xs-1").css("padding-right",0).addClass("responsive-xs-l").append($("<ul />").addClass("list-group").attr("id","seat-no"))).append($("<div />").addClass("col-md-11 col-sm-11 col-xs-11 pl0-xs mt10-xs").addClass("responsive-xs-r").append($("<ul />").addClass("nav nav-tabs").attr("role","tab-list").append($("<li />").addClass("active").append($("<a />").attr("href","#general").attr("role","tab").attr("data-toggle","tab").attr("data-tab","general").text("Thông tin chung"))).append($("<li />").append($("<a />").attr("href","#valid").attr("role","tab").attr("data-toggle","tab").attr("data-tab","valid").text("Vé mở"))).append($("<li />").append($("<a />").attr("href","#history").attr("role","tab").attr("data-toggle","tab").attr("data-tab","history").text("Lịch sử")))).append($("<div />").addClass("tab-content").append($("<div />").addClass("tab-pane fade in active").attr("id","general").append(t)).append($("<div />").addClass("tab-pane fade").attr("id","valid").append(n._$validForm)).append($("<div />").addClass("tab-pane fade").attr("id","history"))))));n._$modal=$("<div />").addClass("modal fade").attr("id","update-popup").attr("role","dialog").attr("aria-hidden","true").append($("<div />").addClass("modal-dialog modal-md").append($("<div />").addClass("modal-content").append($("<div />").addClass("modal-header bg-primary").css("padding-top","10px").css("padding-bottom","10px").append($("<h3 />").addClass("modal-title thin-1").html("Cập nhật thông tin").css("font-size","18px"))).append(i))).appendTo($("body"));vbf("onUpdateFormCreated")},_mapInfo:function(n){var t=this,i=t._createGetInfoObj(),r=function(t,i,r){var f,e,u,o;t!=1||r<=0||(app.branchInfo=i,f=[],e=[],$.each(i,function(n,t){var i={value:t[0],text:$.trim(t[3])};t[1]==2?f.push(i):t[1]==3&&e.push(i)}),f.sort(function(n,t){return n.text.localeCompare(t.text)}),e.sort(function(n,t){return n.text.localeCompare(t.text)}),$.each(f,function(t,i){n.find("select[name=BranchName]").append($("<option />",{value:i.value}).text(i.text))}),u=n.find("select[name=AgentName]"),o=u.find("option:first-child"),u.empty(),u.append(o),$.each(e,function(n,t){u.append($("<option />",{value:t.value}).text(t.text))}),n.find("select[name=AgentName]").chosen({width:"100%",search_contains:!0}))};vdc.gCompany(i._c,"#",!1,null,r)},_createGetInfoObj:function(){var n={};return n._a="fGetCompany",n._c={BaseId:app.cid,Type:"($x = 2 OR $x = 3)",IsPrgStatus:1},n._f="Id, Type, Code, Name, AddressInfo, PhoneInfo",n},_updateTicket:function(n,t,i,r,u,f,e,o){var h=this,s=h._createUpdateTicketObj(n,t,i,r,u,e),c;s&&(s._d||(s._d=[{}]),c=function(t,i,u,c){var nt,p,w,l,d,g,a,v,tt;if(t!=1){h._closeUpdateDialog(n);return}if(nt=app.seatStack,typeof o!="undefined"&&typeof o=="function"?(app.seatToBeUpdatedReturningInfo=app.seatStack,$.each(app.seatStack,function(n,t){var i=t._getCurrentTicket();i.fromArea=s._d[0].FromArea;i.toArea=s._d[0].ToArea}),o.call(this,s._d[0].Code,s._d[0].FromArea,s._d[0].ToArea)):(p=[],$.each(app.seatStack,function(n,t){p.push(t._label)}),app.dataToBeSavedReturningInfo.code=c,app.seatToBeUpdatedReturningInfo.length>0&&vbf("onUpdateInfoOfReturnTickets"),h._closeUpdateDialog(n),vbf("onStoreHistory",{un:app.un,key:"update",his:{_tid:r,_tname:f,_tdate:e,_s:p}}),vbf("resetSeatStack"),vbf("reloadBookingSheet")),w=!1,l=s._d[0],$.isEmptyObject(l)||l.HasSendSms!="YES"||(w=!0),_dict._autoSendSmsUpdate!=undefined&&_dict._autoSendSmsUpdate&&w){var b=[],k=[],y=0;$.isEmptyObject(l)||(y=l.Status,d=l.CustomerInfo.split("|"),g=d[d.length-1],vIsEstStr(g)&&b.push(g));$.each(nt,function(n,t){k.push(t._label)});a="";v={_tripName:f,_tripDate:e.toFormatString("HH:mm-dd.mm.yyyy"),_nOfSeat:k.length,_seatCodes:k.join(","),_status:y==2||y==5?"Da thanh toan":"Chua thanh toan"};switch(parseInt(y)){case 1:a=vtpl(_dict._smsUpdateTpl,v);break;case 2:a=vtpl(_dict._smsUpdateTpl,v);break;case 3:a=vtpl(_dict._smsCancelTpl,v);break;case 5:a=vtpl(_dict._smsUpdateTpl,v)}b.length>0&&(tt={_a:"sendMobifoneSms",_c:{},_d:{phones:b.join(","),message:a}},vRqs(tt))}},vRqs(s,c))},_createUpdateTicketObj:function(n,t,i,r,u,f){var l=this,e=$._convertFormDataToObj(n),a=e.StatusInfo.split(","),v=e.CustomerInfo.split(","),s={},h,c,o;if(s._a="UpdateBookTicket",s._c=[],s._d=[],h="",vIsEstStr(e.PaymentType)){c="";o="";$.each(_dict._pm,function(n,t){""==c&&t[0]==e.PaymentType&&(c=t[1].vi)});switch(parseInt(e.PaymentType)){case 1:o=typeof _dict._hasSelectBranchPayment!="undefined"&&_dict._hasSelectBranchPayment?$._getBranchInfo(e.BranchName):$._getBranchInfo(app.aid);break;case 2:o=e.ChargeCode;break;case 3:o=e.PayAddress;break;case 4:o=l._getTeamInfo();break;case 5:o=e.TransCode;break;case 6:o=$._getBranchInfo(e.AgentName);break;case 10:o=$._getBranchInfo(e.BranchName)}h=$._getPayment(e.PaymentType,c,o)}return $.each(app.seatStack,function(o,c){var p=c._getCurrentTicket(),ut=a[o],ft=v[o],nt=moment(p._pdate),tt=moment(p._dept),y,w,it,et,b,rt;if(nt.add(u,"m"),y={TripAlias:parseInt(i),Status:ut,CustomerInfo:ft,FromArea:st,ToArea:ht},_dict._autoCancelTickets!=undefined&&_dict._autoCancelTickets&&(_dict._bookedTicketStatus!=undefined&&app.status==_dict._bookedTicketStatus&&(w=moment(f),app.seatStack.length<=2?(it=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+_dict._cancelledTime,tt.isAfter(it)?w=moment(it).add(_dict._eslapsedTime[1],"m"):w.add(_dict._eslapsedTime[2],"m")):app.seatStack.length>2&&app.seatStack.length<=5?w.add(_dict._eslapsedTime[3],"m"):app.seatStack.length>5&&app.seatStack.length<=9?w.add(_dict._eslapsedTime[4],"m"):app.seatStack.length>9&&w.add(_dict._eslapsedTime[5],"m")),y.ExpiredTime=w.format("YYYY-MM-DD HH:mm")),tt=tt.format("YYYY-MM-DD HH:mm"),s._c.push({Id:p._id,TripId:r,SeatCode:c._getSeatInfo(),PickupDate:nt.format("YYYY-MM-DD HH:mm"),Bus:i}),app.dataToBeSavedReturningInfo.code=c._getSeatInfo(),app.dataToBeSavedReturningInfo.date=nt.format("YYYY-MM-DD HH:mm"),et=app.un,vIsEstStr(p._firstUserUpdated)||(y.FirstUserUpdated=et),p._isBooking()){var k=0,d=0,ot=n.find('input[name="RoutePoint"][checked="checked"]');app.fromRouteId==0?(k=ot.first().attr("data-point-id"),app.fromRouteId=k):k=app.fromRouteId;b=t.data[t.idx[k]];app.toRouteId==0?(d=ot.last().attr("data-point-id"),app.toRouteId=d):d=app.toRouteId;var g=t.data[t.idx[d]],st="1~"+b.Id+"|"+b.Type+"|"+b.Code+"|"+b.Name,ht="1~"+g.Id+"|"+g.Type+"|"+g.Code+"|"+g.Name;y.FromArea=st;y.ToArea=ht}if(vIsEstStr(p._code)?y.Code=p._code:typeof e.Code!="undefined"&&vIsEstStr(e.Code)&&(y.Code=e.Code),e.PhoneNumbers!=undefined||e.FullName!=undefined){var ct=ft.split("|"),lt=e.PhoneNumbers!=undefined?e.PhoneNumbers.trim():ct[4],at=e.FullName!=undefined?e.FullName:ct[3];y.CustomerInfo=l._getCustomer(e.CustomerId,at,lt)}typeof e.Debt!="undefined"&&(y.Debt=ut==1?e.Debt.toNum()/app.seatStack.length:0);(typeof e.PickupInfo!="undefined"||typeof e.TransferInfo!="undefined")&&(y.PickupInfo=l._getPickupInfo(e.PickupInfo,e.TransferInfo,e.pIndex));typeof e.PaymentType!="undefined"&&vIsEstStr(h)&&(p._isBooking()?y.UserCharge=app.un:y.ChargeDate=p._chargeDate,y.PaymentInfo=h);typeof e.Note!="undefined"&&(y.Note=e.Note);typeof e.Fare!="undefined"&&(y.Fare=e.Fare.toNum());typeof e.Surcharge!="undefined"&&(y.Surcharge=e.Surcharge.toNum());typeof e.Deposit!="undefined"&&(y.Deposit=e.Deposit.toNum());typeof e.Discount!="undefined"&&(y.Discount=e.Discount.toNum());typeof e.Serial!="undefined"&&(y.Serial=e.Serial);typeof e.RoundTripCode!="undefined"&&(y.RoundTripCode=e.RoundTripCode);typeof e.SNote!="undefined"&&(y.SNote=e.SNote);typeof e.ResponsibilityUser!="undefined"&&(y.ResponsibilityUser=e.ResponsibilityUser);typeof e.PickOrReturnDate!="undefined"&&(y.PickOrReturnDate=e.PickOrReturnDate);rt=n.find("input[type='checkbox'][name='HasSendSms']");y.HasSendSms=rt.length>0&&rt.is(":checked")?"YES":"NO";s._d.push(y)}),s},_validateUpdateForm:function(n){var i=!1,t=n.find("div.message-error"),o=n.find("select[name=PaymentType]"),c=n.find("select[name=AgentName]"),r=n.find("input:text[name=PhoneNumbers]"),s=n.find("textarea[name=Note]"),p=n.find("input[name=PickupInfo]"),w=n.find("input[name=TransferInfo]"),f=n.find("input[name=Fare]"),h=n.find("div.checkbox-route-point"),y=n.find("input[name=ToTalFare]"),u=null,l,e,a,v;return _dict._reqFieldUpdateForm!=undefined&&$.each(_dict._reqFieldUpdateForm,function(n,u){switch(u){case"PhoneNumbers":vIsEstStr(r.val())||vIsEstStr(s.val())||vIsEstStr(o.val())||(i=!0,r.closest("div.col-md-6").addClass("has-error"),t.html("Vui lòng nhập số điện thoại."),t.show())}}),vIsEstStr(r.val())?vIsPhone(r.val())?(t.html(""),t.hide()):(i=!0,r.closest("div.col-md-6").addClass("has-error"),t.html("Số điện thoại không chính xác, vui lòng kiểm tra lại."),t.show()):vIsEstStr(s.val())&&vIsEstStr(r.val())&&(vIsPhone(r.val())?(t.html(""),t.hide()):(i=!0,r.closest("div.col-md-6").addClass("has-error"),t.html("Số điện thoại không chính xác, vui lòng kiểm tra lại."),t.show())),vIsEstStr(o.val())&&_dict._validUpdateForm!=undefined&&parseInt(o.val())!=9&&(_dict._validUpdateForm.indexOf(">=")!=-1?(u=parseInt(_dict._validUpdateForm.substring(_dict._validUpdateForm.indexOf(">=")+1,_dict._validUpdateForm.length)),!parseInt(f.val())>=u?(i=!0,f.closest("div.col-md-6").addClass("has-error"),t.html("Giá vé phải lớn hơn hoặc bằng "+u+"."),t.show()):(t.html(""),t.hide())):_dict._validUpdateForm.indexOf(">")!=-1?(u=parseInt(_dict._validUpdateForm.substring(_dict._validUpdateForm.indexOf(">")+1,_dict._validUpdateForm.length)),!parseInt(f.val())>u?(i=!0,f.closest("div.col-md-6").addClass("has-error"),t.html("Giá vé phải lớn hơn "+u+"."),t.show()):(l=y.val().toNum()/app.seatStack.length,e="",$.each(app.seatStack,function(n,t){var i=t._getCurrentTicket();l<f.val().toNum()&&i._fare==0&&(e+=t._label+", ")}),e!=""?(a="Ghế "+e.substring(0,e.length-2)+": Giá vé phải lớn hơn 0.",i=!0,t.html(a),t.show()):(t.html(""),t.hide()))):_dict._validUpdateForm.indexOf("=")!=-1&&(u=parseInt(_dict._validUpdateForm.substring(_dict._validUpdateForm.indexOf("=")+1,_dict._validUpdateForm.length)),!parseInt(f.val())==u?(i=!0,f.closest("div.col-md-6").addClass("has-error"),t.html("Giá vé bằng "+u+"."),t.show()):(t.html(""),t.hide())),parseInt(o.val())==6&&(vIsEstStr(c.val())||(i=!0,c.closest("div.col-md-6").addClass("has-error"),t.html("Vui lòng chọn đại lý thanh toán."),t.show()))),h.length>0&&h.is(":visible")&&(v=h.find('input[name="RoutePoint"][checked="checked"]'),v.length!=2&&(i=!0,t.html("Điểm đi, điểm đến không chính xác. Vui lòng kiểm tra lại."),t.show())),app.hasCopyTicket&&_dict._copyFieldRequired!=undefined&&$.each(_dict._copyFieldRequired,function(n,t){switch(t){case"PhoneNumbers":vIsEstStr(r.val())||(i=!0,r.closest("div.col-md-6").addClass("has-error"));break;case"Note":vIsEstStr(s.val())||(i=!0,s.closest("div.col-md-6").addClass("has-error"))}}),app.hasBookReturnTicket&&_dict._returnFieldRequired!=undefined&&$.each(_dict._returnFieldRequired,function(n,t){switch(t){case"PhoneNumbers":if(!vIsEstStr(r.val())){i=!0;r.closest("div.col-md-6").addClass("has-error");break}}}),!i},_validateUpdateForm2:function(n){var r=n.find("div.message-error"),s=n.find("select[name=PaymentType]"),a=n.find("select[name=AgentName]"),o=n.find("input:text[name=PhoneNumbers]"),h=n.find("textarea[name=Note]"),v=n.find("input[name=PickupInfo]"),y=n.find("input[name=TransferInfo]"),p=n.find("input[name=Fare]"),c=n.find("div.checkbox-route-point"),i={payment:parseInt(s.val()),agent:a.val(),phone:o.val(),note:h.val(),pickup:v.val(),transfer:y.val(),fare:vToNum(p.val())},e=!1,w=!1,u="",l=function(n){var r=!1,t;try{t=i[n];n.indexOf("[")>=0?isNaN(s.val())||t==9||(t=parseInt(i[n.substring(0,n.indexOf("["))]),n.indexOf("[>=")>=0?r=t>=parseInt(n.substring(n.indexOf("[>=")+3).replace("]","")):n.indexOf("[<=")>=0?r=t<=parseInt(n.substring(n.indexOf("[<=")+3).replace("]","")):n.indexOf("[=")>=0?r=t==parseInt(n.substring(n.indexOf("[=")+2).replace("]","")):n.indexOf("[>")>=0?r=t>parseInt(n.substring(n.indexOf("[>")+2).replace("]","")):n.indexOf("[<")>=0&&(r=t<parseInt(n.substring(n.indexOf("[<")+2).replace("]","")))):r=vIsEstStr(t)}catch(u){}return r},k=function(){var f,s,t,o,n,h,r;if(_dict._updateFormValidatingConditions!="undefined")for(f=0;f<_dict._updateFormValidatingConditions.length;f++)for(s=_dict._updateFormValidatingConditions[f].split("&"),t=!0,o=0;o<s.length;o++){if(n=s[o],n=="phone"?t=t&&vIsPhone(i.phone):n.indexOf("!")==0?(h=n.replace("!","").split("->"),t=l(h[0])?t&&l(h[1]):t&&!0):t=t&&l(n),t||u!=""||(u=n,n.indexOf("!")>=0?(r=n.split("->"),u=r[1].indexOf("[")>0?r[1].substring(0,r[1].indexOf("[")):r[1]):n.indexOf("[")>=0&&(u=n.substring(0,n.indexOf("[")))),vIsEstStr(i.phone)&&!vIsPhone(i.phone)){e=!1;break}if(e=e||t,e)return!0}return!1},t,f,b;if(w=k(),w)r.html(""),r.hide();else{switch(u){case"payment":t=s;break;case"agent":t=a;break;case"phone":t=o;break;case"note":t=h;break;case"pickup":t=v;break;case"transfer":t=y;break;case"fare":t=p}_dict._updateFormValidatingErrorMessages!=null&&_dict._updateFormValidatingErrorMessages[u]!=null?r.html(_dict._updateFormValidatingErrorMessages[u]):r.html(_dict._updateFormValidatingErrorMessage);r.show();t!=null&&(t.closest("div.col-md-6").addClass("has-error"),t.focus())}return f=!1,c.length>0&&c.is(":visible")&&(b=c.find('input[name="RoutePoint"][checked="checked"]'),b.length!=2&&(f=!0,r.html("Điểm đi, điểm đến không chính xác. Vui lòng kiểm tra lại."),r.show())),app.hasCopyTicket&&_dict._copyFieldRequired!=undefined&&$.each(_dict._copyFieldRequired,function(n,t){switch(t){case"PhoneNumbers":if(!vIsEstStr(i.phone)){f=!0;o.closest("div.col-md-6").addClass("has-error");break}case"Note":if(!vIsEstStr(i.note)){f=!0;h.closest("div.col-md-6").addClass("has-error");break}}}),app.hasBookReturnTicket&&_dict._returnFieldRequired!=undefined&&$.each(_dict._returnFieldRequired,function(n,t){switch(t){case"PhoneNumbers":if(!vIsEstStr(i.phone)){f=!0;o.closest("div.col-md-6").addClass("has-error");break}}}),e&&!f},_bindEventOnUpdateForm:function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b){var k=this;n.find("input[name=TransferInfo]").not(":disabled").blur(function(){n.find("div.search-result.search-location").remove()});n.find("input[name=TransferInfo]").not(":disabled").keyup(function(t){if(t.keyCode==13||t.keyCode==9){var i=n.find("div.search-result tr.location-selected");i.length>0&&(n.find("input[name=TransferInfo]").val(i.attr("data-name")),n.find("input[name=pIndex]").val(i.attr("data-order")));n.find("div.search-result").remove()}else t.keyCode==40||t.keyCode==38?vbf("onNavigateSuggestTransfer",{keyCode:t.keyCode}):vbf("onGetSuggestTransfer",{f:n,ltp:y,tTime:p,key:this.value})});n.find("input[name=PickupInfo]").not(":disabled").blur(function(){n.find("div.search-result.search-location").remove()});n.find("input[name=PickupInfo]").not(":disabled").keyup(function(t){if(t.keyCode==13||t.keyCode==9){var i=n.find("div.search-result tr.location-selected");i.length>0&&(n.find("input[name=PickupInfo]").val(i.attr("data-name")),n.find("input[name=pIndex]").val(i.attr("data-order")));$("div.search-result").remove()}else t.keyCode==40||t.keyCode==38?vbf("onNavigateSuggestPickup",{keyCode:t.keyCode}):vbf("onGetSuggestPickup",{f:n,lpp:v,tTime:p,key:this.value})});n.find("input[name=PhoneNumbers]").not(":disabled").unbind("keyup").keyup(function(t){if(t.keyCode==13){t.preventDefault();t.stopPropagation();var u=n.find("div.upform-search-result-phone ul.search-items li.selected"),f=u.attr("cid"),e=u.attr("cphone"),o=u.attr("cname");f&&n.find("input[name=CustomerId]").val(u.attr("cid"));e&&n.find("input:text[name=PhoneNumbers]").val(u.attr("cphone"));o&&n.find("input[name=FullName]").val(u.attr("cname"));_dict._hasBTWarning&&f&&vbf("doGetWarningCustomer",{f:n,cName:u.attr("cname"),cPhone:u.attr("cphone"),cId:u.attr("cid"),lmDate:l,tId:i,tName:r});vbf("onClearSuggestCustomer",{f:n})}else vIsNumKey(t)?this.value.length>=6&&this.value.length<=11?(t.preventDefault(),t.stopPropagation(),vbf("onGetSuggestCustomer",{f:n,key:this.value,lmDate:l,tId:i,tName:r})):(t.preventDefault(),t.stopPropagation(),vbf("onClearSuggestCustomer",{f:n})):_dict._arrows.indexOf(t.keyCode)==-1?(t.preventDefault(),t.stopPropagation(),vbf("onClearSuggestCustomer",{f:n})):t.keyCode==27&&(t.preventDefault(),t.stopPropagation(),vbf("onClearSuggestCustomer",{f:n}))});n.find("input[name=PhoneNumbers]").not(":disabled").bind("paste",function(t){this.value=t.originalEvent.clipboardData.getData("Text");isNaN(this.value)||this.value.length!=10&&this.value.length!=11?(t.preventDefault(),t.stopPropagation(),vbf("onClearSuggestCustomer",{f:n})):(t.preventDefault(),t.stopPropagation(),vbf("onGetSuggestCustomer",{f:n,key:this.value,lmDate:l,tId:i,tName:r}));n.find("input[name=PhoneNumbers]").not(":disabled").blur()});n.find("input[type=text]").not("[readonly]").on("keypress",function(t){var e=n.find("div.upform-search-result-phone"),h=n.find("div.search-result.search-location");if(e.length==0&&h.length==0&&t.keyCode==13&&!b){if(t.preventDefault(),t.stopPropagation(),$(this).prop("name")=="Fare")return;if(!k._validateUpdateForm(n))return;if(a!=null&&a==1)return;k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u)}}).on("focus",function(){});n.find("input[name=Code]").parent().find(".input-group-addon").attr("title","Copy to clipboard").clipboard({path:"Base/jquery-clipboard-1.3.2/jquery.clipboard.swf",copy:function(){return console.log("Copy code to clipboard"),n.find("input[name=Code]").val()}});n.find("select[name=PaymentType]").unbind("change").on("change",function(){var i=$(this).closest(".row"),t;i.find(".mpayment").parent().hide();i.find(".mpayment").parent().prev().hide();this.value&&(t=i.find(".mpayment[data-type="+this.value+"]"),this.value==1||this.value==4?typeof _dict._hasSelectBranchPayment!="undefined"&&_dict._hasSelectBranchPayment&&t.length>0&&(t.parent().show(),t.parent().prev().show()):t.length>0&&(t.parent().show(),t.parent().prev().show(),this.value==6&&(t.parent().find("a.chosen-single").css("border-color","#aaa"),n.find("select[name=PaymentType]").attr("disabled")||t.parent().find("select[name=AgentName]").children().each(function(n){n==0?$(this).attr("selected",!0):$(this).attr("selected",!1)}),t.parent().find("select[name=AgentName]").trigger("chosen:updated"))))});n.find("input[name=Fare]").not(["readonly"]).unbind("change").on("change",function(){var r=parseInt(n.find("input[name=NumSeat]").val()),u=0,f=0,e=0,t,i,o;n.find("input[name=Deposit]").length>0&&(u=n.find("input[name=Deposit]").val().toNum());n.find("input[name=Discount]").length>0&&(f=n.find("input[name=Discount]").val().toNum());n.find("input[name=Surcharge]").length>0&&(e=n.find("input[name=Surcharge]").val().toNum());t=$(this).val().toNum();t<1e4&&(t=t*1e3);i=(t+e-f)*r;$(this).val(t.toMn());o=i-u*r;n.find("input[name=Debt]").val(o.toMn());n.find("input[name=ToTalFare]").val(i.toMn())}).focus(function(){$(this).select()}).mouseup(function(n){n.preventDefault()});n.find("input[name=Deposit]").not(["readonly"]).unbind("change").on("change",function(){var t=$(this).val().toNum(),i,u,f,r,e;t<1e4&&(t=t*1e3);$(this).val(t.toMn());i=0;u=0;n.find("input[name=Discount]").length>0&&(i=n.find("input[name=Discount]").val().toNum());n.find("input[name=Surcharge]").length>0&&(i=n.find("input[name=Surcharge]").val().toNum());f=n.find("input[name=Fare]").val().toNum();r=parseInt(n.find("input[name=NumSeat]").val());n.find("input[name=Debt]").length>0&&(e=r*(f+u-i)-r*t,n.find("input[name=Debt]").val(e.toMn()))}).focus(function(){$(this).select()}).mouseup(function(n){n.preventDefault()});n.find("input[name=Surcharge]").not(["readonly"]).unbind("change").on("change",function(){var t=$(this).val().toNum(),i,e;t<1e4&&(t=t*1e3);$(this).val(t.toMn());var r=parseInt(n.find("input[name=NumSeat]").val()),o=n.find("input[name=Fare]").val().toNum(),u=0,f=0;n.find("input[name=Discount]").length>0&&(u=n.find("input[name=Discount]").val().toNum());n.find("input[name=Deposit]").length>0&&(f=n.find("input[name=Deposit]").val().toNum());i=(o+t-u)*r;n.find("input[name=Debt]").length>0&&(e=i-f*r,n.find("input[name=Debt]").val(e.toMn()));n.find("input[name=ToTalFare]").val(i.toMn())}).focus(function(){$(this).select()}).mouseup(function(n){n.preventDefault()});n.find("input[name=Discount]").not(["readonly"]).unbind("change").on("change",function(){var t=$(this).val().toNum(),i,e;t<1e4&&(t=t*1e3);$(this).val(t.toMn());var r=parseInt(n.find("input[name=NumSeat]").val()),o=n.find("input[name=Fare]").val().toNum(),u=0,f=0;n.find("input[name=Surcharge]").length>0&&(u=n.find("input[name=Surcharge]").val().toNum());n.find("input[name=Deposit]").length>0&&(f=n.find("input[name=Deposit]").val().toNum());i=(o+u-t)*r;n.find("input[name=Debt]").length>0&&(e=i-f*r,n.find("input[name=Debt]").val(e.toMn()));n.find("input[name=ToTalFare]").val(i.toMn())}).focus(function(){$(this).select()}).mouseup(function(n){n.preventDefault()});n.find("input").not("[name=PhoneNumbers]").each(function(t,i){$(i).focus(function(t){t.preventDefault();t.stopPropagation();vbf("onClearSuggestCustomer",{f:n})})});n.unbind("shown.bs.modal").on("shown.bs.modal",function(){try{vIsEstStr(_dict._focusUpdateForm)?n.find("input[name="+_dict._focusUpdateForm+"]").focus():n.find("input[name=PhoneNumbers]").focus()}catch(e){n.find("input[name=PhoneNumbers]").focus()}vbf("onClearSuggestCustomer",{f:n})});n.find("button").each(function(l,a){if($(a).hasClass("btn-cancel"))$(a).unbind().on("click",function(o){var s,h,c;o.preventDefault();s=[];h=!0;$.each(t,function(n,t){var i=t._getCurrentTicket();i._status!=1&&(h=!1);s.push(i._fare)});c=0;$.each(s,function(n,t){c+=t});k._closeUpdateDialog(n);vbf("doShowCancelForm",{totalFare:c,allIsBooking:h,st:t,tId:i,tName:r,tDate:u,tBus:f,sc:e});app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1});else if($(a).hasClass("btn-update"))$(a).unbind().on("click",function(t){t.preventDefault();var e=k._createGetSeatStatusObj(n),h=function(t,e){var h,a,v;if(typeof e[0][2]!="undefined")if(e[0][2]==3)k._closeUpdateDialog(n),vbf("showErrorForm",{message:_dict._err[7]}),vbf("reloadBookingSheet"),vbf("onClearSelectedItem");else{if(!k._validateUpdateForm(n))return;var y=n.find("input[name=CreatedUser]").val(),c=y.split(","),l=c[0];for(h=0;h<c.length;h++)c[h]!=app.un&&(l=c[h]);l!=app.un?(a=n.find("input:hidden[name=PhoneNumbers]").val(),v=n.find("input:text[name=PhoneNumbers]").val(),a!=v?(k._closeUpdateDialog(n),k._createUpdateConflictDialogDiv(n,l,o,f,i,s,r,u)):(k._transformUpdateFormValue(n),k._updateTicket(n,o,f,i,s,r,u),app.selectedPhone="",app.selectedCode="",app.ctrlOn=!1,$._resetCopyInfo(),$._resetBookReturnInfo())):(k._transformUpdateFormValue(n),k._updateTicket(n,o,f,i,s,r,u),app.selectedPhone="",app.selectedCode="",app.ctrlOn=!1,$._resetCopyInfo(),$._resetBookReturnInfo())}else k._transformUpdateFormValue(n),k._updateTicket(n,o,f,i,s,r,u),app.selectedPhone="",app.selectedCode="",app.ctrlOn=!1,$._resetCopyInfo(),$._resetBookReturnInfo()};$.isEmptyObject(e)?alert("Dữ liệu không chính xác, vui lòng nhấn phím F5. Xin cảm ơn !"):vRqs(e,h)});else if($(a).hasClass("btn-close"))$(a).unbind().on("click",function(t){t.preventDefault();vbf("onClearSelectedItem");vbf("resetSeatStack");app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1;k._closeUpdateDialog(n)});else if($(a).hasClass("btn-eprint"))$(a).unbind().on("click",function(t){t.preventDefault();vbf("onPrintETicket",{tId:i,tName:r,tDate:u,cTrip:h,tInfo:w});vbf("onClearSelectedItem");vbf("resetSeatStack");k._closeUpdateDialog(n);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1});else if($(a).hasClass("btn-eprint-save"))$(a).unbind().on("click",function(t){var c,e,l;if(t.preventDefault(),c=function(){var t=function(){vbf("onPrintETicketSave",{tId:i,tName:r,tDate:u,cTrip:h,tInfo:w});vbf("onClearSelectedItem");vbf("resetSeatStack");k._closeUpdateDialog(n)};vbf("reloadBookingSheet",{},t)},k._validateUpdateForm(n)){if(e=[],$.each(app.seatStack,function(n,t){var i=t._getCurrentTicket();e.push(i._status)}),e=e.getUnique(),e.length>1){n.find("div.message-error").html("Đã có ghế thanh toán rồi, vui lòng kiểm tra lại.");n.find("div.message-error").show();return}if(l=n.find('select[name="PaymentType"]').val(),!vIsEstStr(l)){n.find("div.message-error").html("Vui lòng chọn hình thức thanh toán.");n.find("div.message-error").show();return}k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u,c);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1}});else if($(a).hasClass("btn-add-more-ticket"))$(a).unbind().on("click",function(t){t.preventDefault();app.hasCopyTicket=!0;var e=function(t,r,u){var f=function(){vbf("onBookMoreTicket",{f:n,oldCode:t,fromArea:r,toArea:u,tdid:c,tId:i})};vbf("reloadBookingSheet",{},f)};if(!k._validateUpdateForm(n)){app.hasCopyTicket&&($._resetCopyInfo(),vbf("onUnbindEventCopying"));return}k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u,e);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1});else if($(a).hasClass("btn-return"))$(a).unbind().on("click",function(t){t.preventDefault();app.hasBookReturnTicket=!0;var e=function(){var t=function(){vbf("onBookReturnTicket",{f:n,tId:i})};vbf("reloadBookingSheet",{},t)};if(!k._validateUpdateForm(n)){app.hasBookReturnTicket&&($._resetBookReturnInfo(),vbf("onUnbindEventBookReturnTicket"));return}k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u,e);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1;$("html, body").animate({scrollTop:parseInt($("body").offset().top)},500)})});n.find('textarea[name="Note"]').unbind().on("keypress",function(t){if(t.keyCode==13&&!b){if(t.preventDefault(),t.stopPropagation(),!k._validateUpdateForm(n))return;if(a!=null&&a==1)return;k._transformUpdateFormValue(n);k._updateTicket(n,o,f,i,s,r,u)}})},_populateFormData:function(n,t){$.each(n,function(n,i){var r=$(t).find('[name="'+n+'"]'),u=r.attr("type");switch(u){case"checkbox":r.prop("checked",i);break;case"radio":r.filter('[value="'+i+'"]').prop("checked",i);break;case"label":r.text(i);break;default:r.val(i)}n=="AgentName"&&r.length>0&&setTimeout(function(){r.val(i);r.trigger("chosen:updated")},500)})},_createGetSeatStatusObj:function(n){var t=null,i={};return t=n.find("input[name=IdInfo]").val().split(","),t.length>0&&t[0]!=null&&t[0]!=""&&(i._a="fGetTicket",i._c={Id:t[0]},i._f="Id, TripId, Status, IsPrgHistoryInfo, Code"),i},_initUpdateFormData:function(n,t,i,r,u,f,e){var h=app.copyInfo,o=t._getCurrentTicket(),v,ut,s,c,y,p,l;if($.isEmptyObject(o))return!1;var w=o.fromArea,b=o.toArea,d=0;vIsEstStr(h.CurrentTripId)&&(d=h.CurrentTripId);app.hasCopyTicket&&(d==e?(vIsEstStr(h.FromArea)&&(w=h.FromArea),vIsEstStr(h.ToArea)&&(b=h.ToArea)):(h.FromArea=w,h.ToArea=b));var g=[],k=[],nt=[],tt=[],it=0,rt=[],a=0;if($.each(i,function(n,t){var i=t._getCurrentTicket();app.hasCopyTicket&&h.Fare!=undefined&&(i._fare=h.Fare.toNum());(a==0||a>i._fare&&i._fare>0)&&(a=i._fare);g.push(i._id);k.push(t._label);nt.push(i._getCustomerInfo());tt.push(i._status);rt.push(i._suser);it+=i._fare+i._surCharge-i._discount;i._status!=1&&(i._debt=0)}),v=new Date(o._pdate.getTime()),v.addMinutes(u),ut=f,s={IdInfo:g.join(),PickupDate:v.toFormatString("dd-mm-yyyy"),PickupTime:v.toFormatString("hh:mm"),SeatNo:k,Code:o._code,Fare:a.toMn(),Surcharge:o._surCharge.toMn(),Deposit:o._deposit.toMn(),Discount:o._discount.toMn(),Debt:(o._debt*app.seatStack.length).toMn(),CustomerId:o._cid,CustomerInfo:nt.join(),PhoneNumbers:o._cphone,FullName:o._cname,CreatedUser:rt,Note:o._note,StatusInfo:tt.join(),Serial:o._seri,Notcome:o._status==4?!0:!1,KeepOnTime:o._status==8?!0:!1,NumSeat:k.length,ToTalFare:it.toMn(),RoutePoints:ut,NumClick:0,FromArea:w,ToArea:b,SNote:o._sNote,ResponsibilityUser:o._responUser,PickOrReturnDate:o._porDate},vIsEstStr(o._pmInfo)){c=o._getPaymentInfo();s.PaymentType=c.type;switch(c.type){case 1:s.BranchName=c.info._id;break;case 2:s.ChargeCode=$.map(c.info,function(n){return n}).join("|");break;case 3:s.PayAddress=c.info._addr;break;case 4:s.DriverName=c.info._dname;break;case 5:s.TransCode=c.info._tcode;break;case 6:s.AgentName=c.info._id}}if(vIsEstStr(s.BranchName)||(y=[],n.find("select[name=BranchName] > option").each(function(){y.push($(this).val())}),y.length>0&&y.indexOf(app.aid)!=-1&&(s.BranchName=app.aid)),vIsEstStr(s.AgentName)||(p=[],n.find("select[name=AgentName] > option").each(function(){p.push($(this).val())}),p.length>0&&p.indexOf(app.aid)!=-1&&(s.AgentName=app.aid)),typeof s.ChargeCode=="undefined"&&(s.ChargeCode=_dict._pm[1][4]),vIsEstStr(o._pInfo)&&(l=o._getPickupInfo(),!$.isEmptyObject(l))){switch(l.type){case"P":s.PickupInfo=l.text;break;case"T":s.TransferInfo=l.text}s.pIndex=null;typeof l.pIndex!="undefined"&&(s.pIndex=l.pIndex)}return app.hasCopyTicket&&typeof _dict._copyField!="undefined"&&$.each(_dict._copyField,function(n,t){if(t!="Code")s[t]=h[t];else{var i=h.TripDetailId?h.TripDetailId:0;i==r&&(s[t]=h[t])}}),app.hasBookReturnTicket&&typeof _dict._returnField!="undefined"&&$.each(_dict._returnField,function(n,t){s[t]=h[t]}),_dict._autoSendSmsUpdate!=undefined&&_dict._autoSendSmsUpdate&&(s.HasSendSms=!0),s},_renderSeatNoDiv:function(n,t){var i=t.find("ul#seat-no").empty();$.each(n,function(n,t){i.append($("<li />").addClass("list-group-item").addClass(_dict._vc[Math.floor(Math.random()*_dict._vc.length)]).text(t))})},_normalFormFields:function(n){n.find("input:disabled").prop("disabled",!1);n.find("select:disabled").prop("disabled",!1);n.find("textarea:disabled").prop("disabled",!1);n.find('input[name="RoutePoint"]').prop("disabled",!1);n.find("ul[role=tab-list] li").removeClass("hidden").removeClass("active");n.find("button").removeClass("hidden")},_disableFormFields:function(n,t,i,r,u){var w=this,e,s,p;w._normalFormFields(n);e=["input","select","textarea"];i.length>1&&($.each(_dict._frule[0],function(n,t){var i=$("#"+t[0]);$.each(t[1],function(n,t){for(var r=$(),u=0;r.length==0&&u<e.length;)r=i.find(e[u]+"[name="+t+"]"),u++;r.length>0&&r.prop("disabled",!0)})}),$.each(_dict._trule[0],function(t,i){n.find("a[data-tab="+i+"]").closest("li").addClass("hidden")}));var h=[],c=[],l=[],f={_customer:[],_pickUp:[],_note:[],_fare:[],_surCharge:[],_deposit:[],_discount:[],_paymentInfo:[],_cNames:[],_cPhones:[]},a=[],v=[],y=[],o=[];$.each(i,function(n,t){var i=t._getCurrentTicket(),r,u;$.each(_dict._frule[1],function(n,t){i._status==t[0]&&app.rights.indexOf($.rights.bEdtInfPaidTk.val)==-1&&h.push(t[1])});$.each(_dict._trule[1],function(n,t){i._status==t[0]&&c.push(t[1])});$.each(_dict._brule[1],function(n,t){i._status==t[0]&&l.push(t[1])});f._customer.push(i._getCustomerInfo());f._cNames.push(i._cname);f._cPhones.push(i._cphone);r=i._getPickupInfo();u="";$.isEmptyObject(r)||(u=r.text);f._pickUp.push(u);f._note.push(i._note);f._fare.push(i._fare);f._surCharge.push(i._surCharge);f._deposit.push(i._deposit);f._discount.push(i._discount);f._paymentInfo.push(i._pmInfo);a.push(i.fromArea);v.push(i.toArea);y.push(i._status)});a=a.getUnique();v=v.getUnique();(a.length>1||v.length>1)&&o.push("RoutePoint");y=y.getUnique();y.length>1&&o.push("RoutePoint");o=o.getUnique();$.each(o,function(t,i){switch(i){case"RoutePoint":n.find('input[name="RoutePoint"]').prop("disabled",!0)}});h=h.getUnique();c=c.getUnique();l=l.getUnique();$.each(h,function(n,t){$.each(t,function(n,t){var i=$("#"+t[0]);$.each(t[1],function(n,t){for(var r=$(),u=0;r.length==0&&u<e.length;)r=i.find(e[u]+"[name="+t+"]"),u++;r.length>0&&r.prop("disabled",!0)})})});$.each(c,function(t,i){$.each(i,function(t,i){n.find("a[data-tab="+i+"]").closest("li").addClass("hidden")})});$.each(l,function(n,t){$.each(t,function(n,t){var i=$("#"+t[0]);$.each(t[1],function(n,t){t=="btn-cancel"?app.rights.indexOf($.rights.cReDeFo.val)==-1&&i.find("button."+t).addClass("hidden"):i.find("button."+t).addClass("hidden")})})});s=t._tickets[t._currentTicketIndex]._status;r==1&&(s==2||s==5||s==3)&&typeof _dict._closedTripConf!="undefined"&&_dict._closedTripConf.UpdateForm.length>0&&app.rights.indexOf($.rights.bEnBtnAtDpt.val)==-1&&$.each(_dict._closedTripConf.UpdateForm,function(t,i){n.find("button."+i).addClass("hidden")});s!=1&&n.find('input[name="RoutePoint"]').prop("disabled",!0);app.hasCopyTicket&&(n.find("button.btn-add-more-ticket").addClass("hidden"),n.find("button.btn-return").addClass("hidden"));app.hasBookReturnTicket&&(n.find("button.btn-add-more-ticket").addClass("hidden"),n.find("button.btn-return").addClass("hidden"));f._customer=f._customer.getUnique();f._pickUp=f._pickUp.getUnique();f._note=f._note.getUnique();f._fare=f._fare.getUnique();f._surCharge=f._surCharge.getUnique();f._deposit=f._deposit.getUnique();f._discount=f._discount.getUnique();f._paymentInfo=f._paymentInfo.getUnique();f._cNames=f._cNames.getUnique();f._cPhones=f._cPhones.getUnique();f._cNames.length>1&&n.find("input[name=FullName]").prop("disabled",!0);f._cPhones.length>1&&n.find("input:text[name=PhoneNumbers]").prop("disabled",!0);f._pickUp.length>1&&(n.find("input[name=PickupInfo]").prop("disabled",!0),n.find("input[name=TransferInfo]").prop("disabled",!0),n.find("input[name=pIndex]").prop("disabled",!0));f._note.length>1&&n.find("textarea[name=Note]").prop("disabled",!0);f._fare.length>1&&n.find("input[name=Fare]").prop("disabled",!0);f._surCharge.length>1&&n.find("input[name=Surcharge]").prop("disabled",!0);f._deposit.length>1&&n.find("input[name=Deposit]").prop("disabled",!0);f._discount.length>1&&n.find("input[name=Discount]").prop("disabled",!0);f._paymentInfo.length>1&&(n.find("select[name=PaymentType]").prop("disabled",!0),n.find("input[name=BranchName]").prop("disabled",!0),n.find("select[name=BranchName]").prop("disabled",!0),n.find("input[name=ChargeCode]").prop("disabled",!0),n.find("input[name=PayAddress]").prop("disabled",!0),n.find("input[name=DriverName]").prop("disabled",!0),n.find("input[name=TransCode]").prop("disabled",!0),n.find("input[name=AgentName]").prop("disabled",!0));typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&(p=n.find('div.checkbox-route-point input[name="RoutePoint"]').first(),app.rights.indexOf($.rights.bUBFrtStg.val)==-1&&(p.is(":disabled")||p.attr("disabled",!0)));w._checkRightOnUpdateForm(u)?n.find("button.btn-cancel").show():n.find("button.btn-cancel").hide()},_triggerUpdateTab:function(n){n.find("ul[role=tab-list] li").not(".hidden").first().find("a").trigger("click")},_triggerUpdateForm:function(n){n.find("select[name=PaymentType]").trigger("change")},_createRoutePoints:function(n,t,i,r,u,f,e,o){var b=this,c=n.find("div.checkbox-route-point"),l,a,y,p,v;c.empty();l=0;a=0;u!=0&&(l=u);f!=0&&(a=f);vIsEstStr(i)&&(y=i.indexOf("~"),l=i.substr(y+1,i.length).split("|")[0]);vIsEstStr(r)&&(p=r.indexOf("~"),a=r.substr(p+1,r.length).split("|")[0]);var w=e,s=parseInt(w.split(":")[0]),h=parseInt(w.split(":")[1]);$.each(t,function(n,i){var r="",o="",u,f;s+=parseInt(i.Hour);h+=parseInt(i.Minute);h>=60&&(h=h%60,s+=1);s>24?s=s%24:s==24&&(s=0,r="00");s<10?r="0"+s:s>=10&&(r=s);o=h<10?"0"+h:h;u="";u=n==0?e:r+":"+o;f=$('<label class="checkbox-inline" />').append($('<input type="checkbox" name="RoutePoint" data-point-id="'+i.Id+'"/>')).append($("<b />").html(i.Code)).append($('<mark class="text-primary"/>').html(u));t.length==2&&f.addClass("hidden");c.append(f)});l==0&&a==0?(v=c.find('input[name="RoutePoint"]'),v.first().attr("checked",!0),v.last().attr("checked",!0)):(c.find('input[name="RoutePoint"][data-point-id="'+l+'"]').attr("checked",!0),c.find('input[name="RoutePoint"][data-point-id="'+a+'"]').attr("checked",!0));b._bindEventRoutePoints(n,o)},_bindEventRoutePoints:function(n,t){var i=this;n.find('input[name="RoutePoint"]').unbind().on("click",function(){var f=0,e=0,u=0,o=0,s=n.find('input[name="NumSeat"]').val(),h=n.find('input[name="NumClick"]').val(),r;$(this).is(":checked")?(r=n.find('input[name="RoutePoint"][checked="checked"]'),r.length>=2?h!=0?(n.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),$(this).attr("checked",!0),typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint?(r=n.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),r.length==1&&(f=n.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),e=r.attr("data-point-id"),u=i._getFareQuickBook(f,e,t)),o=s*u,n.find('input[name="Fare"]').val(u.toMn()),n.find('input[name="ToTalFare"]').val(o.toMn())):(n.find('input[name="Fare"]').val(0),n.find('input[name="ToTalFare"]').val(0))):(r=n.find('input[name="RoutePoint"][checked="checked"]'),r.last().removeAttr("checked"),$(this).attr("checked",!0),r=n.find('input[name="RoutePoint"][checked="checked"]'),r.length==2&&(f=r.first().attr("data-point-id"),e=r.last().attr("data-point-id"),u=i._getFareQuickBook(f,e,t)),o=s*u,n.find('input[name="Fare"]').val(u.toMn()),n.find('input[name="ToTalFare"]').val(o.toMn()),n.find('input[name="NumClick"]').val(1)):r.length<=1&&(typeof _dict._hasBlockFromPoint!="undefined"&&_dict._hasBlockFromPoint&&app.rights.indexOf($.rights.bUBFrtStg.val)==-1?(n.find('input[name="RoutePoint"][checked="checked"]').not(":disabled").removeAttr("checked"),$(this).attr("checked",!0),r=n.find('input[name="RoutePoint"][checked="checked"]').not(":disabled"),r.length==1&&(f=n.find('input[name="RoutePoint"][disabled="disabled"]').first().attr("data-point-id"),e=r.attr("data-point-id"),u=i._getFareQuickBook(f,e,t)),o=s*u,n.find('input[name="Fare"]').val(u.toMn()),n.find('input[name="ToTalFare"]').val(o.toMn())):($(this).attr("checked",!0),r=n.find('input[name="RoutePoint"][checked="checked"]'),r.length==2&&(f=r.first().attr("data-point-id"),e=r.last().attr("data-point-id"),u=i._getFareQuickBook(f,e,t)),o=s*u,n.find('input[name="Fare"]').val(u.toMn()),n.find('input[name="ToTalFare"]').val(o.toMn())))):($(this).removeAttr("checked"),n.find('input[name="Fare"]').val(0),n.find('input[name="ToTalFare"]').val(0),n.find('input[name="NumClick"]').val(1))})},_closeUpdateDialog:function(n){n&&(vbf("onClearWarningCustomer",{f:n}),n.modal("hide"));$("body").find(".updateConflict-popup").remove();$("body").find(".modal-backdrop.fade.in").remove()},_createUpdateConflictDialogDiv:function(n,t,i,r,u,f,e,o){var s=this,h;$("body").find("#updateConflict-popup").remove();h=$("<div />").addClass("modal-body").append($("<form />").attr("id","UpdateConflictForm").append($("<table />").addClass("table no-border mb0 table-modal table-condensed").append($("<tr />").append($('<td style="border:0;" />').addClass("col-md-6").append($("<div />").addClass("form-group").attr("area-hidden","true").append($("<p />").html("Ghế đã được đặt bởi <strong style='color:red'>"+t+"<\/strong>. Đặt chồng vé ?"))))).append($("<tr />").append($("<td />").addClass("col-md-12 list-btn").attr("colspan",3).append($("<button />",{type:"button"}).addClass("btn btn-danger").text("Đồng ý").css("float","left").click(function(){s._closeUpdateConflictDialog();s._transformUpdateFormValue(n);s._updateTicket(n,i,r,u,f,e,o);app.selectedPhone="";app.selectedCode="";app.ctrlOn=!1;$._resetCopyInfo();$._resetBookReturnInfo()})).append($("<button />",{type:"button"}).addClass("btn btn-default").text("Không").css("float","left").click(function(){s._closeUpdateConflictDialog()}))))));s._$updateConflictModal=$("<div />").addClass("modal fade updateConflict-popup").attr("role","dialog").attr("aria-hidden","true").append($("<div />").addClass("modal-dialog modal-md").append($("<div />").addClass("modal-content").append($("<div />").addClass("modal-header").css("background-color","#c9302c").addClass("bg-primary").append($("<h2 />").addClass("modal-title thin-1").html("Cảnh báo"))).append(h))).appendTo($("body"));s._$updateConflictModal.modal("show")},_closeUpdateConflictDialog:function(){this._$updateConflictModal.modal("hide")},_resetForm:function(n){n.find("input[type=hidden]").val("");n.find("input[type=text], textarea, select").val("");n.find("input[type=checkbox]").prop("checked",!1);n.find("input[type=radio]").prop("checked",!1);n.find("div.has-error").removeClass("has-error");n.find("div.search-result").remove()},_getPickupInfo:function(n,t,i){return typeof n=="undefined"&&(n=""),typeof t=="undefined"&&(t=""),typeof i=="undefined"&&(t=""),$.trim(n+"|"+t+"|"+i)},_getCustomer:function(n,t,i){return $.trim("1|1|"+n+"|"+t+"|"+i)},_getTeamInfo:function(){var n=FlatObj.cTrip.TeamInfo,t="|",i;return n&&(i=n.split("~"),$.each(i,function(n,i){if(n>=1){var r=i.split("|");r[0]==2&&(t=r[2]+"|"+r[3])}})),t},_getFareQuickBook:function(n,t,i){var u=this,f=u._parseFares(i),e=n+"|"+t,r=f[e];return typeof r=="undefined"?0:r},_parseFares:function(n){var u="",f="",r=0,t;if(n!=undefined&&vIsEstStr(n)&&n.length>1){var i=n.split("~"),o=i.length,e=[];for(t=1;t<o;t++)u=i[t].split("|")[0],f=i[t].split("|")[1],r=parseInt(i[t].split("|")[2]),e[u+"|"+f]=isNaN(r)?0:r;return e}return[]},_transformUpdateFormValue:function(n){var t=this,i=n.find("select[name=PaymentType]").not(":disabled").val(),r=n.find("input[name=Notcome]").not(":disabled").prop("checked"),u=n.find("input[name=KeepOnTime]").not(":disabled").prop("checked");if(r)t._changeFormToNotComeStatus(n);else if(u)t._changeFormToKeepOnTimeStatus(n);else if(typeof i!="undefined")if(i=parseInt(i),isNaN(i))t._changeFormToBookingStatus(n);else switch(i){case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 10:t._changeFormToPaidStatus(n);break;case 9:t._changeFormToPassStatus(n)}},_changeFormToPaidStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(2);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToNotComeStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(4);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToPassStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(5);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToKeepOnTimeStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(8);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToBookingStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(1);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToOpenStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(7);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToValidStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(6);n.find("input[name=StatusInfo]").val(t.join())},_changeFormToCancelledStatus:function(n){for(var t=[],i=0;i<app.seatStack.length;i++)t.push(3);n.find("input[name=StatusInfo]").val(t.join())},_checkRightOnUpdateForm:function(n){var r,i,t;if(app.rights.indexOf("~3|2|")==-1)return!0;for(r=app.rights.indexOf("~3|2|0")>=0?!1:!0,i=app.rights.split("~"),t=0;t<i.length;t++)if(i[t].indexOf("3|2|")>=0&&n==i[t].split("|")[2])return!r;return r}});$(document).ready(function(){$._convertFormDataToObj=function(n){var t={},i=!1,r;return(app.hasCopyTicket||app.hasBookReturnTicket)&&(i=!0),r=n.find("#UpdateForm input,textarea,select"),$.each(r,function(n,r){(!$(r).is(":disabled")||i)&&(t[r.name]=r.value)}),t};$._bindEventOnCalendarIcon=function(){$("#FilterForm").find(".glyphicon-calendar").parent().on("click",function(){$(this).prev().datepicker("show")})};$._getBranchInfo=function(n){var t="";return $.each(app.branchInfo,function(i,r){t==""&&n==r[0]&&(t=r.join("|"))}),t==""&&(t=[app.aid,app.aite,app.aice,app.aisne,"",""].join("|")),t};$._getPayment=function(n,t,i){return $.trim(n+":"+t+":"+i)}});
//# sourceMappingURL=p.min.js.map
