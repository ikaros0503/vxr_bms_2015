define({start:function(n){var t=this;vbv("doCloseCancelForm",function(){t._closeCancelDialog()});vbv("doShowCancelForm",function(i){t._createCancelDialogDiv();var r=$(n._e),u=function(n){if(n==null||n.length<=0)return!1;for(var t=0;t<n.length;t++)if(n[t]._getCurrentTicket()._status==1)return!0;return!1};u(i.d.st)?(r.find(".divFeePercentRadio").children().prop("disabled",!0),r.find(".divFeePercentRadio div").children().prop("disabled",!0)):typeof i.d.allIsBooking!="undefined"&&i.d.allIsBooking?(r.find(".divFeePercentRadio").children().prop("disabled",!0),r.find(".divFeePercentRadio div").children().prop("disabled",!0)):(r.find(".divFeePercentRadio").children().prop("disabled",!1),r.find(".divFeePercentRadio div").children().prop("disabled",!1));r.find('input[name="TicketFares"]').val(i.d.totalFare);t._bindEventOnCancelForm(r,i.d.tId,i.d.tName,i.d.tDate,i.d.st,i.d.tBus,i.d.sc);r.modal("show")})},_createCancelDialogDiv:function(){var n=null,i=0,r=0,t;typeof _dict._cancelFeePercentDefault!="undefined"&&(i=_dict._cancelFeePercentDefault);typeof _dict._cancelFeeMoneyDefault!="undefined"&&(r=_dict._cancelFeeMoneyDefault.toMn());t=$("<div />").addClass("modal-body").css("padding-top","10px").append($("<form />").attr("id","CancelForm").append($("<table />").addClass("table no-border mb0 table-modal table-condensed").append($("<tr />").append($('<td style="border:0;" />').addClass("col-md-6").append($('<input type="hidden" name="TicketFares" value="" />')).append($('<lable class="control-label col-md-2 pr0 pl0 lblFeePercentRadio" style="margin: 5px 0 0 0 !important;"/>').html("Phí hủy vé : ")).append($("<div />").addClass("input-group col-md-10 divFeePercentRadio").css("margin-top","-2px").append($('<div class="input-group-addon pl0 " />').css("border","0").css("background-color","transparent").append($('<input type="radio" name="FeePercentRadio" checked="checked"/>').css("margin-top","3px"))).append($('<input type="text" class="form-control input-sm" name="CancelFeePercentInput" value="'+i+'" style="border-bottom-left-radius: 3px;border-top-left-radius: 3px;" />')).append($('<span style="border-bottom-right-radius: 3px;border-top-right-radius: 3px;"/>').addClass("input-group-addon").html("%")).append($('<div class="input-group-addon pl0" />').css("border","0").css("background-color","transparent").append($('<input type="radio" name="FeeMoneyRadio" />').css("margin","3px 0 0 25px"))).append($('<input type="text" class="form-control input-sm" name="CancelFeeMoneyInput" value="'+r+'" style="border-bottom-left-radius: 3px;border-top-left-radius: 3px;" />')).append($("<span />").addClass("input-group-addon").html("đ"))).append($('<div style="margin-top:10px;margin-bottom:10px;"/>').addClass("form-group col-md-12 pl0 pr0").append($('<lable class="control-label col-md-2 pr0 pl0" style="margin: 5px 0 0 0 !important;"/>').html("Lý do hủy vé: ")).append($('<div class="col-md-10 pl0 pr0" />').append($('<select class="form-control input-sm cor-black" name="CancelReason"/>').append($('<option value=""> - - - - - Chọn lý do hủy vé - - - - - <\/option>')).append($('<option value="1">Nhà xe hủy<\/option>')).append($('<option value="2">Khách hàng hủy<\/option>')).append($('<option value="3">Đại lý hủy<\/option>')).append($('<option value="0">Khác<\/option>'))).change(function(t){t.stopPropagation();t.preventDefault();var i=n.find('select[name="CancelReason"]').val();i!=""&&n.find("div.warning-mess").html("").hide()}))).append($("<div />").addClass("form-group col-md-12 pl0 pr0").css("margin-bottom","10px").append($('<lable class="control-label col-md-2 pr0 pl0" />').html("Ghi chú: ")).append($('<div class="col-md-10 pl0 pr0" />').append($('<textarea class="col-md-12 form-control input-sm" name="NoteCancel" />')))).append($('<div style="margin:10px 0;"/>').addClass("form-group").append($("<p />").html("Bạn có chắc muốn hủy vé đã chọn ?"))))).append($("<tr />").append($("<td />").addClass("col-md-12 list-btn").attr("colspan",3).append($("<button />",{type:"button"}).addClass("btn btn-danger btn-cancel").text("Hủy vé").css("float","left")).append($("<button />",{type:"button"}).addClass("btn btn-default btn-close").text("Đóng").css("float","left"))))));$.rights.cReDeFo!=null&&app.rights.indexOf($.rights.cReDeFo.val)!=-1&&t.find('select[name="CancelReason"] option:last-child').before($('<option value="4">Hủy hoàn toàn<\/option>'));n=$("<div />").addClass("modal fade").attr("id","cancel-popup").attr("role","dialog").attr("aria-hidden","true").append($("<div />").addClass("modal-dialog modal-md").append($("<div />").addClass("modal-content").append($("<div />").addClass("modal-header bg-primary").append($("<h3 />").addClass("modal-title thin-1").html("Xác nhận"))).append($('<div class="warning-mess alert alert-danger" role="alert" style="display:none;"/>').css("margin","10px 10px 0 10px")).append(t))).appendTo($("body"))},_closeCancelDialog:function(n){var t=this;n&&(n.modal("hide"),t._resetCancelForm(n))},_resetCancelForm:function(n){var t=0,i=0;typeof _dict._cancelFeePercentDefault!="undefined"&&(t=_dict._cancelFeePercentDefault);typeof _dict._cancelFeeMoneyDefault!="undefined"&&(i=_dict._cancelFeeMoneyDefault.toMn());n.find('input[name="FeePercentRadio"]').prop("checked",!0).button("refresh");n.find('input[name="CancelFeePercentInput"]').val(t);n.find('input[name="CancelFeePercentInput"]').removeClass("cmodal-error-input");n.find('input[name="CancelFeePercentInput"]').next().removeClass("cmodal-error-addon");n.find('input[name="FeeMoneyRadio"]').prop("checked",!1).button("refresh");n.find('input[name="CancelFeeMoneyInput"]').val(i);n.find('input[name="CancelFeeMoneyInput"]').removeClass("cmodal-error-input");n.find('input[name="CancelFeeMoneyInput"]').next().removeClass("cmodal-error-addon");n.find('select[name="CancelReason"]').val("");n.find('textarea[name="NoteCancel"]').val("");n.find("div.warning-mess").html("").hide()},_bindEventOnCancelForm:function(n,t,i,r,u,f,e){var o=this,s=0,h=0;typeof _dict._cancelFeePercentDefault!="undefined"&&(s=_dict._cancelFeePercentDefault);typeof _dict._cancelFeeMoneyDefault!="undefined"&&(h=_dict._cancelFeeMoneyDefault.toMn());n.find('input[name="FeePercentRadio"]').unbind().on("change",function(t){try{t.preventDefault();t.stopPropagation();n.find("div.warning-mess").html("").hide();$(this).prop("checked",!0).button("refresh");n.find('input[name="FeeMoneyRadio"]').prop("checked",!1);n.find('input[name="CancelFeeMoneyInput"]').val(h);n.find('input[name="CancelFeeMoneyInput"]').removeClass("cmodal-error-input");n.find('input[name="CancelFeeMoneyInput"]').next().removeClass("cmodal-error-addon")}catch(t){console.error(t)}});n.find('input[name="FeeMoneyRadio"]').unbind().on("change",function(t){try{t.preventDefault();t.stopPropagation();n.find("div.warning-mess").html("").hide();$(this).prop("checked",!0).button("refresh");n.find('input[name="FeePercentRadio"]').prop("checked",!1);n.find('input[name="CancelFeePercentInput"]').val(s);n.find('input[name="CancelFeePercentInput"]').removeClass("cmodal-error-input");n.find('input[name="CancelFeePercentInput"]').next().removeClass("cmodal-error-addon")}catch(t){console.error(t)}});n.find('[name="CancelFeeMoneyInput"]').on("focus",function(){$(this).select();n.find('input[name="FeeMoneyRadio"]').prop("checked",!0);n.find('input[name="FeePercentRadio"]').prop("checked",!1)}).mouseup(function(n){n.preventDefault()});n.find('[name="CancelFeePercentInput"]').on("focus",function(){$(this).select();n.find('input[name="FeeMoneyRadio"]').prop("checked",!1);n.find('input[name="FeePercentRadio"]').prop("checked",!0)}).mouseup(function(n){n.preventDefault()});n.find("button.btn-cancel").unbind().on("click",function(s){var y,p,l,w;s.preventDefault();s.stopPropagation();try{var h=0,c=0,a=!1,v=!1;if(n.find('input[name="FeePercentRadio"]').is(":checked")){if(h=n.find('input[name="CancelFeePercentInput"]').val(),isNaN(h))return n.find("div.warning-mess").html("Phí hủy vé không chính xác, vui lòng kiểm tra lại.").show(),!1;if(h>100)return n.find("div.warning-mess").html("Phí hủy vé không được lớn hơn 100%, vui lòng kiểm tra lại.").show(),!1;a=!0}if(n.find('input[name="FeeMoneyRadio"]').is(":checked")){if(c=n.find('input[name="CancelFeeMoneyInput"]').val().replace(/\./g,""),isNaN(c))return n.find("div.warning-mess").html("Phí hủy vé không chính xác, vui lòng kiểm tra lại.").show(),!1;if(y=n.find('input[name="TicketFares"]').val(),p=[],$.each(y.split(","),function(n,t){parseInt(c)>parseInt(t)&&p.push(t)}),p.length>0)return n.find("div.warning-mess").html("Phí hủy vé không được lớn hơn tổng giá vé: "+y+" đ.").show(),!1;v=!0}l=n.find('select[name="CancelReason"]').val();w=n.find('textarea[name="NoteCancel"]').val();typeof _dict._cancelReasonRequired!="undefined"&&_dict._cancelReasonRequired?l!=""?(o._cancelTicket(n,a,h,v,c,l,w,t,i,r,u,f,e),o._resetCancelForm(n)):n.find("div.warning-mess").html("Vui lòng chọn lý do hủy vé.").show():(o._cancelTicket(n,a,h,v,c,l,w,t,i,r,u,f,e),o._resetCancelForm(n))}catch(s){console.error(s)}});n.find("button.btn-close").unbind().on("click",function(){vbf("onClearSelectedItem");vbf("resetSeatStack");o._closeCancelDialog(n);o._resetCancelForm(n)})},_cancelTicket:function(n,t,i,r,u,f,e,o,s,h,c,l,a){var v=this,y=v._createCancelTicketObj(t,i,r,u,f,e,c,o,l,a),p=function(t){var i,f,r,u,e,l,a;t==1&&(i=[],$.each(c,function(n,t){i.push(t._label)}),f=c[0],vbf("onStoreHistory",{un:app.un,key:"cancel",his:{_tid:o,_tname:s,_tdate:h,_s:i}}),vbf("resetSeatStack"),vbf("reloadBookingSheet",{},function(){vbf("doGetTotalSeats")}),v._closeCancelDialog(n),_dict._autoSendSmsCancel!=undefined&&_dict._autoSendSmsCancel&&(r=[],u=f._getCurrentTicket(),!$.isEmptyObject(u)&&vIsEstStr(u._cphone)&&r.push(u._cphone),e={_tripName:s,_tripDate:h.toFormatString("HH:mm-dd.mm.yyyy"),_nOfSeat:i.length,_seatCodes:i.join(",")},l=vtpl(_dict._smsCancelTpl,e),r.length>0&&(a={_a:"sendMobifoneSms",_c:{},_d:{phones:r.join(","),message:l}},vRqs(a))))};vRqs(y,p)},_createCancelTicketObj:function(n,t,i,r,u,f,e,o,s,h){var c={},l;return c._a="UpdateBookTicket",c._c=[],c._d=[],l=0,$.each(e,function(n,t){var i=t._getCurrentTicket();i._status==2&&l++}),$.each(e,function(e,a){var v=a._getCurrentTicket(),y=0,p;n&&(y=v._fare*t/100);i&&v._status==2&&(y=Math.floor(r/l));c._c.push({Id:v._id,TripId:o,SeatCode:a._getSeatInfo(),PickupDate:v._pdate.toFormatString("iso"),Bus:s,StageCode:h?h:1});p={TripAlias:parseInt(s),Status:3,CancelFee:y,CancelType:u,CancelInfo:f,CanceledUser:app.un,CanceledAgentId:app.aid};c._d.push(p)}),c}});
//# sourceMappingURL=p.min.js.map
