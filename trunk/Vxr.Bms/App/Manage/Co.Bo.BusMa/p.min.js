define({routesData:{},start:function(){try{$("#bksContent").hide();$("#report").hide();$("#product-content").hide();$("#cod").hide();$("#busManager").show();$("#busManager").html($("#BusManagerTemplate").html());this.initView();this.loadRoutesAndTrips();this.loadDrivers();this.loadBus();this.loadSeatTemplates()}catch(n){console.error(n)}},initView:function(){var n=this;$(".departure").datepicker({dateFormat:"dd-mm-yy"});$(".departure").datepicker("setDate",new Date);$("#spnDate").html("Ngày "+new Date($(".departure").datepicker("getDate")).toFormatString("dd-mm-yyyy"));vev(".departure","change",function(){$("#spnDate").html("Ngày "+new Date($(".departure").datepicker("getDate")).toFormatString("dd-mm-yyyy"));n.loadRoutesAndTrips()})},getTicketInfo:function(){var n=this,i=new Date($(".departure").datepicker("getDate")),t=new Date(i);t.setDate(t.getDate()+1);vRqs({_a:"fGetTicketSummary",_c:{CompId:"$x="+app.cid+" and TripDate>='"+n.toDbDateString(i)+"' and TripDate<'"+n.toDbDateString(t)+"'"},_f:"TripDate, TripId, CompId, Booked, Paid, Total"},function(t,i){var r,u;if(t==1&&i.length>0)for(r=0;r<i.length;r++)u=moment(i[r][0]).format("HH:mm"),n.routesData[i[r][1]]!=null&&(n.routesData[i[r][1]].trips[u].booked=i[r][3],n.routesData[i[r][1]].trips[u].paid=i[r][4],n.routesData[i[r][1]].trips[u].empty=parseInt(n.routesData[i[r][1]].trips[u].total)-parseInt(i[r][3])-parseInt(i[r][4]));n.renderGroups()})},loadRoutesAndTrips:function(){var n=this,r=function(n){var r,u,i,t;if(!(n!=null&&n!=""))return[];for(r=[],u=n.split("~"),i=1;i<u.length;i++)t=u[i].split("|"),t[0]=="2"&&r.push({type:2,id:t[1],name:t[2],phone:t[3]});return r},u=function(n){for(var i="",t=0;t<n.length;t++)i+=n[t].name+"<br />";return i},t=function(n){for(var i="",t=0;t<n.length;t++)i+=n[t].id+"-";return i},f=function(n){var r,u,i,t;if(!(n!=null&&n!=""))return[];for(r=[],u=n.split("~"),i=1;i<u.length;i++)t=u[i].split("|"),t[0]=="4"&&r.push({type:4,id:t[1],name:t[2],phone:t[3]});return r},i;n.routesData=[];i=n.toDbDateString(new Date($(".departure").datepicker("getDate")));vRqs({_a:"fGetRoutesAndTrips",_c:{CompId:"$x="+app.cid+" and IsPrgStatus=1 and (Type=1 or (Type=2 and Date='"+i+"')) order by Type, DisplayOrder, Name"},_f:"Id, Type, Name, Date, Time, SeatTemplateInfo, Info, CompId, IsPrgStatus, BaseId,StatusInfo,VehicleInfo, TeamInfo, Note, FromArea, ToArea, RouteInfo, FareInfo,Keywords, TotalStage,BranchReceiveProduct, FromId, ToId, RouteId, DisplayOrder"},function(i,e){var a,o,v,l,h,s,p,y,c;if($("#selectRoutes").html(""),a=function(i,e){var o=r(i[12]),s=f(i[12]);return{tripId:i[1]==1?i[0]:i[9],time:e,id:i[0],type:i[1],date:i[3],booked:0,paid:0,total:parseInt(i[5].split("|")[2]),empty:parseInt(i[5].split("|")[2]),status:"",bus:n.getSubItem(i[11],"|",2),busId:n.getSubItem(n.getSubItem(i[11],"|",0),"~",1),drivers:o,assitants:s,assitantIds:t(s),driversStr:u(o),driverIds:t(o),seatTemplateId:n.getSubItem(i[5],"~",0),statusInfo:i[10],tripType:i[10]==2?"enhanced":i[10]==3?"cancelled":"",isCancelled:i[10]==3?"isCancelled":"",note:i[13]}},i==1&&e.length>0){for(o=0;o<e.length;o++)if(e[o][1]==1){for(v={id:e[o][0],name:e[o][2],note:e[o][13],fromArea:e[o][14],toArea:e[o][15],routeInfo:e[o][16],fareInfo:e[o][17],seatTemplateInfo:e[o][5],info:e[o][6],keywords:e[o][18],totalStage:e[o][19],branchReceiveProduct:e[o][20],fromId:e[o][21],toId:e[o][22],routeId:e[o][23],displayOrder:e[o][24],trips:{}},l=e[o][6].split("~"),h=0;h<l.length;h++)v.trips[l[h]]=a(e[o],l[h]);n.routesData[e[o][0]]=v}else n.routesData[e[o][9]]!=null&&(n.routesData[e[o][9]].trips[e[o][4]]=a(e[o],e[o][4]));for(s in n.routesData)if(n.routesData.hasOwnProperty(s)){p=n.routesData[s].info;for(y in n.routesData[s].trips)n.routesData[s].trips.hasOwnProperty(y)&&(c=n.routesData[s].trips[y],c.statusInfo!=3&&p.indexOf(c.time)<0&&(c.statusInfo=2,c.tripType="enhanced"))}n.getTicketInfo()}})},loadDrivers:function(){vRqs({_a:"fGetPerson",_c:{CompId:"$x="+app.cid+" and (Type=2 or Type=4)"},_f:"Id, FullName, Type, PhoneInfo"},function(n,t){if(n==1&&t.length>0){$("#selectDrivers").html("");$("#selectAssitants").html("");for(var i=0;i<t.length;i++)t[i][2]==2?$("#selectDrivers").append('<option data-phone="'+t[i][3]+'" value="'+t[i][0]+'">'+t[i][1]+"<\/option>"):$("#selectAssitants").append('<option data-phone="'+t[i][3]+'"  value="'+t[i][0]+'">'+t[i][1]+"<\/option>");$("#selectDrivers").chosen({});$("#selectAssitants").chosen({})}})},loadBus:function(){vRqs({_a:"fGetVehicle",_c:{CompId:"$x="+app.cid+" and Type=1"},_f:"Id, LicensePlate"},function(n,t){if(n==1&&t.length>0){$("#selectBus").html("");$("#selectBus").append('<option value="-1">----<\/option>');for(var i=0;i<t.length;i++)$("#selectBus").append('<option value="'+t[i][0]+'">'+t[i][1]+"<\/option>")}})},loadSeatTemplates:function(){vRqs({_a:"fGetResource",_c:{CompId:"$x="+app.cid+" and IsPrgStatus=1"},_f:"Id, Name, Info"},function(n,t){if(n==1&&t.length>0){$("#selectSeatTemplates").html("");for(var i=0;i<t.length;i++)$("#selectSeatTemplates").append('<option value="'+t[i][0]+'" data-info="'+t[i][2]+'">'+t[i][1]+"<\/option>")}})},renderGroups:function(){var n=this,r,i,t;if($("#divAllTables").html(""),r=function(t){if(t!=null){$("#hGroupTitle").text(t.name);$("#tbdTableTemplate").html("");t.trips=n.sortObject(t.trips);for(var i in t.trips)$("#tbdTableTemplate").append(vtpl($("#rowTemplate").html(),t.trips[i]));$("#divAllTables").append($("#tableTemplate").html())}},$("#selectRoutes").html(""),n.routesData!=null){for(i=n.getRoutesArray(),t=0;t<i.length;t++)r(i[t]),$("#selectRoutes").append('<option value="'+i[t].id+'" >'+i[t].name+"<\/option>");n.updateSelectTimes()}$("#btnCancelTrip").attr("disabled","disabled");$("#btnUpdateTrip").attr("disabled","disabled");n.bindEvents();n.deselectRow()},getSubItem:function(n,t,i){if(n==null)return"";try{return n.split(t)[i]}catch(r){}return""},updateSelectTimes:function(){var t=this,n;if($("#selectTimes").html(""),$("#selectTimes").append('<option value="-1">---<\/option>'),t.routesData[$("#selectRoutes").val()]!=null)for(n in t.routesData[$("#selectRoutes").val()].trips)$("#selectTimes").append('<option value="'+n+'">'+n+"<\/option>")},selectRow:function(n){var u=this,f,e,t,r,i;if($("tr").removeClass("selectedRow"),$(n).addClass("selectedRow"),$(n).hasClass("isCancelled")?($("#btnCancelTrip").text("Phục hồi"),$("#btnCancelTrip").removeClass("btn-danger"),$("#btnCancelTrip").addClass("btn-primary")):($("#btnCancelTrip").text("Hủy"),$("#btnCancelTrip").removeClass("btn-primary"),$("#btnCancelTrip").addClass("btn-danger")),$("#btnCancelTrip").removeAttr("disabled"),$("#selectRoutes").val($(n).attr("data-tripId")),u.updateSelectTimes(),$("#txtNote").val($(n).attr("data-note")),$("#selectSeatTemplates").val($(n).attr("data-seatTemplateId")),$("#selectSeatTemplates").val()==null&&$("#selectSeatTemplates").val($("#selectSeatTemplates option:first").val()),$("#selectTimes").val($(n).attr("data-tripTime")),$(n).attr("data-busId")!=""&&$("#selectBus").val($(n).attr("data-busId")),f=$("#selectRoutes").val(),e=$("#selectTimes").val(),parseInt(u.routesData[f].trips[e].booked)+parseInt(u.routesData[f].trips[e].paid)>0&&$("#selectSeatTemplates").attr("disabled","disabled"),$(n).attr("data-driverIds")!=""&&(t=$(n).attr("data-driverIds").split("-"),t.length>1)){for(r=[],i=0;i<t.length-1;i++)r.push(t[i]);$("#selectDrivers").chosen("destroy").val(r).chosen()}if($(n).attr("data-assitantids")!=""&&(t=$(n).attr("data-assitantids").split("-"),t.length>1)){for(r=[],i=0;i<t.length-1;i++)r.push(t[i]);$("#selectAssitants").chosen("destroy").val(r).chosen()}$(n).hasClass("isCancelled")||($("#selectDrivers").removeAttr("disabled"),$("#selectBus").removeAttr("disabled"),$("#selectDrivers").removeAttr("disabled"),$("#selectAssitants").removeAttr("disabled"),$("#selectDrivers").chosen("destroy").chosen(),$("#selectAssitants").chosen("destroy").chosen(),$("#selectSeatTemplates").removeAttr("disabled"),$("#txtNote").removeAttr("disabled"),$("#btnUpdateTrip").removeAttr("disabled"))},deselectRow:function(){var n=this;$("tr").removeClass("selectedRow");$("#btnCancelTrip").text("Hủy");$("#btnCancelTrip").removeClass("btn-primary");$("#btnCancelTrip").addClass("btn-danger");$("#btnCancelTrip").attr("disabled","disabled");$("#btnUpdateTrip").attr("disabled","disabled");$("#selectDrivers").attr("disabled","disabled");$("#selectBus").attr("disabled","disabled");$("#selectDrivers").chosen("destroy").chosen();$("#selectAssitants").chosen("destroy").chosen();$("#selectDrivers").attr("disabled","disabled");$("#selectAssitants").attr("disabled","disabled");$("#selectSeatTemplates").attr("disabled","disabled");$("#txtNote").attr("disabled","disabled");$("#txtNote").val("");$("#selectTimes").val("-1");$("#selectDrivers").chosen("destroy").val([]).chosen();$("#selectAssitants").chosen("destroy").val([]).chosen();$("#selectTimes").val("-1");$("#selectBus").val("-1");$("#selectSeatTemplates").val("-1")},bindEvents:function(){var n=this,t,i;vev("#txtAddTime","keyup",function(){var i=$(this).val().split(":"),n,t;try{if(n=parseInt(i[0]),t=parseInt(i[1]),n>=0&&n<=23&&t>=0&&t<=59){$("#btnAddTime").removeAttr("disabled");return}}catch(r){}$("#btnAddTime").attr("disabled","disabled")});vev("#btnAddTime","click",function(){var i=$("#txtAddTime").val().split(":"),r,t;parseInt(i[0])<0||parseInt(i[0])>23||parseInt(i[1])<0||parseInt(i[1])>59?alert("Invalid Time"):(r=(parseInt(i[0])<10?"0"+parseInt(i[0]):parseInt(i[0]))+":"+(parseInt(i[1])<10?"0"+parseInt(i[1]).toString():parseInt(i[1])),t=$("#selectRoutes").val(),$("#selectTimes option").each(function(){if($(this).val()==r){alert("Chuyen nay da co roi");return}}),vRqs({_a:"InsertTrip",_d:{Type:2,Name:n.routesData[t].name,FromArea:n.routesData[t].fromArea,ToArea:n.routesData[t].toArea,Date:n.toDbDateString(new Date($(".departure").datepicker("getDate"))),Time:r,RouteInfo:n.routesData[t].routeInfo,FareInfo:n.routesData[t].fareInfo,SeatTemplateInfo:n.routesData[t].seatTemplateInfo,Info:n.routesData[t].info,Keywords:n.routesData[t].keywords,CompId:app.cid,TotalStage:n.routesData[t].totalStage,StatusInfo:2,IsPrgStatus:1,BaseId:t,BranchReceiveProduct:n.routesData[t].branchReceiveProduct,FromId:n.routesData[t].fromId,ToId:n.routesData[t].toId,RouteId:n.routesData[t].routeId,TotalBookedSeats:0,TotalPaidSeats:0}},function(t,i){t==1&&i.length>0?n.loadRoutesAndTrips():alert("Please try again later");$("#btnAddTime").attr("disabled","disabled");$("#txtAddTime").val("")}))});vev("#selectRoutes","change",function(){for(var t=0;t<n.routesData.length;t++)$(this).val()==n.routesData[t].id&&n.updateSelectTimes(n.routesData[t])});vev("#selectTimes","change",function(){var i=$("#selectRoutes").val(),t=$("#selectTimes").val();n.deselectRow();t!="-1"&&n.selectRow($("tr[data-tripTime='"+t+"'][data-tripId='"+i+"']"))});t=function(){var r=$("tr.selectedRow"),t=$("#selectRoutes").val(),i=$("#selectTimes").val();if(parseInt(n.routesData[t].trips[i].booked)+parseInt(n.routesData[t].trips[i].paid)>0){alert("Chuyến hiện tại đang có vé, vui lòng hủy hết để hủy chuyến");return}$(r).attr("data-type")=="1"?vRqs({_a:"InsertTrip",_d:{Type:2,Name:n.routesData[t].name,FromArea:n.routesData[t].fromArea,ToArea:n.routesData[t].toArea,Date:n.toDbDateString(new Date($(".departure").datepicker("getDate"))),Time:i,RouteInfo:n.routesData[t].routeInfo,FareInfo:n.routesData[t].fareInfo,SeatTemplateInfo:n.routesData[t].seatTemplateInfo,Info:n.routesData[t].info,Keywords:n.routesData[t].keywords,CompId:app.cid,TotalStage:n.routesData[t].totalStage,StatusInfo:3,IsPrgStatus:1,BaseId:t,BranchReceiveProduct:n.routesData[t].branchReceiveProduct,FromId:n.routesData[t].fromId,ToId:n.routesData[t].toId,RouteId:n.routesData[t].routeId,TotalBookedSeats:0,TotalPaidSeats:0}},function(t,i){t==1&&i.length>0?n.loadRoutesAndTrips():alert("Please try again later");$("#btnAddTime").attr("disabled","disabled");$("#txtAddTime").val("")}):vRqs({_a:"UpdateTrip",_c:{Id:$(r).attr("data-id")},_d:{StatusInfo:3}},function(t,i){t==1&&i.length>0?n.loadRoutesAndTrips():alert("Please try again later")})};i=function(){var i=$("tr.selectedRow"),t=$("#selectRoutes").val(),e=$("#selectTimes").val(),r=function(){return $("#selectBus").val()=="-1"?"":"1~"+$("#selectBus").val()+"|1|"+$("#selectBus").find("option:selected").text()+"|"},u=function(){return $("#selectSeatTemplates").val()+"~"+$("#selectSeatTemplates").find("option:selected").attr("data-info")},f=function(){var u="1",t=$("#selectDrivers").chosen().val(),i=$("#selectAssitants").chosen().val(),n,r;if(console.log(t,i),t==null&&i==null)return"";if(t!=null)for(n=0;n<t.length;n++)r=$("#selectDrivers").find("option[value="+t[n]+"]"),u+="~2|"+t[n]+"|"+$(r).text()+"|"+$(r).attr("data-phone");if(i!=null)for(n=0;n<i.length;n++)r=$("#selectAssitants").find("option[value="+i[n]+"]"),u+="~4|"+i[n]+"|"+$(r).text()+"|"+$(r).attr("data-phone");return u};$(i).attr("data-type")=="1"?vRqs({_a:"InsertTrip",_d:{Type:2,Name:n.routesData[t].name,FromArea:n.routesData[t].fromArea,ToArea:n.routesData[t].toArea,Date:n.toDbDateString(new Date($(".departure").datepicker("getDate"))),Time:e,RouteInfo:n.routesData[t].routeInfo,FareInfo:n.routesData[t].fareInfo,SeatTemplateInfo:u(),Info:n.routesData[t].info,Keywords:n.routesData[t].keywords,CompId:app.cid,TotalStage:n.routesData[t].totalStage,StatusInfo:1,IsPrgStatus:1,BaseId:t,BranchReceiveProduct:n.routesData[t].branchReceiveProduct,FromId:n.routesData[t].fromId,ToId:n.routesData[t].toId,RouteId:n.routesData[t].routeId,TotalBookedSeats:0,TotalPaidSeats:0,VehicleInfo:r(),TeamInfo:f(),Note:$("#txtNote").val()}},function(t,i){t==1&&i.length>0?n.loadRoutesAndTrips():alert("Please try again later");$("#btnAddTime").attr("disabled","disabled");$("#txtAddTime").val("")}):vRqs({_a:"UpdateTrip",_c:{Id:$(i).attr("data-id")},_d:{SeatTemplateInfo:u(),VehicleInfo:r(),TeamInfo:f(),Note:$("#txtNote").val()}},function(t,i){t==1&&i.length>0?n.loadRoutesAndTrips():alert("Please try again later")})};vev("#btnCancelTrip","click",function(){$(this).text()=="Hủy"?t():vRqs({_a:"UpdateTrip",_c:{Id:$("tr.selectedRow").attr("data-id")},_d:{StatusInfo:1}},function(t,i){t==1&&i.length>0?n.loadRoutesAndTrips():alert("Please try again later")});n.deselectRow()});vev("#btnUpdateTrip","click",function(){i()});vev("#busManager tr","click",function(){var t=$(this).hasClass("selectedRow");n.deselectRow();t||n.selectRow(this)});vev("a.btn-book","click",function(){var n=$(this).attr("data-tripId"),t=$(this).attr("data-tripTime");$("#bksContent").show();$("#report").hide();$("#product-content").hide();$("#busManager").hide();setTimeout(function(){vbf("rlBKS",n==null?{}:{o:{data:{t:n,d:moment(new Date($(".departure").datepicker("getDate"))).format("DD.MM.YYYY"),h:t!=null?t.replace(":","."):""}}})},50)})},sortObject:function(n,t){var f=function(n,t){var i,r,u;if(t==null)return n.sort();if(n.length>0)for(i=0;i<n.length-1;i++)for(r=i+1;r<n.length;r++)console.log(n[i],n[r]),n[i][t]>n[r][t]&&(u=n[i],n[i]=n[r],n[r]=u);return n},u={},i,r=[];for(i in n)n.hasOwnProperty(i)&&(t!=null?r.push(n[i]):r.push(i));for(r=f(r,t),i=0;i<r.length;i++)u[r[i]]=n[r[i]];return u},getRoutesArray:function(){var r=this,n=[],t,i,u;for(key in r.routesData)r.routesData[key].id!=null&&n.push(r.routesData[key]);for(t=0;t<n.length-1;t++)for(i=t+1;i<n.length;i++)n[t].displayOrder>n[i].displayOrder&&(u=n[t],n[t]=n[i],n[i]=u);return n},toDbDateString:function(n){return n.getFullYear()+(n.getMonth()<=8?"-0":"-")+(n.getMonth()+1)+(n.getDate()<=9?"-0":"-")+n.getDate()},toDatePickerDateString:function(n){return(n.getDate()<=9?"0":"")+n.getDate()+(n.getMonth()<=8?"-0":"-")+(n.getMonth()+1)+":"+n.getFullYear()}});
//# sourceMappingURL=p.min.js.map
